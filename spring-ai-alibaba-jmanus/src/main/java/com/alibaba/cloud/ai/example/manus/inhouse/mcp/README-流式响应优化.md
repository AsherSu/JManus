# 流式响应优化方案

## 概述

本方案优化了McpPlan工具的流式响应机制，当计划执行状态为"processing"时，通过轮询机制持续监控执行状态，直到计划执行完成或超时。

## 问题分析

从截图可以看到，当前执行结果中：
- `executionStatus`: "success" 
- `executionResult.status`: "processing"

这表明计划模板的初始请求成功了，但实际的计划执行还在进行中。用户无法获得实时的执行进度和最终结果。

## 解决方案

### 1. 核心组件

#### PlanPollingProperties
- 配置轮询相关参数
- 支持最大轮询次数、轮询间隔、超时时间等配置
- 支持指数退避策略

#### PlanPollingService
- 负责轮询计划执行状态
- 调用ManusController的getExecutionDetails接口
- 支持进度反馈和错误处理

#### McpPlanConfiguration
- Spring配置类，注册轮询相关Bean
- 启用配置属性自动绑定

### 2. 工作流程

1. **初始执行**: 调用计划模板服务
2. **状态检查**: 检查executionResult.status
3. **轮询启动**: 如果status="processing"，启动轮询任务
4. **进度反馈**: 定期发送进度更新
5. **结果返回**: 当status不再是"processing"时，发送最终结果

### 3. 轮询策略

- **基础轮询**: 每2秒轮询一次
- **指数退避**: 网络错误时使用指数退避策略
- **超时控制**: 最大轮询60次，避免无限等待
- **错误处理**: 连续失败过多时提前退出

### 4. 配置参数

```yaml
manus:
  plan:
    polling:
      enable-polling: true          # 是否启用轮询
      max-attempts: 60              # 最大轮询次数
      poll-interval: 2000           # 轮询间隔（毫秒）
      connect-timeout: 5000         # 连接超时时间
      read-timeout: 10000           # 读取超时时间
      base-backoff-delay: 1000      # 指数退避基础延迟
      max-backoff-delay: 10000      # 最大退避延迟
```

## 使用方式

### 1. 启用配置

在application.yml中引入轮询配置：

```yaml
spring:
  profiles:
    include: polling
```

### 2. 自动生效

轮询功能会自动生效，无需修改现有代码。当检测到计划执行状态为"processing"时，系统会自动启动轮询。

### 3. 进度反馈

轮询过程中会发送以下类型的消息：

```json
{
  "message": "计划执行中... (1/60)",
  "progress": 81,
  "timestamp": 1754312286812,
  "type": "progress"
}
```

### 4. 最终结果

轮询完成后会发送最终结果：

```json
{
  "planId": "plan-1754312286803",
  "status": "completed",
  "result": "...",
  "type": "final",
  "executionTime": 1754312286812
}
```

## 优势

1. **实时反馈**: 用户能看到计划执行的实时进度
2. **状态同步**: 确保返回的是最终执行结果
3. **错误处理**: 完善的异常和超时处理
4. **可配置**: 轮询参数可配置，适应不同场景
5. **资源安全**: 避免无限轮询和资源泄漏
6. **向后兼容**: 不影响现有功能，自动启用

## 注意事项

1. **网络依赖**: 轮询需要调用内部API，确保网络连通性
2. **资源消耗**: 轮询会消耗一定的网络和CPU资源
3. **超时设置**: 根据实际业务需求调整超时参数
4. **错误处理**: 网络异常时会有重试机制，但连续失败会提前退出

## 扩展性

该方案具有良好的扩展性：

1. **支持更多状态**: 可以扩展支持其他执行状态
2. **自定义轮询策略**: 可以实现不同的轮询策略
3. **监控集成**: 可以集成监控系统，记录轮询指标
4. **多租户支持**: 可以为不同租户配置不同的轮询参数 