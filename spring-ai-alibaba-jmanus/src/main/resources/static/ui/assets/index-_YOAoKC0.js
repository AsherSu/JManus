var ut=Object.defineProperty;var dt=(R,s,o)=>s in R?ut(R,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):R[s]=o;var be=(R,s,o)=>dt(R,typeof s!="symbol"?s+"":s,o);import{d as Ce,c as ke,r as x,z as qe,A as Pe,o as Se,a as v,b as p,F as de,g as f,f as B,k as Te,i as K,x as l,t as i,e,n as ee,w as ae,j as ie,B as it,l as _e,s as ce,u as xe,h as ge,y as re,C as Re,T as Me,q as Le,D as Ne,E as pt,G as ht,p as rt,H as vt}from"./index-DzRkMW4B.js";import{I as _}from"./iconify-Dq7NakTV.js";import{s as b,P as Ae,u as ct}from"./sidebar-CF7gySSu.js";import{M as mt,u as gt,a as ft}from"./useMessage-DS9brSWe.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as bt}from"./llm-check-D2idVWhZ.js";import{L as kt}from"./index-CEvZFws8.js";class me{static async getCoordinatorToolConfig(){try{const s=await fetch(`${this.BASE_URL}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`Failed to get coordinator tool config: ${s.status}`);return await s.json()}catch(s){return console.error("获取CoordinatorTool配置失败:",s),{enabled:!0,showPublishButton:!0,success:!1,message:s.message}}}static async getAllEndpoints(){try{const s=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`Failed to get endpoints: ${s.status}`);return await s.json()}catch(s){throw console.error("获取endpoints失败:",s),new Error("获取endpoints失败: "+s.message)}}static async getOrNewCoordinatorToolsByTemplate(s){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",s),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${s}`);try{const o=await fetch(`${this.BASE_URL}/get-or-new-by-template/${s}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",o.status),console.log("[CoordinatorToolApiService] 响应状态文本:",o.statusText),!o.ok){const S=await o.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",S),new Error(`Failed to get coordinator tools: ${o.status} - ${S}`)}const u=await o.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",u),u}catch(o){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",o),new Error("获取协调器工具失败: "+o.message)}}static async createCoordinatorTool(s){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 原始数据:",JSON.stringify(s,null,2)),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const o={id:s.id,toolName:s.toolName,toolDescription:s.toolDescription,inputSchema:s.inputSchema,mcpSchema:s.mcpSchema,planTemplateId:s.planTemplateId,endpoint:s.endpoint,publishStatus:s.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",JSON.stringify(o,null,2));try{const u=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(console.log("[CoordinatorToolApiService] 响应状态:",u.status),console.log("[CoordinatorToolApiService] 响应状态文本:",u.statusText),!u.ok){const m=await u.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",m),new Error(`Failed to create coordinator tool: ${u.status} - ${m}`)}const S=await u.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",S),S}catch(u){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",u),new Error("创建协调器工具失败: "+u.message)}}static async updateCoordinatorTool(s,o){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",s),console.log("[CoordinatorToolApiService] 发送的数据:",o),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${s}`);const u={id:o.id,toolName:o.toolName,toolDescription:o.toolDescription,inputSchema:o.inputSchema,mcpSchema:o.mcpSchema,planTemplateId:o.planTemplateId,endpoint:o.endpoint,publishStatus:o.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",u);try{const S=await fetch(`${this.BASE_URL}/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(console.log("[CoordinatorToolApiService] 响应状态:",S.status),console.log("[CoordinatorToolApiService] 响应状态文本:",S.statusText),!S.ok){const k=await S.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",k),new Error(`Failed to update coordinator tool: ${S.status} - ${k}`)}const m=await S.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",m),m}catch(S){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",S),new Error("更新协调器工具失败: "+S.message)}}static async publishCoordinatorTool(s){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",s),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${s}/publish`);try{const o=await fetch(`${this.BASE_URL}/${s}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",o.status),console.log("[CoordinatorToolApiService] 响应状态文本:",o.statusText),!o.ok){const S=await o.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",S),new Error(`Failed to publish coordinator tool: ${o.status} - ${S}`)}const u=await o.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",u),u}catch(o){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",o),new Error("发布协调器工具失败: "+o.message)}}}be(me,"BASE_URL","/api/coordinator-tools");const _t={class:"modal-form"},$t={class:"form-section"},Pt={class:"form-item endpoint-item"},Ct={class:"endpoint-container"},St={class:"endpoint-row"},yt={class:"custom-select"},wt={class:"select-input-container"},Tt={class:"input-content"},Et={class:"dropdown-header"},It={class:"select-options"},Dt=["onClick"],xt={class:"option-name"},Rt={class:"manual-input-section"},Mt={class:"manual-input-container"},At={key:0,class:"form-item url-item"},Ut={class:"url-container"},Nt=["title"],Lt={class:"url-text"},Vt={class:"form-section"},qt={class:"form-item"},Bt={class:"form-section"},Ft={class:"form-item"},Ot={class:"form-section"},jt={class:"parameters-table"},Wt=["onUpdate:modelValue"],Ht=["onUpdate:modelValue"],Jt={class:"button-container"},zt=["disabled"],Gt=Ce({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(R,{emit:s}){const o=R,u=s,S=ke({get:()=>o.modelValue,set:n=>u("update:modelValue",n)}),m=x(""),k=x(""),A=x(!1),O=x(!1),P=x([]),W=x(""),U=x(""),q=x(!1),g=x("bottom"),I=x(""),T=x(null),Y=x(!1),N=x(!1),C=qe({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),c=ke(()=>T.value&&T.value.id?"更新MCP服务":"创建MCP服务"),E=()=>{C.serviceName="",C.userRequest=o.planDescription||"",C.endpoint="",C.parameters=[],T.value=null,W.value="",U.value=""},Z=async()=>{try{P.value=await me.getAllEndpoints()}catch(n){console.error("加载endpoints失败:",n),te("加载endpoints失败: "+n.message,"error")}},oe=()=>{q.value||d(),q.value=!q.value},d=()=>{const n=document.querySelector(".custom-select");if(!n)return;const t=n.getBoundingClientRect(),a=window.innerHeight;t.bottom+200>a?g.value="top":g.value="bottom"},y=n=>{C.endpoint=n,q.value=!1,I.value=""},j=()=>{if(I.value.trim()){const n=I.value.trim().replace(/[^a-zA-Z0-9_/]/g,"");n&&(C.endpoint=n,P.value.includes(n)||P.value.push(n),q.value=!1,I.value="")}},L=()=>{setTimeout(()=>{I.value.trim()&&j()},200)},D=()=>{P.value.includes(C.endpoint)&&y(C.endpoint)},V=()=>{P.value.includes(C.endpoint)&&y(C.endpoint)},ne=()=>{P.value.includes(C.endpoint)&&y(C.endpoint)},le=async()=>{if(U.value)try{await navigator.clipboard.writeText(U.value),te("URL已复制到剪贴板","success")}catch(n){console.error("复制失败:",n),te("复制失败","error")}},te=(n,t)=>{t==="success"?(k.value=n,setTimeout(()=>{k.value=""},3e3)):t==="error"&&(m.value=n,setTimeout(()=>{m.value=""},5e3))},fe=()=>C.serviceName.trim()?C.userRequest.trim()?C.endpoint.trim()?!0:(te("请输入Endpoint","error"),!1):(te("请输入Tool Description","error"),!1):(te("请输入Tool Name","error"),!1),pe=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",C),console.log("[PublishModal] 当前工具:",T.value),!fe()){console.log("[PublishModal] 表单验证失败");return}O.value=!0;try{if(!T.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const a=await me.getOrNewCoordinatorToolsByTemplate(o.planTemplateId);if(!a.success)throw new Error(a.message);Array.isArray(a.data)?T.value=a.data[0]:T.value=a.data}console.log("[PublishModal] 更新工具信息"),T.value.toolName=C.serviceName.trim(),T.value.toolDescription=C.userRequest.trim(),T.value.endpoint=C.endpoint.trim(),T.value.planTemplateId=o.planTemplateId;const n=C.parameters.filter(a=>a.name.trim()&&a.description.trim()).map(a=>({name:a.name.trim(),description:a.description.trim(),type:"string"}));T.value.inputSchema=JSON.stringify(n),console.log("[PublishModal] 更新后的工具信息:",T.value);let t;T.value.id?(console.log("[PublishModal] 更新现有工具，ID:",T.value.id),t=await me.updateCoordinatorTool(T.value.id,T.value)):(console.log("[PublishModal] 创建新工具"),t=await me.createCoordinatorTool(T.value),T.value=t),console.log("[PublishModal] 保存成功:",t),te("MCP服务保存成功","success"),Y.value=!0}catch(n){console.error("[PublishModal] 保存MCP服务失败:",n),te("保存MCP服务失败: "+n.message,"error")}finally{O.value=!1}},$=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",C),console.log("[PublishModal] 当前工具:",T.value),!fe()){console.log("[PublishModal] 表单验证失败");return}A.value=!0;try{if(!T.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const a=await me.getOrNewCoordinatorToolsByTemplate(o.planTemplateId);if(!a.success)throw new Error(a.message);Array.isArray(a.data)?T.value=a.data[0]:T.value=a.data}console.log("[PublishModal] 更新工具信息"),T.value.toolName=C.serviceName.trim(),T.value.toolDescription=C.userRequest.trim(),T.value.endpoint=C.endpoint.trim(),T.value.planTemplateId=o.planTemplateId;const n=C.parameters.filter(a=>a.name.trim()&&a.description.trim()).map(a=>({name:a.name.trim(),description:a.description.trim(),type:"string"}));if(T.value.inputSchema=JSON.stringify(n),console.log("[PublishModal] 更新后的工具信息:",T.value),T.value.id)console.log("[PublishModal] 更新现有工具，ID:",T.value.id),await me.updateCoordinatorTool(T.value.id,T.value);else{console.log("[PublishModal] 创建新工具");const a=await me.createCoordinatorTool(T.value);T.value=a}console.log("[PublishModal] 步骤5: 发布工具，ID:",T.value.id);const t=await me.publishCoordinatorTool(T.value.id);if(console.log("[PublishModal] 发布结果:",t),t.success){if(console.log("[PublishModal] 发布成功"),W.value=t.publishStatus||"PUBLISHED",t.endpointUrl)U.value=t.endpointUrl;else if(T.value.endpoint){const a=window.location.origin;U.value=`${a}/mcp${T.value.endpoint}`}else U.value="";console.log("[PublishModal] 设置状态 - publishStatus:",W.value,"endpointUrl:",U.value),te("MCP服务发布成功","success"),u("published",T.value)}else throw new Error(t.message)}catch(n){console.error("[PublishModal] 发布MCP服务失败:",n),te("发布MCP服务失败: "+n.message,"error")}finally{A.value=!1}},r=async()=>{if(!A.value){A.value=!0;try{N.value?(console.log("[PublishModal] 取消发布MCP服务"),T.value&&(T.value.publishStatus="UNPUBLISHED",await me.updateCoordinatorTool(T.value.id,T.value),N.value=!1,U.value="",te("MCP服务已取消发布","success"))):(console.log("[PublishModal] 发布MCP服务"),await $(),N.value=!0)}catch(n){console.error("[PublishModal] 发布开关操作失败:",n),te("操作失败: "+n.message,"error")}finally{A.value=!1}}},w=async()=>{S.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),E(),await Z(),await M())},M=async()=>{if(!o.planTemplateId){console.log("[PublishModal] 没有planTemplateId，跳过加载协调器工具数据");return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",o.planTemplateId);const n=await me.getOrNewCoordinatorToolsByTemplate(o.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",n),n.success&&n.data){let t;if(Array.isArray(n.data)?(t=n.data[0],console.log("[PublishModal] 使用已存在的工具:",t)):(t=n.data,console.log("[PublishModal] 使用新创建的工具:",t)),T.value=t,W.value=t.publishStatus||"",N.value=t.publishStatus==="PUBLISHED",Y.value=!0,t.publishStatus==="PUBLISHED")if(n.endpointUrl)U.value=n.endpointUrl;else if(t.endpoint){const a=window.location.origin;U.value=`${a}/mcp${t.endpoint}`}else U.value="";else U.value="";console.log("[PublishModal] 加载工具数据 - publishStatus:",W.value,"endpointUrl:",U.value),C.serviceName=t.toolName||"",C.userRequest=t.toolDescription||o.planDescription||"",C.endpoint=t.endpoint||"";try{if(t.inputSchema){const a=JSON.parse(t.inputSchema);Array.isArray(a)&&(C.parameters=a.map(h=>({name:h.name||"",description:h.description||""})))}}catch(a){console.warn("[PublishModal] 解析inputSchema失败:",a),C.parameters=[]}console.log("[PublishModal] 表单数据已填充:",C)}else console.log("[PublishModal] 获取协调器工具数据失败:",n.message)}catch(n){console.error("[PublishModal] 加载协调器工具数据失败:",n)}};return Pe(()=>o.modelValue,w),Se(async()=>{S.value&&(console.log("[PublishModal] 组件挂载时初始化"),E(),await Z(),await M())}),(n,t)=>(p(),v(de,null,[f(mt,{modelValue:S.value,"onUpdate:modelValue":t[7]||(t[7]=a=>S.value=a),title:c.value,"endpoint-url":U.value,onConfirm:$,class:"wide-modal"},{footer:Te(()=>[e("div",Jt,[e("button",{class:"action-btn primary",onClick:pe,disabled:O.value},[O.value?(p(),ce(l(_),{key:0,icon:"carbon:loading",class:"loading-icon"})):(p(),ce(l(_),{key:1,icon:"carbon:save"})),K(" "+i(O.value?"保存中...":"保存"),1)],8,zt),e("div",{class:ee(["publish-toggle-container",{visible:Y.value,hidden:!Y.value}])},[e("div",{class:"publish-toggle",onClick:r},[e("div",{class:ee(["toggle-track",{"toggle-on":N.value,"toggle-off":!N.value}])},[e("div",{class:ee(["toggle-thumb",{"thumb-on":N.value,"thumb-off":!N.value}])},null,2),e("span",{class:ee(["toggle-label",{"label-on":N.value,"label-off":!N.value}])},i(N.value?n.$t("common.published"):n.$t("common.unpublished")),3)],2)])],2)])]),default:Te(()=>[e("div",_t,[e("div",$t,[e("div",{class:ee(["endpoint-url-row",{"single-item":!N.value}])},[e("div",Pt,[t[11]||(t[11]=e("label",null,[K("Endpoint "),e("span",{class:"required"},"*")],-1)),e("div",Ct,[e("div",St,[e("div",yt,[e("div",wt,[e("div",Tt,[f(l(_),{icon:"carbon:application",width:"16",class:"input-icon"}),ae(e("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>C.endpoint=a),placeholder:"请选择或输入Endpoint",class:"select-input",onFocus:t[1]||(t[1]=a=>q.value=!0),onInput:D,onKeydown:it(V,["enter"]),onBlur:ne},null,544),[[ie,C.endpoint]])]),e("button",{class:"select-arrow-btn",onClick:oe,title:"展开选项"},[f(l(_),{icon:q.value?"carbon:chevron-up":"carbon:chevron-down",width:"14",class:"chevron"},null,8,["icon"])])]),q.value?(p(),v("div",{key:0,class:ee(["select-dropdown",{"dropdown-top":g.value==="top"}])},[e("div",Et,[t[10]||(t[10]=e("span",null,"选择Endpoint",-1)),e("button",{class:"close-btn",onClick:t[2]||(t[2]=a=>q.value=!1)},[f(l(_),{icon:"carbon:close",width:"12"})])]),e("div",It,[(p(!0),v(de,null,_e(P.value,a=>(p(),v("button",{key:a,class:ee(["select-option",{active:C.endpoint===a}]),onClick:h=>y(a)},[e("span",xt,i(a),1),C.endpoint===a?(p(),ce(l(_),{key:0,icon:"carbon:checkmark",width:"14",class:"check-icon"})):B("",!0)],10,Dt))),128))]),e("div",Rt,[e("div",Mt,[ae(e("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=a=>I.value=a),placeholder:"手动输入Endpoint",class:"manual-input",onKeydown:it(j,["enter"]),onBlur:L},null,544),[[ie,I.value]]),e("button",{class:"add-manual-btn",onClick:j},[f(l(_),{icon:"carbon:add",width:"14"})])])])],2)):B("",!0),q.value?(p(),v("div",{key:1,class:"backdrop",onClick:t[4]||(t[4]=a=>q.value=!1)})):B("",!0)])])])]),N.value?(p(),v("div",At,[t[12]||(t[12]=e("label",null,"MCP Streamable URL",-1)),e("div",Ut,[e("div",{class:"url-display",onDblclick:le,title:"双击复制: "+U.value},[e("span",Lt,i(U.value||"请输入Endpoint以生成URL"),1),f(l(_),{icon:"carbon:copy",width:"16",class:"copy-icon"})],40,Nt)])])):B("",!0)],2)]),e("div",Vt,[e("div",qt,[t[13]||(t[13]=e("label",null,[K("Tool Name "),e("span",{class:"required"},"*")],-1)),ae(e("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=a=>C.serviceName=a),placeholder:"请输入Tool Name",required:"",readonly:"",class:"readonly-input"},null,512),[[ie,C.serviceName]])])]),e("div",Bt,[e("div",Ft,[t[14]||(t[14]=e("label",null,[K("Tool Description "),e("span",{class:"required"},"*")],-1)),ae(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=a=>C.userRequest=a),placeholder:"请输入Tool Description",class:"description-field",rows:"3",required:""},null,512),[[ie,C.userRequest]])])]),e("div",Ot,[t[16]||(t[16]=e("div",{class:"section-title"},"参数配置",-1)),e("div",jt,[e("table",null,[t[15]||(t[15]=e("thead",null,[e("tr",null,[e("th",null,"字段名"),e("th",null,"字段描述")])],-1)),e("tbody",null,[(p(!0),v(de,null,_e(C.parameters,(a,h)=>(p(),v("tr",{key:h},[e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":J=>a.name=J,class:"param-input",placeholder:"参数名称"},null,8,Wt),[[ie,a.name]])]),e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":J=>a.description=J,class:"param-input",placeholder:"参数描述"},null,8,Ht),[[ie,a.description]])])]))),128))])])])])])]),_:1},8,["modelValue","title","endpoint-url"]),m.value?(p(),v("div",{key:0,class:"error-toast",onClick:t[8]||(t[8]=a=>m.value="")},[f(l(_),{icon:"carbon:error"}),K(" "+i(m.value),1)])):B("",!0),k.value?(p(),v("div",{key:1,class:"success-toast",onClick:t[9]||(t[9]=a=>k.value="")},[f(l(_),{icon:"carbon:checkmark"}),K(" "+i(k.value),1)])):B("",!0)],64))}}),Kt=ye(Gt,[["__scopeId","data-v-73ac71f5"]]),Xt={class:"sidebar-content"},Qt={class:"sidebar-content-header"},Zt={class:"sidebar-content-title"},Yt={class:"tab-switcher"},en=["disabled"],tn={key:0,class:"tab-content"},nn={class:"new-task-section"},on={class:"sidebar-content-list"},sn={key:0,class:"loading-state"},an={key:1,class:"error-state"},ln={key:2,class:"empty-state"},rn=["onClick"],cn={class:"task-icon"},un={class:"task-details"},dn={class:"task-title"},pn={class:"task-preview"},hn={class:"task-time"},vn={class:"task-actions"},mn=["title","onClick"],gn={key:1,class:"tab-content config-tab"},fn={key:0,class:"config-container"},bn={class:"template-info-header"},kn={class:"template-info"},_n={class:"template-id"},$n={class:"config-section"},Pn={class:"section-header"},Cn={class:"generator-content"},Sn=["placeholder"],yn={class:"generator-actions"},wn=["disabled"],Tn=["disabled"],En={class:"config-section"},In={class:"section-header"},Dn={class:"section-actions"},xn=["disabled","title"],Rn=["disabled","title"],Mn=["disabled"],An=["placeholder"],Un={class:"config-section"},Nn={class:"section-header"},Ln={class:"execution-content"},Vn={class:"params-input-group"},qn={class:"params-help-text"},Bn={class:"params-input-container"},Fn=["placeholder"],On=["title"],jn={class:"api-url-display"},Wn={class:"api-url-label"},Hn={class:"api-url"},Jn={class:"api-url-display"},zn={class:"api-url-label"},Gn=["disabled"],Kn=["disabled"],Xn=Ce({__name:"index",emits:["planExecutionRequested"],setup(R,{expose:s,emit:o}){const{t:u}=xe(),S=["currentPlanId","userRequest","rootPlanId"],m=x({enabled:!0,showPublishButton:!0,success:!0}),k=ke(()=>m.value.enabled&&m.value.showPublishButton),A=async()=>{try{const c=await me.getCoordinatorToolConfig();m.value=c}catch(c){console.error("加载CoordinatorTool配置失败:",c),m.value={enabled:!0,showPublishButton:!0,success:!1,message:c instanceof Error?c.message:"Unknown error"}}},O=ke({get(){try{if(!b.jsonContent)return"";const E={...JSON.parse(b.jsonContent)};return S.forEach(Z=>{delete E[Z]}),JSON.stringify(E,null,2)}catch{return b.jsonContent}},set(c){try{if(!c.trim()){b.jsonContent="";return}const E=JSON.parse(c);let Z={};try{Z=JSON.parse(b.jsonContent||"{}")}catch{}const oe={...E};S.forEach(d=>{Z[d]!==void 0&&(oe[d]=Z[d])}),b.jsonContent=JSON.stringify(oe)}catch{b.jsonContent=c}}}),P=o,W=async()=>{try{const c=await b.saveTemplate();c!=null&&c.duplicate?alert(u("sidebar.saveCompleted",{message:c.message,versionCount:c.versionCount})):c!=null&&c.saved?alert(u("sidebar.saveSuccess",{message:c.message,versionCount:c.versionCount})):c!=null&&c.message&&alert(u("sidebar.saveStatus",{message:c.message}))}catch(c){console.error("Failed to save plan modifications:",c),alert(c.message||u("sidebar.saveFailed"))}},U=async()=>{var c;try{await b.generatePlan(),alert(u("sidebar.generateSuccess",{templateId:((c=b.selectedTemplate)==null?void 0:c.id)??u("sidebar.unknown")}))}catch(E){console.error("Failed to generate plan:",E),alert(u("sidebar.generateFailed")+": "+E.message)}},q=async()=>{try{await b.updatePlan(),alert(u("sidebar.updateSuccess"))}catch(c){console.error("Failed to update plan:",c),alert(u("sidebar.updateFailed")+": "+c.message)}},g=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const c=b.preparePlanExecution();if(!c){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",c),console.log("[Sidebar] Emitting planExecutionRequested event"),P("planExecutionRequested",c),console.log("[Sidebar] Event emitted")}catch(c){console.error("Error executing plan:",c),alert(u("sidebar.executeFailed")+": "+c.message)}finally{b.finishPlanExecution()}},I=x(!1),T=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",b.currentPlanTemplateId),!b.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert("请先选择一个计划模板");return}console.log("[Sidebar] 打开发布MCP服务模态框"),I.value=!0},Y=c=>{console.log("MCP服务发布成功:",c)},N=c=>{if(isNaN(c.getTime()))return console.warn("Invalid date received:",c),u("time.unknown");const Z=new Date().getTime()-c.getTime(),oe=Math.floor(Z/6e4),d=Math.floor(Z/36e5),y=Math.floor(Z/864e5);return oe<1?u("time.now"):oe<60?u("time.minuteAgo",{count:oe}):d<24?u("time.hourAgo",{count:d}):y<30?u("time.dayAgo",{count:y}):c.toLocaleDateString("zh-CN")},C=(c,E)=>!c||c.length<=E?c:c.substring(0,E)+"...";return Se(()=>{b.loadPlanTemplateList(),A()}),s({loadPlanTemplateList:b.loadPlanTemplateList,toggleSidebar:b.toggleSidebar,currentPlanTemplateId:b.currentPlanTemplateId}),(c,E)=>{var Z,oe;return p(),v(de,null,[e("div",{class:ee(["sidebar-wrapper",{"sidebar-wrapper-collapsed":l(b).isCollapsed}])},[e("div",Xt,[e("div",Qt,[e("div",Zt,i(c.$t("sidebar.title")),1)]),e("div",Yt,[e("button",{class:ee(["tab-button",{active:l(b).currentTab==="list"}]),onClick:E[0]||(E[0]=d=>l(b).switchToTab("list"))},[f(l(_),{icon:"carbon:list",width:"16"}),K(" "+i(c.$t("sidebar.templateList")),1)],2),e("button",{class:ee(["tab-button",{active:l(b).currentTab==="config"}]),onClick:E[1]||(E[1]=d=>l(b).switchToTab("config")),disabled:!l(b).selectedTemplate},[f(l(_),{icon:"carbon:settings",width:"16"}),K(" "+i(c.$t("sidebar.configuration")),1)],10,en)]),l(b).currentTab==="list"?(p(),v("div",tn,[e("div",nn,[e("button",{class:"new-task-btn",onClick:E[2]||(E[2]=d=>l(b).createNewTemplate())},[f(l(_),{icon:"carbon:add",width:"16"}),K(" "+i(c.$t("sidebar.newPlan"))+" ",1),E[12]||(E[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",on,[l(b).isLoading?(p(),v("div",sn,[f(l(_),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,i(c.$t("sidebar.loading")),1)])):l(b).errorMessage?(p(),v("div",an,[f(l(_),{icon:"carbon:warning",width:"20"}),e("span",null,i(l(b).errorMessage),1),e("button",{onClick:E[3]||(E[3]=(...d)=>l(b).loadPlanTemplateList&&l(b).loadPlanTemplateList(...d)),class:"retry-btn"},i(c.$t("sidebar.retry")),1)])):l(b).planTemplateList.length===0?(p(),v("div",ln,[f(l(_),{icon:"carbon:document",width:"32"}),e("span",null,i(c.$t("sidebar.noTemplates")),1)])):(p(!0),v(de,{key:3},_e(l(b).sortedTemplates,d=>(p(),v("div",{key:d.id,class:ee(["sidebar-content-list-item",{"sidebar-content-list-item-active":d.id===l(b).currentPlanTemplateId}]),onClick:y=>l(b).selectTemplate(d)},[e("div",cn,[f(l(_),{icon:"carbon:document",width:"20"})]),e("div",un,[e("div",dn,i(d.title||c.$t("sidebar.unnamedPlan")),1),e("div",pn,i(C(d.description||c.$t("sidebar.noDescription"),40)),1)]),e("div",hn,i(N(l(b).parseDateTime(d.updateTime||d.createTime))),1),e("div",vn,[e("button",{class:"delete-task-btn",title:c.$t("sidebar.deleteTemplate"),onClick:ge(y=>l(b).deleteTemplate(d),["stop"])},[f(l(_),{icon:"carbon:close",width:"16"})],8,mn)])],10,rn))),128))])])):l(b).currentTab==="config"?(p(),v("div",gn,[l(b).selectedTemplate?(p(),v("div",fn,[e("div",bn,[e("div",kn,[e("h3",null,i(l(b).selectedTemplate.title||c.$t("sidebar.unnamedPlan")),1),e("span",_n,"ID: "+i(l(b).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:E[4]||(E[4]=d=>l(b).switchToTab("list"))},[f(l(_),{icon:"carbon:arrow-left",width:"16"})])]),e("div",$n,[e("div",Pn,[f(l(_),{icon:"carbon:generate",width:"16"}),e("span",null,i(c.$t("sidebar.planGenerator")),1)]),e("div",Cn,[ae(e("textarea",{"onUpdate:modelValue":E[5]||(E[5]=d=>l(b).generatorPrompt=d),class:"prompt-input",placeholder:c.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Sn),[[ie,l(b).generatorPrompt]]),e("div",yn,[e("button",{class:"btn btn-primary btn-sm",onClick:U,disabled:l(b).isGenerating||!l(b).generatorPrompt.trim()},[f(l(_),{icon:l(b).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ee({spinning:l(b).isGenerating})},null,8,["icon","class"]),K(" "+i(l(b).isGenerating?c.$t("sidebar.generating"):c.$t("sidebar.generatePlan")),1)],8,wn),e("button",{class:"btn btn-secondary btn-sm",onClick:q,disabled:l(b).isGenerating||!l(b).generatorPrompt.trim()||!l(b).jsonContent.trim()},[f(l(_),{icon:"carbon:edit",width:"14"}),K(" "+i(c.$t("sidebar.updatePlan")),1)],8,Tn)])])]),e("div",En,[e("div",In,[f(l(_),{icon:"carbon:code",width:"16"}),e("span",null,i(c.$t("sidebar.jsonTemplate")),1),e("div",Dn,[e("button",{class:"btn btn-sm",onClick:E[6]||(E[6]=(...d)=>l(b).rollbackVersion&&l(b).rollbackVersion(...d)),disabled:!l(b).canRollback,title:c.$t("sidebar.rollback")},[f(l(_),{icon:"carbon:undo",width:"14"})],8,xn),e("button",{class:"btn btn-sm",onClick:E[7]||(E[7]=(...d)=>l(b).restoreVersion&&l(b).restoreVersion(...d)),disabled:!l(b).canRestore,title:c.$t("sidebar.restore")},[f(l(_),{icon:"carbon:redo",width:"14"})],8,Rn),e("button",{class:"btn btn-primary btn-sm",onClick:W,disabled:l(b).isGenerating||l(b).isExecuting},[f(l(_),{icon:"carbon:save",width:"14"})],8,Mn)])]),ae(e("textarea",{"onUpdate:modelValue":E[8]||(E[8]=d=>O.value=d),class:"json-editor",placeholder:c.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,An),[[ie,O.value]])]),e("div",Un,[e("div",Nn,[f(l(_),{icon:"carbon:play",width:"16"}),e("span",null,i(c.$t("sidebar.executionController")),1)]),e("div",Ln,[e("div",Vn,[e("label",null,i(c.$t("sidebar.executionParams")),1),e("div",qn,i(c.$t("sidebar.executionParamsHelp")),1),e("div",Bn,[ae(e("input",{"onUpdate:modelValue":E[9]||(E[9]=d=>l(b).executionParams=d),class:"params-input",placeholder:c.$t("sidebar.executionParamsPlaceholder")},null,8,Fn),[[ie,l(b).executionParams]]),e("button",{class:"clear-params-btn",onClick:E[10]||(E[10]=(...d)=>l(b).clearExecutionParams&&l(b).clearExecutionParams(...d)),title:c.$t("sidebar.clearParams")},[f(l(_),{icon:"carbon:close",width:"12"})],8,On)])]),e("div",jn,[e("span",Wn,i(c.$t("sidebar.apiUrl"))+":",1),e("code",Hn,i(l(b).computedApiUrl),1)]),e("div",Jn,[e("span",zn,i(c.$t("sidebar.statusApiUrl"))+":",1),E[13]||(E[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:g,disabled:l(b).isExecuting||l(b).isGenerating},[f(l(_),{icon:l(b).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ee({spinning:l(b).isExecuting})},null,8,["icon","class"]),K(" "+i(l(b).isExecuting?c.$t("sidebar.executing"):c.$t("sidebar.executePlan")),1)],8,Gn),k.value?(p(),v("button",{key:0,class:"btn publish-mcp-btn",onClick:T,disabled:!l(b).currentPlanTemplateId},[f(l(_),{icon:"carbon:application",width:"16"}),E[14]||(E[14]=K(" 发布MCP服务 ",-1))],8,Kn)):B("",!0)])])])):B("",!0)])):B("",!0)])],2),f(Kt,{modelValue:I.value,"onUpdate:modelValue":E[11]||(E[11]=d=>I.value=d),"plan-template-id":l(b).currentPlanTemplateId||"","plan-title":((Z=l(b).selectedTemplate)==null?void 0:Z.title)||"","plan-description":((oe=l(b).selectedTemplate)==null?void 0:oe.description)||"",onPublished:Y},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),Qn=ye(Xn,[["__scopeId","data-v-caf5e532"]]);class Be{static async sendMessage(s){return bt.withLlmCheck(async()=>{const o=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s})});if(!o.ok)throw new Error(`API request failed: ${o.status}`);return await o.json()})}}be(Be,"BASE_URL","/api/executor");class Fe{static async getDetails(s){try{const o=await fetch(`${this.BASE_URL}/details/${s}`);if(o.status===404)return null;if(!o.ok){const m=await o.text();throw new Error(`Failed to get detailed information: ${o.status} - ${m}`)}const u=await o.text(),S=JSON.parse(u);return S&&typeof S=="object"&&!S.currentPlanId&&(S.currentPlanId=s),S}catch(o){return console.error("[CommonApiService] Failed to get plan details:",o),{currentPlanId:s,status:"failed",message:o instanceof Error?o.message:"Failed to save, please retry"}}}static async submitFormInput(s,o){const u=await fetch(`${this.BASE_URL}/submit-input/${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!u.ok){let m;try{m=await u.json()}catch{m={message:`Failed to submit form input: ${u.status}`}}throw new Error(m.message||`Failed to submit form input: ${u.status}`)}const S=u.headers.get("content-type");return S&&S.indexOf("application/json")!==-1?await u.json():{success:!0}}static async getAllPrompts(){try{const s=await fetch(this.BASE_URL);return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to get Prompt list:",s),s}}static async handleResponse(s){if(!s.ok)try{const o=await s.json();throw new Error(o.message||`API request failed: ${s.status}`)}catch{throw new Error(`API request failed: ${s.status} ${s.statusText}`)}return s}}be(Fe,"BASE_URL","/api/executor");const we=class we{constructor(){be(this,"POLL_INTERVAL",5e3);be(this,"state",qe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));be(this,"callbacks",{});be(this,"planExecutionCache",new Map);be(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(s){return this.planExecutionCache.get(s)}getCachedUIState(s){return this.uiStateCache.get(s)}setCachedUIState(s,o){this.uiStateCache.set(s,o),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${s}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(s){return this.planExecutionCache.has(s)}setCachedPlanRecord(s,o){this.planExecutionCache.set(s,o),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s}`)}clearCachedPlanRecord(s){const o=this.planExecutionCache.delete(s);return o&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${s}`),o}clearAllCachedRecords(){const s=this.planExecutionCache.size,o=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${s}, UI States: ${o}`)}static getInstance(){return we.instance||(we.instance=new we),we.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(s){this.callbacks={...this.callbacks,...s},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(s))}async handleUserMessageSendRequested(s){if(this.validateAndPrepareUIForNewRequest(s))try{if(await this.sendUserMessageAndSetPlanId(s),this.state.activePlanId)this.initiatePlanExecutionSequence(s,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(o){console.error("[PlanExecutionManager] Failed to send user message:",o);const u=this.state.activePlanId??"error";this.setCachedUIState(u,{enabled:!0}),this.emitChatInputUpdateState(u),this.state.activePlanId=null}}handlePlanExecutionRequested(s,o){console.log("[PlanExecutionManager] Received plan execution request:",{planId:s,query:o}),s?(this.state.activePlanId=s,this.initiatePlanExecutionSequence(o??"执行计划",s)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(s,o){const u=this.getCachedPlanRecord(s);return u!=null&&u.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${s}`),this.handlePlanExecutionRequested(u.currentPlanId,o),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${s}`),!1)}validateAndPrepareUIForNewRequest(s){if(!s)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const o=this.state.activePlanId??"ui-state";return this.setCachedUIState(o,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(o),!0}async sendUserMessageAndSetPlanId(s){try{const o=await Be.sendMessage(s);if(o!=null&&o.planId)return this.state.activePlanId=o.planId,o;if(o!=null&&o.planTemplateId)return this.state.activePlanId=o.planTemplateId,{...o,planId:o.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",o),new Error("Failed to get valid planId from API response")}catch(o){throw console.error("[PlanExecutionManager] API call failed:",o),o}}initiatePlanExecutionSequence(s,o){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${s}", planId: ${o}`);const u=o;this.emitDialogRoundStart(u),this.startPolling()}handlePlanCompletion(s){this.emitPlanCompleted(s.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Ae.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}},5e3)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}s.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(s.rootPlanId??""))}handlePlanError(s){this.emitPlanError(s.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Ae.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}},5e3)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const s=await this.getPlanDetails(this.state.activePlanId);if(!s){console.warn("[PlanExecutionManager] No details received from API");return}if(s.status&&s.status==="failed"){this.handlePlanError(s);return}if(s.rootPlanId&&this.setCachedPlanRecord(s.rootPlanId,s),!s.steps||s.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(s.rootPlanId??""),this.handlePlanCompletion(s);return}this.emitPlanUpdate(s.rootPlanId??""),s.completed&&this.handlePlanCompletion(s)}catch(s){console.error("[PlanExecutionManager] Failed to poll plan status:",s)}finally{this.state.isPolling=!1}}}async getPlanDetails(s){try{const o=await Fe.getDetails(s);return o!=null&&o.rootPlanId&&(this.planExecutionCache.set(o.rootPlanId,o),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${o.rootPlanId}`)),o}catch(o){return console.error("[PlanExecutionManager] Failed to get plan details:",o),{currentPlanId:s,status:"failed",message:o instanceof Error?o.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(s){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(s)}emitDialogRoundStart(s){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(s)}emitPlanUpdate(s){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(s)}emitPlanCompleted(s){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(s)}emitPlanError(s){this.callbacks.onPlanError&&this.callbacks.onPlanError(s)}};be(we,"instance",null);let Ve=we;const ue=Ve.getInstance(),Zn={class:"right-panel"},Yn={class:"preview-header"},eo={class:"preview-tabs"},to={class:"tab-button active"},no={class:"preview-content"},oo={class:"step-details"},so={key:0,class:"step-info-fixed"},ao={key:0,class:"agent-info"},lo={class:"info-item"},io={class:"label"},ro={class:"value"},co={class:"info-item"},uo={class:"label"},po={class:"value"},ho={class:"info-item"},vo={class:"label"},mo={class:"value"},go={class:"info-item"},fo={class:"label"},bo={class:"value"},ko={class:"info-item"},_o={class:"label"},$o={class:"execution-status"},Po={class:"status-item"},Co={class:"status-text"},So={key:0},yo={key:0,class:"think-act-steps"},wo={class:"steps-container"},To={class:"step-header"},Eo={class:"step-number"},Io={class:"think-section"},Do={class:"think-content"},xo={class:"input"},Ro={class:"label"},Mo={class:"output"},Ao={class:"label"},Uo={key:0,class:"action-section"},No={class:"action-content"},Lo={class:"tool-info"},Vo={class:"label"},qo={class:"value"},Bo={class:"input"},Fo={class:"label"},Oo={class:"output"},jo={class:"label"},Wo={key:0,class:"sub-plan-section"},Ho={class:"sub-plan-content"},Jo={class:"sub-plan-header"},zo={class:"sub-plan-info"},Go={class:"value"},Ko={key:0,class:"sub-plan-info"},Xo={class:"value"},Qo={class:"sub-plan-status"},Zo={class:"status-text"},Yo={key:0,class:"no-steps-message"},es={key:1,class:"no-execution-message"},ts={class:"step-basic-info"},ns={class:"info-item"},os={class:"label"},ss={class:"value"},as={key:0,class:"info-item"},ls={class:"value"},is={class:"info-item"},rs={class:"no-execution-hint"},cs={key:2,class:"execution-indicator"},us={class:"execution-text"},ds={key:1,class:"no-selection"},ps=["title"],hs=Ce({__name:"index",setup(R,{expose:s}){const{t:o}=xe(),u=x(),S=x(),m=x(),k=x(null),A=x(!1),O=x(!0),P=x(!0),W=ke(()=>m.value?m.value.completed?o("rightPanel.status.completed"):m.value.current?o("rightPanel.status.executing"):o("rightPanel.status.waiting"):""),U=d=>{var j;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${d}`),m.value&&k.value){const L=k.value.rootPlanId??S.value;if(L&&L!==d){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${L}, Requested: ${d}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${d}`);const y=ue.getCachedPlanRecord(d);if(!y){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${d}`);return}if(y.steps&&y.steps.length>0){const L=y.steps.length,D=(y.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${D} / ${L}`)}if(m.value&&S.value&&(S.value===d||((j=k.value)==null?void 0:j.rootPlanId)===d)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${d}`),k.value)){const D=k.value,V=g(D.planId,D.rootPlanId,D.subPlanId);V?(I(V,D.stepIndex,D.planId,D.isSubPlan),c()):console.warn("[RightPanel] Could not find plan record for refresh:",D)}},q=(d,y,j,L,D)=>{console.log("[RightPanel] Step selected:",{planId:d,stepIndex:y,rootPlanId:j,subPlanId:L,subStepIndex:D});const V=!!(j&&L&&D!==void 0);k.value={planId:d,stepIndex:y,isSubPlan:V,...V&&{rootPlanId:j,subPlanId:L,subStepIndex:D}};const ne=g(d,j,L);if(!ne){console.warn("[RightPanel] Plan data not found:",{planId:d,rootPlanId:j,subPlanId:L}),m.value=null,k.value=null;return}I(ne,y,d,V)},g=(d,y,j)=>{var V;if(!y||!j)return ue.getCachedPlanRecord(d)??null;const L=ue.getCachedPlanRecord(d);if(L)return L;const D=ue.getCachedPlanRecord(y);if(!(D!=null&&D.agentExecutionSequence))return null;for(const ne of D.agentExecutionSequence)if(ne.thinkActSteps){for(const le of ne.thinkActSteps)if(((V=le.subPlanExecutionRecord)==null?void 0:V.currentPlanId)===j)return le.subPlanExecutionRecord}return null},I=(d,y,j,L)=>{var fe,pe,$,r,w;if(!d.steps||y>=d.steps.length){m.value=null,k.value=null,console.warn("[RightPanel] Invalid step data:",{planId:j,stepIndex:y,hasSteps:!!d.steps,stepsLength:(fe=d.steps)==null?void 0:fe.length,message:"Invalid step index"});return}S.value=j;const D=d.steps[y],V=(pe=d.agentExecutionSequence)==null?void 0:pe[y];console.log("[RightPanel] Step data details:",{planId:j,stepIndex:y,step:D,hasAgentExecutionSequence:!!d.agentExecutionSequence,agentExecutionSequenceLength:($=d.agentExecutionSequence)==null?void 0:$.length,agentExecution:V,hasThinkActSteps:!!(V!=null&&V.thinkActSteps),thinkActStepsLength:(r=V==null?void 0:V.thinkActSteps)==null?void 0:r.length,isSubPlan:L});const ne=(V==null?void 0:V.status)==="FINISHED",le=!ne&&y===d.currentStepIndex&&!d.completed,te={planId:j,index:y,title:typeof D=="string"?D:D.title||D.description||D.name||`${L?"子":""}步骤 ${y+1}`,description:typeof D=="string"?D:D.description||D,completed:ne,current:le};V&&(te.agentExecution=V),m.value=te,console.log("[RightPanel] Step details updated:",{planId:j,stepIndex:y,stepTitle:m.value.title,hasAgentExecution:!!V,hasThinkActSteps:(((w=V==null?void 0:V.thinkActSteps)==null?void 0:w.length)??0)>0,completed:ne,current:le,planCurrentStep:d.currentStepIndex,planCompleted:d.completed,isSubPlan:L}),V!=null&&V.thinkActSteps&&V.thinkActSteps.forEach((M,n)=>{M.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${n}:`,M.subPlanExecutionRecord)}),setTimeout(()=>{N()},100),c()},T=(d,y,j,L)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:d,subPlanId:y,stepIndex:j,subStepIndex:L}),q(y,L,d,y,L)},Y=d=>{u.value=d??void 0},N=()=>{if(!u.value)return;const{scrollTop:d,scrollHeight:y,clientHeight:j}=u.value,L=y-d-j<50,D=y>j;O.value=L,A.value=D&&!L,L?P.value=!0:y-d-j>100&&(P.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:d,scrollHeight:y,clientHeight:j,isAtBottom:L,hasScrollableContent:D,showButton:A.value,shouldAutoScroll:P.value})},C=()=>{u.value&&(u.value.scrollTo({top:u.value.scrollHeight,behavior:"smooth"}),re(()=>{P.value=!0,N()}))},c=()=>{!P.value||!u.value||re(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},E=d=>{if(d===null||typeof d>"u"||d==="")return"N/A";try{const y=typeof d=="object"?d:JSON.parse(d);return JSON.stringify(y,null,2)}catch{return String(d)}},Z=()=>{m.value=null,S.value=void 0,P.value=!0,u.value&&u.value.removeEventListener("scroll",N)},oe=()=>{const d=()=>{const y=u.value;return y?(Y(y),y.addEventListener("scroll",N),P.value=!0,N(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};re(()=>{d()||setTimeout(()=>{d()},100)})};return Se(()=>{console.log("[RightPanel] Component mounted"),re(()=>{oe()})}),Re(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),k.value=null,Z()}),s({updateDisplayedPlanProgress:U,handleStepSelected:q,handleSubPlanStepSelected:T}),(d,y)=>{var j,L;return p(),v("div",Zn,[e("div",Yn,[e("div",eo,[e("button",to,[f(l(_),{icon:"carbon:events"}),K(" "+i(l(o)("rightPanel.stepExecutionDetails")),1)])])]),e("div",no,[e("div",oo,[m.value?(p(),v("div",so,[e("h3",null,i(m.value.title||m.value.description||l(o)("rightPanel.defaultStepTitle",{number:m.value.index+1})),1),m.value.agentExecution?(p(),v("div",ao,[e("div",lo,[e("span",io,i(l(o)("rightPanel.executingAgent"))+":",1),e("span",ro,i(m.value.agentExecution.agentName),1)]),e("div",co,[e("span",uo,i(l(o)("rightPanel.description"))+":",1),e("span",po,i(m.value.agentExecution.agentDescription||""),1)]),e("div",ho,[e("span",vo,i(l(o)("rightPanel.callingModel"))+":",1),e("span",mo,i(m.value.agentExecution.modelName),1)]),e("div",go,[e("span",fo,i(l(o)("rightPanel.request"))+":",1),e("span",bo,i(m.value.agentExecution.agentRequest||""),1)]),e("div",ko,[e("span",_o,i(l(o)("rightPanel.executionResult"))+":",1),e("span",{class:ee(["value",{success:m.value.agentExecution.status==="FINISHED"}])},i(m.value.agentExecution.status||l(o)("rightPanel.executing")),3)])])):B("",!0),e("div",$o,[e("div",Po,[m.value.completed?(p(),ce(l(_),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):m.value.current?(p(),ce(l(_),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(p(),ce(l(_),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Co,i(W.value),1)])])])):B("",!0),e("div",{ref_key:"scrollContainer",ref:u,class:"step-details-scroll-container",onScroll:N},[m.value?(p(),v("div",So,[(j=m.value.agentExecution)!=null&&j.thinkActSteps&&m.value.agentExecution.thinkActSteps.length>0?(p(),v("div",yo,[e("h4",null,i(l(o)("rightPanel.thinkAndActionSteps")),1),e("div",wo,[(p(!0),v(de,null,_e(m.value.agentExecution.thinkActSteps,(D,V)=>(p(),v("div",{key:V,class:"think-act-step"},[e("div",To,[e("span",Eo,"#"+i(V+1),1),e("span",{class:ee(["step-status",D.status])},i(D.status||l(o)("rightPanel.executing")),3)]),e("div",Io,[e("h5",null,[f(l(_),{icon:"carbon:thinking"}),K(" "+i(l(o)("rightPanel.thinking")),1)]),e("div",Do,[e("div",xo,[e("span",Ro,i(l(o)("rightPanel.input"))+":",1),e("pre",null,i(E(D.thinkInput)),1)]),e("div",Mo,[e("span",Ao,i(l(o)("rightPanel.output"))+":",1),e("pre",null,i(E(D.thinkOutput)),1)])])]),D.actionNeeded?(p(),v("div",Uo,[e("h5",null,[f(l(_),{icon:"carbon:play"}),K(" "+i(l(o)("rightPanel.action")),1)]),e("div",No,[(p(!0),v(de,null,_e(D.actToolInfoList,(ne,le)=>(p(),v("div",{key:le},[e("div",Lo,[e("span",Vo,i(l(o)("rightPanel.tool"))+":",1),e("span",qo,i(ne.name||""),1)]),e("div",Bo,[e("span",Fo,i(l(o)("rightPanel.toolParameters"))+":",1),e("pre",null,i(E(ne.parameters)),1)]),e("div",Oo,[e("span",jo,i(l(o)("rightPanel.executionResult"))+":",1),e("pre",null,i(E(ne.result)),1)])]))),128))]),D.subPlanExecutionRecord?(p(),v("div",Wo,[e("h5",null,[f(l(_),{icon:"carbon:tree-view"}),K(" "+i(l(o)("rightPanel.subPlan")),1)]),e("div",Ho,[e("div",Jo,[e("div",zo,[y[0]||(y[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",Go,i(D.subPlanExecutionRecord.currentPlanId),1)]),D.subPlanExecutionRecord.title?(p(),v("div",Ko,[y[1]||(y[1]=e("span",{class:"label"},"标题:",-1)),e("span",Xo,i(D.subPlanExecutionRecord.title),1)])):B("",!0),e("div",Qo,[D.subPlanExecutionRecord.completed?(p(),ce(l(_),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(p(),ce(l(_),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",Zo,i(D.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):B("",!0)])):B("",!0)]))),128))]),m.value.agentExecution&&!((L=m.value.agentExecution.thinkActSteps)!=null&&L.length)?(p(),v("div",Yo,[e("p",null,i(l(o)("rightPanel.noStepDetails")),1)])):m.value.agentExecution?B("",!0):(p(),v("div",es,[f(l(_),{icon:"carbon:information",class:"info-icon"}),e("h4",null,i(l(o)("rightPanel.stepInfo")),1),e("div",ts,[e("div",ns,[e("span",os,i(l(o)("rightPanel.stepName"))+":",1),e("span",ss,i(m.value.title||m.value.description||`步骤 ${m.value.index+1}`),1)]),m.value.description?(p(),v("div",as,[y[2]||(y[2]=e("span",{class:"label"},"描述:",-1)),e("span",ls,i(m.value.description),1)])):B("",!0),e("div",is,[y[3]||(y[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ee(["value",{"status-completed":m.value.completed,"status-current":m.value.current,"status-pending":!m.value.completed&&!m.value.current}])},i(m.value.completed?"已完成":m.value.current?"执行中":"待执行"),3)])]),e("p",rs,i(l(o)("rightPanel.noExecutionInfo")),1)])),m.value.current&&!m.value.completed?(p(),v("div",cs,[y[4]||(y[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",us,[f(l(_),{icon:"carbon:in-progress",class:"rotating-icon"}),K(" "+i(l(o)("rightPanel.stepExecuting")),1)])])):B("",!0)])):(p(),v("div",ds,[f(l(_),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,i(l(o)("rightPanel.noStepSelected")),1),e("p",null,i(l(o)("rightPanel.selectStepHint")),1)]))])):B("",!0),f(Me,{name:"scroll-button"},{default:Te(()=>[A.value?(p(),v("button",{key:0,onClick:C,class:"scroll-to-bottom-btn",title:l(o)("rightPanel.scrollToBottom")},[f(l(_),{icon:"carbon:chevron-down"})],8,ps)):B("",!0)]),_:1})],544)])])])}}}),vs=ye(hs,[["__scopeId","data-v-e90596ce"]]);function ms(){const R=ue,s=ke(()=>R.getActivePlanId()),o=ke(()=>R.getState()),u=ke(()=>o.value.isPolling),S=ke(()=>!!s.value),m=(P,W)=>{R.initiatePlanExecutionSequence(P,W)},k=()=>{R.stopPolling()},A=()=>{R.startPolling()},O=()=>{R.cleanup()};return Re(()=>{O()}),{activePlanId:s,state:o,isPolling:u,hasActivePlan:S,startExecution:m,stopPolling:k,startPolling:A,cleanup:O}}const gs={class:"chat-container"},fs={class:"message-content"},bs={key:0,class:"user-message"},ks={key:1,class:"assistant-message"},_s={key:0,class:"thinking-section"},$s={class:"thinking-header"},Ps={class:"thinking-avatar"},Cs={class:"thinking-label"},Ss={class:"thinking-content"},ys={key:0,class:"thinking"},ws={key:1,class:"progress"},Ts={class:"progress-bar"},Es={class:"progress-text"},Is={key:2,class:"steps-container"},Ds={class:"steps-title"},xs=["onClick"],Rs={class:"section-header"},Ms={class:"step-icon"},As={class:"step-title"},Us={key:0,class:"step-status current"},Ns={key:1,class:"step-status completed"},Ls={key:2,class:"step-status pending"},Vs={key:0,class:"action-info"},qs={class:"action-description"},Bs={class:"action-icon"},Fs={key:0,class:"tool-params"},Os={class:"param-label"},js={class:"param-content"},Ws={key:1,class:"think-details"},Hs={class:"think-header"},Js={class:"think-label"},zs={class:"think-output"},Gs={class:"think-content"},Ks={key:1,class:"sub-plan-steps"},Xs={class:"sub-plan-header"},Qs={class:"sub-plan-step-list"},Zs=["onClick"],Ys={class:"sub-step-indicator"},ea={class:"sub-step-icon"},ta={class:"sub-step-number"},na={class:"sub-step-content"},oa={class:"sub-step-title"},sa={key:2,class:"user-input-form-container"},aa={class:"user-input-message"},la={key:0,class:"form-description"},ia=["onSubmit"],ra=["for"],ca=["id","name","onUpdate:modelValue"],ua={key:1,class:"form-group"},da={for:"form-input-genericInput"},pa=["onUpdate:modelValue"],ha={type:"submit",class:"submit-user-input-btn"},va={key:3,class:"default-processing"},ma={class:"processing-indicator"},ga={class:"response-section"},fa={class:"response-header"},ba={class:"response-avatar"},ka={class:"response-name"},_a={class:"response-content"},$a={key:0,class:"final-response"},Pa=["innerHTML"],Ca={key:1,class:"response-placeholder"},Sa={class:"typing-indicator"},ya={class:"typing-text"},wa={key:0,class:"message assistant"},Ta={class:"message-content"},Ea={class:"assistant-message"},Ia={class:"thinking-section"},Da={class:"thinking-header"},xa={class:"thinking-avatar"},Ra={class:"thinking-label"},Ma={class:"thinking-content"},Aa={class:"default-processing"},Ua={class:"processing-indicator"},Na={class:"response-section"},La={class:"response-header"},Va={class:"response-avatar"},qa={class:"response-name"},Ba={class:"response-content"},Fa={class:"response-placeholder"},Oa={class:"typing-indicator"},ja={class:"typing-text"},Wa=["title"],Ha=Ce({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(R,{expose:s,emit:o}){const u=R,S=o,{t:m}=xe(),k=ms(),A=x(),O=x(!1),P=x([]),W=x(),U=x(!1),q=qe({}),g=(n,t,a)=>{const h={id:Date.now().toString(),type:n,content:t,timestamp:new Date,...a};return n==="assistant"&&!h.thinking&&!h.content&&(h.thinking=m("chat.thinking")),P.value.push(h),h},I=n=>{const t=P.value[P.value.length-1];t.type==="assistant"&&Object.assign(t,n)},T=async n=>{try{O.value=!0;const t=g("assistant","",{thinking:"正在理解您的请求并准备回复..."}),a=await Be.sendMessage(n);if(a.planId)console.log("[ChatComponent] Received planId from direct execution:",a.planId),t.planExecution||(t.planExecution={}),t.planExecution.currentPlanId=a.planId,ue.handlePlanExecutionRequested(a.planId,n),delete t.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete t.thinking;const h=Y(a,n);t.content=h}}catch(t){console.error("Direct mode error:",t),I({content:N(t)})}finally{O.value=!1}},Y=(n,t)=>n.result??n.message??n.content??"",N=n=>{const t=(n==null?void 0:n.message)??(n==null?void 0:n.toString())??"未知错误";return t.includes("网络")||t.includes("network")||t.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":t.includes("认证")||t.includes("权限")||t.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":t.includes("格式")||t.includes("参数")||t.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${t}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},C=(n=!1)=>{re(()=>{if(A.value){const t=A.value;(n||t.scrollHeight-t.scrollTop-t.clientHeight<150)&&t.scrollTo({top:t.scrollHeight,behavior:n?"auto":"smooth"})}})},c=()=>{C(!0),U.value=!1},E=()=>{if(A.value){const n=A.value,t=n.scrollHeight-n.scrollTop-n.clientHeight<150;U.value=!t&&P.value.length>0}},Z=()=>{A.value&&A.value.addEventListener("scroll",E)},oe=()=>{A.value&&A.value.removeEventListener("scroll",E)},d=n=>{g("user",n),u.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",n):T(n)},y=(n,t)=>{var J;const a=((J=n.planExecution)==null?void 0:J.agentExecutionSequence)??[];return t<0||t>=a.length?"IDLE":a[t].status??"IDLE"},j=(n,t)=>{var a,h;if(!((a=n.planExecution)!=null&&a.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:n.planExecution.currentPlanId,stepIndex:t,stepTitle:(h=n.planExecution.steps)==null?void 0:h[t]}),S("step-selected",n.planExecution.currentPlanId,t)},L=(n,t)=>{var a;try{const h=(a=n.planExecution)==null?void 0:a.agentExecutionSequence;if(!(h!=null&&h.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const J=h[t];if(!J)return console.log(`[ChatComponent] No agentExecution found for step ${t}`),[];if(!J.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${t}`),[];for(const H of J.thinkActSteps)if(H.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${t}:`,H.subPlanExecutionRecord),(H.subPlanExecutionRecord.steps??[]).map(z=>typeof z=="string"?z:typeof z=="object"&&z!==null&&(z.title||z.description)||"子步骤");return[]}catch(h){return console.warn("[ChatComponent] Error getting sub-plan steps:",h),[]}},D=(n,t,a)=>{var h;try{const J=(h=n.planExecution)==null?void 0:h.agentExecutionSequence;if(!(J!=null&&J.length))return"pending";const H=J[t];if(!H||!H.thinkActSteps)return"pending";let se=null;for(const G of H.thinkActSteps)if(G.subPlanExecutionRecord){se=G.subPlanExecutionRecord;break}if(!se)return"pending";const z=se.currentStepIndex;return se.completed?"completed":z==null?a===0?"current":"pending":a<z?"completed":a===z?"current":"pending"}catch(J){return console.warn("[ChatComponent] Error getting sub-plan step status:",J),"pending"}},V=(n,t,a)=>{var h,J;try{const H=(h=n.planExecution)==null?void 0:h.agentExecutionSequence;if(!(H!=null&&H.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const se=H[t];if(!se){console.warn("[ChatComponent] No agentExecution found for step",t);return}if(!se.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",t);return}let z=null;for(const G of se.thinkActSteps)if(G.subPlanExecutionRecord){z=G.subPlanExecutionRecord;break}if(!(z!=null&&z.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}S("sub-plan-step-selected",((J=n.planExecution)==null?void 0:J.currentPlanId)??"",z.currentPlanId,t,a)}catch(H){console.error("[ChatComponent] Error handling sub-plan step click:",H)}},ne=(n,t)=>{var h,J,H,se;if(!((h=n.planExecution)!=null&&h.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",n.planExecution.steps.length,"execution sequence:",((J=t.agentExecutionSequence)==null?void 0:J.length)??0);const a=new Array(n.planExecution.steps.length).fill(null);if((H=t.agentExecutionSequence)!=null&&H.length){const z=Math.min(t.agentExecutionSequence.length,n.planExecution.steps.length);for(let G=0;G<z;G++){const F=t.agentExecutionSequence[G];if((se=F.thinkActSteps)!=null&&se.length){const X=F.thinkActSteps[F.thinkActSteps.length-1];X.actionDescription&&X.toolParameters?(a[G]={actionDescription:X.actionDescription,toolParameters:typeof X.toolParameters=="string"?X.toolParameters:JSON.stringify(X.toolParameters,null,2),thinkInput:X.thinkInput??"",thinkOutput:X.thinkOutput??"",status:t.currentStepIndex!==void 0&&G<t.currentStepIndex?"completed":t.currentStepIndex!==void 0&&G===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${G} action set: ${a[G].actionDescription}`)):(a[G]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:X.thinkInput??"",thinkOutput:X.thinkOutput??"",status:t.currentStepIndex!==void 0&&G===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${G} is thinking`))}else a[G]={actionDescription:t.currentStepIndex!==void 0&&G<t.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:t.currentStepIndex!==void 0&&G<t.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${G} 无执行细节, 状态设为: ${a[G].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");n.stepActions=[...a],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(a.map(z=>z==null?void 0:z.actionDescription))),re(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},le=n=>{console.log("[ChatComponent] Starting dialog round with planId:",n),n&&(P.value.findIndex(a=>{var h;return((h=a.planExecution)==null?void 0:h.currentPlanId)===n&&a.type==="assistant"})===-1?(g("assistant","",{planExecution:{currentPlanId:n},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",n)):console.log("[ChatComponent] Found existing assistant message for planId:",n))},te=n=>{var H,se,z,G;console.log("[ChatComponent] Processing plan update with rootPlanId:",n);const t=ue.getCachedPlanRecord(n);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",n);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",t),console.log("[ChatComponent] Plan steps:",t.steps),console.log("[ChatComponent] Plan completed:",t.completed),!t.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const a=P.value.findIndex(F=>{var X;return((X=F.planExecution)==null?void 0:X.currentPlanId)===t.currentPlanId&&F.type==="assistant"});let h;if(a!==-1)h=P.value[a],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",t.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",t.currentPlanId),console.log("[ChatComponent] Current messages:",P.value.map(X=>{var he;return{type:X.type,planId:(he=X.planExecution)==null?void 0:he.currentPlanId,content:X.content.substring(0,50)}}));let F=-1;for(let X=P.value.length-1;X>=0;X--)if(P.value[X].type==="assistant"){F=X;break}if(F!==-1)h=P.value[F],h.planExecution||(h.planExecution={}),h.planExecution.currentPlanId=t.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",t.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(h.planExecution||(h.planExecution={}),h.planExecution=JSON.parse(JSON.stringify(t)),!t.steps||t.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),t.completed){delete h.thinking;const F=t.summary??t.result??t.message??"处理完成";h.content=fe(F),console.log("[ChatComponent] Set simple response content:",h.content)}else t.title&&(h.thinking=`正在执行: ${t.title}`);return}delete h.thinking;const J=t.steps.map(F=>typeof F=="string"?F:typeof F=="object"&&F!==null&&(F.title||F.description)||"步骤");if(h.planExecution&&(h.planExecution.steps=J),t.agentExecutionSequence&&t.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",t.agentExecutionSequence.length),ne(h,t);const F=t.currentStepIndex??0;if(F>=0&&F<t.agentExecutionSequence.length){const he=t.agentExecutionSequence[F].thinkActSteps;if(he&&he.length>0){const Ee=he[he.length-1];if(Ee.thinkOutput){const Ue=Ee.thinkOutput.length>150?Ee.thinkOutput.substring(0,150)+"...":Ee.thinkOutput;h.thinking=`正在思考: ${Ue}`}}}}else if(h.planExecution){const F=h.planExecution.currentStepIndex??0,X=(H=h.planExecution.steps)==null?void 0:H[F],he=typeof X=="string"?X:"";h.thinking=`正在执行: ${he}`}if(t.userInputWaitState&&h.planExecution?(console.log("[ChatComponent] 需要用户输入:",t.userInputWaitState),h.planExecution.userInputWaitState||(h.planExecution.userInputWaitState={}),h.planExecution.userInputWaitState={message:t.userInputWaitState.message??"",formDescription:t.userInputWaitState.formDescription??"",formInputs:((se=t.userInputWaitState.formInputs)==null?void 0:se.map(F=>({label:F.label,value:F.value||""})))??[]},q[z=h.id]??(q[z]={}),h.thinking="等待用户输入..."):(G=h.planExecution)!=null&&G.userInputWaitState&&delete h.planExecution.userInputWaitState,t.completed??t.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete h.thinking;let F="";t.summary?F=t.summary:t.result?F=t.result:F="任务已完成",h.content=pe(F),console.log("[ChatComponent] Updated completed message:",h.content)}re(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},fe=n=>n?n.includes("我")||n.includes("您")||n.includes("您好")||n.includes("可以")?n:n.length<10?`${n}！还有什么需要我帮助的吗？`:n.length<50?`好的，${n}。如果您还有其他问题，请随时告诉我。`:`${n}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",pe=n=>n?`${n}`:"任务已完成！还有什么我可以帮您的吗？",$=n=>{console.log("[ChatComponent] Plan completed with rootPlanId:",n);const t=ue.getCachedPlanRecord(n);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",n);return}if(console.log("[ChatComponent] Plan details:",t),t.rootPlanId){const a=P.value.findIndex(h=>{var J;return((J=h.planExecution)==null?void 0:J.currentPlanId)===t.rootPlanId});if(a!==-1){const h=P.value[a];delete h.thinking;let H=t.summary??t.result??"任务已完成";!H.includes("我")&&!H.includes("您")&&(H.includes("成功")||H.includes("完成")?H=`很好！${H}。如果您还有其他需要帮助的地方，请随时告诉我。`:H=`我已经完成了您的请求：${H}`),h.content=H,console.log("[ChatComponent] Updated completed message:",h.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",t.rootPlanId)}},r=n=>{O.value=!1,P.value[P.value.length-1]={id:Date.now().toString(),type:"assistant",content:n,timestamp:new Date}},w=n=>{if(!n)return"";let t=n.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return t=t.replace(/(<br><br>)/g,"</p><p>"),t.includes("</p><p>")&&(t=`<p>${t}</p>`),t},M=async n=>{var t;if(!((t=n.planExecution)!=null&&t.currentPlanId)||!n.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const a={},h=n.planExecution.userInputWaitState.formInputs;h&&h.length>0?Object.entries(q[n.id]).forEach(([H,se])=>{var F;const z=parseInt(H,10),G=((F=h[z])==null?void 0:F.label)||`input_${H}`;a[G]=se}):a.genericInput=n.genericInput??"",console.log("[ChatComponent] 提交用户输入:",a);const J=await Fe.submitFormInput(n.planExecution.currentPlanId,a);delete n.planExecution.userInputWaitState,delete n.genericInput,delete q[n.id],k.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",J)}catch(a){console.error("[ChatComponent] 用户输入提交失败:",a),alert(`提交失败: ${(a==null?void 0:a.message)||"未知错误"}`)}};return Pe(()=>u.initialPrompt,(n,t)=>{console.log("[ChatComponent] initialPrompt changed from:",t,"to:",n),n&&typeof n=="string"&&n.trim()&&n!==t&&(console.log("[ChatComponent] Processing changed initial prompt:",n),re(()=>{d(n)}))},{immediate:!1}),Se(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ue.setEventCallbacks({onPlanUpdate:te,onPlanCompleted:$,onDialogRoundStart:le,onChatInputUpdateState:n=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",n)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:r}),re(()=>{Z()}),u.initialPrompt&&typeof u.initialPrompt=="string"&&u.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",u.initialPrompt),re(()=>{d(u.initialPrompt)}))}),Re(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),oe(),W.value&&clearInterval(W.value),k.cleanup(),Object.keys(q).forEach(n=>delete q[n])}),s({handleSendMessage:d,handlePlanUpdate:te,handlePlanCompleted:$,handleDialogRoundStart:le,addMessage:g,handlePlanError:r}),(n,t)=>(p(),v("div",gs,[e("div",{class:"messages",ref_key:"messagesRef",ref:A},[(p(!0),v(de,null,_e(P.value,a=>{var h,J,H,se,z,G,F,X,he;return p(),v("div",{key:a.id,class:ee(["message",{user:a.type==="user",assistant:a.type==="assistant"}])},[e("div",fs,[a.type==="user"?(p(),v("div",bs,i(a.content),1)):(p(),v("div",ks,[a.thinking||((h=a.planExecution)==null?void 0:h.progress)!==void 0||(((H=(J=a.planExecution)==null?void 0:J.steps)==null?void 0:H.length)??0)>0?(p(),v("div",_s,[e("div",$s,[e("div",Ps,[f(l(_),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Cs,i(n.$t("chat.thinkingLabel")),1)]),e("div",Ss,[a.thinking?(p(),v("div",ys,[f(l(_),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,i(a.thinking),1)])):B("",!0),((se=a.planExecution)==null?void 0:se.progress)!==void 0?(p(),v("div",ws,[e("div",Ts,[e("div",{class:"progress-fill",style:Le({width:a.planExecution.progress+"%"})},null,4)]),e("span",Es,i(a.planExecution.progressText??n.$t("chat.processing")+"..."),1)])):B("",!0),(((G=(z=a.planExecution)==null?void 0:z.steps)==null?void 0:G.length)??0)>0?(p(),v("div",Is,[e("h4",Ds,i(n.$t("chat.stepExecutionDetails")),1),(p(!0),v(de,null,_e((F=a.planExecution)==null?void 0:F.steps,(Ee,Q)=>{var Ue,Oe,je,We,He,Je,ze,Ge,Ke,Xe,Qe,Ze,Ye,et,tt,nt,ot,st,at;return p(),v("div",{key:Q,class:ee(["ai-section",{running:y(a,Q)==="RUNNING",completed:y(a,Q)==="FINISHED",pending:y(a,Q)==="IDLE"}]),onClick:ge($e=>j(a,Q),["stop"])},[e("div",Rs,[e("span",Ms,i(y(a,Q)==="FINISHED"?"✓":y(a,Q)==="RUNNING"?"▶":"○"),1),e("span",As,i(Ee||`${n.$t("chat.step")} ${Q+1}`),1),y(a,Q)==="RUNNING"?(p(),v("span",Us,i(n.$t("chat.status.executing")),1)):y(a,Q)==="FINISHED"?(p(),v("span",Ns,i(n.$t("chat.status.completed")),1)):(p(),v("span",Ls,i(n.$t("chat.status.pending")),1))]),a.stepActions&&a.stepActions[Q]?(p(),v("div",Vs,[e("div",qs,[e("span",Bs,i(((Ue=a.stepActions[Q])==null?void 0:Ue.status)==="current"?"🔄":((Oe=a.stepActions[Q])==null?void 0:Oe.status)==="completed"?"✓":"⏳"),1),e("strong",null,i((je=a.stepActions[Q])==null?void 0:je.actionDescription),1)]),(We=a.stepActions[Q])!=null&&We.toolParameters?(p(),v("div",Fs,[t[0]||(t[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Os,i(n.$t("common.parameters"))+":",1),e("pre",js,i((He=a.stepActions[Q])==null?void 0:He.toolParameters),1)])):B("",!0),(Je=a.stepActions[Q])!=null&&Je.thinkOutput?(p(),v("div",Ws,[e("div",Hs,[t[1]||(t[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",Js,i(n.$t("chat.thinkingOutput"))+":",1)]),e("div",zs,[e("pre",Gs,i((ze=a.stepActions[Q])==null?void 0:ze.thinkOutput),1)])])):B("",!0)])):B("",!0),((Ge=L(a,Q))==null?void 0:Ge.length)>0?(p(),v("div",Ks,[e("div",Xs,[f(l(_),{icon:"carbon:tree-view",class:"sub-plan-icon"}),t[2]||(t[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",Qs,[(p(!0),v(de,null,_e(L(a,Q),($e,ve)=>(p(),v("div",{key:`sub-${Q}-${ve}`,class:ee(["sub-plan-step-item",{completed:D(a,Q,ve)==="completed",current:D(a,Q,ve)==="current",pending:D(a,Q,ve)==="pending"}]),onClick:ge(lt=>V(a,Q,ve),["stop"])},[e("div",Ys,[e("span",ea,i(D(a,Q,ve)==="completed"?"✓":D(a,Q,ve)==="current"?"▶":"○"),1),e("span",ta,i(ve+1),1)]),e("div",na,[e("span",oa,i($e),1),t[3]||(t[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,Zs))),128))])])):B("",!0),(Ke=a.planExecution)!=null&&Ke.userInputWaitState&&y(a,Q)==="RUNNING"?(p(),v("div",sa,[e("p",aa,i(((Qe=(Xe=a.planExecution)==null?void 0:Xe.userInputWaitState)==null?void 0:Qe.message)??n.$t("chat.userInput.message")),1),(Ye=(Ze=a.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&Ye.formDescription?(p(),v("p",la,i((tt=(et=a.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.formDescription),1)):B("",!0),e("form",{onSubmit:ge($e=>M(a),["prevent"]),class:"user-input-form"},[(ot=(nt=a.planExecution)==null?void 0:nt.userInputWaitState)!=null&&ot.formInputs&&a.planExecution.userInputWaitState.formInputs.length>0?(p(!0),v(de,{key:0},_e((at=(st=a.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:at.formInputs,($e,ve)=>(p(),v("div",{key:ve,class:"form-group"},[e("label",{for:`form-input-${$e.label.replace(/\W+/g,"_")}`},i($e.label)+": ",9,ra),ae(e("input",{type:"text",id:`form-input-${$e.label.replace(/\W+/g,"_")}`,name:$e.label,"onUpdate:modelValue":lt=>q[a.id][ve]=lt,class:"form-input"},null,8,ca),[[ie,q[a.id][ve]]])]))),128)):(p(),v("div",ua,[e("label",da,i(n.$t("common.input"))+":",1),ae(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":$e=>a.genericInput=$e,class:"form-input"},null,8,pa),[[ie,a.genericInput]])])),e("button",ha,i(n.$t("chat.userInput.submit")),1)],40,ia)])):B("",!0)],10,xs)}),128))])):!a.content&&(a.thinking||((X=a.planExecution)==null?void 0:X.progress)!==void 0&&(((he=a.planExecution)==null?void 0:he.progress)??0)<100)?(p(),v("div",va,[e("div",ma,[t[4]||(t[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(a.thinking??n.$t("chat.thinkingProcessing")),1)])])):B("",!0)])])):B("",!0),e("div",ga,[e("div",fa,[e("div",ba,[f(l(_),{icon:"carbon:bot",class:"bot-icon"})]),e("div",ka,i(n.$t("chat.botName")),1)]),e("div",_a,[a.content?(p(),v("div",$a,[e("div",{class:"response-text",innerHTML:w(a.content)},null,8,Pa)])):(p(),v("div",Ca,[e("div",Sa,[t[5]||(t[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ya,i(n.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),O.value?(p(),v("div",wa,[e("div",Ta,[e("div",Ea,[e("div",Ia,[e("div",Da,[e("div",xa,[f(l(_),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ra,i(n.$t("chat.thinkingLabel")),1)]),e("div",Ma,[e("div",Aa,[e("div",Ua,[t[6]||(t[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(n.$t("chat.thinking")),1)])])])]),e("div",Na,[e("div",La,[e("div",Va,[f(l(_),{icon:"carbon:bot",class:"bot-icon"})]),e("div",qa,i(n.$t("chat.botName")),1)]),e("div",Ba,[e("div",Fa,[e("div",Oa,[t[7]||(t[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ja,i(n.$t("chat.thinkingResponse")),1)])])])])])])])):B("",!0)],512),U.value?(p(),v("div",{key:0,class:"scroll-to-bottom-btn",onClick:c,title:n.$t("chat.scrollToBottom")},[f(l(_),{icon:"carbon:chevron-down"})],8,Wa)):B("",!0)]))}}),Ja=ye(Ha,[["__scopeId","data-v-46f87864"]]),za={class:"input-area"},Ga={class:"input-container"},Ka={class:"attach-btn",title:"附加文件"},Xa=["placeholder","disabled"],Qa=["title"],Za=["disabled","title"],Ya=Ce({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(R,{expose:s,emit:o}){const{t:u}=xe(),S=R,m=o,k=x(),A=x(""),O=ke(()=>S.placeholder||u("input.placeholder")),P=x(O.value),W=ke(()=>!!S.disabled),U=()=>{re(()=>{k.value&&(k.value.style.height="auto",k.value.style.height=Math.min(k.value.scrollHeight,120)+"px")})},q=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),g())},g=()=>{if(!A.value.trim()||W.value)return;const c=A.value.trim();m("send",c),T()},I=()=>{m("plan-mode-clicked")},T=()=>{A.value="",U(),m("clear")},Y=(c,E)=>{E&&(P.value=c?E:u("input.waiting")),m("update-state",c,E)},N=c=>{A.value=c,U()},C=()=>A.value.trim();return Pe(()=>S.initialValue,c=>{c&&c.trim()&&(A.value=c,U())},{immediate:!0}),s({clearInput:T,updateState:Y,setInputValue:N,getQuery:C,focus:()=>{var c;return(c=k.value)==null?void 0:c.focus()}}),Se(()=>{}),Re(()=>{}),(c,E)=>(p(),v("div",za,[e("div",Ga,[e("button",Ka,[f(l(_),{icon:"carbon:attachment"})]),ae(e("textarea",{"onUpdate:modelValue":E[0]||(E[0]=Z=>A.value=Z),ref_key:"inputRef",ref:k,class:"chat-input",placeholder:P.value,disabled:W.value,onKeydown:q,onInput:U},null,40,Xa),[[ie,A.value]]),e("button",{class:"plan-mode-btn",title:c.$t("input.planMode"),onClick:I},[f(l(_),{icon:"carbon:document"}),K(" "+i(c.$t("input.planMode")),1)],8,Qa),e("button",{class:"send-button",disabled:!A.value.trim()||W.value,onClick:g,title:c.$t("input.send")},[f(l(_),{icon:"carbon:send-alt"}),K(" "+i(c.$t("input.send")),1)],8,Za)])]))}}),el=ye(Ya,[["__scopeId","data-v-639c8b2a"]]);class Ie{static async getAllCronTasks(){try{const s=await fetch(this.BASE_URL);return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to get cron tasks:",s),s}}static async getCronTaskById(s){try{const o=await fetch(`${this.BASE_URL}/${s}`);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get cron task by id:",o),o}}static async createCronTask(s){try{const o=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to create cron task:",o),o}}static async updateCronTask(s,o){try{const u=await fetch(`${this.BASE_URL}/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return await(await this.handleResponse(u)).json()}catch(u){throw console.error("Failed to update cron task:",u),u}}static async updateTaskStatus(s,o){try{const u=await fetch(`${this.BASE_URL}/${s}/status?status=${o}`,{method:"PUT"});await this.handleResponse(u)}catch(u){throw console.error("Failed to update task status:",u),u}}static async deleteCronTask(s){try{const o=await fetch(`${this.BASE_URL}/${s}`,{method:"DELETE"});await this.handleResponse(o)}catch(o){throw console.error("Failed to delete cron task:",o),o}}static async handleResponse(s){if(!s.ok)try{const o=await s.json();throw new Error(o.message||`API request failed: ${s.status}`)}catch{throw new Error(`API request failed: ${s.status} ${s.statusText}`)}return s}}be(Ie,"BASE_URL","/api/cron-tasks");const De={validateCronExpression(R){const s=R.trim().split(/\s+/);return s.length>=5&&s.length<=6},formatTime(R){return new Date(R).toLocaleString()},async saveTask(R){try{let s;return R.id?s=await Ie.updateCronTask(Number(R.id),R):s=await Ie.createCronTask(R),s}catch(s){throw console.error("Failed to save cron task:",s),s}},async deleteTask(R){try{await Ie.deleteCronTask(String(R))}catch(s){throw console.error("Failed to delete cron task:",s),s}},async toggleTaskStatus(R){if(!R.id)throw new Error("Task ID is required");const s=R.status===0?1:0;return await Ie.updateCronTask(Number(R.id),{...R,status:s})},prepareTaskExecution(R){return R.planTemplateId?{useTemplate:!0,planData:{title:R.cronName||"定时任务执行",planData:{id:R.planTemplateId,planTemplateId:R.planTemplateId,planId:R.planTemplateId},params:R.executionParams||void 0}}:{useTemplate:!1,taskContent:R.planDesc||R.cronName||""}}},tl={class:"modal-header"},nl={class:"header-actions"},ol={class:"status-switch"},sl={class:"status-label"},al={class:"toggle-switch"},ll=["checked"],il={class:"modal-content"},rl={class:"form-group"},cl={class:"form-label"},ul=["placeholder"],dl={class:"form-group"},pl={class:"form-label"},hl=["placeholder"],vl={class:"form-help"},ml={class:"form-group"},gl={class:"form-label"},fl=["placeholder"],bl={class:"form-group"},kl={class:"form-label"},_l={class:"template-toggle"},$l={key:0,class:"template-selector"},Pl={value:""},Cl=["value"],Sl={class:"form-help"},yl={key:0,class:"form-group"},wl={class:"time-info"},Tl={class:"time-label"},El={class:"time-value"},Il={key:1,class:"form-group"},Dl={class:"time-info"},xl={class:"time-label"},Rl={class:"time-value"},Ml={class:"modal-footer"},Al=["disabled"],Ul=Ce({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(R,{emit:s}){const o=R,u=s,S=x(!1),m=x([]),k=x({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Se(async()=>{try{const g=await Ae.getAllPlanTemplates();g&&g.templates&&(m.value=g.templates.map(I=>({id:I.id,name:I.title||"Unnamed Template"})))}catch(g){console.error("Failed to get template list:",g)}});const O=g=>{g.target===g.currentTarget&&u("update:modelValue",!1)},P=()=>{k.value.linkTemplate=!1,k.value.templateId="",k.value.planTemplateId=""},W=()=>k.value.cronName.trim()?k.value.cronTime.trim()?De.validateCronExpression(k.value.cronTime)?k.value.planDesc.trim()?k.value.linkTemplate&&!k.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),U=g=>De.formatTime(g),q=async()=>{var g;if(W()){S.value=!0;try{const I={...k.value,...((g=o.task)==null?void 0:g.id)!==void 0&&{id:o.task.id},cronName:k.value.cronName.trim(),cronTime:k.value.cronTime.trim(),planDesc:k.value.planDesc.trim(),status:k.value.status,planTemplateId:k.value.linkTemplate&&k.value.templateId||""};u("save",I)}finally{S.value=!1}}};return Pe(()=>o.task,g=>{if(g){const I=g.templateId||g.planTemplateId||"";k.value={cronName:g.cronName||"",cronTime:g.cronTime||"",planDesc:g.planDesc||"",status:g.status??1,linkTemplate:!!I,templateId:I,planTemplateId:I}}else k.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),Pe(()=>o.modelValue,g=>{g||(k.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(g,I)=>(p(),ce(Ne,{to:"body"},[f(Me,{name:"modal"},{default:Te(()=>{var T,Y,N;return[g.modelValue?(p(),v("div",{key:0,class:"modal-overlay",onClick:O},[e("div",{class:"modal-container",onClick:I[8]||(I[8]=ge(()=>{},["stop"]))},[e("div",tl,[e("h3",null,i(g.$t("cronTask.taskDetail")),1),e("div",nl,[e("div",ol,[e("span",sl,i(g.$t("cronTask.taskStatus")),1),e("label",al,[e("input",{type:"checkbox",checked:k.value.status===0,onChange:I[0]||(I[0]=C=>k.value.status=k.value.status===0?1:0)},null,40,ll),I[9]||(I[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:I[1]||(I[1]=C=>g.$emit("update:modelValue",!1))},[f(l(_),{icon:"carbon:close"})])])]),e("div",il,[e("form",{onSubmit:ge(q,["prevent"]),class:"task-form"},[e("div",rl,[e("label",cl,i(g.$t("cronTask.taskName")),1),ae(e("input",{"onUpdate:modelValue":I[2]||(I[2]=C=>k.value.cronName=C),type:"text",class:"form-input",placeholder:g.$t("cronTask.taskNamePlaceholder"),required:""},null,8,ul),[[ie,k.value.cronName]])]),e("div",dl,[e("label",pl,i(g.$t("cronTask.cronExpression")),1),ae(e("input",{"onUpdate:modelValue":I[3]||(I[3]=C=>k.value.cronTime=C),type:"text",class:"form-input",placeholder:g.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,hl),[[ie,k.value.cronTime]]),e("div",vl,i(g.$t("cronTask.cronExpressionHelp")),1)]),e("div",ml,[e("label",gl,i(g.$t("cronTask.taskDescription")),1),ae(e("textarea",{"onUpdate:modelValue":I[4]||(I[4]=C=>k.value.planDesc=C),class:"form-textarea",placeholder:g.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,fl),[[ie,k.value.planDesc]])]),e("div",bl,[e("label",kl,i(g.$t("cronTask.planTemplate")),1),e("div",_l,[e("button",{type:"button",class:ee(["template-btn",k.value.linkTemplate?"active":""]),onClick:I[5]||(I[5]=C=>k.value.linkTemplate=!0)},[f(l(_),{icon:"carbon:checkmark"}),K(" "+i(g.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ee(["template-btn",k.value.linkTemplate?"":"active"]),onClick:P},[f(l(_),{icon:"carbon:close"}),K(" "+i(g.$t("cronTask.noTemplate")),1)],2)]),k.value.linkTemplate?(p(),v("div",$l,[ae(e("select",{"onUpdate:modelValue":I[6]||(I[6]=C=>k.value.templateId=C),class:"form-select"},[e("option",Pl,i(g.$t("cronTask.selectTemplate")),1),(p(!0),v(de,null,_e(m.value,C=>(p(),v("option",{key:C.id,value:C.id},i(C.name),9,Cl))),128))],512),[[pt,k.value.templateId]]),e("div",Sl,i(g.$t("cronTask.templateHelpText")),1)])):B("",!0)]),(T=g.task)!=null&&T.createTime?(p(),v("div",yl,[e("div",wl,[e("span",Tl,i(g.$t("cronTask.createTime"))+":",1),e("span",El,i(U(g.task.createTime)),1)])])):B("",!0),(Y=g.task)!=null&&Y.updateTime?(p(),v("div",Il,[e("div",Dl,[e("span",xl,i(g.$t("cronTask.updateTime"))+":",1),e("span",Rl,i(U(g.task.updateTime)),1)])])):B("",!0)],32)]),e("div",Ml,[e("button",{type:"button",class:"cancel-btn",onClick:I[7]||(I[7]=C=>g.$emit("update:modelValue",!1))},i(g.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:q,disabled:S.value},[S.value?(p(),ce(l(_),{key:0,icon:"carbon:loading",class:"loading-icon"})):B("",!0),K(" "+i((N=o.task)!=null&&N.id?g.$t("common.save"):g.$t("common.create")),1)],8,Al)])])])):B("",!0)]}),_:1})]))}}),Nl=ye(Ul,[["__scopeId","data-v-5b32448e"]]),Ll={class:"modal-header"},Vl={class:"header-actions"},ql={class:"modal-content"},Bl={key:0,class:"loading-container"},Fl={key:1,class:"empty-container"},Ol={key:2,class:"task-list"},jl=["onClick"],Wl={class:"task-main"},Hl={class:"task-info"},Jl={class:"task-header"},zl={class:"task-name"},Gl={class:"task-description"},Kl={class:"task-time"},Xl=["onClick"],Ql=["onClick","disabled","title"],Zl=["onClick","title"],Yl={class:"dropdown-menu"},ei=["onClick"],ti=["onClick","disabled"],ni=["onClick","disabled"],oi={class:"confirm-header"},si={class:"confirm-content"},ai={class:"confirm-actions"},li=["disabled"],ii={class:"confirm-header"},ri={class:"confirm-content"},ci={class:"create-options"},ui={class:"option-content"},di={class:"option-title"},pi={class:"option-desc"},hi={class:"option-content"},vi={class:"option-title"},mi={class:"option-desc"},gi={class:"confirm-actions"},fi=Ce({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(R,{emit:s}){const o=rt(),u=ct(),S=gt(),{t:m}=xe(),k=R,A=s,O=x([]),P=x(!1),W=x(null),U=x(null),q=x(null),g=x(null),I=x(!1),T=x(null),Y=x(!1),N=x(null),C=x(!1),c=r=>{r.target===r.currentTarget&&A("update:modelValue",!1)},E=async()=>{P.value=!0;try{O.value=await Ie.getAllCronTasks()}catch(r){console.error("Failed to load cron tasks:",r),S.error(`Failed to load tasks: ${r instanceof Error?r.message:String(r)}`)}finally{P.value=!1}},Z=async r=>{W.value=r;try{const w=O.value.find(t=>t.id===r);if(!w){console.error("Task not found:",r);return}A("update:modelValue",!1);const M=Date.now().toString();await o.push({name:"direct",params:{id:M}}),await new Promise(t=>setTimeout(t,100));const n=De.prepareTaskExecution(w);n.useTemplate&&n.planData?u.emitPlanExecutionRequested(n.planData):n.taskContent&&u.setTask(n.taskContent)}catch(w){console.error("Failed to execute task:",w),S.error(`Execution failed: ${w instanceof Error?w.message:String(w)}`)}finally{W.value=null}},oe=r=>{T.value={...r},I.value=!0,g.value=null},d=async r=>{try{await De.saveTask(r),await E(),I.value=!1,S.success("Task saved successfully")}catch(w){console.error("Failed to save task:",w),S.error(`Save failed: ${w instanceof Error?w.message:String(w)}`)}},y=r=>{N.value=r,Y.value=!0},j=async()=>{var r;if((r=N.value)!=null&&r.id){U.value=N.value.id;try{await De.deleteTask(N.value.id),await E(),Y.value=!1,N.value=null,S.success("Task deleted successfully")}catch(w){console.error("Failed to delete task:",w),S.error(`Delete failed: ${w instanceof Error?w.message:String(w)}`)}finally{U.value=null}}},L=()=>{Y.value=!1,N.value=null},D=r=>{g.value=g.value===r?null:r},V=async r=>{if(r.id){q.value=r.id;try{await De.toggleTaskStatus(r),await E(),g.value=null,S.success(`Task ${r.status===0?"disabled":"enabled"} successfully`)}catch(w){console.error("Failed to toggle task status:",w),S.error(`Status toggle failed: ${w instanceof Error?w.message:String(w)}`)}finally{q.value=null}}},ne=async r=>{try{await navigator.clipboard.writeText(r),S.success("Cron expression copied successfully")}catch(w){S.error(`Copy failed: ${w instanceof Error?w.message:String(w)}`)}},le=()=>{C.value=!0},te=()=>{C.value=!1;try{A("update:modelValue",!1);const r=m("cronTask.template");u.setTaskToInput(r);const w=Date.now().toString();o.push({name:"direct",params:{id:w}})}catch(r){console.error("Error in createWithJmanus:",r),S.error(`Creation failed: ${r instanceof Error?r.message:String(r)}`)}},fe=()=>{C.value=!1,T.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},I.value=!0},pe=()=>{C.value=!1},$=r=>{const w=r.target;!w.closest(".action-dropdown")&&!w.closest(".dropdown-menu")&&(g.value=null)};return Se(()=>{document.addEventListener("click",$,!0)}),Re(()=>{document.removeEventListener("click",$,!0)}),Pe(()=>k.modelValue,r=>{r&&E()}),(r,w)=>(p(),v(de,null,[(p(),ce(Ne,{to:"body"},[f(Me,{name:"modal"},{default:Te(()=>[R.modelValue?(p(),v("div",{key:0,class:"modal-overlay",onClick:c},[e("div",{class:"modal-container",onClick:w[3]||(w[3]=ge(()=>{},["stop"]))},[e("div",Ll,[e("h3",null,i(r.$t("cronTask.title")),1),e("div",Vl,[e("button",{class:"add-task-btn",onClick:[le,w[0]||(w[0]=ge(()=>{},["stop"]))]},[f(l(_),{icon:"carbon:add"}),K(" "+i(r.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:w[1]||(w[1]=M=>r.$emit("update:modelValue",!1))},[f(l(_),{icon:"carbon:close"})])])]),e("div",ql,[P.value?(p(),v("div",Bl,[f(l(_),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,i(r.$t("common.loading")),1)])):O.value.length===0?(p(),v("div",Fl,[f(l(_),{icon:"carbon:time",class:"empty-icon"}),e("span",null,i(r.$t("cronTask.noTasks")),1)])):(p(),v("div",Ol,[(p(!0),v(de,null,_e(O.value,M=>(p(),v("div",{key:M.id||"",class:"task-item",onClick:n=>oe(M)},[e("div",Wl,[e("div",Hl,[e("div",Jl,[e("div",zl,i(M.cronName),1),e("div",{class:ee(["task-status-badge",M.status===0?"active":"inactive"])},[f(l(_),{icon:M.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,i(M.status===0?r.$t("cronTask.active"):r.$t("cronTask.inactive")),1)],2)]),e("div",Gl,i(M.planDesc),1),e("div",Kl,[f(l(_),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ge(n=>ne(M.cronTime),["stop"])},i(M.cronTime),9,Xl)])])]),e("div",{class:"task-actions",onClick:w[2]||(w[2]=ge(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:n=>Z(M.id),disabled:W.value===M.id,title:r.$t("cronTask.executeOnce")},[f(l(_),{icon:W.value===M.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),K(" "+i(r.$t("cronTask.executeOnce")),1)],8,Ql),e("div",{class:ee(["action-dropdown",{active:g.value===M.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:n=>D(M.id),title:r.$t("cronTask.operations")},[f(l(_),{icon:"carbon:overflow-menu-horizontal"}),K(" "+i(r.$t("cronTask.operations")),1)],8,Zl),ae(e("div",Yl,[e("button",{class:"dropdown-item edit-btn",onClick:n=>oe(M)},[f(l(_),{icon:"carbon:edit"}),K(" "+i(r.$t("cronTask.edit")),1)],8,ei),e("button",{class:"dropdown-item toggle-btn",onClick:n=>V(M),disabled:q.value===M.id},[f(l(_),{icon:q.value===M.id?"carbon:loading":M.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),K(" "+i(M.status===0?r.$t("cronTask.disable"):r.$t("cronTask.enable")),1)],8,ti),e("button",{class:"dropdown-item delete-btn",onClick:n=>y(M),disabled:U.value===M.id},[f(l(_),{icon:U.value===M.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),K(" "+i(r.$t("cronTask.delete")),1)],8,ni)],512),[[ht,g.value===M.id]])],2)])],8,jl))),128))]))])])])):B("",!0)]),_:1})])),f(Nl,{modelValue:I.value,"onUpdate:modelValue":w[4]||(w[4]=M=>I.value=M),task:T.value,onSave:d},null,8,["modelValue","task"]),(p(),ce(Ne,{to:"body"},[f(Me,{name:"modal"},{default:Te(()=>{var M,n,t,a;return[Y.value?(p(),v("div",{key:0,class:"modal-overlay",onClick:L},[e("div",{class:"confirm-modal",onClick:w[5]||(w[5]=ge(()=>{},["stop"]))},[e("div",oi,[f(l(_),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,i(r.$t("cronTask.deleteConfirm")),1)]),e("div",si,[e("p",null,i(r.$t("cronTask.deleteConfirmMessage",{taskName:((M=N.value)==null?void 0:M.cronName)||((n=N.value)==null?void 0:n.planDesc)||""})),1)]),e("div",ai,[e("button",{class:"confirm-btn cancel-btn",onClick:L},i(r.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:j,disabled:U.value===((t=N.value)==null?void 0:t.id)},[f(l(_),{icon:U.value===((a=N.value)==null?void 0:a.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),K(" "+i(r.$t("cronTask.delete")),1)],8,li)])])])):B("",!0)]}),_:1})])),(p(),ce(Ne,{to:"body"},[f(Me,{name:"modal"},{default:Te(()=>[C.value?(p(),v("div",{key:0,class:"modal-overlay",onClick:pe},[e("div",{class:"confirm-modal create-options-modal",onClick:w[6]||(w[6]=ge(()=>{},["stop"]))},[e("div",ii,[f(l(_),{icon:"carbon:time",class:"create-icon"}),e("h3",null,i(r.$t("cronTask.createTask")),1)]),e("div",ri,[e("p",null,i(r.$t("cronTask.selectCreateMethod")),1),e("div",ci,[e("button",{class:"create-option-btn jmanus-btn",onClick:te},[f(l(_),{icon:"carbon:ai-status"}),e("div",ui,[e("span",di,i(r.$t("cronTask.createWithJmanus")),1),e("span",pi,i(r.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:fe},[f(l(_),{icon:"carbon:edit"}),e("div",hi,[e("span",vi,i(r.$t("cronTask.createManually")),1),e("span",mi,i(r.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",gi,[e("button",{class:"confirm-btn cancel-btn",onClick:pe},i(r.$t("common.cancel")),1)])])])):B("",!0)]),_:1})]))],64))}}),bi=ye(fi,[["__scopeId","data-v-f31a9ce7"]]),ki={class:"direct-page"},_i={class:"direct-chat"},$i={class:"chat-header"},Pi={class:"header-actions"},Ci=["title"],Si=["title"],yi={class:"chat-content"},wi=["title"],Ti={class:"message-content"},Ei=Ce({__name:"index",setup(R){const s=vt(),o=rt(),u=ct(),{t:S}=xe(),{message:m}=ft(),k=x(""),A=x(""),O=x(),P=x(),W=x(),U=x(!1),q=x(!1),g=x(null),I=x(!1),T=x(50),Y=x(!1),N=x(0),C=x(0);Se(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",u.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",u.hasUnprocessedTask()),ue.setEventCallbacks({onPlanUpdate:r=>{console.log("[Direct] Plan update event received for rootPlanId:",r),d(r)&&(console.log("[Direct] Processing plan update for current rootPlanId:",r),P.value&&typeof P.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",r),P.value.handlePlanUpdate(r)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),O.value&&typeof O.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",r),O.value.updateDisplayedPlanProgress(r)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:r=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",r),!!d(r)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",r),P.value&&typeof P.value.handlePlanCompleted=="function"){const w=ue.getCachedPlanRecord(r);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",w),P.value.handlePlanCompleted(w??{planId:r})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");g.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:r=>{console.log("[Direct] Dialog round start event received for rootPlanId:",r),g.value=r,console.log("[Direct] Set currentRootPlanId to:",r),P.value&&typeof P.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",r),P.value.handleDialogRoundStart(r)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),j()},onChatInputUpdateState:r=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",r),!d(r,!0))return;const w=ue.getCachedUIState(r);w&&D(w.enabled,w.placeholder)},onPlanError:r=>{P.value.handlePlanError(r)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),b.loadPlanTemplateList(),u.hasUnprocessedTask()&&u.currentTask){const r=u.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",r),u.markTaskAsProcessed(),re(()=>{P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",r),P.value.handleSendMessage(r)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),k.value=r)})}else{const r=u.getAndClearTaskToInput();r?(A.value=r,console.log("[Direct] Setting inputOnlyContent for input only:",A.value)):(k.value=s.query.prompt||"",console.log("[Direct] Received task from URL:",k.value),console.log("[Direct] No unprocessed task in store"))}const $=localStorage.getItem("directPanelWidth");$&&(T.value=parseFloat($)),console.log("[Direct] Final prompt value:",k.value),A.value&&re(()=>{W.value&&typeof W.value.setInputValue=="function"&&(W.value.setInputValue(A.value),console.log("[Direct] Set input value:",A.value),A.value="")}),window.addEventListener("plan-execution-requested",r=>{console.log("[DirectView] Received plan-execution-requested event:",r.detail),pe(r.detail)})}),Pe(()=>u.currentTask,$=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",$),$&&!$.processed){const r=$.prompt;u.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",r),re(()=>{P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",r),P.value.handleSendMessage(r)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Pe(()=>k.value,($,r)=>{console.log("[Direct] prompt value changed from:",r,"to:",$)},{immediate:!1}),Pe(()=>u.taskToInput,$=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",$),$&&$.trim()&&(console.log("[Direct] Setting input value from taskToInput:",$),re(()=>{W.value&&typeof W.value.setInputValue=="function"&&(W.value.setInputValue($.trim()),console.log("[Direct] Input value set from taskToInput watch:",$.trim()),u.getAndClearTaskToInput())}))},{immediate:!1}),Re(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),g.value=null,ue.cleanup(),document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",Z),window.removeEventListener("plan-execution-requested",$=>{pe($.detail)})});const c=$=>{Y.value=!0,N.value=$.clientX,C.value=T.value,document.addEventListener("mousemove",E),document.addEventListener("mouseup",Z),document.body.style.cursor="col-resize",document.body.style.userSelect="none",$.preventDefault()},E=$=>{if(!Y.value)return;const r=window.innerWidth,M=($.clientX-N.value)/r*100;let n=C.value+M;n=Math.max(20,Math.min(80,n)),T.value=n},Z=()=>{Y.value=!1,document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",Z),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",T.value.toString())},oe=()=>{T.value=50,localStorage.setItem("directPanelWidth","50")},d=($,r=!1)=>!g.value||$===g.value||r&&($==="ui-state"||$==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",$,"current:",g.value),!1),y=$=>{console.log("[DirectView] Send message from input:",$),P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",$),P.value.handleSendMessage($)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},j=()=>{console.log("[DirectView] Input cleared"),W.value&&typeof W.value.clear=="function"&&W.value.clear()},L=()=>{console.log("[DirectView] Input focused")},D=($,r)=>{console.log("[DirectView] Input state updated:",$,r),q.value=!$},V=($,r)=>{console.log("[DirectView] Step selected:",$,r),O.value&&typeof O.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",$,r),O.value.handleStepSelected($,r)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},ne=($,r,w,M)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:$,subPlanId:r,stepIndex:w,subStepIndex:M}),O.value&&typeof O.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:$,subPlanId:r,stepIndex:w,subStepIndex:M}),O.value.handleSubPlanStepSelected($,r,w,M)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},le=()=>{console.log("[DirectView] Plan mode button clicked"),b.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",b.isCollapsed)},te=()=>{o.push("/home")},fe=()=>{o.push("/configs")},pe=async $=>{var w,M,n,t;if(console.log("[DirectView] Plan execution requested:",$),U.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}U.value=!0;let r=!1;P.value&&typeof P.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",$.title),P.value.addMessage("user",$.title),r=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const a=((w=$.planData)==null?void 0:w.planTemplateId)||((M=$.planData)==null?void 0:M.id)||((n=$.planData)==null?void 0:n.planId);if(!a)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",a,"params:",$.params),console.log("[Direct] About to call PlanActApiService.executePlan");let h;if((t=$.params)!=null&&t.trim()?(console.log("[Direct] Calling executePlan with params:",$.params.trim()),h=await Ae.executePlan(a,$.params.trim())):(console.log("[Direct] Calling executePlan without params"),h=await Ae.executePlan(a)),console.log("[Direct] Plan execution API response:",h),h.planId)console.log("[Direct] Got planId from response:",h.planId,"starting plan execution"),g.value=h.planId,console.log("[Direct] Set currentRootPlanId to:",h.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ue.handlePlanExecutionRequested(h.planId,$.title);else throw console.error("[Direct] No planId in response:",h),new Error("执行计划失败：未返回有效的计划ID")}catch(a){console.error("[Direct] Plan execution failed:",a),console.error("[Direct] Error details:",{message:a.message,stack:a.stack}),g.value=null,P.value&&typeof P.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),r||P.value.addMessage("user",$.title),P.value.addMessage("assistant",`执行计划失败: ${a.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${a.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),U.value=!1}};return($,r)=>(p(),v("div",ki,[e("div",_i,[f(Qn,{onPlanExecutionRequested:pe}),e("div",{class:"left-panel",style:Le({width:T.value+"%"})},[e("div",$i,[e("button",{class:"back-button",onClick:te},[f(l(_),{icon:"carbon:arrow-left"})]),e("h2",null,i($.$t("conversation")),1),e("div",Pi,[f(kt),e("button",{class:"config-button",onClick:fe,title:$.$t("direct.configuration")},[f(l(_),{icon:"carbon:settings-adjust",width:"20"})],8,Ci),e("button",{class:"cron-task-btn",onClick:r[0]||(r[0]=w=>I.value=!0),title:$.$t("cronTask.title")},[f(l(_),{icon:"carbon:alarm",width:"20"})],8,Si)])]),e("div",yi,[f(Ja,{ref_key:"chatRef",ref:P,mode:"direct","initial-prompt":k.value||"",onStepSelected:V,onSubPlanStepSelected:ne},null,8,["initial-prompt"])]),(p(),ce(el,{key:$.$i18n.locale,ref_key:"inputRef",ref:W,disabled:q.value,placeholder:q.value?l(S)("input.waiting"):l(S)("input.placeholder"),"initial-value":k.value,onSend:y,onClear:j,onFocus:L,onUpdateState:D,onPlanModeClicked:le},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:c,onDblclick:oe,title:$.$t("direct.panelResizeHint")},r[2]||(r[2]=[e("div",{class:"resizer-line"},null,-1)]),40,wi),f(vs,{ref_key:"rightPanelRef",ref:O,style:Le({width:100-T.value+"%"})},null,8,["style"])]),f(bi,{modelValue:I.value,"onUpdate:modelValue":r[1]||(r[1]=w=>I.value=w)},null,8,["modelValue"]),l(m).show?(p(),v("div",{key:0,class:ee(["message-toast",l(m).type])},[e("div",Ti,[e("span",null,i(l(m).text),1)])],2)):B("",!0)]))}}),Li=ye(Ei,[["__scopeId","data-v-ea79c7eb"]]);export{Li as default};
