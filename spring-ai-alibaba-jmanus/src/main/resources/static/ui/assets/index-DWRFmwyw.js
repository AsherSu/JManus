var ut=Object.defineProperty;var dt=(A,n,t)=>n in A?ut(A,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):A[n]=t;var fe=(A,n,t)=>dt(A,typeof n!="symbol"?n+"":n,t);import{d as Pe,u as Ee,c as be,r as R,z as qe,A as $e,o as Ce,a as f,b as h,F as de,g as S,f as L,k as we,i as Q,x as o,t as a,e,n as ne,w as ae,j as ce,B as it,l as _e,s as ie,h as me,y as re,C as Re,T as Ae,q as Le,D as Ne,E as pt,G as ht,p as ct,H as vt}from"./index-7O0lrT-c.js";import{I as P}from"./iconify-DubhOMrm.js";import{s as $,P as Me,u as rt}from"./sidebar-B9cDRuut.js";import{M as mt,u as gt,a as ft}from"./useMessage-BBJIElrz.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as bt}from"./llm-check-D2idVWhZ.js";import{L as _t}from"./index-LLDOq3SZ.js";class pe{static async getCoordinatorToolConfig(){try{const n=await fetch(`${this.BASE_URL}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get coordinator tool config: ${n.status}`);return await n.json()}catch(n){return console.error("获取CoordinatorTool配置失败:",n),{enabled:!0,success:!1,message:n.message}}}static async getAllEndpoints(){try{const n=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get endpoints: ${n.status}`);return await n.json()}catch(n){throw console.error("获取endpoints失败:",n),new Error("获取endpoints失败: "+n.message)}}static async getOrNewCoordinatorToolsByTemplate(n){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${n}`);try{const t=await fetch(`${this.BASE_URL}/get-or-new-by-template/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const T=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",T),new Error(`Failed to get coordinator tools: ${t.status} - ${T}`)}const u=await t.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",u),u}catch(t){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",t),new Error("获取协调器工具失败: "+t.message)}}static async createCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 原始数据:",JSON.stringify(n,null,2)),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const t={id:n.id,toolName:n.toolName,toolDescription:n.toolDescription,inputSchema:n.inputSchema,mcpSchema:n.mcpSchema,planTemplateId:n.planTemplateId,endpoint:n.endpoint,publishStatus:n.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",JSON.stringify(t,null,2));try{const u=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[CoordinatorToolApiService] 响应状态:",u.status),console.log("[CoordinatorToolApiService] 响应状态文本:",u.statusText),!u.ok){const _=await u.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",_),new Error(`Failed to create coordinator tool: ${u.status} - ${_}`)}const T=await u.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",T),T}catch(u){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",u),new Error("创建协调器工具失败: "+u.message)}}static async updateCoordinatorTool(n,t){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 发送的数据:",t),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);const u={id:t.id,toolName:t.toolName,toolDescription:t.toolDescription,inputSchema:t.inputSchema,mcpSchema:t.mcpSchema,planTemplateId:t.planTemplateId,endpoint:t.endpoint,publishStatus:t.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",u);try{const T=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(console.log("[CoordinatorToolApiService] 响应状态:",T.status),console.log("[CoordinatorToolApiService] 响应状态文本:",T.statusText),!T.ok){const C=await T.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",C),new Error(`Failed to update coordinator tool: ${T.status} - ${C}`)}const _=await T.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",_),_}catch(T){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",T),new Error("更新协调器工具失败: "+T.message)}}static async publishCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}/publish`);try{const t=await fetch(`${this.BASE_URL}/${n}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const T=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",T),new Error(`Failed to publish coordinator tool: ${t.status} - ${T}`)}const u=await t.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",u),u}catch(t){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",t),new Error("发布协调器工具失败: "+t.message)}}static async deleteCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始删除协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const T=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",T),new Error(`Failed to delete coordinator tool: ${t.status} - ${T}`)}const u=await t.json();return console.log("[CoordinatorToolApiService] 删除成功，结果:",u),u}catch(t){throw console.error("[CoordinatorToolApiService] 删除协调器工具失败:",t),new Error("删除协调器工具失败: "+t.message)}}}fe(pe,"BASE_URL","/api/coordinator-tools");const kt={class:"modal-form"},St={class:"form-section"},$t={class:"form-item endpoint-item"},Pt={class:"endpoint-container"},Ct={class:"endpoint-row"},yt={class:"custom-select"},Tt={class:"select-input-container"},wt={class:"input-content"},Et=["placeholder"],It={class:"dropdown-header"},Dt={class:"select-options"},xt=["onClick"],Rt={class:"option-name"},At={class:"manual-input-section"},Mt={class:"manual-input-container"},Ut=["placeholder"],Nt={key:0,class:"form-item url-item"},Lt={class:"url-container"},Vt=["title"],qt={class:"url-text"},Ft={class:"form-section"},Bt={class:"form-item"},Ot=["placeholder"],jt={class:"form-section"},Wt={class:"form-item"},Ht=["placeholder"],Jt={class:"form-section"},zt={class:"section-title"},Gt={class:"parameter-table"},Kt=["onUpdate:modelValue","placeholder"],Xt=["onUpdate:modelValue","placeholder"],Qt={class:"button-container"},Zt=["disabled"],Yt=["disabled"],en={key:1,class:"publish-toggle-container"},tn=Pe({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(A,{emit:n}){const{t}=Ee(),u=A,T=n,_=be({get:()=>u.modelValue,set:c=>T("update:modelValue",c)}),C=R(""),U=R(""),F=R(!1),E=R(!1),O=R(!1),W=R([]),H=R(""),g=R(""),D=R(!1),Z=R("bottom"),Y=R(""),k=R(null),B=R(!1),r=R(!1),p=qe({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),te=be(()=>{const c=k.value&&k.value.id;return t(c?"mcpService.updateService":"mcpService.createService")}),oe=()=>{p.serviceName="",p.userRequest=u.planDescription||"",p.endpoint="",p.parameters=[],k.value=null,H.value="",g.value="",B.value=!1,r.value=!1},m=async()=>{try{W.value=await pe.getAllEndpoints()}catch(c){console.error("加载endpoints失败:",c),ee(t("mcpService.loadEndpointsFailed")+": "+c.message,"error")}},I=()=>{D.value||j(),D.value=!D.value},j=()=>{const c=document.querySelector(".custom-select");if(!c)return;const b=c.getBoundingClientRect(),v=window.innerHeight;b.bottom+200>v?Z.value="top":Z.value="bottom"},N=c=>{p.endpoint=c,D.value=!1,Y.value=""},x=()=>{if(Y.value.trim()){const c=Y.value.trim().replace(/[^a-zA-Z0-9_/]/g,"");c&&(p.endpoint=c,W.value.includes(c)||W.value.push(c),D.value=!1,Y.value="")}},V=()=>{setTimeout(()=>{Y.value.trim()&&x()},200)},se=()=>{W.value.includes(p.endpoint)&&N(p.endpoint)},le=()=>{W.value.includes(p.endpoint)&&N(p.endpoint)},ge=()=>{W.value.includes(p.endpoint)&&N(p.endpoint)},ke=async()=>{if(g.value)try{await navigator.clipboard.writeText(g.value),ee(t("common.copy")+" "+t("common.success"),"success")}catch(c){console.error("复制失败:",c),ee(t("common.copy")+" "+t("common.error"),"error")}},ee=(c,b)=>{b==="success"?(U.value=c,setTimeout(()=>{U.value=""},3e3)):b==="error"&&(C.value=c,setTimeout(()=>{C.value=""},5e3))},y=()=>p.serviceName.trim()?p.userRequest.trim()?p.endpoint.trim()?!0:(ee(t("mcpService.endpointRequiredError"),"error"),!1):(ee(t("mcpService.toolDescriptionRequiredError"),"error"),!1):(ee(t("mcpService.toolNameRequiredError"),"error"),!1),i=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",p),console.log("[PublishModal] 当前工具:",k.value),!y()){console.log("[PublishModal] 表单验证失败");return}E.value=!0;try{if(!k.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const v=await pe.getOrNewCoordinatorToolsByTemplate(u.planTemplateId);if(!v.success)throw new Error(v.message);Array.isArray(v.data)?k.value=v.data[0]:k.value=v.data}console.log("[PublishModal] 更新工具信息"),k.value.toolName=p.serviceName.trim(),k.value.toolDescription=p.userRequest.trim(),k.value.endpoint=p.endpoint.trim(),k.value.planTemplateId=u.planTemplateId;const c=p.parameters.filter(v=>v.name.trim()&&v.description.trim()).map(v=>({name:v.name.trim(),description:v.description.trim(),type:"string"}));k.value.inputSchema=JSON.stringify(c),console.log("[PublishModal] 更新后的工具信息:",k.value);let b;k.value.id?(console.log("[PublishModal] 更新现有工具，ID:",k.value.id),b=await pe.updateCoordinatorTool(k.value.id,k.value)):(console.log("[PublishModal] 创建新工具"),b=await pe.createCoordinatorTool(k.value),k.value=b),console.log("[PublishModal] 保存成功:",b),ee(t("mcpService.saveSuccess"),"success"),B.value=!0}catch(c){console.error("[PublishModal] 保存MCP服务失败:",c),ee(t("mcpService.saveFailed")+": "+c.message,"error")}finally{E.value=!1}},w=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",p),console.log("[PublishModal] 当前工具:",k.value),!y()){console.log("[PublishModal] 表单验证失败");return}F.value=!0;try{if(!k.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const v=await pe.getOrNewCoordinatorToolsByTemplate(u.planTemplateId);if(!v.success)throw new Error(v.message);Array.isArray(v.data)?k.value=v.data[0]:k.value=v.data}console.log("[PublishModal] 更新工具信息"),k.value.toolName=p.serviceName.trim(),k.value.toolDescription=p.userRequest.trim(),k.value.endpoint=p.endpoint.trim(),k.value.planTemplateId=u.planTemplateId;const c=p.parameters.filter(v=>v.name.trim()&&v.description.trim()).map(v=>({name:v.name.trim(),description:v.description.trim(),type:"string"}));if(k.value.inputSchema=JSON.stringify(c),console.log("[PublishModal] 更新后的工具信息:",k.value),k.value.id)console.log("[PublishModal] 更新现有工具，ID:",k.value.id),await pe.updateCoordinatorTool(k.value.id,k.value);else{console.log("[PublishModal] 创建新工具");const v=await pe.createCoordinatorTool(k.value);k.value=v}console.log("[PublishModal] 步骤5: 发布工具，ID:",k.value.id);const b=await pe.publishCoordinatorTool(k.value.id);if(console.log("[PublishModal] 发布结果:",b),b.success){if(console.log("[PublishModal] 发布成功"),H.value=b.publishStatus||"PUBLISHED",b.endpointUrl)g.value=b.endpointUrl;else if(k.value.endpoint){const v=window.location.origin;g.value=`${v}/mcp${k.value.endpoint}`}else g.value="";console.log("[PublishModal] 设置状态 - publishStatus:",H.value,"endpointUrl:",g.value),ee(t("mcpService.publishSuccess"),"success"),T("published",k.value)}else throw new Error(b.message)}catch(c){console.error("[PublishModal] 发布MCP服务失败:",c),ee(t("mcpService.publishFailed")+": "+c.message,"error")}finally{F.value=!1}},M=async()=>{if(!F.value){F.value=!0;try{r.value?(console.log("[PublishModal] 取消发布MCP服务"),k.value&&(k.value.publishStatus="UNPUBLISHED",await pe.updateCoordinatorTool(k.value.id,k.value),r.value=!1,g.value="",ee(t("mcpService.unpublishSuccess"),"success"))):(console.log("[PublishModal] 发布MCP服务"),await w(),r.value=!0)}catch(c){console.error("[PublishModal] 发布开关操作失败:",c),ee(t("mcpService.unpublishFailed")+": "+c.message,"error")}finally{F.value=!1}}},l=async()=>{if(!O.value&&confirm(t("mcpService.deleteConfirmMessage"))){if(!k.value||!k.value.id){ee(t("mcpService.deleteFailed")+": "+t("mcpService.selectPlanTemplateFirst"),"error");return}O.value=!0;try{console.log("[PublishModal] 开始删除MCP服务，ID:",k.value.id);const c=await pe.deleteCoordinatorTool(k.value.id);if(c.success)console.log("[PublishModal] 删除成功"),ee(t("mcpService.deleteSuccess"),"success"),_.value=!1,T("published",null);else throw new Error(c.message)}catch(c){console.error("[PublishModal] 删除MCP服务失败:",c),ee(t("mcpService.deleteFailed")+": "+c.message,"error")}finally{O.value=!1}}},s=async()=>{_.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),oe(),await m(),await d())},d=async()=>{if(!u.planTemplateId){console.log("[PublishModal] "+t("mcpService.noPlanTemplateId"));return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",u.planTemplateId);const c=await pe.getOrNewCoordinatorToolsByTemplate(u.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",c),c.success&&c.data){let b;if(Array.isArray(c.data)?(b=c.data[0],console.log("[PublishModal] 使用已存在的工具:",b)):(b=c.data,console.log("[PublishModal] 使用新创建的工具:",b)),k.value=b,H.value=b.publishStatus||"",r.value=b.publishStatus==="PUBLISHED",B.value=!!b.id,b.publishStatus==="PUBLISHED")if(c.endpointUrl)g.value=c.endpointUrl;else if(b.endpoint){const v=window.location.origin;g.value=`${v}/mcp${b.endpoint}`}else g.value="";else g.value="";console.log("[PublishModal] 加载工具数据 - publishStatus:",H.value,"endpointUrl:",g.value),p.serviceName=b.toolName||"",p.userRequest=b.toolDescription||u.planDescription||"",p.endpoint=b.endpoint||"";try{if(b.inputSchema){const v=JSON.parse(b.inputSchema);Array.isArray(v)&&(p.parameters=v.map(z=>({name:z.name||"",description:z.description||""})))}}catch(v){console.warn("[PublishModal] "+t("mcpService.parseInputSchemaFailed")+":",v),p.parameters=[]}console.log("[PublishModal] 表单数据已填充:",p)}else console.log("[PublishModal] 获取协调器工具数据失败:",c.message)}catch(c){console.error("[PublishModal] "+t("mcpService.loadToolDataFailed")+":",c)}};return $e(()=>u.modelValue,s),Ce(async()=>{_.value&&(console.log("[PublishModal] 组件挂载时初始化"),oe(),await m(),await d())}),(c,b)=>(h(),f(de,null,[S(mt,{modelValue:_.value,"onUpdate:modelValue":b[7]||(b[7]=v=>_.value=v),title:te.value,"endpoint-url":g.value,onConfirm:w,class:"wide-modal"},{footer:we(()=>{var v,z;return[e("div",Qt,[B.value&&((v=k.value)!=null&&v.id)?(h(),f("button",{key:0,class:"action-btn danger",onClick:l,disabled:O.value},[O.value?(h(),ie(o(P),{key:0,icon:"carbon:loading",class:"loading-icon"})):(h(),ie(o(P),{key:1,icon:"carbon:trash-can"})),Q(" "+a(O.value?o(t)("mcpService.deleting"):o(t)("mcpService.delete")),1)],8,Zt)):L("",!0),e("button",{class:"action-btn primary",onClick:i,disabled:E.value},[E.value?(h(),ie(o(P),{key:0,icon:"carbon:loading",class:"loading-icon"})):(h(),ie(o(P),{key:1,icon:"carbon:save"})),Q(" "+a(E.value?o(t)("mcpService.saving"):o(t)("mcpService.save")),1)],8,Yt),B.value&&((z=k.value)!=null&&z.id)?(h(),f("div",en,[e("div",{class:"publish-toggle",onClick:M},[e("div",{class:ne(["toggle-track",{"toggle-on":r.value,"toggle-off":!r.value}])},[e("div",{class:ne(["toggle-thumb",{"thumb-on":r.value,"thumb-off":!r.value}])},null,2),e("span",{class:ne(["toggle-label",{"label-on":r.value,"label-off":!r.value}])},a(r.value?o(t)("mcpService.published"):o(t)("mcpService.unpublished")),3)],2)])])):L("",!0)])]}),default:we(()=>[e("div",kt,[e("div",St,[e("div",{class:ne(["endpoint-url-row",{"single-item":!r.value}])},[e("div",$t,[e("label",null,a(o(t)("mcpService.endpointRequired")),1),e("div",Pt,[e("div",Ct,[e("div",yt,[e("div",Tt,[e("div",wt,[S(o(P),{icon:"carbon:application",width:"16",class:"input-icon"}),ae(e("input",{type:"text","onUpdate:modelValue":b[0]||(b[0]=v=>p.endpoint=v),placeholder:o(t)("mcpService.endpointPlaceholder"),class:"select-input",onFocus:b[1]||(b[1]=v=>D.value=!0),onInput:se,onKeydown:it(le,["enter"]),onBlur:ge},null,40,Et),[[ce,p.endpoint]])]),e("button",{class:"select-arrow-btn",onClick:I,title:"展开选项"},[S(o(P),{icon:D.value?"carbon:chevron-up":"carbon:chevron-down",width:"14",class:"chevron"},null,8,["icon"])])]),D.value?(h(),f("div",{key:0,class:ne(["select-dropdown",{"dropdown-top":Z.value==="top"}])},[e("div",It,[e("span",null,a(o(t)("mcpService.selectEndpoint")),1),e("button",{class:"close-btn",onClick:b[2]||(b[2]=v=>D.value=!1)},[S(o(P),{icon:"carbon:close",width:"12"})])]),e("div",Dt,[(h(!0),f(de,null,_e(W.value,v=>(h(),f("button",{key:v,class:ne(["select-option",{active:p.endpoint===v}]),onClick:z=>N(v)},[e("span",Rt,a(v),1),p.endpoint===v?(h(),ie(o(P),{key:0,icon:"carbon:checkmark",width:"14",class:"check-icon"})):L("",!0)],10,xt))),128))]),e("div",At,[e("div",Mt,[ae(e("input",{type:"text","onUpdate:modelValue":b[3]||(b[3]=v=>Y.value=v),placeholder:o(t)("mcpService.manualInput"),class:"manual-input",onKeydown:it(x,["enter"]),onBlur:V},null,40,Ut),[[ce,Y.value]]),e("button",{class:"add-manual-btn",onClick:x},[S(o(P),{icon:"carbon:add",width:"14"})])])])],2)):L("",!0),D.value?(h(),f("div",{key:1,class:"backdrop",onClick:b[4]||(b[4]=v=>D.value=!1)})):L("",!0)])])])]),r.value?(h(),f("div",Nt,[e("label",null,a(o(t)("mcpService.mcpStreamableUrl")),1),e("div",Lt,[e("div",{class:"url-display",onDblclick:ke,title:o(t)("mcpService.copyUrl")+": "+g.value},[e("span",qt,a(g.value||o(t)("mcpService.mcpStreamableUrlPlaceholder")),1),S(o(P),{icon:"carbon:copy",width:"16",class:"copy-icon"})],40,Vt)])])):L("",!0)],2)]),e("div",Ft,[e("div",Bt,[e("label",null,a(o(t)("mcpService.toolNameRequired")),1),ae(e("input",{type:"text","onUpdate:modelValue":b[5]||(b[5]=v=>p.serviceName=v),placeholder:o(t)("mcpService.toolNamePlaceholder"),required:"",readonly:"",class:"readonly-input"},null,8,Ot),[[ce,p.serviceName]])])]),e("div",jt,[e("div",Wt,[e("label",null,a(o(t)("mcpService.toolDescriptionRequired")),1),ae(e("textarea",{"onUpdate:modelValue":b[6]||(b[6]=v=>p.userRequest=v),placeholder:o(t)("mcpService.toolDescriptionPlaceholder"),class:"description-field",rows:"3",required:""},null,8,Ht),[[ce,p.userRequest]])])]),e("div",Jt,[e("div",zt,a(o(t)("mcpService.parameterConfig")),1),e("div",Gt,[e("table",null,[e("thead",null,[e("tr",null,[e("th",null,a(o(t)("mcpService.parameterName")),1),e("th",null,a(o(t)("mcpService.parameterDescription")),1)])]),e("tbody",null,[(h(!0),f(de,null,_e(p.parameters,(v,z)=>(h(),f("tr",{key:z},[e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":J=>v.name=J,placeholder:o(t)("mcpService.parameterName"),class:"parameter-input"},null,8,Kt),[[ce,v.name]])]),e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":J=>v.description=J,placeholder:o(t)("mcpService.parameterDescription"),class:"parameter-input"},null,8,Xt),[[ce,v.description]])])]))),128))])])])])])]),_:1},8,["modelValue","title","endpoint-url"]),C.value?(h(),f("div",{key:0,class:"error-toast",onClick:b[8]||(b[8]=v=>C.value="")},[S(o(P),{icon:"carbon:error"}),Q(" "+a(C.value),1)])):L("",!0),U.value?(h(),f("div",{key:1,class:"success-toast",onClick:b[9]||(b[9]=v=>U.value="")},[S(o(P),{icon:"carbon:checkmark"}),Q(" "+a(U.value),1)])):L("",!0)],64))}}),nn=ye(tn,[["__scopeId","data-v-be4dcd13"]]),on={class:"sidebar-content"},sn={class:"sidebar-content-header"},an={class:"sidebar-content-title"},ln={class:"tab-switcher"},cn=["disabled"],rn={key:0,class:"tab-content"},un={class:"new-task-section"},dn={class:"sidebar-content-list"},pn={key:0,class:"loading-state"},hn={key:1,class:"error-state"},vn={key:2,class:"empty-state"},mn=["onClick"],gn={class:"task-icon"},fn={class:"task-details"},bn={class:"task-title"},_n={class:"task-preview"},kn={class:"task-time"},Sn={class:"task-actions"},$n=["title","onClick"],Pn={key:1,class:"tab-content config-tab"},Cn={key:0,class:"config-container"},yn={class:"template-info-header"},Tn={class:"template-info"},wn={class:"template-id"},En={class:"config-section"},In={class:"section-header"},Dn={class:"generator-content"},xn=["placeholder"],Rn={class:"generator-actions"},An=["disabled"],Mn=["disabled"],Un={class:"config-section"},Nn={class:"section-header"},Ln={class:"section-actions"},Vn=["disabled","title"],qn=["disabled","title"],Fn=["disabled"],Bn=["placeholder"],On={class:"config-section"},jn={class:"section-header"},Wn={class:"execution-content"},Hn={class:"params-input-group"},Jn={class:"params-help-text"},zn={class:"params-input-container"},Gn=["placeholder"],Kn=["title"],Xn={class:"api-url-display"},Qn={class:"api-url-label"},Zn={class:"api-url"},Yn={class:"api-url-display"},eo={class:"api-url-label"},to=["disabled"],no=["disabled"],oo=Pe({__name:"index",emits:["planExecutionRequested"],setup(A,{expose:n,emit:t}){const{t:u}=Ee(),T=["currentPlanId","userRequest","rootPlanId"],_=R({enabled:!0,success:!0}),C=be(()=>_.value.enabled),U=async()=>{try{const r=await pe.getCoordinatorToolConfig();_.value=r}catch(r){console.error("加载CoordinatorTool配置失败:",r),_.value={enabled:!0,success:!1,message:r instanceof Error?r.message:"Unknown error"}}},F=be({get(){try{if(!$.jsonContent)return"";const p={...JSON.parse($.jsonContent)};return T.forEach(te=>{delete p[te]}),JSON.stringify(p,null,2)}catch{return $.jsonContent}},set(r){try{if(!r.trim()){$.jsonContent="";return}const p=JSON.parse(r);let te={};try{te=JSON.parse($.jsonContent||"{}")}catch{}const oe={...p};T.forEach(m=>{te[m]!==void 0&&(oe[m]=te[m])}),$.jsonContent=JSON.stringify(oe)}catch{$.jsonContent=r}}}),E=t,O=async()=>{try{const r=await $.saveTemplate();r!=null&&r.duplicate?alert(u("sidebar.saveCompleted",{message:r.message,versionCount:r.versionCount})):r!=null&&r.saved?alert(u("sidebar.saveSuccess",{message:r.message,versionCount:r.versionCount})):r!=null&&r.message&&alert(u("sidebar.saveStatus",{message:r.message}))}catch(r){console.error("Failed to save plan modifications:",r),alert(r.message||u("sidebar.saveFailed"))}},W=async()=>{var r;try{await $.generatePlan(),alert(u("sidebar.generateSuccess",{templateId:((r=$.selectedTemplate)==null?void 0:r.id)??u("sidebar.unknown")}))}catch(p){console.error("Failed to generate plan:",p),alert(u("sidebar.generateFailed")+": "+p.message)}},H=async()=>{try{await $.updatePlan(),alert(u("sidebar.updateSuccess"))}catch(r){console.error("Failed to update plan:",r),alert(u("sidebar.updateFailed")+": "+r.message)}},g=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const r=$.preparePlanExecution();if(!r){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",r),console.log("[Sidebar] Emitting planExecutionRequested event"),E("planExecutionRequested",r),console.log("[Sidebar] Event emitted")}catch(r){console.error("Error executing plan:",r),alert(u("sidebar.executeFailed")+": "+r.message)}finally{$.finishPlanExecution()}},D=R(!1),Z=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",$.currentPlanTemplateId),!$.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert(u("mcpService.selectPlanTemplateFirst"));return}console.log("[Sidebar] 打开发布MCP服务模态框"),D.value=!0},Y=r=>{r===null?console.log("MCP服务删除成功"):console.log("MCP服务发布成功:",r)},k=r=>{if(isNaN(r.getTime()))return console.warn("Invalid date received:",r),u("time.unknown");const te=new Date().getTime()-r.getTime(),oe=Math.floor(te/6e4),m=Math.floor(te/36e5),I=Math.floor(te/864e5);return oe<1?u("time.now"):oe<60?u("time.minuteAgo",{count:oe}):m<24?u("time.hourAgo",{count:m}):I<30?u("time.dayAgo",{count:I}):r.toLocaleDateString("zh-CN")},B=(r,p)=>!r||r.length<=p?r:r.substring(0,p)+"...";return Ce(()=>{$.loadPlanTemplateList(),U()}),n({loadPlanTemplateList:$.loadPlanTemplateList,toggleSidebar:$.toggleSidebar,currentPlanTemplateId:$.currentPlanTemplateId}),(r,p)=>{var te,oe;return h(),f(de,null,[e("div",{class:ne(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o($).isCollapsed}])},[e("div",on,[e("div",sn,[e("div",an,a(r.$t("sidebar.title")),1)]),e("div",ln,[e("button",{class:ne(["tab-button",{active:o($).currentTab==="list"}]),onClick:p[0]||(p[0]=m=>o($).switchToTab("list"))},[S(o(P),{icon:"carbon:list",width:"16"}),Q(" "+a(r.$t("sidebar.templateList")),1)],2),e("button",{class:ne(["tab-button",{active:o($).currentTab==="config"}]),onClick:p[1]||(p[1]=m=>o($).switchToTab("config")),disabled:!o($).selectedTemplate},[S(o(P),{icon:"carbon:settings",width:"16"}),Q(" "+a(r.$t("sidebar.configuration")),1)],10,cn)]),o($).currentTab==="list"?(h(),f("div",rn,[e("div",un,[e("button",{class:"new-task-btn",onClick:p[2]||(p[2]=m=>o($).createNewTemplate())},[S(o(P),{icon:"carbon:add",width:"16"}),Q(" "+a(r.$t("sidebar.newPlan"))+" ",1),p[12]||(p[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",dn,[o($).isLoading?(h(),f("div",pn,[S(o(P),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,a(r.$t("sidebar.loading")),1)])):o($).errorMessage?(h(),f("div",hn,[S(o(P),{icon:"carbon:warning",width:"20"}),e("span",null,a(o($).errorMessage),1),e("button",{onClick:p[3]||(p[3]=(...m)=>o($).loadPlanTemplateList&&o($).loadPlanTemplateList(...m)),class:"retry-btn"},a(r.$t("sidebar.retry")),1)])):o($).planTemplateList.length===0?(h(),f("div",vn,[S(o(P),{icon:"carbon:document",width:"32"}),e("span",null,a(r.$t("sidebar.noTemplates")),1)])):(h(!0),f(de,{key:3},_e(o($).sortedTemplates,m=>(h(),f("div",{key:m.id,class:ne(["sidebar-content-list-item",{"sidebar-content-list-item-active":m.id===o($).currentPlanTemplateId}]),onClick:I=>o($).selectTemplate(m)},[e("div",gn,[S(o(P),{icon:"carbon:document",width:"20"})]),e("div",fn,[e("div",bn,a(m.title||r.$t("sidebar.unnamedPlan")),1),e("div",_n,a(B(m.description||r.$t("sidebar.noDescription"),40)),1)]),e("div",kn,a(k(o($).parseDateTime(m.updateTime||m.createTime))),1),e("div",Sn,[e("button",{class:"delete-task-btn",title:r.$t("sidebar.deleteTemplate"),onClick:me(I=>o($).deleteTemplate(m),["stop"])},[S(o(P),{icon:"carbon:close",width:"16"})],8,$n)])],10,mn))),128))])])):o($).currentTab==="config"?(h(),f("div",Pn,[o($).selectedTemplate?(h(),f("div",Cn,[e("div",yn,[e("div",Tn,[e("h3",null,a(o($).selectedTemplate.title||r.$t("sidebar.unnamedPlan")),1),e("span",wn,"ID: "+a(o($).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:p[4]||(p[4]=m=>o($).switchToTab("list"))},[S(o(P),{icon:"carbon:arrow-left",width:"16"})])]),e("div",En,[e("div",In,[S(o(P),{icon:"carbon:generate",width:"16"}),e("span",null,a(r.$t("sidebar.planGenerator")),1)]),e("div",Dn,[ae(e("textarea",{"onUpdate:modelValue":p[5]||(p[5]=m=>o($).generatorPrompt=m),class:"prompt-input",placeholder:r.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,xn),[[ce,o($).generatorPrompt]]),e("div",Rn,[e("button",{class:"btn btn-primary btn-sm",onClick:W,disabled:o($).isGenerating||!o($).generatorPrompt.trim()},[S(o(P),{icon:o($).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ne({spinning:o($).isGenerating})},null,8,["icon","class"]),Q(" "+a(o($).isGenerating?r.$t("sidebar.generating"):r.$t("sidebar.generatePlan")),1)],8,An),e("button",{class:"btn btn-secondary btn-sm",onClick:H,disabled:o($).isGenerating||!o($).generatorPrompt.trim()||!o($).jsonContent.trim()},[S(o(P),{icon:"carbon:edit",width:"14"}),Q(" "+a(r.$t("sidebar.updatePlan")),1)],8,Mn)])])]),e("div",Un,[e("div",Nn,[S(o(P),{icon:"carbon:code",width:"16"}),e("span",null,a(r.$t("sidebar.jsonTemplate")),1),e("div",Ln,[e("button",{class:"btn btn-sm",onClick:p[6]||(p[6]=(...m)=>o($).rollbackVersion&&o($).rollbackVersion(...m)),disabled:!o($).canRollback,title:r.$t("sidebar.rollback")},[S(o(P),{icon:"carbon:undo",width:"14"})],8,Vn),e("button",{class:"btn btn-sm",onClick:p[7]||(p[7]=(...m)=>o($).restoreVersion&&o($).restoreVersion(...m)),disabled:!o($).canRestore,title:r.$t("sidebar.restore")},[S(o(P),{icon:"carbon:redo",width:"14"})],8,qn),e("button",{class:"btn btn-primary btn-sm",onClick:O,disabled:o($).isGenerating||o($).isExecuting},[S(o(P),{icon:"carbon:save",width:"14"})],8,Fn)])]),ae(e("textarea",{"onUpdate:modelValue":p[8]||(p[8]=m=>F.value=m),class:"json-editor",placeholder:r.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Bn),[[ce,F.value]])]),e("div",On,[e("div",jn,[S(o(P),{icon:"carbon:play",width:"16"}),e("span",null,a(r.$t("sidebar.executionController")),1)]),e("div",Wn,[e("div",Hn,[e("label",null,a(r.$t("sidebar.executionParams")),1),e("div",Jn,a(r.$t("sidebar.executionParamsHelp")),1),e("div",zn,[ae(e("input",{"onUpdate:modelValue":p[9]||(p[9]=m=>o($).executionParams=m),class:"params-input",placeholder:r.$t("sidebar.executionParamsPlaceholder")},null,8,Gn),[[ce,o($).executionParams]]),e("button",{class:"clear-params-btn",onClick:p[10]||(p[10]=(...m)=>o($).clearExecutionParams&&o($).clearExecutionParams(...m)),title:r.$t("sidebar.clearParams")},[S(o(P),{icon:"carbon:close",width:"12"})],8,Kn)])]),e("div",Xn,[e("span",Qn,a(r.$t("sidebar.apiUrl"))+":",1),e("code",Zn,a(o($).computedApiUrl),1)]),e("div",Yn,[e("span",eo,a(r.$t("sidebar.statusApiUrl"))+":",1),p[13]||(p[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:g,disabled:o($).isExecuting||o($).isGenerating},[S(o(P),{icon:o($).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ne({spinning:o($).isExecuting})},null,8,["icon","class"]),Q(" "+a(o($).isExecuting?r.$t("sidebar.executing"):r.$t("sidebar.executePlan")),1)],8,to),C.value?(h(),f("button",{key:0,class:"btn publish-mcp-btn",onClick:Z,disabled:!o($).currentPlanTemplateId},[S(o(P),{icon:"carbon:application",width:"16"}),Q(" "+a(o(u)("sidebar.publishMcpService")),1)],8,no)):L("",!0)])])])):L("",!0)])):L("",!0)])],2),S(nn,{modelValue:D.value,"onUpdate:modelValue":p[11]||(p[11]=m=>D.value=m),"plan-template-id":o($).currentPlanTemplateId||"","plan-title":((te=o($).selectedTemplate)==null?void 0:te.title)||"","plan-description":((oe=o($).selectedTemplate)==null?void 0:oe.description)||"",onPublished:Y},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),so=ye(oo,[["__scopeId","data-v-f134656c"]]);class Fe{static async sendMessage(n){return bt.withLlmCheck(async()=>{const t=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n})});if(!t.ok)throw new Error(`API request failed: ${t.status}`);return await t.json()})}}fe(Fe,"BASE_URL","/api/executor");class Be{static async getDetails(n){try{const t=await fetch(`${this.BASE_URL}/details/${n}`);if(t.status===404)return null;if(!t.ok){const _=await t.text();throw new Error(`Failed to get detailed information: ${t.status} - ${_}`)}const u=await t.text(),T=JSON.parse(u);return T&&typeof T=="object"&&!T.currentPlanId&&(T.currentPlanId=n),T}catch(t){return console.error("[CommonApiService] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to save, please retry"}}}static async submitFormInput(n,t){const u=await fetch(`${this.BASE_URL}/submit-input/${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!u.ok){let _;try{_=await u.json()}catch{_={message:`Failed to submit form input: ${u.status}`}}throw new Error(_.message||`Failed to submit form input: ${u.status}`)}const T=u.headers.get("content-type");return T&&T.indexOf("application/json")!==-1?await u.json():{success:!0}}static async getAllPrompts(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get Prompt list:",n),n}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}fe(Be,"BASE_URL","/api/executor");const Te=class Te{constructor(){fe(this,"POLL_INTERVAL",5e3);fe(this,"state",qe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));fe(this,"callbacks",{});fe(this,"planExecutionCache",new Map);fe(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(n){return this.planExecutionCache.get(n)}getCachedUIState(n){return this.uiStateCache.get(n)}setCachedUIState(n,t){this.uiStateCache.set(n,t),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${n}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(n){return this.planExecutionCache.has(n)}setCachedPlanRecord(n,t){this.planExecutionCache.set(n,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n}`)}clearCachedPlanRecord(n){const t=this.planExecutionCache.delete(n);return t&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${n}`),t}clearAllCachedRecords(){const n=this.planExecutionCache.size,t=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${n}, UI States: ${t}`)}static getInstance(){return Te.instance||(Te.instance=new Te),Te.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(n){this.callbacks={...this.callbacks,...n},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(n))}async handleUserMessageSendRequested(n){if(this.validateAndPrepareUIForNewRequest(n))try{if(await this.sendUserMessageAndSetPlanId(n),this.state.activePlanId)this.initiatePlanExecutionSequence(n,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(t){console.error("[PlanExecutionManager] Failed to send user message:",t);const u=this.state.activePlanId??"error";this.setCachedUIState(u,{enabled:!0}),this.emitChatInputUpdateState(u),this.state.activePlanId=null}}handlePlanExecutionRequested(n,t){console.log("[PlanExecutionManager] Received plan execution request:",{planId:n,query:t}),n?(this.state.activePlanId=n,this.initiatePlanExecutionSequence(t??"执行计划",n)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(n,t){const u=this.getCachedPlanRecord(n);return u!=null&&u.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${n}`),this.handlePlanExecutionRequested(u.currentPlanId,t),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${n}`),!1)}validateAndPrepareUIForNewRequest(n){if(!n)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const t=this.state.activePlanId??"ui-state";return this.setCachedUIState(t,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(t),!0}async sendUserMessageAndSetPlanId(n){try{const t=await Fe.sendMessage(n);if(t!=null&&t.planId)return this.state.activePlanId=t.planId,t;if(t!=null&&t.planTemplateId)return this.state.activePlanId=t.planTemplateId,{...t,planId:t.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",t),new Error("Failed to get valid planId from API response")}catch(t){throw console.error("[PlanExecutionManager] API call failed:",t),t}}initiatePlanExecutionSequence(n,t){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${n}", planId: ${t}`);const u=t;this.emitDialogRoundStart(u),this.startPolling()}handlePlanCompletion(n){this.emitPlanCompleted(n.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}n.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(n.rootPlanId??""))}handlePlanError(n){this.emitPlanError(n.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const n=await this.getPlanDetails(this.state.activePlanId);if(!n){console.warn("[PlanExecutionManager] No details received from API");return}if(n.status&&n.status==="failed"){this.handlePlanError(n);return}if(n.rootPlanId&&this.setCachedPlanRecord(n.rootPlanId,n),!n.steps||n.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(n.rootPlanId??""),this.handlePlanCompletion(n);return}this.emitPlanUpdate(n.rootPlanId??""),n.completed&&this.handlePlanCompletion(n)}catch(n){console.error("[PlanExecutionManager] Failed to poll plan status:",n)}finally{this.state.isPolling=!1}}}async getPlanDetails(n){try{const t=await Be.getDetails(n);return t!=null&&t.rootPlanId&&(this.planExecutionCache.set(t.rootPlanId,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t.rootPlanId}`)),t}catch(t){return console.error("[PlanExecutionManager] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(n){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(n)}emitDialogRoundStart(n){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(n)}emitPlanUpdate(n){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(n)}emitPlanCompleted(n){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(n)}emitPlanError(n){this.callbacks.onPlanError&&this.callbacks.onPlanError(n)}};fe(Te,"instance",null);let Ve=Te;const ue=Ve.getInstance(),ao={class:"right-panel"},lo={class:"preview-header"},io={class:"preview-tabs"},co={class:"tab-button active"},ro={class:"preview-content"},uo={class:"step-details"},po={key:0,class:"step-info-fixed"},ho={key:0,class:"agent-info"},vo={class:"info-item"},mo={class:"label"},go={class:"value"},fo={class:"info-item"},bo={class:"label"},_o={class:"value"},ko={class:"info-item"},So={class:"label"},$o={class:"value"},Po={class:"info-item"},Co={class:"label"},yo={class:"value"},To={class:"info-item"},wo={class:"label"},Eo={class:"execution-status"},Io={class:"status-item"},Do={class:"status-text"},xo={key:0},Ro={key:0,class:"think-act-steps"},Ao={class:"steps-container"},Mo={class:"step-header"},Uo={class:"step-number"},No={class:"think-section"},Lo={class:"think-content"},Vo={class:"input"},qo={class:"label"},Fo={class:"output"},Bo={class:"label"},Oo={key:0,class:"action-section"},jo={class:"action-content"},Wo={class:"tool-info"},Ho={class:"label"},Jo={class:"value"},zo={class:"input"},Go={class:"label"},Ko={class:"output"},Xo={class:"label"},Qo={key:0,class:"sub-plan-section"},Zo={class:"sub-plan-content"},Yo={class:"sub-plan-header"},es={class:"sub-plan-info"},ts={class:"value"},ns={key:0,class:"sub-plan-info"},os={class:"value"},ss={class:"sub-plan-status"},as={class:"status-text"},ls={key:0,class:"no-steps-message"},is={key:1,class:"no-execution-message"},cs={class:"step-basic-info"},rs={class:"info-item"},us={class:"label"},ds={class:"value"},ps={key:0,class:"info-item"},hs={class:"value"},vs={class:"info-item"},ms={class:"no-execution-hint"},gs={key:2,class:"execution-indicator"},fs={class:"execution-text"},bs={key:1,class:"no-selection"},_s=["title"],ks=Pe({__name:"index",setup(A,{expose:n}){const{t}=Ee(),u=R(),T=R(),_=R(),C=R(null),U=R(!1),F=R(!0),E=R(!0),O=be(()=>_.value?_.value.completed?t("rightPanel.status.completed"):_.value.current?t("rightPanel.status.executing"):t("rightPanel.status.waiting"):""),W=m=>{var j;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${m}`),_.value&&C.value){const N=C.value.rootPlanId??T.value;if(N&&N!==m){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${N}, Requested: ${m}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${m}`);const I=ue.getCachedPlanRecord(m);if(!I){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${m}`);return}if(I.steps&&I.steps.length>0){const N=I.steps.length,x=(I.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${x} / ${N}`)}if(_.value&&T.value&&(T.value===m||((j=C.value)==null?void 0:j.rootPlanId)===m)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${m}`),C.value)){const x=C.value,V=g(x.planId,x.rootPlanId,x.subPlanId);V?(D(V,x.stepIndex,x.planId,x.isSubPlan),r()):console.warn("[RightPanel] Could not find plan record for refresh:",x)}},H=(m,I,j,N,x)=>{console.log("[RightPanel] Step selected:",{planId:m,stepIndex:I,rootPlanId:j,subPlanId:N,subStepIndex:x});const V=!!(j&&N&&x!==void 0);C.value={planId:m,stepIndex:I,isSubPlan:V,...V&&{rootPlanId:j,subPlanId:N,subStepIndex:x}};const se=g(m,j,N);if(!se){console.warn("[RightPanel] Plan data not found:",{planId:m,rootPlanId:j,subPlanId:N}),_.value=null,C.value=null;return}D(se,I,m,V)},g=(m,I,j)=>{var V;if(!I||!j)return ue.getCachedPlanRecord(m)??null;const N=ue.getCachedPlanRecord(m);if(N)return N;const x=ue.getCachedPlanRecord(I);if(!(x!=null&&x.agentExecutionSequence))return null;for(const se of x.agentExecutionSequence)if(se.thinkActSteps){for(const le of se.thinkActSteps)if(((V=le.subPlanExecutionRecord)==null?void 0:V.currentPlanId)===j)return le.subPlanExecutionRecord}return null},D=(m,I,j,N)=>{var ke,ee,y,i,w;if(!m.steps||I>=m.steps.length){_.value=null,C.value=null,console.warn("[RightPanel] Invalid step data:",{planId:j,stepIndex:I,hasSteps:!!m.steps,stepsLength:(ke=m.steps)==null?void 0:ke.length,message:"Invalid step index"});return}T.value=j;const x=m.steps[I],V=(ee=m.agentExecutionSequence)==null?void 0:ee[I];console.log("[RightPanel] Step data details:",{planId:j,stepIndex:I,step:x,hasAgentExecutionSequence:!!m.agentExecutionSequence,agentExecutionSequenceLength:(y=m.agentExecutionSequence)==null?void 0:y.length,agentExecution:V,hasThinkActSteps:!!(V!=null&&V.thinkActSteps),thinkActStepsLength:(i=V==null?void 0:V.thinkActSteps)==null?void 0:i.length,isSubPlan:N});const se=(V==null?void 0:V.status)==="FINISHED",le=!se&&I===m.currentStepIndex&&!m.completed,ge={planId:j,index:I,title:typeof x=="string"?x:x.title||x.description||x.name||`${N?"子":""}步骤 ${I+1}`,description:typeof x=="string"?x:x.description||x,completed:se,current:le};V&&(ge.agentExecution=V),_.value=ge,console.log("[RightPanel] Step details updated:",{planId:j,stepIndex:I,stepTitle:_.value.title,hasAgentExecution:!!V,hasThinkActSteps:(((w=V==null?void 0:V.thinkActSteps)==null?void 0:w.length)??0)>0,completed:se,current:le,planCurrentStep:m.currentStepIndex,planCompleted:m.completed,isSubPlan:N}),V!=null&&V.thinkActSteps&&V.thinkActSteps.forEach((M,l)=>{M.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${l}:`,M.subPlanExecutionRecord)}),setTimeout(()=>{k()},100),r()},Z=(m,I,j,N)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:m,subPlanId:I,stepIndex:j,subStepIndex:N}),H(I,N,m,I,N)},Y=m=>{u.value=m??void 0},k=()=>{if(!u.value)return;const{scrollTop:m,scrollHeight:I,clientHeight:j}=u.value,N=I-m-j<50,x=I>j;F.value=N,U.value=x&&!N,N?E.value=!0:I-m-j>100&&(E.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:m,scrollHeight:I,clientHeight:j,isAtBottom:N,hasScrollableContent:x,showButton:U.value,shouldAutoScroll:E.value})},B=()=>{u.value&&(u.value.scrollTo({top:u.value.scrollHeight,behavior:"smooth"}),re(()=>{E.value=!0,k()}))},r=()=>{!E.value||!u.value||re(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},p=m=>{if(m===null||typeof m>"u"||m==="")return"N/A";try{const I=typeof m=="object"?m:JSON.parse(m);return JSON.stringify(I,null,2)}catch{return String(m)}},te=()=>{_.value=null,T.value=void 0,E.value=!0,u.value&&u.value.removeEventListener("scroll",k)},oe=()=>{const m=()=>{const I=u.value;return I?(Y(I),I.addEventListener("scroll",k),E.value=!0,k(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};re(()=>{m()||setTimeout(()=>{m()},100)})};return Ce(()=>{console.log("[RightPanel] Component mounted"),re(()=>{oe()})}),Re(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),C.value=null,te()}),n({updateDisplayedPlanProgress:W,handleStepSelected:H,handleSubPlanStepSelected:Z}),(m,I)=>{var j,N;return h(),f("div",ao,[e("div",lo,[e("div",io,[e("button",co,[S(o(P),{icon:"carbon:events"}),Q(" "+a(o(t)("rightPanel.stepExecutionDetails")),1)])])]),e("div",ro,[e("div",uo,[_.value?(h(),f("div",po,[e("h3",null,a(_.value.title||_.value.description||o(t)("rightPanel.defaultStepTitle",{number:_.value.index+1})),1),_.value.agentExecution?(h(),f("div",ho,[e("div",vo,[e("span",mo,a(o(t)("rightPanel.executingAgent"))+":",1),e("span",go,a(_.value.agentExecution.agentName),1)]),e("div",fo,[e("span",bo,a(o(t)("rightPanel.description"))+":",1),e("span",_o,a(_.value.agentExecution.agentDescription||""),1)]),e("div",ko,[e("span",So,a(o(t)("rightPanel.callingModel"))+":",1),e("span",$o,a(_.value.agentExecution.modelName),1)]),e("div",Po,[e("span",Co,a(o(t)("rightPanel.request"))+":",1),e("span",yo,a(_.value.agentExecution.agentRequest||""),1)]),e("div",To,[e("span",wo,a(o(t)("rightPanel.executionResult"))+":",1),e("span",{class:ne(["value",{success:_.value.agentExecution.status==="FINISHED"}])},a(_.value.agentExecution.status||o(t)("rightPanel.executing")),3)])])):L("",!0),e("div",Eo,[e("div",Io,[_.value.completed?(h(),ie(o(P),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):_.value.current?(h(),ie(o(P),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),ie(o(P),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Do,a(O.value),1)])])])):L("",!0),e("div",{ref_key:"scrollContainer",ref:u,class:"step-details-scroll-container",onScroll:k},[_.value?(h(),f("div",xo,[(j=_.value.agentExecution)!=null&&j.thinkActSteps&&_.value.agentExecution.thinkActSteps.length>0?(h(),f("div",Ro,[e("h4",null,a(o(t)("rightPanel.thinkAndActionSteps")),1),e("div",Ao,[(h(!0),f(de,null,_e(_.value.agentExecution.thinkActSteps,(x,V)=>(h(),f("div",{key:V,class:"think-act-step"},[e("div",Mo,[e("span",Uo,"#"+a(V+1),1),e("span",{class:ne(["step-status",x.status])},a(x.status||o(t)("rightPanel.executing")),3)]),e("div",No,[e("h5",null,[S(o(P),{icon:"carbon:thinking"}),Q(" "+a(o(t)("rightPanel.thinking")),1)]),e("div",Lo,[e("div",Vo,[e("span",qo,a(o(t)("rightPanel.input"))+":",1),e("pre",null,a(p(x.thinkInput)),1)]),e("div",Fo,[e("span",Bo,a(o(t)("rightPanel.output"))+":",1),e("pre",null,a(p(x.thinkOutput)),1)])])]),x.actionNeeded?(h(),f("div",Oo,[e("h5",null,[S(o(P),{icon:"carbon:play"}),Q(" "+a(o(t)("rightPanel.action")),1)]),e("div",jo,[(h(!0),f(de,null,_e(x.actToolInfoList,(se,le)=>(h(),f("div",{key:le},[e("div",Wo,[e("span",Ho,a(o(t)("rightPanel.tool"))+":",1),e("span",Jo,a(se.name||""),1)]),e("div",zo,[e("span",Go,a(o(t)("rightPanel.toolParameters"))+":",1),e("pre",null,a(p(se.parameters)),1)]),e("div",Ko,[e("span",Xo,a(o(t)("rightPanel.executionResult"))+":",1),e("pre",null,a(p(se.result)),1)])]))),128))]),x.subPlanExecutionRecord?(h(),f("div",Qo,[e("h5",null,[S(o(P),{icon:"carbon:tree-view"}),Q(" "+a(o(t)("rightPanel.subPlan")),1)]),e("div",Zo,[e("div",Yo,[e("div",es,[I[0]||(I[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",ts,a(x.subPlanExecutionRecord.currentPlanId),1)]),x.subPlanExecutionRecord.title?(h(),f("div",ns,[I[1]||(I[1]=e("span",{class:"label"},"标题:",-1)),e("span",os,a(x.subPlanExecutionRecord.title),1)])):L("",!0),e("div",ss,[x.subPlanExecutionRecord.completed?(h(),ie(o(P),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),ie(o(P),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",as,a(x.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):L("",!0)])):L("",!0)]))),128))]),_.value.agentExecution&&!((N=_.value.agentExecution.thinkActSteps)!=null&&N.length)?(h(),f("div",ls,[e("p",null,a(o(t)("rightPanel.noStepDetails")),1)])):_.value.agentExecution?L("",!0):(h(),f("div",is,[S(o(P),{icon:"carbon:information",class:"info-icon"}),e("h4",null,a(o(t)("rightPanel.stepInfo")),1),e("div",cs,[e("div",rs,[e("span",us,a(o(t)("rightPanel.stepName"))+":",1),e("span",ds,a(_.value.title||_.value.description||`步骤 ${_.value.index+1}`),1)]),_.value.description?(h(),f("div",ps,[I[2]||(I[2]=e("span",{class:"label"},"描述:",-1)),e("span",hs,a(_.value.description),1)])):L("",!0),e("div",vs,[I[3]||(I[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ne(["value",{"status-completed":_.value.completed,"status-current":_.value.current,"status-pending":!_.value.completed&&!_.value.current}])},a(_.value.completed?"已完成":_.value.current?"执行中":"待执行"),3)])]),e("p",ms,a(o(t)("rightPanel.noExecutionInfo")),1)])),_.value.current&&!_.value.completed?(h(),f("div",gs,[I[4]||(I[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",fs,[S(o(P),{icon:"carbon:in-progress",class:"rotating-icon"}),Q(" "+a(o(t)("rightPanel.stepExecuting")),1)])])):L("",!0)])):(h(),f("div",bs,[S(o(P),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,a(o(t)("rightPanel.noStepSelected")),1),e("p",null,a(o(t)("rightPanel.selectStepHint")),1)]))])):L("",!0),S(Ae,{name:"scroll-button"},{default:we(()=>[U.value?(h(),f("button",{key:0,onClick:B,class:"scroll-to-bottom-btn",title:o(t)("rightPanel.scrollToBottom")},[S(o(P),{icon:"carbon:chevron-down"})],8,_s)):L("",!0)]),_:1})],544)])])])}}}),Ss=ye(ks,[["__scopeId","data-v-e90596ce"]]);function $s(){const A=ue,n=be(()=>A.getActivePlanId()),t=be(()=>A.getState()),u=be(()=>t.value.isPolling),T=be(()=>!!n.value),_=(E,O)=>{A.initiatePlanExecutionSequence(E,O)},C=()=>{A.stopPolling()},U=()=>{A.startPolling()},F=()=>{A.cleanup()};return Re(()=>{F()}),{activePlanId:n,state:t,isPolling:u,hasActivePlan:T,startExecution:_,stopPolling:C,startPolling:U,cleanup:F}}const Ps={class:"chat-container"},Cs={class:"message-content"},ys={key:0,class:"user-message"},Ts={key:1,class:"assistant-message"},ws={key:0,class:"thinking-section"},Es={class:"thinking-header"},Is={class:"thinking-avatar"},Ds={class:"thinking-label"},xs={class:"thinking-content"},Rs={key:0,class:"thinking"},As={key:1,class:"progress"},Ms={class:"progress-bar"},Us={class:"progress-text"},Ns={key:2,class:"steps-container"},Ls={class:"steps-title"},Vs=["onClick"],qs={class:"section-header"},Fs={class:"step-icon"},Bs={class:"step-title"},Os={key:0,class:"step-status current"},js={key:1,class:"step-status completed"},Ws={key:2,class:"step-status pending"},Hs={key:0,class:"action-info"},Js={class:"action-description"},zs={class:"action-icon"},Gs={key:0,class:"tool-params"},Ks={class:"param-label"},Xs={class:"param-content"},Qs={key:1,class:"think-details"},Zs={class:"think-header"},Ys={class:"think-label"},ea={class:"think-output"},ta={class:"think-content"},na={key:1,class:"sub-plan-steps"},oa={class:"sub-plan-header"},sa={class:"sub-plan-step-list"},aa=["onClick"],la={class:"sub-step-indicator"},ia={class:"sub-step-icon"},ca={class:"sub-step-number"},ra={class:"sub-step-content"},ua={class:"sub-step-title"},da={key:2,class:"user-input-form-container"},pa={class:"user-input-message"},ha={key:0,class:"form-description"},va=["onSubmit"],ma=["for"],ga=["id","name","onUpdate:modelValue"],fa={key:1,class:"form-group"},ba={for:"form-input-genericInput"},_a=["onUpdate:modelValue"],ka={type:"submit",class:"submit-user-input-btn"},Sa={key:3,class:"default-processing"},$a={class:"processing-indicator"},Pa={class:"response-section"},Ca={class:"response-header"},ya={class:"response-avatar"},Ta={class:"response-name"},wa={class:"response-content"},Ea={key:0,class:"final-response"},Ia=["innerHTML"],Da={key:1,class:"response-placeholder"},xa={class:"typing-indicator"},Ra={class:"typing-text"},Aa={key:0,class:"message assistant"},Ma={class:"message-content"},Ua={class:"assistant-message"},Na={class:"thinking-section"},La={class:"thinking-header"},Va={class:"thinking-avatar"},qa={class:"thinking-label"},Fa={class:"thinking-content"},Ba={class:"default-processing"},Oa={class:"processing-indicator"},ja={class:"response-section"},Wa={class:"response-header"},Ha={class:"response-avatar"},Ja={class:"response-name"},za={class:"response-content"},Ga={class:"response-placeholder"},Ka={class:"typing-indicator"},Xa={class:"typing-text"},Qa=["title"],Za=Pe({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(A,{expose:n,emit:t}){const u=A,T=t,{t:_}=Ee(),C=$s(),U=R(),F=R(!1),E=R([]),O=R(),W=R(!1),H=qe({}),g=(l,s,d)=>{const c={id:Date.now().toString(),type:l,content:s,timestamp:new Date,...d};return l==="assistant"&&!c.thinking&&!c.content&&(c.thinking=_("chat.thinking")),E.value.push(c),c},D=l=>{const s=E.value[E.value.length-1];s.type==="assistant"&&Object.assign(s,l)},Z=async l=>{try{F.value=!0;const s=g("assistant","",{thinking:"正在理解您的请求并准备回复..."}),d=await Fe.sendMessage(l);if(d.planId)console.log("[ChatComponent] Received planId from direct execution:",d.planId),s.planExecution||(s.planExecution={}),s.planExecution.currentPlanId=d.planId,ue.handlePlanExecutionRequested(d.planId,l),delete s.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete s.thinking;const c=Y(d,l);s.content=c}}catch(s){console.error("Direct mode error:",s),D({content:k(s)})}finally{F.value=!1}},Y=(l,s)=>l.result??l.message??l.content??"",k=l=>{const s=(l==null?void 0:l.message)??(l==null?void 0:l.toString())??"未知错误";return s.includes("网络")||s.includes("network")||s.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":s.includes("认证")||s.includes("权限")||s.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":s.includes("格式")||s.includes("参数")||s.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${s}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},B=(l=!1)=>{re(()=>{if(U.value){const s=U.value;(l||s.scrollHeight-s.scrollTop-s.clientHeight<150)&&s.scrollTo({top:s.scrollHeight,behavior:l?"auto":"smooth"})}})},r=()=>{B(!0),W.value=!1},p=()=>{if(U.value){const l=U.value,s=l.scrollHeight-l.scrollTop-l.clientHeight<150;W.value=!s&&E.value.length>0}},te=()=>{U.value&&U.value.addEventListener("scroll",p)},oe=()=>{U.value&&U.value.removeEventListener("scroll",p)},m=l=>{g("user",l),u.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",l):Z(l)},I=(l,s)=>{var b;const d=((b=l.planExecution)==null?void 0:b.agentExecutionSequence)??[];return s<0||s>=d.length?"IDLE":d[s].status??"IDLE"},j=(l,s)=>{var d,c;if(!((d=l.planExecution)!=null&&d.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:l.planExecution.currentPlanId,stepIndex:s,stepTitle:(c=l.planExecution.steps)==null?void 0:c[s]}),T("step-selected",l.planExecution.currentPlanId,s)},N=(l,s)=>{var d;try{const c=(d=l.planExecution)==null?void 0:d.agentExecutionSequence;if(!(c!=null&&c.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const b=c[s];if(!b)return console.log(`[ChatComponent] No agentExecution found for step ${s}`),[];if(!b.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${s}`),[];for(const v of b.thinkActSteps)if(v.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${s}:`,v.subPlanExecutionRecord),(v.subPlanExecutionRecord.steps??[]).map(J=>typeof J=="string"?J:typeof J=="object"&&J!==null&&(J.title||J.description)||"子步骤");return[]}catch(c){return console.warn("[ChatComponent] Error getting sub-plan steps:",c),[]}},x=(l,s,d)=>{var c;try{const b=(c=l.planExecution)==null?void 0:c.agentExecutionSequence;if(!(b!=null&&b.length))return"pending";const v=b[s];if(!v||!v.thinkActSteps)return"pending";let z=null;for(const G of v.thinkActSteps)if(G.subPlanExecutionRecord){z=G.subPlanExecutionRecord;break}if(!z)return"pending";const J=z.currentStepIndex;return z.completed?"completed":J==null?d===0?"current":"pending":d<J?"completed":d===J?"current":"pending"}catch(b){return console.warn("[ChatComponent] Error getting sub-plan step status:",b),"pending"}},V=(l,s,d)=>{var c,b;try{const v=(c=l.planExecution)==null?void 0:c.agentExecutionSequence;if(!(v!=null&&v.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const z=v[s];if(!z){console.warn("[ChatComponent] No agentExecution found for step",s);return}if(!z.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",s);return}let J=null;for(const G of z.thinkActSteps)if(G.subPlanExecutionRecord){J=G.subPlanExecutionRecord;break}if(!(J!=null&&J.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}T("sub-plan-step-selected",((b=l.planExecution)==null?void 0:b.currentPlanId)??"",J.currentPlanId,s,d)}catch(v){console.error("[ChatComponent] Error handling sub-plan step click:",v)}},se=(l,s)=>{var c,b,v,z;if(!((c=l.planExecution)!=null&&c.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",l.planExecution.steps.length,"execution sequence:",((b=s.agentExecutionSequence)==null?void 0:b.length)??0);const d=new Array(l.planExecution.steps.length).fill(null);if((v=s.agentExecutionSequence)!=null&&v.length){const J=Math.min(s.agentExecutionSequence.length,l.planExecution.steps.length);for(let G=0;G<J;G++){const q=s.agentExecutionSequence[G];if((z=q.thinkActSteps)!=null&&z.length){const K=q.thinkActSteps[q.thinkActSteps.length-1];K.actionDescription&&K.toolParameters?(d[G]={actionDescription:K.actionDescription,toolParameters:typeof K.toolParameters=="string"?K.toolParameters:JSON.stringify(K.toolParameters,null,2),thinkInput:K.thinkInput??"",thinkOutput:K.thinkOutput??"",status:s.currentStepIndex!==void 0&&G<s.currentStepIndex?"completed":s.currentStepIndex!==void 0&&G===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${G} action set: ${d[G].actionDescription}`)):(d[G]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:K.thinkInput??"",thinkOutput:K.thinkOutput??"",status:s.currentStepIndex!==void 0&&G===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${G} is thinking`))}else d[G]={actionDescription:s.currentStepIndex!==void 0&&G<s.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:s.currentStepIndex!==void 0&&G<s.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${G} 无执行细节, 状态设为: ${d[G].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");l.stepActions=[...d],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(d.map(J=>J==null?void 0:J.actionDescription))),re(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},le=l=>{console.log("[ChatComponent] Starting dialog round with planId:",l),l&&(E.value.findIndex(d=>{var c;return((c=d.planExecution)==null?void 0:c.currentPlanId)===l&&d.type==="assistant"})===-1?(g("assistant","",{planExecution:{currentPlanId:l},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",l)):console.log("[ChatComponent] Found existing assistant message for planId:",l))},ge=l=>{var v,z,J,G;console.log("[ChatComponent] Processing plan update with rootPlanId:",l);const s=ue.getCachedPlanRecord(l);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",s),console.log("[ChatComponent] Plan steps:",s.steps),console.log("[ChatComponent] Plan completed:",s.completed),!s.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const d=E.value.findIndex(q=>{var K;return((K=q.planExecution)==null?void 0:K.currentPlanId)===s.currentPlanId&&q.type==="assistant"});let c;if(d!==-1)c=E.value[d],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",s.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",s.currentPlanId),console.log("[ChatComponent] Current messages:",E.value.map(K=>{var he;return{type:K.type,planId:(he=K.planExecution)==null?void 0:he.currentPlanId,content:K.content.substring(0,50)}}));let q=-1;for(let K=E.value.length-1;K>=0;K--)if(E.value[K].type==="assistant"){q=K;break}if(q!==-1)c=E.value[q],c.planExecution||(c.planExecution={}),c.planExecution.currentPlanId=s.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",s.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(c.planExecution||(c.planExecution={}),c.planExecution=JSON.parse(JSON.stringify(s)),!s.steps||s.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),s.completed){delete c.thinking;const q=s.summary??s.result??s.message??"处理完成";c.content=ke(q),console.log("[ChatComponent] Set simple response content:",c.content)}else s.title&&(c.thinking=`正在执行: ${s.title}`);return}delete c.thinking;const b=s.steps.map(q=>typeof q=="string"?q:typeof q=="object"&&q!==null&&(q.title||q.description)||"步骤");if(c.planExecution&&(c.planExecution.steps=b),s.agentExecutionSequence&&s.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",s.agentExecutionSequence.length),se(c,s);const q=s.currentStepIndex??0;if(q>=0&&q<s.agentExecutionSequence.length){const he=s.agentExecutionSequence[q].thinkActSteps;if(he&&he.length>0){const Ie=he[he.length-1];if(Ie.thinkOutput){const Ue=Ie.thinkOutput.length>150?Ie.thinkOutput.substring(0,150)+"...":Ie.thinkOutput;c.thinking=`正在思考: ${Ue}`}}}}else if(c.planExecution){const q=c.planExecution.currentStepIndex??0,K=(v=c.planExecution.steps)==null?void 0:v[q],he=typeof K=="string"?K:"";c.thinking=`正在执行: ${he}`}if(s.userInputWaitState&&c.planExecution?(console.log("[ChatComponent] 需要用户输入:",s.userInputWaitState),c.planExecution.userInputWaitState||(c.planExecution.userInputWaitState={}),c.planExecution.userInputWaitState={message:s.userInputWaitState.message??"",formDescription:s.userInputWaitState.formDescription??"",formInputs:((z=s.userInputWaitState.formInputs)==null?void 0:z.map(q=>({label:q.label,value:q.value||""})))??[]},H[J=c.id]??(H[J]={}),c.thinking="等待用户输入..."):(G=c.planExecution)!=null&&G.userInputWaitState&&delete c.planExecution.userInputWaitState,s.completed??s.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete c.thinking;let q="";s.summary?q=s.summary:s.result?q=s.result:q="任务已完成",c.content=ee(q),console.log("[ChatComponent] Updated completed message:",c.content)}re(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},ke=l=>l?l.includes("我")||l.includes("您")||l.includes("您好")||l.includes("可以")?l:l.length<10?`${l}！还有什么需要我帮助的吗？`:l.length<50?`好的，${l}。如果您还有其他问题，请随时告诉我。`:`${l}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",ee=l=>l?`${l}`:"任务已完成！还有什么我可以帮您的吗？",y=l=>{console.log("[ChatComponent] Plan completed with rootPlanId:",l);const s=ue.getCachedPlanRecord(l);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Plan details:",s),s.rootPlanId){const d=E.value.findIndex(c=>{var b;return((b=c.planExecution)==null?void 0:b.currentPlanId)===s.rootPlanId});if(d!==-1){const c=E.value[d];delete c.thinking;let v=s.summary??s.result??"任务已完成";!v.includes("我")&&!v.includes("您")&&(v.includes("成功")||v.includes("完成")?v=`很好！${v}。如果您还有其他需要帮助的地方，请随时告诉我。`:v=`我已经完成了您的请求：${v}`),c.content=v,console.log("[ChatComponent] Updated completed message:",c.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",s.rootPlanId)}},i=l=>{F.value=!1,E.value[E.value.length-1]={id:Date.now().toString(),type:"assistant",content:l,timestamp:new Date}},w=l=>{if(!l)return"";let s=l.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return s=s.replace(/(<br><br>)/g,"</p><p>"),s.includes("</p><p>")&&(s=`<p>${s}</p>`),s},M=async l=>{var s;if(!((s=l.planExecution)!=null&&s.currentPlanId)||!l.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const d={},c=l.planExecution.userInputWaitState.formInputs;c&&c.length>0?Object.entries(H[l.id]).forEach(([v,z])=>{var q;const J=parseInt(v,10),G=((q=c[J])==null?void 0:q.label)||`input_${v}`;d[G]=z}):d.genericInput=l.genericInput??"",console.log("[ChatComponent] 提交用户输入:",d);const b=await Be.submitFormInput(l.planExecution.currentPlanId,d);delete l.planExecution.userInputWaitState,delete l.genericInput,delete H[l.id],C.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",b)}catch(d){console.error("[ChatComponent] 用户输入提交失败:",d),alert(`提交失败: ${(d==null?void 0:d.message)||"未知错误"}`)}};return $e(()=>u.initialPrompt,(l,s)=>{console.log("[ChatComponent] initialPrompt changed from:",s,"to:",l),l&&typeof l=="string"&&l.trim()&&l!==s&&(console.log("[ChatComponent] Processing changed initial prompt:",l),re(()=>{m(l)}))},{immediate:!1}),Ce(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ue.setEventCallbacks({onPlanUpdate:ge,onPlanCompleted:y,onDialogRoundStart:le,onChatInputUpdateState:l=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",l)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:i}),re(()=>{te()}),u.initialPrompt&&typeof u.initialPrompt=="string"&&u.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",u.initialPrompt),re(()=>{m(u.initialPrompt)}))}),Re(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),oe(),O.value&&clearInterval(O.value),C.cleanup(),Object.keys(H).forEach(l=>delete H[l])}),n({handleSendMessage:m,handlePlanUpdate:ge,handlePlanCompleted:y,handleDialogRoundStart:le,addMessage:g,handlePlanError:i}),(l,s)=>(h(),f("div",Ps,[e("div",{class:"messages",ref_key:"messagesRef",ref:U},[(h(!0),f(de,null,_e(E.value,d=>{var c,b,v,z,J,G,q,K,he;return h(),f("div",{key:d.id,class:ne(["message",{user:d.type==="user",assistant:d.type==="assistant"}])},[e("div",Cs,[d.type==="user"?(h(),f("div",ys,a(d.content),1)):(h(),f("div",Ts,[d.thinking||((c=d.planExecution)==null?void 0:c.progress)!==void 0||(((v=(b=d.planExecution)==null?void 0:b.steps)==null?void 0:v.length)??0)>0?(h(),f("div",ws,[e("div",Es,[e("div",Is,[S(o(P),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ds,a(l.$t("chat.thinkingLabel")),1)]),e("div",xs,[d.thinking?(h(),f("div",Rs,[S(o(P),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,a(d.thinking),1)])):L("",!0),((z=d.planExecution)==null?void 0:z.progress)!==void 0?(h(),f("div",As,[e("div",Ms,[e("div",{class:"progress-fill",style:Le({width:d.planExecution.progress+"%"})},null,4)]),e("span",Us,a(d.planExecution.progressText??l.$t("chat.processing")+"..."),1)])):L("",!0),(((G=(J=d.planExecution)==null?void 0:J.steps)==null?void 0:G.length)??0)>0?(h(),f("div",Ns,[e("h4",Ls,a(l.$t("chat.stepExecutionDetails")),1),(h(!0),f(de,null,_e((q=d.planExecution)==null?void 0:q.steps,(Ie,X)=>{var Ue,Oe,je,We,He,Je,ze,Ge,Ke,Xe,Qe,Ze,Ye,et,tt,nt,ot,st,at;return h(),f("div",{key:X,class:ne(["ai-section",{running:I(d,X)==="RUNNING",completed:I(d,X)==="FINISHED",pending:I(d,X)==="IDLE"}]),onClick:me(Se=>j(d,X),["stop"])},[e("div",qs,[e("span",Fs,a(I(d,X)==="FINISHED"?"✓":I(d,X)==="RUNNING"?"▶":"○"),1),e("span",Bs,a(Ie||`${l.$t("chat.step")} ${X+1}`),1),I(d,X)==="RUNNING"?(h(),f("span",Os,a(l.$t("chat.status.executing")),1)):I(d,X)==="FINISHED"?(h(),f("span",js,a(l.$t("chat.status.completed")),1)):(h(),f("span",Ws,a(l.$t("chat.status.pending")),1))]),d.stepActions&&d.stepActions[X]?(h(),f("div",Hs,[e("div",Js,[e("span",zs,a(((Ue=d.stepActions[X])==null?void 0:Ue.status)==="current"?"🔄":((Oe=d.stepActions[X])==null?void 0:Oe.status)==="completed"?"✓":"⏳"),1),e("strong",null,a((je=d.stepActions[X])==null?void 0:je.actionDescription),1)]),(We=d.stepActions[X])!=null&&We.toolParameters?(h(),f("div",Gs,[s[0]||(s[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Ks,a(l.$t("common.parameters"))+":",1),e("pre",Xs,a((He=d.stepActions[X])==null?void 0:He.toolParameters),1)])):L("",!0),(Je=d.stepActions[X])!=null&&Je.thinkOutput?(h(),f("div",Qs,[e("div",Zs,[s[1]||(s[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",Ys,a(l.$t("chat.thinkingOutput"))+":",1)]),e("div",ea,[e("pre",ta,a((ze=d.stepActions[X])==null?void 0:ze.thinkOutput),1)])])):L("",!0)])):L("",!0),((Ge=N(d,X))==null?void 0:Ge.length)>0?(h(),f("div",na,[e("div",oa,[S(o(P),{icon:"carbon:tree-view",class:"sub-plan-icon"}),s[2]||(s[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",sa,[(h(!0),f(de,null,_e(N(d,X),(Se,ve)=>(h(),f("div",{key:`sub-${X}-${ve}`,class:ne(["sub-plan-step-item",{completed:x(d,X,ve)==="completed",current:x(d,X,ve)==="current",pending:x(d,X,ve)==="pending"}]),onClick:me(lt=>V(d,X,ve),["stop"])},[e("div",la,[e("span",ia,a(x(d,X,ve)==="completed"?"✓":x(d,X,ve)==="current"?"▶":"○"),1),e("span",ca,a(ve+1),1)]),e("div",ra,[e("span",ua,a(Se),1),s[3]||(s[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,aa))),128))])])):L("",!0),(Ke=d.planExecution)!=null&&Ke.userInputWaitState&&I(d,X)==="RUNNING"?(h(),f("div",da,[e("p",pa,a(((Qe=(Xe=d.planExecution)==null?void 0:Xe.userInputWaitState)==null?void 0:Qe.message)??l.$t("chat.userInput.message")),1),(Ye=(Ze=d.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&Ye.formDescription?(h(),f("p",ha,a((tt=(et=d.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.formDescription),1)):L("",!0),e("form",{onSubmit:me(Se=>M(d),["prevent"]),class:"user-input-form"},[(ot=(nt=d.planExecution)==null?void 0:nt.userInputWaitState)!=null&&ot.formInputs&&d.planExecution.userInputWaitState.formInputs.length>0?(h(!0),f(de,{key:0},_e((at=(st=d.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:at.formInputs,(Se,ve)=>(h(),f("div",{key:ve,class:"form-group"},[e("label",{for:`form-input-${Se.label.replace(/\W+/g,"_")}`},a(Se.label)+": ",9,ma),ae(e("input",{type:"text",id:`form-input-${Se.label.replace(/\W+/g,"_")}`,name:Se.label,"onUpdate:modelValue":lt=>H[d.id][ve]=lt,class:"form-input"},null,8,ga),[[ce,H[d.id][ve]]])]))),128)):(h(),f("div",fa,[e("label",ba,a(l.$t("common.input"))+":",1),ae(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":Se=>d.genericInput=Se,class:"form-input"},null,8,_a),[[ce,d.genericInput]])])),e("button",ka,a(l.$t("chat.userInput.submit")),1)],40,va)])):L("",!0)],10,Vs)}),128))])):!d.content&&(d.thinking||((K=d.planExecution)==null?void 0:K.progress)!==void 0&&(((he=d.planExecution)==null?void 0:he.progress)??0)<100)?(h(),f("div",Sa,[e("div",$a,[s[4]||(s[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(d.thinking??l.$t("chat.thinkingProcessing")),1)])])):L("",!0)])])):L("",!0),e("div",Pa,[e("div",Ca,[e("div",ya,[S(o(P),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ta,a(l.$t("chat.botName")),1)]),e("div",wa,[d.content?(h(),f("div",Ea,[e("div",{class:"response-text",innerHTML:w(d.content)},null,8,Ia)])):(h(),f("div",Da,[e("div",xa,[s[5]||(s[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Ra,a(l.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),F.value?(h(),f("div",Aa,[e("div",Ma,[e("div",Ua,[e("div",Na,[e("div",La,[e("div",Va,[S(o(P),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",qa,a(l.$t("chat.thinkingLabel")),1)]),e("div",Fa,[e("div",Ba,[e("div",Oa,[s[6]||(s[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(l.$t("chat.thinking")),1)])])])]),e("div",ja,[e("div",Wa,[e("div",Ha,[S(o(P),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ja,a(l.$t("chat.botName")),1)]),e("div",za,[e("div",Ga,[e("div",Ka,[s[7]||(s[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Xa,a(l.$t("chat.thinkingResponse")),1)])])])])])])])):L("",!0)],512),W.value?(h(),f("div",{key:0,class:"scroll-to-bottom-btn",onClick:r,title:l.$t("chat.scrollToBottom")},[S(o(P),{icon:"carbon:chevron-down"})],8,Qa)):L("",!0)]))}}),Ya=ye(Za,[["__scopeId","data-v-46f87864"]]),el={class:"input-area"},tl={class:"input-container"},nl={class:"attach-btn",title:"附加文件"},ol=["placeholder","disabled"],sl=["title"],al=["disabled","title"],ll=Pe({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(A,{expose:n,emit:t}){const{t:u}=Ee(),T=A,_=t,C=R(),U=R(""),F=be(()=>T.placeholder||u("input.placeholder")),E=R(F.value),O=be(()=>!!T.disabled),W=()=>{re(()=>{C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,120)+"px")})},H=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),g())},g=()=>{if(!U.value.trim()||O.value)return;const r=U.value.trim();_("send",r),Z()},D=()=>{_("plan-mode-clicked")},Z=()=>{U.value="",W(),_("clear")},Y=(r,p)=>{p&&(E.value=r?p:u("input.waiting")),_("update-state",r,p)},k=r=>{U.value=r,W()},B=()=>U.value.trim();return $e(()=>T.initialValue,r=>{r&&r.trim()&&(U.value=r,W())},{immediate:!0}),n({clearInput:Z,updateState:Y,setInputValue:k,getQuery:B,focus:()=>{var r;return(r=C.value)==null?void 0:r.focus()}}),Ce(()=>{}),Re(()=>{}),(r,p)=>(h(),f("div",el,[e("div",tl,[e("button",nl,[S(o(P),{icon:"carbon:attachment"})]),ae(e("textarea",{"onUpdate:modelValue":p[0]||(p[0]=te=>U.value=te),ref_key:"inputRef",ref:C,class:"chat-input",placeholder:E.value,disabled:O.value,onKeydown:H,onInput:W},null,40,ol),[[ce,U.value]]),e("button",{class:"plan-mode-btn",title:r.$t("input.planMode"),onClick:D},[S(o(P),{icon:"carbon:document"}),Q(" "+a(r.$t("input.planMode")),1)],8,sl),e("button",{class:"send-button",disabled:!U.value.trim()||O.value,onClick:g,title:r.$t("input.send")},[S(o(P),{icon:"carbon:send-alt"}),Q(" "+a(r.$t("input.send")),1)],8,al)])]))}}),il=ye(ll,[["__scopeId","data-v-639c8b2a"]]);class De{static async getAllCronTasks(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron tasks:",n),n}}static async getCronTaskById(n){try{const t=await fetch(`${this.BASE_URL}/${n}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron task by id:",t),t}}static async createCronTask(n){try{const t=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to create cron task:",t),t}}static async updateCronTask(n,t){try{const u=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(u)).json()}catch(u){throw console.error("Failed to update cron task:",u),u}}static async updateTaskStatus(n,t){try{const u=await fetch(`${this.BASE_URL}/${n}/status?status=${t}`,{method:"PUT"});await this.handleResponse(u)}catch(u){throw console.error("Failed to update task status:",u),u}}static async deleteCronTask(n){try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE"});await this.handleResponse(t)}catch(t){throw console.error("Failed to delete cron task:",t),t}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}fe(De,"BASE_URL","/api/cron-tasks");const xe={validateCronExpression(A){const n=A.trim().split(/\s+/);return n.length>=5&&n.length<=6},formatTime(A){return new Date(A).toLocaleString()},async saveTask(A){try{let n;return A.id?n=await De.updateCronTask(Number(A.id),A):n=await De.createCronTask(A),n}catch(n){throw console.error("Failed to save cron task:",n),n}},async deleteTask(A){try{await De.deleteCronTask(String(A))}catch(n){throw console.error("Failed to delete cron task:",n),n}},async toggleTaskStatus(A){if(!A.id)throw new Error("Task ID is required");const n=A.status===0?1:0;return await De.updateCronTask(Number(A.id),{...A,status:n})},prepareTaskExecution(A){return A.planTemplateId?{useTemplate:!0,planData:{title:A.cronName||"定时任务执行",planData:{id:A.planTemplateId,planTemplateId:A.planTemplateId,planId:A.planTemplateId},params:A.executionParams||void 0}}:{useTemplate:!1,taskContent:A.planDesc||A.cronName||""}}},cl={class:"modal-header"},rl={class:"header-actions"},ul={class:"status-switch"},dl={class:"status-label"},pl={class:"toggle-switch"},hl=["checked"],vl={class:"modal-content"},ml={class:"form-group"},gl={class:"form-label"},fl=["placeholder"],bl={class:"form-group"},_l={class:"form-label"},kl=["placeholder"],Sl={class:"form-help"},$l={class:"form-group"},Pl={class:"form-label"},Cl=["placeholder"],yl={class:"form-group"},Tl={class:"form-label"},wl={class:"template-toggle"},El={key:0,class:"template-selector"},Il={value:""},Dl=["value"],xl={class:"form-help"},Rl={key:0,class:"form-group"},Al={class:"time-info"},Ml={class:"time-label"},Ul={class:"time-value"},Nl={key:1,class:"form-group"},Ll={class:"time-info"},Vl={class:"time-label"},ql={class:"time-value"},Fl={class:"modal-footer"},Bl=["disabled"],Ol=Pe({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(A,{emit:n}){const t=A,u=n,T=R(!1),_=R([]),C=R({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Ce(async()=>{try{const g=await Me.getAllPlanTemplates();g&&g.templates&&(_.value=g.templates.map(D=>({id:D.id,name:D.title||"Unnamed Template"})))}catch(g){console.error("Failed to get template list:",g)}});const F=g=>{g.target===g.currentTarget&&u("update:modelValue",!1)},E=()=>{C.value.linkTemplate=!1,C.value.templateId="",C.value.planTemplateId=""},O=()=>C.value.cronName.trim()?C.value.cronTime.trim()?xe.validateCronExpression(C.value.cronTime)?C.value.planDesc.trim()?C.value.linkTemplate&&!C.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),W=g=>xe.formatTime(g),H=async()=>{var g;if(O()){T.value=!0;try{const D={...C.value,...((g=t.task)==null?void 0:g.id)!==void 0&&{id:t.task.id},cronName:C.value.cronName.trim(),cronTime:C.value.cronTime.trim(),planDesc:C.value.planDesc.trim(),status:C.value.status,planTemplateId:C.value.linkTemplate&&C.value.templateId||""};u("save",D)}finally{T.value=!1}}};return $e(()=>t.task,g=>{if(g){const D=g.templateId||g.planTemplateId||"";C.value={cronName:g.cronName||"",cronTime:g.cronTime||"",planDesc:g.planDesc||"",status:g.status??1,linkTemplate:!!D,templateId:D,planTemplateId:D}}else C.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),$e(()=>t.modelValue,g=>{g||(C.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(g,D)=>(h(),ie(Ne,{to:"body"},[S(Ae,{name:"modal"},{default:we(()=>{var Z,Y,k;return[g.modelValue?(h(),f("div",{key:0,class:"modal-overlay",onClick:F},[e("div",{class:"modal-container",onClick:D[8]||(D[8]=me(()=>{},["stop"]))},[e("div",cl,[e("h3",null,a(g.$t("cronTask.taskDetail")),1),e("div",rl,[e("div",ul,[e("span",dl,a(g.$t("cronTask.taskStatus")),1),e("label",pl,[e("input",{type:"checkbox",checked:C.value.status===0,onChange:D[0]||(D[0]=B=>C.value.status=C.value.status===0?1:0)},null,40,hl),D[9]||(D[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:D[1]||(D[1]=B=>g.$emit("update:modelValue",!1))},[S(o(P),{icon:"carbon:close"})])])]),e("div",vl,[e("form",{onSubmit:me(H,["prevent"]),class:"task-form"},[e("div",ml,[e("label",gl,a(g.$t("cronTask.taskName")),1),ae(e("input",{"onUpdate:modelValue":D[2]||(D[2]=B=>C.value.cronName=B),type:"text",class:"form-input",placeholder:g.$t("cronTask.taskNamePlaceholder"),required:""},null,8,fl),[[ce,C.value.cronName]])]),e("div",bl,[e("label",_l,a(g.$t("cronTask.cronExpression")),1),ae(e("input",{"onUpdate:modelValue":D[3]||(D[3]=B=>C.value.cronTime=B),type:"text",class:"form-input",placeholder:g.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,kl),[[ce,C.value.cronTime]]),e("div",Sl,a(g.$t("cronTask.cronExpressionHelp")),1)]),e("div",$l,[e("label",Pl,a(g.$t("cronTask.taskDescription")),1),ae(e("textarea",{"onUpdate:modelValue":D[4]||(D[4]=B=>C.value.planDesc=B),class:"form-textarea",placeholder:g.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,Cl),[[ce,C.value.planDesc]])]),e("div",yl,[e("label",Tl,a(g.$t("cronTask.planTemplate")),1),e("div",wl,[e("button",{type:"button",class:ne(["template-btn",C.value.linkTemplate?"active":""]),onClick:D[5]||(D[5]=B=>C.value.linkTemplate=!0)},[S(o(P),{icon:"carbon:checkmark"}),Q(" "+a(g.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ne(["template-btn",C.value.linkTemplate?"":"active"]),onClick:E},[S(o(P),{icon:"carbon:close"}),Q(" "+a(g.$t("cronTask.noTemplate")),1)],2)]),C.value.linkTemplate?(h(),f("div",El,[ae(e("select",{"onUpdate:modelValue":D[6]||(D[6]=B=>C.value.templateId=B),class:"form-select"},[e("option",Il,a(g.$t("cronTask.selectTemplate")),1),(h(!0),f(de,null,_e(_.value,B=>(h(),f("option",{key:B.id,value:B.id},a(B.name),9,Dl))),128))],512),[[pt,C.value.templateId]]),e("div",xl,a(g.$t("cronTask.templateHelpText")),1)])):L("",!0)]),(Z=g.task)!=null&&Z.createTime?(h(),f("div",Rl,[e("div",Al,[e("span",Ml,a(g.$t("cronTask.createTime"))+":",1),e("span",Ul,a(W(g.task.createTime)),1)])])):L("",!0),(Y=g.task)!=null&&Y.updateTime?(h(),f("div",Nl,[e("div",Ll,[e("span",Vl,a(g.$t("cronTask.updateTime"))+":",1),e("span",ql,a(W(g.task.updateTime)),1)])])):L("",!0)],32)]),e("div",Fl,[e("button",{type:"button",class:"cancel-btn",onClick:D[7]||(D[7]=B=>g.$emit("update:modelValue",!1))},a(g.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:H,disabled:T.value},[T.value?(h(),ie(o(P),{key:0,icon:"carbon:loading",class:"loading-icon"})):L("",!0),Q(" "+a((k=t.task)!=null&&k.id?g.$t("common.save"):g.$t("common.create")),1)],8,Bl)])])])):L("",!0)]}),_:1})]))}}),jl=ye(Ol,[["__scopeId","data-v-5b32448e"]]),Wl={class:"modal-header"},Hl={class:"header-actions"},Jl={class:"modal-content"},zl={key:0,class:"loading-container"},Gl={key:1,class:"empty-container"},Kl={key:2,class:"task-list"},Xl=["onClick"],Ql={class:"task-main"},Zl={class:"task-info"},Yl={class:"task-header"},ei={class:"task-name"},ti={class:"task-description"},ni={class:"task-time"},oi=["onClick"],si=["onClick","disabled","title"],ai=["onClick","title"],li={class:"dropdown-menu"},ii=["onClick"],ci=["onClick","disabled"],ri=["onClick","disabled"],ui={class:"confirm-header"},di={class:"confirm-content"},pi={class:"confirm-actions"},hi=["disabled"],vi={class:"confirm-header"},mi={class:"confirm-content"},gi={class:"create-options"},fi={class:"option-content"},bi={class:"option-title"},_i={class:"option-desc"},ki={class:"option-content"},Si={class:"option-title"},$i={class:"option-desc"},Pi={class:"confirm-actions"},Ci=Pe({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(A,{emit:n}){const t=ct(),u=rt(),T=gt(),{t:_}=Ee(),C=A,U=n,F=R([]),E=R(!1),O=R(null),W=R(null),H=R(null),g=R(null),D=R(!1),Z=R(null),Y=R(!1),k=R(null),B=R(!1),r=i=>{i.target===i.currentTarget&&U("update:modelValue",!1)},p=async()=>{E.value=!0;try{F.value=await De.getAllCronTasks()}catch(i){console.error("Failed to load cron tasks:",i),T.error(`Failed to load tasks: ${i instanceof Error?i.message:String(i)}`)}finally{E.value=!1}},te=async i=>{O.value=i;try{const w=F.value.find(s=>s.id===i);if(!w){console.error("Task not found:",i);return}U("update:modelValue",!1);const M=Date.now().toString();await t.push({name:"direct",params:{id:M}}),await new Promise(s=>setTimeout(s,100));const l=xe.prepareTaskExecution(w);l.useTemplate&&l.planData?u.emitPlanExecutionRequested(l.planData):l.taskContent&&u.setTask(l.taskContent)}catch(w){console.error("Failed to execute task:",w),T.error(`Execution failed: ${w instanceof Error?w.message:String(w)}`)}finally{O.value=null}},oe=i=>{Z.value={...i},D.value=!0,g.value=null},m=async i=>{try{await xe.saveTask(i),await p(),D.value=!1,T.success("Task saved successfully")}catch(w){console.error("Failed to save task:",w),T.error(`Save failed: ${w instanceof Error?w.message:String(w)}`)}},I=i=>{k.value=i,Y.value=!0},j=async()=>{var i;if((i=k.value)!=null&&i.id){W.value=k.value.id;try{await xe.deleteTask(k.value.id),await p(),Y.value=!1,k.value=null,T.success("Task deleted successfully")}catch(w){console.error("Failed to delete task:",w),T.error(`Delete failed: ${w instanceof Error?w.message:String(w)}`)}finally{W.value=null}}},N=()=>{Y.value=!1,k.value=null},x=i=>{g.value=g.value===i?null:i},V=async i=>{if(i.id){H.value=i.id;try{await xe.toggleTaskStatus(i),await p(),g.value=null,T.success(`Task ${i.status===0?"disabled":"enabled"} successfully`)}catch(w){console.error("Failed to toggle task status:",w),T.error(`Status toggle failed: ${w instanceof Error?w.message:String(w)}`)}finally{H.value=null}}},se=async i=>{try{await navigator.clipboard.writeText(i),T.success("Cron expression copied successfully")}catch(w){T.error(`Copy failed: ${w instanceof Error?w.message:String(w)}`)}},le=()=>{B.value=!0},ge=()=>{B.value=!1;try{U("update:modelValue",!1);const i=_("cronTask.template");u.setTaskToInput(i);const w=Date.now().toString();t.push({name:"direct",params:{id:w}})}catch(i){console.error("Error in createWithJmanus:",i),T.error(`Creation failed: ${i instanceof Error?i.message:String(i)}`)}},ke=()=>{B.value=!1,Z.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},D.value=!0},ee=()=>{B.value=!1},y=i=>{const w=i.target;!w.closest(".action-dropdown")&&!w.closest(".dropdown-menu")&&(g.value=null)};return Ce(()=>{document.addEventListener("click",y,!0)}),Re(()=>{document.removeEventListener("click",y,!0)}),$e(()=>C.modelValue,i=>{i&&p()}),(i,w)=>(h(),f(de,null,[(h(),ie(Ne,{to:"body"},[S(Ae,{name:"modal"},{default:we(()=>[A.modelValue?(h(),f("div",{key:0,class:"modal-overlay",onClick:r},[e("div",{class:"modal-container",onClick:w[3]||(w[3]=me(()=>{},["stop"]))},[e("div",Wl,[e("h3",null,a(i.$t("cronTask.title")),1),e("div",Hl,[e("button",{class:"add-task-btn",onClick:[le,w[0]||(w[0]=me(()=>{},["stop"]))]},[S(o(P),{icon:"carbon:add"}),Q(" "+a(i.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:w[1]||(w[1]=M=>i.$emit("update:modelValue",!1))},[S(o(P),{icon:"carbon:close"})])])]),e("div",Jl,[E.value?(h(),f("div",zl,[S(o(P),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,a(i.$t("common.loading")),1)])):F.value.length===0?(h(),f("div",Gl,[S(o(P),{icon:"carbon:time",class:"empty-icon"}),e("span",null,a(i.$t("cronTask.noTasks")),1)])):(h(),f("div",Kl,[(h(!0),f(de,null,_e(F.value,M=>(h(),f("div",{key:M.id||"",class:"task-item",onClick:l=>oe(M)},[e("div",Ql,[e("div",Zl,[e("div",Yl,[e("div",ei,a(M.cronName),1),e("div",{class:ne(["task-status-badge",M.status===0?"active":"inactive"])},[S(o(P),{icon:M.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,a(M.status===0?i.$t("cronTask.active"):i.$t("cronTask.inactive")),1)],2)]),e("div",ti,a(M.planDesc),1),e("div",ni,[S(o(P),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:me(l=>se(M.cronTime),["stop"])},a(M.cronTime),9,oi)])])]),e("div",{class:"task-actions",onClick:w[2]||(w[2]=me(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:l=>te(M.id),disabled:O.value===M.id,title:i.$t("cronTask.executeOnce")},[S(o(P),{icon:O.value===M.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),Q(" "+a(i.$t("cronTask.executeOnce")),1)],8,si),e("div",{class:ne(["action-dropdown",{active:g.value===M.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:l=>x(M.id),title:i.$t("cronTask.operations")},[S(o(P),{icon:"carbon:overflow-menu-horizontal"}),Q(" "+a(i.$t("cronTask.operations")),1)],8,ai),ae(e("div",li,[e("button",{class:"dropdown-item edit-btn",onClick:l=>oe(M)},[S(o(P),{icon:"carbon:edit"}),Q(" "+a(i.$t("cronTask.edit")),1)],8,ii),e("button",{class:"dropdown-item toggle-btn",onClick:l=>V(M),disabled:H.value===M.id},[S(o(P),{icon:H.value===M.id?"carbon:loading":M.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),Q(" "+a(M.status===0?i.$t("cronTask.disable"):i.$t("cronTask.enable")),1)],8,ci),e("button",{class:"dropdown-item delete-btn",onClick:l=>I(M),disabled:W.value===M.id},[S(o(P),{icon:W.value===M.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Q(" "+a(i.$t("cronTask.delete")),1)],8,ri)],512),[[ht,g.value===M.id]])],2)])],8,Xl))),128))]))])])])):L("",!0)]),_:1})])),S(jl,{modelValue:D.value,"onUpdate:modelValue":w[4]||(w[4]=M=>D.value=M),task:Z.value,onSave:m},null,8,["modelValue","task"]),(h(),ie(Ne,{to:"body"},[S(Ae,{name:"modal"},{default:we(()=>{var M,l,s,d;return[Y.value?(h(),f("div",{key:0,class:"modal-overlay",onClick:N},[e("div",{class:"confirm-modal",onClick:w[5]||(w[5]=me(()=>{},["stop"]))},[e("div",ui,[S(o(P),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,a(i.$t("cronTask.deleteConfirm")),1)]),e("div",di,[e("p",null,a(i.$t("cronTask.deleteConfirmMessage",{taskName:((M=k.value)==null?void 0:M.cronName)||((l=k.value)==null?void 0:l.planDesc)||""})),1)]),e("div",pi,[e("button",{class:"confirm-btn cancel-btn",onClick:N},a(i.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:j,disabled:W.value===((s=k.value)==null?void 0:s.id)},[S(o(P),{icon:W.value===((d=k.value)==null?void 0:d.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Q(" "+a(i.$t("cronTask.delete")),1)],8,hi)])])])):L("",!0)]}),_:1})])),(h(),ie(Ne,{to:"body"},[S(Ae,{name:"modal"},{default:we(()=>[B.value?(h(),f("div",{key:0,class:"modal-overlay",onClick:ee},[e("div",{class:"confirm-modal create-options-modal",onClick:w[6]||(w[6]=me(()=>{},["stop"]))},[e("div",vi,[S(o(P),{icon:"carbon:time",class:"create-icon"}),e("h3",null,a(i.$t("cronTask.createTask")),1)]),e("div",mi,[e("p",null,a(i.$t("cronTask.selectCreateMethod")),1),e("div",gi,[e("button",{class:"create-option-btn jmanus-btn",onClick:ge},[S(o(P),{icon:"carbon:ai-status"}),e("div",fi,[e("span",bi,a(i.$t("cronTask.createWithJmanus")),1),e("span",_i,a(i.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:ke},[S(o(P),{icon:"carbon:edit"}),e("div",ki,[e("span",Si,a(i.$t("cronTask.createManually")),1),e("span",$i,a(i.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Pi,[e("button",{class:"confirm-btn cancel-btn",onClick:ee},a(i.$t("common.cancel")),1)])])])):L("",!0)]),_:1})]))],64))}}),yi=ye(Ci,[["__scopeId","data-v-f31a9ce7"]]),Ti={class:"direct-page"},wi={class:"direct-chat"},Ei={class:"chat-header"},Ii={class:"header-actions"},Di=["title"],xi=["title"],Ri={class:"chat-content"},Ai=["title"],Mi={class:"message-content"},Ui=Pe({__name:"index",setup(A){const n=vt(),t=ct(),u=rt(),{t:T}=Ee(),{message:_}=ft(),C=R(""),U=R(""),F=R(),E=R(),O=R(),W=R(!1),H=R(!1),g=R(null),D=R(!1),Z=R(50),Y=R(!1),k=R(0),B=R(0);Ce(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",u.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",u.hasUnprocessedTask()),ue.setEventCallbacks({onPlanUpdate:i=>{console.log("[Direct] Plan update event received for rootPlanId:",i),m(i)&&(console.log("[Direct] Processing plan update for current rootPlanId:",i),E.value&&typeof E.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",i),E.value.handlePlanUpdate(i)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),F.value&&typeof F.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",i),F.value.updateDisplayedPlanProgress(i)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:i=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",i),!!m(i)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",i),E.value&&typeof E.value.handlePlanCompleted=="function"){const w=ue.getCachedPlanRecord(i);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",w),E.value.handlePlanCompleted(w??{planId:i})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");g.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:i=>{console.log("[Direct] Dialog round start event received for rootPlanId:",i),g.value=i,console.log("[Direct] Set currentRootPlanId to:",i),E.value&&typeof E.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",i),E.value.handleDialogRoundStart(i)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),j()},onChatInputUpdateState:i=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",i),!m(i,!0))return;const w=ue.getCachedUIState(i);w&&x(w.enabled,w.placeholder)},onPlanError:i=>{E.value.handlePlanError(i)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),$.loadPlanTemplateList(),u.hasUnprocessedTask()&&u.currentTask){const i=u.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",i),u.markTaskAsProcessed(),re(()=>{E.value&&typeof E.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",i),E.value.handleSendMessage(i)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),C.value=i)})}else{const i=u.getAndClearTaskToInput();i?(U.value=i,console.log("[Direct] Setting inputOnlyContent for input only:",U.value)):(C.value=n.query.prompt||"",console.log("[Direct] Received task from URL:",C.value),console.log("[Direct] No unprocessed task in store"))}const y=localStorage.getItem("directPanelWidth");y&&(Z.value=parseFloat(y)),console.log("[Direct] Final prompt value:",C.value),U.value&&re(()=>{O.value&&typeof O.value.setInputValue=="function"&&(O.value.setInputValue(U.value),console.log("[Direct] Set input value:",U.value),U.value="")}),window.addEventListener("plan-execution-requested",i=>{console.log("[DirectView] Received plan-execution-requested event:",i.detail),ee(i.detail)})}),$e(()=>u.currentTask,y=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",y),y&&!y.processed){const i=y.prompt;u.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",i),re(()=>{E.value&&typeof E.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",i),E.value.handleSendMessage(i)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),$e(()=>C.value,(y,i)=>{console.log("[Direct] prompt value changed from:",i,"to:",y)},{immediate:!1}),$e(()=>u.taskToInput,y=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",y),y&&y.trim()&&(console.log("[Direct] Setting input value from taskToInput:",y),re(()=>{O.value&&typeof O.value.setInputValue=="function"&&(O.value.setInputValue(y.trim()),console.log("[Direct] Input value set from taskToInput watch:",y.trim()),u.getAndClearTaskToInput())}))},{immediate:!1}),Re(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),g.value=null,ue.cleanup(),document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",te),window.removeEventListener("plan-execution-requested",y=>{ee(y.detail)})});const r=y=>{Y.value=!0,k.value=y.clientX,B.value=Z.value,document.addEventListener("mousemove",p),document.addEventListener("mouseup",te),document.body.style.cursor="col-resize",document.body.style.userSelect="none",y.preventDefault()},p=y=>{if(!Y.value)return;const i=window.innerWidth,M=(y.clientX-k.value)/i*100;let l=B.value+M;l=Math.max(20,Math.min(80,l)),Z.value=l},te=()=>{Y.value=!1,document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",te),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",Z.value.toString())},oe=()=>{Z.value=50,localStorage.setItem("directPanelWidth","50")},m=(y,i=!1)=>!g.value||y===g.value||i&&(y==="ui-state"||y==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",y,"current:",g.value),!1),I=y=>{console.log("[DirectView] Send message from input:",y),E.value&&typeof E.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",y),E.value.handleSendMessage(y)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},j=()=>{console.log("[DirectView] Input cleared"),O.value&&typeof O.value.clear=="function"&&O.value.clear()},N=()=>{console.log("[DirectView] Input focused")},x=(y,i)=>{console.log("[DirectView] Input state updated:",y,i),H.value=!y},V=(y,i)=>{console.log("[DirectView] Step selected:",y,i),F.value&&typeof F.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",y,i),F.value.handleStepSelected(y,i)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},se=(y,i,w,M)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:y,subPlanId:i,stepIndex:w,subStepIndex:M}),F.value&&typeof F.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:y,subPlanId:i,stepIndex:w,subStepIndex:M}),F.value.handleSubPlanStepSelected(y,i,w,M)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},le=()=>{console.log("[DirectView] Plan mode button clicked"),$.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",$.isCollapsed)},ge=()=>{t.push("/home")},ke=()=>{t.push("/configs")},ee=async y=>{var w,M,l,s;if(console.log("[DirectView] Plan execution requested:",y),W.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}W.value=!0;let i=!1;E.value&&typeof E.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",y.title),E.value.addMessage("user",y.title),i=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const d=((w=y.planData)==null?void 0:w.planTemplateId)||((M=y.planData)==null?void 0:M.id)||((l=y.planData)==null?void 0:l.planId);if(!d)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",d,"params:",y.params),console.log("[Direct] About to call PlanActApiService.executePlan");let c;if((s=y.params)!=null&&s.trim()?(console.log("[Direct] Calling executePlan with params:",y.params.trim()),c=await Me.executePlan(d,y.params.trim())):(console.log("[Direct] Calling executePlan without params"),c=await Me.executePlan(d)),console.log("[Direct] Plan execution API response:",c),c.planId)console.log("[Direct] Got planId from response:",c.planId,"starting plan execution"),g.value=c.planId,console.log("[Direct] Set currentRootPlanId to:",c.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ue.handlePlanExecutionRequested(c.planId,y.title);else throw console.error("[Direct] No planId in response:",c),new Error("执行计划失败：未返回有效的计划ID")}catch(d){console.error("[Direct] Plan execution failed:",d),console.error("[Direct] Error details:",{message:d.message,stack:d.stack}),g.value=null,E.value&&typeof E.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),i||E.value.addMessage("user",y.title),E.value.addMessage("assistant",`执行计划失败: ${d.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${d.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),W.value=!1}};return(y,i)=>(h(),f("div",Ti,[e("div",wi,[S(so,{onPlanExecutionRequested:ee}),e("div",{class:"left-panel",style:Le({width:Z.value+"%"})},[e("div",Ei,[e("button",{class:"back-button",onClick:ge},[S(o(P),{icon:"carbon:arrow-left"})]),e("h2",null,a(y.$t("conversation")),1),e("div",Ii,[S(_t),e("button",{class:"config-button",onClick:ke,title:y.$t("direct.configuration")},[S(o(P),{icon:"carbon:settings-adjust",width:"20"})],8,Di),e("button",{class:"cron-task-btn",onClick:i[0]||(i[0]=w=>D.value=!0),title:y.$t("cronTask.title")},[S(o(P),{icon:"carbon:alarm",width:"20"})],8,xi)])]),e("div",Ri,[S(Ya,{ref_key:"chatRef",ref:E,mode:"direct","initial-prompt":C.value||"",onStepSelected:V,onSubPlanStepSelected:se},null,8,["initial-prompt"])]),(h(),ie(il,{key:y.$i18n.locale,ref_key:"inputRef",ref:O,disabled:H.value,placeholder:H.value?o(T)("input.waiting"):o(T)("input.placeholder"),"initial-value":C.value,onSend:I,onClear:j,onFocus:N,onUpdateState:x,onPlanModeClicked:le},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:r,onDblclick:oe,title:y.$t("direct.panelResizeHint")},i[2]||(i[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Ai),S(Ss,{ref_key:"rightPanelRef",ref:F,style:Le({width:100-Z.value+"%"})},null,8,["style"])]),S(yi,{modelValue:D.value,"onUpdate:modelValue":i[1]||(i[1]=w=>D.value=w)},null,8,["modelValue"]),o(_).show?(h(),f("div",{key:0,class:ne(["message-toast",o(_).type])},[e("div",Mi,[e("span",null,a(o(_).text),1)])],2)):L("",!0)]))}}),Wi=ye(Ui,[["__scopeId","data-v-ea79c7eb"]]);export{Wi as default};
