var vt=Object.defineProperty;var mt=(U,n,t)=>n in U?vt(U,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):U[n]=t;var Ce=(U,n,t)=>mt(U,typeof n!="symbol"?n+"":n,t);import{d as we,u as De,c as me,r as x,A as Oe,B as _e,o as Ie,a as h,b as d,F as ve,g as $,f as B,p as Me,h as oe,i as o,t as s,z as pe,e,n as se,w as re,m as ce,C as dt,q as ke,l as ue,y as Fe,j as he,D as xe,E as gt,T as Le,G as ut,H as Ve,I as ft,x as pt,J as bt}from"./index-B8cSE8oG.js";import{I as _,_ as Te}from"./_plugin-vue_export-helper-BgusFk4H.js";import{s as w,P as qe,u as ht}from"./sidebar-ChaiNCfE.js";import{M as $t,u as _t,a as yt}from"./useMessage-Du3HTktx.js";import{L as kt}from"./llm-check-BVkAKrj3.js";import{L as St}from"./index-CXd5qJqj.js";class ye{static async getCoordinatorToolConfig(){try{const n=await fetch(`${this.BASE_URL}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get coordinator tool config: ${n.status}`);return await n.json()}catch(n){return console.error("获取CoordinatorTool配置失败:",n),{enabled:!0,success:!1,message:n.message}}}static async getAllEndpoints(){try{const n=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get endpoints: ${n.status}`);return await n.json()}catch(n){throw console.error("获取endpoints失败:",n),new Error("获取endpoints失败: "+n.message)}}static async getOrNewCoordinatorToolsByTemplate(n){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${n}`);try{const t=await fetch(`${this.BASE_URL}/get-or-new-by-template/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const v=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",v),new Error(`Failed to get coordinator tools: ${t.status} - ${v}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",t),new Error("获取协调器工具失败: "+t.message)}}static async createCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 原始数据:",JSON.stringify(n,null,2)),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const t={id:n.id,toolName:n.toolName,toolDescription:n.toolDescription,inputSchema:n.inputSchema,mcpSchema:n.mcpSchema,planTemplateId:n.planTemplateId,endpoint:n.endpoint,publishStatus:n.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",JSON.stringify(t,null,2));try{const a=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[CoordinatorToolApiService] 响应状态:",a.status),console.log("[CoordinatorToolApiService] 响应状态文本:",a.statusText),!a.ok){const k=await a.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",k),new Error(`Failed to create coordinator tool: ${a.status} - ${k}`)}const v=await a.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",v),v}catch(a){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",a),new Error("创建协调器工具失败: "+a.message)}}static async updateCoordinatorTool(n,t){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 发送的数据:",t),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);const a={id:t.id,toolName:t.toolName,toolDescription:t.toolDescription,inputSchema:t.inputSchema,mcpSchema:t.mcpSchema,planTemplateId:t.planTemplateId,endpoint:t.endpoint,publishStatus:t.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",a);try{const v=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(console.log("[CoordinatorToolApiService] 响应状态:",v.status),console.log("[CoordinatorToolApiService] 响应状态文本:",v.statusText),!v.ok){const u=await v.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",u),new Error(`Failed to update coordinator tool: ${v.status} - ${u}`)}const k=await v.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",k),k}catch(v){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",v),new Error("更新协调器工具失败: "+v.message)}}static async publishCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}/publish`);try{const t=await fetch(`${this.BASE_URL}/${n}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const v=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",v),new Error(`Failed to publish coordinator tool: ${t.status} - ${v}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",t),new Error("发布协调器工具失败: "+t.message)}}static async deleteCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始删除协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const v=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",v),new Error(`Failed to delete coordinator tool: ${t.status} - ${v}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 删除成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 删除协调器工具失败:",t),new Error("删除协调器工具失败: "+t.message)}}}Ce(ye,"BASE_URL","/api/coordinator-tools");const Pt={class:"modal-form"},Ct={class:"form-section"},wt={class:"form-item endpoint-item"},Tt={class:"endpoint-container"},Et={class:"endpoint-row"},It={class:"custom-select"},Dt={class:"select-input-container"},xt={class:"input-content"},Rt=["placeholder"],At={class:"dropdown-header"},Mt={class:"select-options"},Ut=["onClick"],Nt={class:"option-name"},Ft={class:"manual-input-section"},Lt={class:"manual-input-container"},qt=["placeholder"],Bt={key:0,class:"form-item url-item"},Vt={class:"url-container"},jt=["title"],Ot={class:"url-text"},Wt={class:"form-section"},zt={class:"form-item"},Ht=["placeholder"],Jt={class:"form-section"},Gt={class:"form-item"},Kt=["placeholder"],Xt={class:"form-section"},Qt={class:"section-title"},Yt={class:"parameter-table"},Zt=["onUpdate:modelValue","placeholder"],en=["onUpdate:modelValue","placeholder"],tn={class:"button-container"},nn=["disabled"],on=["disabled"],sn={key:1,class:"publish-toggle-container"},an=we({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(U,{emit:n}){const{t}=De(),a=U,v=n,k=me({get:()=>a.modelValue,set:f=>v("update:modelValue",f)}),u=x(""),A=x(""),z=x(!1),D=x(!1),V=x(!1),G=x([]),j=x(""),m=x(""),M=x(!1),X=x("bottom"),ee=x(""),g=x(null),N=x(!1),c=x(!1),I=x(null),R=me(()=>({})),E=Oe({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),F=me(()=>{const f=g.value&&g.value.id;return t(f?"mcpService.updateService":"mcpService.createService")}),ae=()=>{E.serviceName="",E.userRequest=a.planDescription||"",E.endpoint="",E.parameters=[],g.value=null,j.value="",m.value="",N.value=!1,c.value=!1},Se=async()=>{try{G.value=await ye.getAllEndpoints()}catch(f){console.error("加载endpoints失败:",f),l(t("mcpService.loadEndpointsFailed")+": "+f.message,"error")}},fe=()=>{M.value||be(),M.value=!M.value},be=()=>{const f=document.querySelector(".custom-select");if(!f)return;const y=f.getBoundingClientRect(),S=window.innerHeight;y.bottom+200>S?X.value="top":X.value="bottom"},Pe=f=>{E.endpoint=f,M.value=!1,ee.value=""},C=()=>{if(ee.value.trim()){const f=ee.value.trim().replace(/[^a-zA-Z0-9_/]/g,"");f&&(E.endpoint=f,G.value.includes(f)||G.value.push(f),M.value=!1,ee.value="")}},q=()=>{setTimeout(()=>{ee.value.trim()&&C()},200)},Y=()=>{G.value.includes(E.endpoint)&&Pe(E.endpoint)},K=()=>{G.value.includes(E.endpoint)&&Pe(E.endpoint)},L=()=>{G.value.includes(E.endpoint)&&Pe(E.endpoint)},b=async()=>{if(m.value)try{await navigator.clipboard.writeText(m.value),l(t("common.copy")+" "+t("common.success"),"success")}catch(f){console.error("复制失败:",f),l(t("common.copy")+" "+t("common.error"),"error")}},l=(f,y)=>{y==="success"?(A.value=f,setTimeout(()=>{A.value=""},3e3)):y==="error"&&(u.value=f,setTimeout(()=>{u.value=""},5e3))},T=()=>E.serviceName.trim()?E.userRequest.trim()?E.endpoint.trim()?!0:(l(t("mcpService.endpointRequiredError"),"error"),!1):(l(t("mcpService.toolDescriptionRequiredError"),"error"),!1):(l(t("mcpService.toolNameRequiredError"),"error"),!1),O=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",E),console.log("[PublishModal] 当前工具:",g.value),!T()){console.log("[PublishModal] 表单验证失败");return}D.value=!0;try{if(!g.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const S=await ye.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(!S.success)throw new Error(S.message);Array.isArray(S.data)?g.value=S.data[0]:g.value=S.data}console.log("[PublishModal] 更新工具信息"),g.value.toolName=E.serviceName.trim(),g.value.toolDescription=E.userRequest.trim(),g.value.endpoint=E.endpoint.trim(),g.value.planTemplateId=a.planTemplateId;const f=E.parameters.filter(S=>S.name.trim()&&S.description.trim()).map(S=>({name:S.name.trim(),description:S.description.trim(),type:"string"}));g.value.inputSchema=JSON.stringify(f),console.log("[PublishModal] 更新后的工具信息:",g.value);let y;g.value.id?(console.log("[PublishModal] 更新现有工具，ID:",g.value.id),y=await ye.updateCoordinatorTool(g.value.id,g.value)):(console.log("[PublishModal] 创建新工具"),y=await ye.createCoordinatorTool(g.value),g.value=y),console.log("[PublishModal] 保存成功:",y),l(t("mcpService.saveSuccess"),"success"),N.value=!0}catch(f){console.error("[PublishModal] 保存MCP服务失败:",f),l(t("mcpService.saveFailed")+": "+f.message,"error")}finally{D.value=!1}},te=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",E),console.log("[PublishModal] 当前工具:",g.value),!T()){console.log("[PublishModal] 表单验证失败");return}z.value=!0;try{if(!g.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const S=await ye.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(!S.success)throw new Error(S.message);Array.isArray(S.data)?g.value=S.data[0]:g.value=S.data}console.log("[PublishModal] 更新工具信息"),g.value.toolName=E.serviceName.trim(),g.value.toolDescription=E.userRequest.trim(),g.value.endpoint=E.endpoint.trim(),g.value.planTemplateId=a.planTemplateId;const f=E.parameters.filter(S=>S.name.trim()&&S.description.trim()).map(S=>({name:S.name.trim(),description:S.description.trim(),type:"string"}));if(g.value.inputSchema=JSON.stringify(f),console.log("[PublishModal] 更新后的工具信息:",g.value),g.value.id)console.log("[PublishModal] 更新现有工具，ID:",g.value.id),await ye.updateCoordinatorTool(g.value.id,g.value);else{console.log("[PublishModal] 创建新工具");const S=await ye.createCoordinatorTool(g.value);g.value=S}console.log("[PublishModal] 步骤5: 发布工具，ID:",g.value.id);const y=await ye.publishCoordinatorTool(g.value.id);if(console.log("[PublishModal] 发布结果:",y),y.success){if(console.log("[PublishModal] 发布成功"),j.value=y.publishStatus||"PUBLISHED",y.endpointUrl)m.value=y.endpointUrl;else if(g.value.endpoint){const S=window.location.origin;m.value=`${S}/mcp${g.value.endpoint}`}else m.value="";console.log("[PublishModal] 设置状态 - publishStatus:",j.value,"endpointUrl:",m.value),l(t("mcpService.publishSuccess"),"success"),v("published",g.value)}else throw new Error(y.message)}catch(f){console.error("[PublishModal] 发布MCP服务失败:",f),l(t("mcpService.publishFailed")+": "+f.message,"error")}finally{z.value=!1}},ie=async()=>{if(!z.value){z.value=!0;try{c.value?(console.log("[PublishModal] 取消发布MCP服务"),g.value&&(g.value.publishStatus="UNPUBLISHED",await ye.updateCoordinatorTool(g.value.id,g.value),c.value=!1,m.value="",l(t("mcpService.unpublishSuccess"),"success"))):(console.log("[PublishModal] 发布MCP服务"),await te(),c.value=!0)}catch(f){console.error("[PublishModal] 发布开关操作失败:",f),l(t("mcpService.unpublishFailed")+": "+f.message,"error")}finally{z.value=!1}}},i=async()=>{if(!V.value&&confirm(t("mcpService.deleteConfirmMessage"))){if(!g.value||!g.value.id){l(t("mcpService.deleteFailed")+": "+t("mcpService.selectPlanTemplateFirst"),"error");return}V.value=!0;try{console.log("[PublishModal] 开始删除MCP服务，ID:",g.value.id);const f=await ye.deleteCoordinatorTool(g.value.id);if(f.success)console.log("[PublishModal] 删除成功"),l(t("mcpService.deleteSuccess"),"success"),k.value=!1,v("published",null);else throw new Error(f.message)}catch(f){console.error("[PublishModal] 删除MCP服务失败:",f),l(t("mcpService.deleteFailed")+": "+f.message,"error")}finally{V.value=!1}}},r=async()=>{k.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),ae(),await Se(),await p(),P())},p=async()=>{if(!a.planTemplateId){console.log("[PublishModal] "+t("mcpService.noPlanTemplateId"));return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",a.planTemplateId);const f=await ye.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",f),f.success&&f.data){let y;if(Array.isArray(f.data)?(y=f.data[0],console.log("[PublishModal] 使用已存在的工具:",y)):(y=f.data,console.log("[PublishModal] 使用新创建的工具:",y)),g.value=y,j.value=y.publishStatus||"",c.value=y.publishStatus==="PUBLISHED",N.value=!!y.id,y.publishStatus==="PUBLISHED")if(f.endpointUrl)m.value=f.endpointUrl;else if(y.endpoint){const S=window.location.origin;m.value=`${S}/mcp${y.endpoint}`}else m.value="";else m.value="";console.log("[PublishModal] 加载工具数据 - publishStatus:",j.value,"endpointUrl:",m.value),E.serviceName=y.toolName||"",E.userRequest=y.toolDescription||a.planDescription||"",E.endpoint=y.endpoint||"";try{if(y.inputSchema){const S=JSON.parse(y.inputSchema);Array.isArray(S)&&(E.parameters=S.map(J=>({name:J.name||"",description:J.description||""})))}}catch(S){console.warn("[PublishModal] "+t("mcpService.parseInputSchemaFailed")+":",S),E.parameters=[]}console.log("[PublishModal] 表单数据已填充:",E)}else console.log("[PublishModal] 获取协调器工具数据失败:",f.message)}catch(f){console.error("[PublishModal] "+t("mcpService.loadToolDataFailed")+":",f)}};_e(()=>a.modelValue,r);const P=()=>{pe(()=>{if(!I.value)return;const f=I.value,y=f.parentElement;if(!y)return;const S=y.getBoundingClientRect(),J=y.querySelector(".toggle-thumb"),Q=J?J.getBoundingClientRect():null,W=Q?Q.width:32,Z=S.width-W-4,ge=f.scrollWidth;if(ge<=Z){const Ee=(Z-ge)/2;c.value?(f.style.position="absolute",f.style.left=`${8+Ee}px`,f.style.right="auto",f.style.transform="none"):(f.style.position="absolute",f.style.right=`${8+Ee}px`,f.style.left="auto",f.style.transform="none")}else c.value?(f.style.position="absolute",f.style.left="8px",f.style.right="50px",f.style.transform="none"):(f.style.position="absolute",f.style.left="50px",f.style.right="8px",f.style.transform="none")})};return _e(()=>c.value,P),_e(()=>t("mcpService.published"),P),_e(()=>t("mcpService.unpublished"),P),Ie(async()=>{k.value&&(console.log("[PublishModal] 组件挂载时初始化"),ae(),await Se(),await p(),P())}),(f,y)=>(d(),h(ve,null,[$($t,{modelValue:k.value,"onUpdate:modelValue":y[7]||(y[7]=S=>k.value=S),title:F.value,"endpoint-url":m.value,onConfirm:te,class:"wide-modal"},{footer:Me(()=>{var S,J;return[e("div",tn,[N.value&&((S=g.value)!=null&&S.id)?(d(),h("button",{key:0,class:"action-btn danger",onClick:i,disabled:V.value},[V.value?(d(),ue(o(_),{key:0,icon:"carbon:loading",class:"loading-icon"})):(d(),ue(o(_),{key:1,icon:"carbon:trash-can"})),oe(" "+s(V.value?o(t)("mcpService.deleting"):o(t)("mcpService.delete")),1)],8,nn)):B("",!0),e("button",{class:"action-btn primary",onClick:O,disabled:D.value},[D.value?(d(),ue(o(_),{key:0,icon:"carbon:loading",class:"loading-icon"})):(d(),ue(o(_),{key:1,icon:"carbon:save"})),oe(" "+s(D.value?o(t)("mcpService.saving"):o(t)("mcpService.save")),1)],8,on),N.value&&((J=g.value)!=null&&J.id)?(d(),h("div",sn,[e("div",{class:"publish-toggle",onClick:ie},[e("div",{class:se(["toggle-track",{"toggle-on":c.value,"toggle-off":!c.value}])},[e("div",{class:se(["toggle-thumb",{"thumb-on":c.value,"thumb-off":!c.value}])},null,2),e("span",{ref_key:"toggleLabelRef",ref:I,class:se(["toggle-label",{"label-on":c.value,"label-off":!c.value}]),style:Fe(R.value)},s(c.value?o(t)("mcpService.published"):o(t)("mcpService.unpublished")),7)],2)])])):B("",!0)])]}),default:Me(()=>[e("div",Pt,[e("div",Ct,[e("div",{class:se(["endpoint-url-row",{"single-item":!c.value}])},[e("div",wt,[e("label",null,s(o(t)("mcpService.endpointRequired")),1),e("div",Tt,[e("div",Et,[e("div",It,[e("div",Dt,[e("div",xt,[$(o(_),{icon:"carbon:application",width:"16",class:"input-icon"}),re(e("input",{type:"text","onUpdate:modelValue":y[0]||(y[0]=S=>E.endpoint=S),placeholder:o(t)("mcpService.endpointPlaceholder"),class:"select-input",onFocus:y[1]||(y[1]=S=>M.value=!0),onInput:Y,onKeydown:dt(K,["enter"]),onBlur:L},null,40,Rt),[[ce,E.endpoint]])]),e("button",{class:"select-arrow-btn",onClick:fe,title:"展开选项"},[$(o(_),{icon:M.value?"carbon:chevron-up":"carbon:chevron-down",width:"14",class:"chevron"},null,8,["icon"])])]),M.value?(d(),h("div",{key:0,class:se(["select-dropdown",{"dropdown-top":X.value==="top"}])},[e("div",At,[e("span",null,s(o(t)("mcpService.selectEndpoint")),1),e("button",{class:"close-btn",onClick:y[2]||(y[2]=S=>M.value=!1)},[$(o(_),{icon:"carbon:close",width:"12"})])]),e("div",Mt,[(d(!0),h(ve,null,ke(G.value,S=>(d(),h("button",{key:S,class:se(["select-option",{active:E.endpoint===S}]),onClick:J=>Pe(S)},[e("span",Nt,s(S),1),E.endpoint===S?(d(),ue(o(_),{key:0,icon:"carbon:checkmark",width:"14",class:"check-icon"})):B("",!0)],10,Ut))),128))]),e("div",Ft,[e("div",Lt,[re(e("input",{type:"text","onUpdate:modelValue":y[3]||(y[3]=S=>ee.value=S),placeholder:o(t)("mcpService.manualInput"),class:"manual-input",onKeydown:dt(C,["enter"]),onBlur:q},null,40,qt),[[ce,ee.value]]),e("button",{class:"add-manual-btn",onClick:C},[$(o(_),{icon:"carbon:add",width:"14"})])])])],2)):B("",!0),M.value?(d(),h("div",{key:1,class:"backdrop",onClick:y[4]||(y[4]=S=>M.value=!1)})):B("",!0)])])])]),c.value?(d(),h("div",Bt,[e("label",null,s(o(t)("mcpService.mcpStreamableUrl")),1),e("div",Vt,[e("div",{class:"url-display",onDblclick:b,title:o(t)("mcpService.copyUrl")+": "+m.value},[e("span",Ot,s(m.value||o(t)("mcpService.mcpStreamableUrlPlaceholder")),1),$(o(_),{icon:"carbon:copy",width:"16",class:"copy-icon"})],40,jt)])])):B("",!0)],2)]),e("div",Wt,[e("div",zt,[e("label",null,s(o(t)("mcpService.toolNameRequired")),1),re(e("input",{type:"text","onUpdate:modelValue":y[5]||(y[5]=S=>E.serviceName=S),placeholder:o(t)("mcpService.toolNamePlaceholder"),required:"",readonly:"",class:"readonly-input"},null,8,Ht),[[ce,E.serviceName]])])]),e("div",Jt,[e("div",Gt,[e("label",null,s(o(t)("mcpService.toolDescriptionRequired")),1),re(e("textarea",{"onUpdate:modelValue":y[6]||(y[6]=S=>E.userRequest=S),placeholder:o(t)("mcpService.toolDescriptionPlaceholder"),class:"description-field",rows:"3",required:""},null,8,Kt),[[ce,E.userRequest]])])]),e("div",Xt,[e("div",Qt,s(o(t)("mcpService.parameterConfig")),1),e("div",Yt,[e("table",null,[e("thead",null,[e("tr",null,[e("th",null,s(o(t)("mcpService.parameterName")),1),e("th",null,s(o(t)("mcpService.parameterDescription")),1)])]),e("tbody",null,[(d(!0),h(ve,null,ke(E.parameters,(S,J)=>(d(),h("tr",{key:J},[e("td",null,[re(e("input",{type:"text","onUpdate:modelValue":Q=>S.name=Q,placeholder:o(t)("mcpService.parameterName"),class:"parameter-input"},null,8,Zt),[[ce,S.name]])]),e("td",null,[re(e("input",{type:"text","onUpdate:modelValue":Q=>S.description=Q,placeholder:o(t)("mcpService.parameterDescription"),class:"parameter-input"},null,8,en),[[ce,S.description]])])]))),128))])])])])])]),_:1},8,["modelValue","title","endpoint-url"]),u.value?(d(),h("div",{key:0,class:"error-toast",onClick:y[8]||(y[8]=S=>u.value="")},[$(o(_),{icon:"carbon:error"}),oe(" "+s(u.value),1)])):B("",!0),A.value?(d(),h("div",{key:1,class:"success-toast",onClick:y[9]||(y[9]=S=>A.value="")},[$(o(_),{icon:"carbon:checkmark"}),oe(" "+s(A.value),1)])):B("",!0)],64))}}),ln=Te(an,[["__scopeId","data-v-d94c5d19"]]),rn={class:"sidebar-content"},cn={class:"sidebar-content-header"},dn={class:"sidebar-content-title"},un={class:"tab-switcher"},pn=["disabled"],hn={key:0,class:"tab-content"},vn={class:"new-task-section"},mn={class:"sidebar-content-list"},gn={key:0,class:"loading-state"},fn={key:1,class:"error-state"},bn={key:2,class:"empty-state"},$n=["onClick"],_n={class:"task-icon"},yn={class:"task-details"},kn={class:"task-title"},Sn={class:"task-preview"},Pn={class:"task-time"},Cn={class:"task-actions"},wn=["title","onClick"],Tn={key:1,class:"tab-content config-tab"},En={key:0,class:"config-container"},In={class:"template-info-header"},Dn={class:"template-info"},xn={class:"template-id"},Rn={class:"config-section"},An={class:"section-header"},Mn={class:"generator-content"},Un=["placeholder"],Nn={class:"generator-actions"},Fn=["disabled"],Ln=["disabled"],qn={class:"config-section"},Bn={class:"section-header"},Vn={class:"section-actions"},jn=["disabled","title"],On=["disabled","title"],Wn=["disabled"],zn=["placeholder"],Hn={class:"config-section"},Jn={class:"section-header"},Gn={class:"execution-content"},Kn={class:"params-input-group"},Xn={class:"params-help-text"},Qn={class:"params-input-container"},Yn=["placeholder"],Zn=["title"],eo={class:"api-url-display"},to={class:"api-url-label"},no={class:"api-url"},oo={class:"api-url-display"},so={class:"api-url-label"},ao=["disabled"],lo=["disabled"],io=we({__name:"index",emits:["planExecutionRequested"],setup(U,{expose:n,emit:t}){const{t:a}=De(),v=["currentPlanId","userRequest","rootPlanId"],k=x({enabled:!0,success:!0}),u=me(()=>k.value.enabled),A=async()=>{try{const c=await ye.getCoordinatorToolConfig();k.value=c}catch(c){console.error("加载CoordinatorTool配置失败:",c),k.value={enabled:!0,success:!1,message:c instanceof Error?c.message:"Unknown error"}}},z=me({get(){try{if(!w.jsonContent)return"";const I={...JSON.parse(w.jsonContent)};return v.forEach(R=>{delete I[R]}),JSON.stringify(I,null,2)}catch{return w.jsonContent}},set(c){try{if(!c.trim()){w.jsonContent="";return}const I=JSON.parse(c);let R={};try{R=JSON.parse(w.jsonContent||"{}")}catch{}const E={...I};v.forEach(F=>{R[F]!==void 0&&(E[F]=R[F])}),w.jsonContent=JSON.stringify(E)}catch{w.jsonContent=c}}}),D=t,V=async()=>{try{const c=await w.saveTemplate();c!=null&&c.duplicate?alert(a("sidebar.saveCompleted",{message:c.message,versionCount:c.versionCount})):c!=null&&c.saved?alert(a("sidebar.saveSuccess",{message:c.message,versionCount:c.versionCount})):c!=null&&c.message&&alert(a("sidebar.saveStatus",{message:c.message}))}catch(c){console.error("Failed to save plan modifications:",c),alert(c.message||a("sidebar.saveFailed"))}},G=async()=>{var c;try{await w.generatePlan(),alert(a("sidebar.generateSuccess",{templateId:((c=w.selectedTemplate)==null?void 0:c.id)??a("sidebar.unknown")}))}catch(I){console.error("Failed to generate plan:",I),alert(a("sidebar.generateFailed")+": "+I.message)}},j=async()=>{try{await w.updatePlan(),alert(a("sidebar.updateSuccess"))}catch(c){console.error("Failed to update plan:",c),alert(a("sidebar.updateFailed")+": "+c.message)}},m=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const c=w.preparePlanExecution();if(!c){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",c),console.log("[Sidebar] Emitting planExecutionRequested event"),D("planExecutionRequested",c),console.log("[Sidebar] Event emitted")}catch(c){console.error("Error executing plan:",c),alert(a("sidebar.executeFailed")+": "+c.message)}finally{w.finishPlanExecution()}},M=x(!1),X=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",w.currentPlanTemplateId),!w.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert(a("mcpService.selectPlanTemplateFirst"));return}console.log("[Sidebar] 打开发布MCP服务模态框"),M.value=!0},ee=c=>{c===null?console.log("MCP服务删除成功"):console.log("MCP服务发布成功:",c)},g=c=>{if(isNaN(c.getTime()))return console.warn("Invalid date received:",c),a("time.unknown");const R=new Date().getTime()-c.getTime(),E=Math.floor(R/6e4),F=Math.floor(R/36e5),ae=Math.floor(R/864e5);return E<1?a("time.now"):E<60?a("time.minuteAgo",{count:E}):F<24?a("time.hourAgo",{count:F}):ae<30?a("time.dayAgo",{count:ae}):c.toLocaleDateString("zh-CN")},N=(c,I)=>!c||c.length<=I?c:c.substring(0,I)+"...";return Ie(()=>{w.loadPlanTemplateList(),A()}),n({loadPlanTemplateList:w.loadPlanTemplateList,toggleSidebar:w.toggleSidebar,currentPlanTemplateId:w.currentPlanTemplateId}),(c,I)=>{var R,E;return d(),h(ve,null,[e("div",{class:se(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(w).isCollapsed}])},[e("div",rn,[e("div",cn,[e("div",dn,s(c.$t("sidebar.title")),1)]),e("div",un,[e("button",{class:se(["tab-button",{active:o(w).currentTab==="list"}]),onClick:I[0]||(I[0]=F=>o(w).switchToTab("list"))},[$(o(_),{icon:"carbon:list",width:"16"}),oe(" "+s(c.$t("sidebar.templateList")),1)],2),e("button",{class:se(["tab-button",{active:o(w).currentTab==="config"}]),onClick:I[1]||(I[1]=F=>o(w).switchToTab("config")),disabled:!o(w).selectedTemplate},[$(o(_),{icon:"carbon:settings",width:"16"}),oe(" "+s(c.$t("sidebar.configuration")),1)],10,pn)]),o(w).currentTab==="list"?(d(),h("div",hn,[e("div",vn,[e("button",{class:"new-task-btn",onClick:I[2]||(I[2]=F=>o(w).createNewTemplate())},[$(o(_),{icon:"carbon:add",width:"16"}),oe(" "+s(c.$t("sidebar.newPlan"))+" ",1),I[12]||(I[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",mn,[o(w).isLoading?(d(),h("div",gn,[$(o(_),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,s(c.$t("sidebar.loading")),1)])):o(w).errorMessage?(d(),h("div",fn,[$(o(_),{icon:"carbon:warning",width:"20"}),e("span",null,s(o(w).errorMessage),1),e("button",{onClick:I[3]||(I[3]=(...F)=>o(w).loadPlanTemplateList&&o(w).loadPlanTemplateList(...F)),class:"retry-btn"},s(c.$t("sidebar.retry")),1)])):o(w).planTemplateList.length===0?(d(),h("div",bn,[$(o(_),{icon:"carbon:document",width:"32"}),e("span",null,s(c.$t("sidebar.noTemplates")),1)])):(d(!0),h(ve,{key:3},ke(o(w).sortedTemplates,F=>(d(),h("div",{key:F.id,class:se(["sidebar-content-list-item",{"sidebar-content-list-item-active":F.id===o(w).currentPlanTemplateId}]),onClick:ae=>o(w).selectTemplate(F)},[e("div",_n,[$(o(_),{icon:"carbon:document",width:"20"})]),e("div",yn,[e("div",kn,s(F.title||c.$t("sidebar.unnamedPlan")),1),e("div",Sn,s(N(F.description||c.$t("sidebar.noDescription"),40)),1)]),e("div",Pn,s(g(o(w).parseDateTime(F.updateTime||F.createTime))),1),e("div",Cn,[e("button",{class:"delete-task-btn",title:c.$t("sidebar.deleteTemplate"),onClick:he(ae=>o(w).deleteTemplate(F),["stop"])},[$(o(_),{icon:"carbon:close",width:"16"})],8,wn)])],10,$n))),128))])])):o(w).currentTab==="config"?(d(),h("div",Tn,[o(w).selectedTemplate?(d(),h("div",En,[e("div",In,[e("div",Dn,[e("h3",null,s(o(w).selectedTemplate.title||c.$t("sidebar.unnamedPlan")),1),e("span",xn,"ID: "+s(o(w).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:I[4]||(I[4]=F=>o(w).switchToTab("list"))},[$(o(_),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Rn,[e("div",An,[$(o(_),{icon:"carbon:generate",width:"16"}),e("span",null,s(c.$t("sidebar.planGenerator")),1)]),e("div",Mn,[re(e("textarea",{"onUpdate:modelValue":I[5]||(I[5]=F=>o(w).generatorPrompt=F),class:"prompt-input",placeholder:c.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Un),[[ce,o(w).generatorPrompt]]),e("div",Nn,[e("button",{class:"btn btn-primary btn-sm",onClick:G,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()},[$(o(_),{icon:o(w).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:se({spinning:o(w).isGenerating})},null,8,["icon","class"]),oe(" "+s(o(w).isGenerating?c.$t("sidebar.generating"):c.$t("sidebar.generatePlan")),1)],8,Fn),e("button",{class:"btn btn-secondary btn-sm",onClick:j,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()||!o(w).jsonContent.trim()},[$(o(_),{icon:"carbon:edit",width:"14"}),oe(" "+s(c.$t("sidebar.updatePlan")),1)],8,Ln)])])]),e("div",qn,[e("div",Bn,[$(o(_),{icon:"carbon:code",width:"16"}),e("span",null,s(c.$t("sidebar.jsonTemplate")),1),e("div",Vn,[e("button",{class:"btn btn-sm",onClick:I[6]||(I[6]=(...F)=>o(w).rollbackVersion&&o(w).rollbackVersion(...F)),disabled:!o(w).canRollback,title:c.$t("sidebar.rollback")},[$(o(_),{icon:"carbon:undo",width:"14"})],8,jn),e("button",{class:"btn btn-sm",onClick:I[7]||(I[7]=(...F)=>o(w).restoreVersion&&o(w).restoreVersion(...F)),disabled:!o(w).canRestore,title:c.$t("sidebar.restore")},[$(o(_),{icon:"carbon:redo",width:"14"})],8,On),e("button",{class:"btn btn-primary btn-sm",onClick:V,disabled:o(w).isGenerating||o(w).isExecuting},[$(o(_),{icon:"carbon:save",width:"14"})],8,Wn)])]),re(e("textarea",{"onUpdate:modelValue":I[8]||(I[8]=F=>z.value=F),class:"json-editor",placeholder:c.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,zn),[[ce,z.value]])]),e("div",Hn,[e("div",Jn,[$(o(_),{icon:"carbon:play",width:"16"}),e("span",null,s(c.$t("sidebar.executionController")),1)]),e("div",Gn,[e("div",Kn,[e("label",null,s(c.$t("sidebar.executionParams")),1),e("div",Xn,s(c.$t("sidebar.executionParamsHelp")),1),e("div",Qn,[re(e("input",{"onUpdate:modelValue":I[9]||(I[9]=F=>o(w).executionParams=F),class:"params-input",placeholder:c.$t("sidebar.executionParamsPlaceholder")},null,8,Yn),[[ce,o(w).executionParams]]),e("button",{class:"clear-params-btn",onClick:I[10]||(I[10]=(...F)=>o(w).clearExecutionParams&&o(w).clearExecutionParams(...F)),title:c.$t("sidebar.clearParams")},[$(o(_),{icon:"carbon:close",width:"12"})],8,Zn)])]),e("div",eo,[e("span",to,s(c.$t("sidebar.apiUrl"))+":",1),e("code",no,s(o(w).computedApiUrl),1)]),e("div",oo,[e("span",so,s(c.$t("sidebar.statusApiUrl"))+":",1),I[13]||(I[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:m,disabled:o(w).isExecuting||o(w).isGenerating},[$(o(_),{icon:o(w).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:se({spinning:o(w).isExecuting})},null,8,["icon","class"]),oe(" "+s(o(w).isExecuting?c.$t("sidebar.executing"):c.$t("sidebar.executePlan")),1)],8,ao),u.value?(d(),h("button",{key:0,class:"btn publish-mcp-btn",onClick:X,disabled:!o(w).currentPlanTemplateId},[$(o(_),{icon:"carbon:application",width:"16"}),oe(" "+s(o(a)("sidebar.publishMcpService")),1)],8,lo)):B("",!0)])])])):B("",!0)])):B("",!0)])],2),$(ln,{modelValue:M.value,"onUpdate:modelValue":I[11]||(I[11]=F=>M.value=F),"plan-template-id":o(w).currentPlanTemplateId||"","plan-title":((R=o(w).selectedTemplate)==null?void 0:R.title)||"","plan-description":((E=o(w).selectedTemplate)==null?void 0:E.description)||"",onPublished:ee},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),ro=Te(io,[["__scopeId","data-v-de78f1ad"]]);class We{static async sendMessage(n){return kt.withLlmCheck(async()=>{const t=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n})});if(!t.ok)throw new Error(`API request failed: ${t.status}`);return await t.json()})}}Ce(We,"BASE_URL","/api/executor");class ze{static async getDetails(n){try{const t=await fetch(`${this.BASE_URL}/details/${n}`);if(t.status===404)return null;if(!t.ok){const k=await t.text();throw new Error(`Failed to get detailed information: ${t.status} - ${k}`)}const a=await t.text(),v=JSON.parse(a);return v&&typeof v=="object"&&!v.currentPlanId&&(v.currentPlanId=n),v}catch(t){return console.error("[CommonApiService] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to save, please retry"}}}static async submitFormInput(n,t){const a=await fetch(`${this.BASE_URL}/submit-input/${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let k;try{k=await a.json()}catch{k={message:`Failed to submit form input: ${a.status}`}}throw new Error(k.message||`Failed to submit form input: ${a.status}`)}const v=a.headers.get("content-type");return v&&v.indexOf("application/json")!==-1?await a.json():{success:!0}}static async getAllPrompts(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get Prompt list:",n),n}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}Ce(ze,"BASE_URL","/api/executor");const Ae=class Ae{constructor(){Ce(this,"POLL_INTERVAL",5e3);Ce(this,"state",Oe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));Ce(this,"callbacks",{});Ce(this,"planExecutionCache",new Map);Ce(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(n){return this.planExecutionCache.get(n)}getCachedUIState(n){return this.uiStateCache.get(n)}setCachedUIState(n,t){this.uiStateCache.set(n,t),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${n}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(n){return this.planExecutionCache.has(n)}setCachedPlanRecord(n,t){this.planExecutionCache.set(n,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n}`)}clearCachedPlanRecord(n){const t=this.planExecutionCache.delete(n);return t&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${n}`),t}clearAllCachedRecords(){const n=this.planExecutionCache.size,t=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${n}, UI States: ${t}`)}static getInstance(){return Ae.instance||(Ae.instance=new Ae),Ae.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(n){this.callbacks={...this.callbacks,...n},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(n))}async handleUserMessageSendRequested(n){if(this.validateAndPrepareUIForNewRequest(n))try{if(await this.sendUserMessageAndSetPlanId(n),this.state.activePlanId)this.initiatePlanExecutionSequence(n,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(t){console.error("[PlanExecutionManager] Failed to send user message:",t);const a=this.state.activePlanId??"error";this.setCachedUIState(a,{enabled:!0}),this.emitChatInputUpdateState(a),this.state.activePlanId=null}}handlePlanExecutionRequested(n,t){console.log("[PlanExecutionManager] Received plan execution request:",{planId:n,query:t}),n?(this.state.activePlanId=n,this.initiatePlanExecutionSequence(t??"Execute Plan",n)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(n,t){const a=this.getCachedPlanRecord(n);return a!=null&&a.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${n}`),this.handlePlanExecutionRequested(a.currentPlanId,t),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${n}`),!1)}validateAndPrepareUIForNewRequest(n){if(!n)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const t=this.state.activePlanId??"ui-state";return this.setCachedUIState(t,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(t),!0}async sendUserMessageAndSetPlanId(n){try{const t=await We.sendMessage(n);if(t!=null&&t.planId)return this.state.activePlanId=t.planId,t;if(t!=null&&t.planTemplateId)return this.state.activePlanId=t.planTemplateId,{...t,planId:t.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",t),new Error("Failed to get valid planId from API response")}catch(t){throw console.error("[PlanExecutionManager] API call failed:",t),t}}initiatePlanExecutionSequence(n,t){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${n}", planId: ${t}`);const a=t;this.emitDialogRoundStart(a),this.startPolling()}handlePlanCompletion(n){this.emitPlanCompleted(n.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await qe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}n.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(n.rootPlanId??""))}handlePlanError(n){this.emitPlanError(n.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await qe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const n=await this.getPlanDetails(this.state.activePlanId);if(!n){console.warn("[PlanExecutionManager] No details received from API");return}if(n.status&&n.status==="failed"){this.handlePlanError(n);return}if(n.rootPlanId&&this.setCachedPlanRecord(n.rootPlanId,n),!n.steps||n.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(n.rootPlanId??""),this.handlePlanCompletion(n);return}this.emitPlanUpdate(n.rootPlanId??""),n.completed&&this.handlePlanCompletion(n)}catch(n){console.error("[PlanExecutionManager] Failed to poll plan status:",n)}finally{this.state.isPolling=!1}}}async getPlanDetails(n){try{const t=await ze.getDetails(n);return t!=null&&t.rootPlanId&&(this.planExecutionCache.set(t.rootPlanId,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t.rootPlanId}`)),t}catch(t){return console.error("[PlanExecutionManager] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(n){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(n)}emitDialogRoundStart(n){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(n)}emitPlanUpdate(n){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(n)}emitPlanCompleted(n){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(n)}emitPlanError(n){this.callbacks.onPlanError&&this.callbacks.onPlanError(n)}};Ce(Ae,"instance",null);let je=Ae;const $e=je.getInstance();class Re{static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}static async getFileTree(n){try{const t=await fetch(`${this.BASE_URL}/tree/${n}`),v=await(await this.handleResponse(t)).json();if(!v.success)throw new Error(v.message||"Failed to get file tree");return v.data}catch(t){throw console.error("Failed to get file tree:",t),t}}static async getFileContent(n,t){try{const a=await fetch(`${this.BASE_URL}/content/${n}?path=${encodeURIComponent(t)}`),k=await(await this.handleResponse(a)).json();if(!k.success)throw new Error(k.message||"Failed to get file content");return k.data}catch(a){throw console.error("Failed to get file content:",a),a}}static async downloadFile(n,t,a){try{const v=await fetch(`${this.BASE_URL}/download/${n}?path=${encodeURIComponent(t)}`);await this.handleResponse(v);const k=await v.blob(),u=window.URL.createObjectURL(k),A=document.createElement("a");A.href=u,A.download=a||t.split("/").pop()||"download",document.body.appendChild(A),A.click(),window.URL.revokeObjectURL(u),document.body.removeChild(A)}catch(v){throw console.error("Failed to download file:",v),v}}static isTextFile(n,t){const a=["text/","application/json","application/xml","application/javascript","application/typescript"],v=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(a.some(u=>n.startsWith(u)))return!0;const k=t.toLowerCase();return v.some(u=>k.endsWith(u))}static getFileIcon(n){if(n.type==="directory")return"carbon:folder";const t=n.name.toLowerCase();return t.endsWith(".js")?"vscode-icons:file-type-js":t.endsWith(".ts")?"vscode-icons:file-type-typescript":t.endsWith(".vue")?"vscode-icons:file-type-vue":t.endsWith(".java")?"vscode-icons:file-type-java":t.endsWith(".py")?"vscode-icons:file-type-python":t.endsWith(".json")?"vscode-icons:file-type-json":t.endsWith(".xml")?"vscode-icons:file-type-xml":t.endsWith(".html")?"vscode-icons:file-type-html":t.endsWith(".css")?"vscode-icons:file-type-css":t.endsWith(".md")?"vscode-icons:file-type-markdown":t.endsWith(".yml")||t.endsWith(".yaml")?"vscode-icons:file-type-yaml":t.endsWith(".pdf")?"vscode-icons:file-type-pdf2":t.endsWith(".doc")||t.endsWith(".docx")?"vscode-icons:file-type-word":t.endsWith(".xls")||t.endsWith(".xlsx")?"vscode-icons:file-type-excel":t.endsWith(".ppt")||t.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":t.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":t.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}Ce(Re,"BASE_URL","/api/file-browser");const co={class:"file-tree-node"},uo={class:"node-icon"},po={class:"node-name"},ho={key:1,class:"file-size"},vo={key:2,class:"node-actions"},mo={key:0,class:"children"},go=we({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(U,{emit:n}){const t=U,a=n,v=x(t.level===0),k=x(!1),u=x(!1),A=x({}),z=()=>{t.node.type==="directory"&&(v.value=!v.value)},D=()=>{t.node.type==="directory"?z():V()},V=()=>{t.node.type==="file"&&a("file-selected",t.node),m()},G=()=>{a("download-file",t.node),m()},j=g=>{g.preventDefault(),u.value=!0,A.value={position:"fixed",top:`${g.clientY}px`,left:`${g.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",m)},0)},m=()=>{u.value=!1,document.removeEventListener("click",m)},M=async()=>{try{await navigator.clipboard.writeText(t.node.path)}catch(g){console.error("Failed to copy path:",g)}m()},X=()=>t.node.type==="directory"?v.value?"carbon:folder-open":"carbon:folder":Re.getFileIcon(t.node),ee=g=>{if(g===0)return"0 B";const N=1024,c=["B","KB","MB","GB"],I=Math.floor(Math.log(g)/Math.log(N));return parseFloat((g/Math.pow(N,I)).toFixed(1))+" "+c[I]};return xe(()=>{document.removeEventListener("click",m)}),(g,N)=>{const c=gt("FileTreeNode",!0);return d(),h("div",co,[e("div",{class:se(["node-content",{"is-directory":g.node.type==="directory","is-file":g.node.type==="file","is-expanded":v.value}]),style:Fe({paddingLeft:`${g.level*16+12}px`}),onClick:D,onContextmenu:he(j,["prevent"])},[g.node.type==="directory"?(d(),h("div",{key:0,class:"expand-icon",onClick:he(z,["stop"])},[$(o(_),{icon:v.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):B("",!0),e("div",uo,[$(o(_),{icon:X()},null,8,["icon"])]),e("span",po,s(g.node.name),1),g.node.type==="file"?(d(),h("span",ho,s(ee(g.node.size)),1)):B("",!0),k.value?(d(),h("div",vo,[g.node.type==="file"?(d(),h("button",{key:0,onClick:N[0]||(N[0]=he(I=>g.$emit("download-file",g.node),["stop"])),class:"action-btn download-btn",title:"Download"},[$(o(_),{icon:"carbon:download"})])):B("",!0)])):B("",!0)],38),g.node.type==="directory"&&v.value&&g.node.children?(d(),h("div",mo,[(d(!0),h(ve,null,ke(g.node.children,I=>(d(),ue(c,{key:I.path,node:I,level:g.level+1,onFileSelected:N[1]||(N[1]=R=>g.$emit("file-selected",R)),onDownloadFile:N[2]||(N[2]=R=>g.$emit("download-file",R))},null,8,["node","level"]))),128))])):B("",!0),u.value?(d(),h("div",{key:1,class:"context-menu",style:Fe(A.value),onClick:N[3]||(N[3]=he(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:V},[$(o(_),{icon:"carbon:view"}),N[4]||(N[4]=e("span",null,"Open",-1))]),g.node.type==="file"?(d(),h("div",{key:0,class:"context-menu-item",onClick:G},[$(o(_),{icon:"carbon:download"}),N[5]||(N[5]=e("span",null,"Download",-1))])):B("",!0),N[7]||(N[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:M},[$(o(_),{icon:"carbon:copy"}),N[6]||(N[6]=e("span",null,"Copy Path",-1))])],4)):B("",!0)])}}}),fo=Te(go,[["__scopeId","data-v-e4a376d5"]]),bo={class:"file-browser"},$o={class:"file-browser-header"},_o={class:"header-actions"},yo=["disabled","title"],ko={class:"file-browser-content"},So={class:"file-tree-panel"},Po={key:0,class:"loading-state"},Co={key:1,class:"error-state"},wo={key:0,class:"waiting-for-files"},To={class:"message-content"},Eo={class:"tips"},Io=["disabled"],Do={key:1,class:"actual-error"},xo={key:2,class:"empty-state"},Ro={key:3,class:"file-tree"},Ao={key:0,class:"file-content-panel"},Mo={class:"file-content-header"},Uo={class:"file-info"},No={class:"file-name"},Fo={class:"file-size"},Lo={class:"file-actions"},qo=["title"],Bo=["title"],Vo={class:"file-content-body"},jo={key:0,class:"loading-content"},Oo={key:1,class:"content-error"},Wo={key:2,class:"file-content"},zo={key:0,class:"text-content"},Ho={key:1,class:"binary-content"},Jo=we({__name:"index",props:{planId:{}},setup(U){const n=U,{t}=De(),a=x(!1),v=x(null),k=x(null),u=x(null),A=x(null),z=x(!1),D=x(null),V=x(null),G=me(()=>!A.value||!u.value?!1:Re.isTextFile(A.value.mimeType,u.value.name)),j=me(()=>v.value&&(v.value.includes("Plan directory not found")||v.value.includes("not found"))),m=()=>{V.value&&(clearTimeout(V.value),V.value=null)},M=()=>{m(),V.value=window.setTimeout(()=>{j.value&&X()},5e3)},X=async()=>{if(n.planId){a.value=!0,v.value=null,m();try{k.value=await Re.getFileTree(n.planId)}catch(R){v.value=R instanceof Error?R.message:t("fileBrowser.loadError"),console.error("Failed to load file tree:",R);const E=R instanceof Error?R.message:"";(E.includes("Plan directory not found")||E.includes("not found"))&&M()}finally{a.value=!1}}},ee=async R=>{if(R.type!=="directory"){u.value=R,A.value=null,z.value=!0,D.value=null;try{A.value=await Re.getFileContent(n.planId,R.path)}catch(E){D.value=E instanceof Error?E.message:t("fileBrowser.contentLoadError"),console.error("Failed to load file content:",E)}finally{z.value=!1}}},g=async R=>{try{await Re.downloadFile(n.planId,R.path,R.name)}catch(E){console.error("Failed to download file:",E)}},N=()=>{u.value=null,A.value=null,D.value=null},c=R=>Re.getFileIcon(R),I=R=>{if(R===0)return"0 B";const E=1024,F=["B","KB","MB","GB"],ae=Math.floor(Math.log(R)/Math.log(E));return parseFloat((R/Math.pow(E,ae)).toFixed(1))+" "+F[ae]};return _e(()=>n.planId,R=>{R&&(u.value=null,A.value=null,X())},{immediate:!0}),Ie(()=>{n.planId&&X()}),xe(()=>{m()}),(R,E)=>(d(),h("div",bo,[e("div",$o,[e("h3",null,s(R.$t("fileBrowser.title")),1),e("div",_o,[e("button",{class:"refresh-btn",onClick:X,disabled:a.value,title:R.$t("fileBrowser.refresh")},[$(o(_),{icon:"carbon:refresh",class:se({rotating:a.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,yo)])]),e("div",ko,[e("div",So,[a.value?(d(),h("div",Po,[$(o(_),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(R.$t("fileBrowser.loading")),1)])):v.value?(d(),h("div",Co,[j.value?(d(),h("div",wo,[$(o(_),{icon:"carbon:time",class:"rotating"}),e("div",To,[e("h3",null,s(R.$t("fileBrowser.waitingForGeneration")),1),e("p",null,s(R.$t("fileBrowser.planExecuting")),1),e("div",Eo,[$(o(_),{icon:"carbon:information"}),e("span",null,s(R.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:X,class:"retry-btn",disabled:a.value},[$(o(_),{icon:"carbon:refresh",class:se({rotating:a.value})},null,8,["class"]),oe(" "+s(a.value?R.$t("fileBrowser.checking"):R.$t("fileBrowser.checkNow")),1)],8,Io)])):(d(),h("div",Do,[$(o(_),{icon:"carbon:warning"}),e("span",null,s(v.value),1),e("button",{onClick:X,class:"retry-btn"},s(R.$t("fileBrowser.retry")),1)]))])):k.value?(d(),h("div",Ro,[$(fo,{node:k.value,level:0,onFileSelected:ee,onDownloadFile:g},null,8,["node"])])):(d(),h("div",xo,[$(o(_),{icon:"carbon:folder-off"}),e("span",null,s(R.$t("fileBrowser.noFiles")),1)]))]),u.value?(d(),h("div",Ao,[e("div",Mo,[e("div",Uo,[$(o(_),{icon:c(u.value)},null,8,["icon"]),e("span",No,s(u.value.name),1),e("span",Fo,"("+s(I(u.value.size))+")",1)]),e("div",Lo,[e("button",{onClick:E[0]||(E[0]=F=>g(u.value)),class:"download-btn",title:R.$t("fileBrowser.download")},[$(o(_),{icon:"carbon:download"})],8,qo),e("button",{onClick:N,class:"close-btn",title:R.$t("common.close")},[$(o(_),{icon:"carbon:close"})],8,Bo)])]),e("div",Vo,[z.value?(d(),h("div",jo,[$(o(_),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(R.$t("fileBrowser.loadingContent")),1)])):D.value?(d(),h("div",Oo,[$(o(_),{icon:"carbon:warning"}),e("span",null,s(D.value),1)])):A.value?(d(),h("div",Wo,[G.value?(d(),h("div",zo,[e("pre",null,[e("code",null,s(A.value.content),1)])])):(d(),h("div",Ho,[$(o(_),{icon:"carbon:document-unknown"}),e("p",null,s(R.$t("fileBrowser.binaryFile")),1),e("button",{onClick:E[1]||(E[1]=F=>g(u.value)),class:"download-btn-large"},[$(o(_),{icon:"carbon:download"}),oe(" "+s(R.$t("fileBrowser.downloadToView")),1)])]))])):B("",!0)])])):B("",!0)])]))}}),Go=Te(Jo,[["__scopeId","data-v-e7c74fe4"]]),Ko={class:"right-panel"},Xo={class:"preview-header"},Qo={class:"preview-tabs"},Yo={class:"preview-content"},Zo={key:0,class:"step-details"},es={key:0,class:"step-info-fixed"},ts={key:0,class:"agent-info"},ns={class:"info-item"},os={class:"label"},ss={class:"value"},as={class:"info-item"},ls={class:"label"},is={class:"value"},rs={class:"info-item"},cs={class:"label"},ds={class:"value"},us={class:"info-item"},ps={class:"label"},hs={class:"value"},vs={class:"info-item"},ms={class:"label"},gs={class:"execution-status"},fs={class:"status-item"},bs={class:"status-text"},$s={key:0},_s={key:0,class:"think-act-steps"},ys={class:"steps-container"},ks={class:"step-header"},Ss={class:"step-number"},Ps={class:"think-section"},Cs={class:"think-content"},ws={class:"input"},Ts={class:"label"},Es={class:"output"},Is={class:"label"},Ds={key:0,class:"action-section"},xs={class:"action-content"},Rs={class:"tool-info"},As={class:"label"},Ms={class:"value"},Us={class:"input"},Ns={class:"label"},Fs={class:"output"},Ls={class:"label"},qs={key:0,class:"sub-plan-section"},Bs={class:"sub-plan-content"},Vs={class:"sub-plan-header"},js={class:"sub-plan-info"},Os={class:"label"},Ws={class:"value"},zs={key:0,class:"sub-plan-info"},Hs={class:"label"},Js={class:"value"},Gs={class:"sub-plan-status"},Ks={class:"status-text"},Xs={key:0,class:"no-steps-message"},Qs={key:1,class:"no-execution-message"},Ys={class:"step-basic-info"},Zs={class:"info-item"},ea={class:"label"},ta={class:"value"},na={key:0,class:"info-item"},oa={class:"label"},sa={class:"value"},aa={class:"info-item"},la={class:"label"},ia={class:"no-execution-hint"},ra={key:2,class:"execution-indicator"},ca={class:"execution-text"},da={key:1,class:"no-selection"},ua=["title"],pa={key:1,class:"file-browser-container"},ha={key:1,class:"no-plan-message"},va={class:"message-content"},ma={class:"tips"},ga=we({__name:"index",props:{currentRootPlanId:{}},setup(U,{expose:n}){const t=U,{t:a}=De(),v=x(),k=x(),u=x(),A=x("details"),z=x(localStorage.getItem("jmanus-last-plan-id")),D=x(localStorage.getItem("jmanus-has-executed-plan")==="true"),V=x(null),G=x(!1),j=x(!0),m=x(!0),M=me(()=>u.value?u.value.completed?a("rightPanel.status.completed"):u.value.current?a("rightPanel.status.executing"):a("rightPanel.status.waiting"):""),X=me(()=>t.currentRootPlanId?t.currentRootPlanId:z.value),ee=me(()=>!X.value&&!D.value),g=C=>{var Y;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${C}`),u.value&&V.value){const K=V.value.rootPlanId??k.value;if(K&&K!==C){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${K}, Requested: ${C}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${C}`);const q=$e.getCachedPlanRecord(C);if(!q){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${C}`);return}if(q.steps&&q.steps.length>0){const K=q.steps.length,L=(q.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${L} / ${K}`)}if(u.value&&k.value&&(k.value===C||((Y=V.value)==null?void 0:Y.rootPlanId)===C)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${C}`),V.value)){const L=V.value,b=c(L.planId,L.rootPlanId,L.subPlanId);b?(I(b,L.stepIndex,L.planId,L.isSubPlan),Se()):console.warn("[RightPanel] Could not find plan record for refresh:",L)}},N=(C,q,Y,K,L)=>{console.log("[RightPanel] Step selected:",{planId:C,stepIndex:q,rootPlanId:Y,subPlanId:K,subStepIndex:L});const b=!!(Y&&K&&L!==void 0);V.value={planId:C,stepIndex:q,isSubPlan:b,...b&&{rootPlanId:Y,subPlanId:K,subStepIndex:L}};const l=c(C,Y,K);if(!l){console.warn("[RightPanel] Plan data not found:",{planId:C,rootPlanId:Y,subPlanId:K}),u.value=null,V.value=null;return}I(l,q,C,b)},c=(C,q,Y)=>{var b;if(!q||!Y)return $e.getCachedPlanRecord(C)??null;const K=$e.getCachedPlanRecord(C);if(K)return K;const L=$e.getCachedPlanRecord(q);if(!(L!=null&&L.agentExecutionSequence))return null;for(const l of L.agentExecutionSequence)if(l.thinkActSteps){for(const T of l.thinkActSteps)if(((b=T.subPlanExecutionRecord)==null?void 0:b.currentPlanId)===Y)return T.subPlanExecutionRecord}return null},I=(C,q,Y,K)=>{var te,ie,i,r,p;if(!C.steps||q>=C.steps.length){u.value=null,V.value=null,console.warn("[RightPanel] Invalid step data:",{planId:Y,stepIndex:q,hasSteps:!!C.steps,stepsLength:(te=C.steps)==null?void 0:te.length,message:"Invalid step index"});return}k.value=Y;const L=C.steps[q],b=(ie=C.agentExecutionSequence)==null?void 0:ie[q];console.log("[RightPanel] Step data details:",{planId:Y,stepIndex:q,step:L,hasAgentExecutionSequence:!!C.agentExecutionSequence,agentExecutionSequenceLength:(i=C.agentExecutionSequence)==null?void 0:i.length,agentExecution:b,hasThinkActSteps:!!(b!=null&&b.thinkActSteps),thinkActStepsLength:(r=b==null?void 0:b.thinkActSteps)==null?void 0:r.length,isSubPlan:K});const l=(b==null?void 0:b.status)==="FINISHED",T=!l&&q===C.currentStepIndex&&!C.completed,O={planId:Y,index:q,title:typeof L=="string"?L:L.title||L.description||L.name||`${K?"Sub ":""}Step ${q+1}`,description:typeof L=="string"?L:L.description||L,completed:l,current:T};b&&(O.agentExecution=b),u.value=O,console.log("[RightPanel] Step details updated:",{planId:Y,stepIndex:q,stepTitle:u.value.title,hasAgentExecution:!!b,hasThinkActSteps:(((p=b==null?void 0:b.thinkActSteps)==null?void 0:p.length)??0)>0,completed:l,current:T,planCurrentStep:C.currentStepIndex,planCompleted:C.completed,isSubPlan:K}),b!=null&&b.thinkActSteps&&b.thinkActSteps.forEach((P,f)=>{P.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${f}:`,P.subPlanExecutionRecord)}),setTimeout(()=>{F()},100),Se()},R=(C,q,Y,K)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:C,subPlanId:q,stepIndex:Y,subStepIndex:K}),N(q,K,C,q,K)},E=C=>{v.value=C??void 0},F=()=>{if(!v.value)return;const{scrollTop:C,scrollHeight:q,clientHeight:Y}=v.value,K=q-C-Y<50,L=q>Y;j.value=K,G.value=L&&!K,K?m.value=!0:q-C-Y>100&&(m.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:C,scrollHeight:q,clientHeight:Y,isAtBottom:K,hasScrollableContent:L,showButton:G.value,shouldAutoScroll:m.value})},ae=()=>{v.value&&(v.value.scrollTo({top:v.value.scrollHeight,behavior:"smooth"}),pe(()=>{m.value=!0,F()}))},Se=()=>{!m.value||!v.value||pe(()=>{v.value&&(v.value.scrollTop=v.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},fe=C=>{if(C===null||typeof C>"u"||C==="")return"N/A";try{const q=typeof C=="object"?C:JSON.parse(C);return JSON.stringify(q,null,2)}catch{return String(C)}},be=()=>{u.value=null,k.value=void 0,m.value=!0,v.value&&v.value.removeEventListener("scroll",F)},Pe=()=>{const C=()=>{const q=v.value;return q?(E(q),q.addEventListener("scroll",F),m.value=!0,F(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};pe(()=>{C()||setTimeout(()=>{C()},100)})};return _e(()=>t.currentRootPlanId,(C,q)=>{C&&C!==q?(z.value=C,D.value=!0,localStorage.setItem("jmanus-last-plan-id",C),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",C)):!C&&q&&console.log("[RightPanel] Plan execution finished, keeping last plan:",z.value)},{immediate:!0}),Ie(()=>{console.log("[RightPanel] Component mounted"),pe(()=>{Pe()})}),xe(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),V.value=null,be()}),n({updateDisplayedPlanProgress:g,handleStepSelected:N,handleSubPlanStepSelected:R}),(C,q)=>{var Y,K;return d(),h("div",Ko,[e("div",Xo,[e("div",Qo,[e("div",{class:se(["tab-item",{active:A.value==="details"}]),onClick:q[0]||(q[0]=L=>A.value="details")},[$(o(_),{icon:"carbon:events"}),e("span",null,s(o(a)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:se(["tab-item",{active:A.value==="files"}]),onClick:q[1]||(q[1]=L=>A.value="files")},[$(o(_),{icon:"carbon:folder"}),e("span",null,s(o(a)("fileBrowser.title")),1)],2)])]),e("div",Yo,[A.value==="details"?(d(),h("div",Zo,[u.value?(d(),h("div",es,[e("h3",null,s(u.value.title||u.value.description||o(a)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(d(),h("div",ts,[e("div",ns,[e("span",os,s(o(a)("rightPanel.executingAgent"))+":",1),e("span",ss,s(u.value.agentExecution.agentName),1)]),e("div",as,[e("span",ls,s(o(a)("rightPanel.description"))+":",1),e("span",is,s(u.value.agentExecution.agentDescription||""),1)]),e("div",rs,[e("span",cs,s(o(a)("rightPanel.callingModel"))+":",1),e("span",ds,s(u.value.agentExecution.modelName),1)]),e("div",us,[e("span",ps,s(o(a)("rightPanel.request"))+":",1),e("span",hs,s(u.value.agentExecution.agentRequest||""),1)]),e("div",vs,[e("span",ms,s(o(a)("rightPanel.executionResult"))+":",1),e("span",{class:se(["value",{success:u.value.agentExecution.status==="FINISHED"}])},s(u.value.agentExecution.status||o(a)("rightPanel.executing")),3)])])):B("",!0),e("div",gs,[e("div",fs,[u.value.completed?(d(),ue(o(_),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(d(),ue(o(_),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(d(),ue(o(_),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",bs,s(M.value),1)])])])):B("",!0),e("div",{ref_key:"scrollContainer",ref:v,class:"step-details-scroll-container",onScroll:F},[u.value?(d(),h("div",$s,[(Y=u.value.agentExecution)!=null&&Y.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(d(),h("div",_s,[e("h4",null,s(o(a)("rightPanel.thinkAndActionSteps")),1),e("div",ys,[(d(!0),h(ve,null,ke(u.value.agentExecution.thinkActSteps,(L,b)=>(d(),h("div",{key:b,class:"think-act-step"},[e("div",ks,[e("span",Ss,"#"+s(b+1),1),e("span",{class:se(["step-status",L.status])},s(L.status||o(a)("rightPanel.executing")),3)]),e("div",Ps,[e("h5",null,[$(o(_),{icon:"carbon:thinking"}),oe(" "+s(o(a)("rightPanel.thinking")),1)]),e("div",Cs,[e("div",ws,[e("span",Ts,s(o(a)("rightPanel.input"))+":",1),e("pre",null,s(fe(L.thinkInput)),1)]),e("div",Es,[e("span",Is,s(o(a)("rightPanel.output"))+":",1),e("pre",null,s(fe(L.thinkOutput)),1)])])]),L.actionNeeded?(d(),h("div",Ds,[e("h5",null,[$(o(_),{icon:"carbon:play"}),oe(" "+s(o(a)("rightPanel.action")),1)]),e("div",xs,[(d(!0),h(ve,null,ke(L.actToolInfoList,(l,T)=>(d(),h("div",{key:T},[e("div",Rs,[e("span",As,s(o(a)("rightPanel.tool"))+":",1),e("span",Ms,s(l.name||""),1)]),e("div",Us,[e("span",Ns,s(o(a)("rightPanel.toolParameters"))+":",1),e("pre",null,s(fe(l.parameters)),1)]),e("div",Fs,[e("span",Ls,s(o(a)("rightPanel.executionResult"))+":",1),e("pre",null,s(fe(l.result)),1)])]))),128))]),L.subPlanExecutionRecord?(d(),h("div",qs,[e("h5",null,[$(o(_),{icon:"carbon:tree-view"}),oe(" "+s(o(a)("rightPanel.subPlan")),1)]),e("div",Bs,[e("div",Vs,[e("div",js,[e("span",Os,s(C.$t("rightPanel.subPlanId"))+":",1),e("span",Ws,s(L.subPlanExecutionRecord.currentPlanId),1)]),L.subPlanExecutionRecord.title?(d(),h("div",zs,[e("span",Hs,s(C.$t("rightPanel.title"))+":",1),e("span",Js,s(L.subPlanExecutionRecord.title),1)])):B("",!0),e("div",Gs,[L.subPlanExecutionRecord.completed?(d(),ue(o(_),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(d(),ue(o(_),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",Ks,s(L.subPlanExecutionRecord.completed?C.$t("rightPanel.status.completed"):C.$t("rightPanel.status.executing")),1)])])])])):B("",!0)])):B("",!0)]))),128))]),u.value.agentExecution&&!((K=u.value.agentExecution.thinkActSteps)!=null&&K.length)?(d(),h("div",Xs,[e("p",null,s(o(a)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?B("",!0):(d(),h("div",Qs,[$(o(_),{icon:"carbon:information",class:"info-icon"}),e("h4",null,s(o(a)("rightPanel.stepInfo")),1),e("div",Ys,[e("div",Zs,[e("span",ea,s(o(a)("rightPanel.stepName"))+":",1),e("span",ta,s(u.value.title||u.value.description||C.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(d(),h("div",na,[e("span",oa,s(C.$t("rightPanel.description"))+":",1),e("span",sa,s(u.value.description),1)])):B("",!0),e("div",aa,[e("span",la,s(C.$t("rightPanel.status.label"))+":",1),e("span",{class:se(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},s(u.value.completed?C.$t("rightPanel.status.completed"):u.value.current?C.$t("rightPanel.status.executing"):C.$t("rightPanel.status.pending")),3)])]),e("p",ia,s(o(a)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(d(),h("div",ra,[q[2]||(q[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",ca,[$(o(_),{icon:"carbon:in-progress",class:"rotating-icon"}),oe(" "+s(o(a)("rightPanel.stepExecuting")),1)])])):B("",!0)])):(d(),h("div",da,[$(o(_),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,s(o(a)("rightPanel.noStepSelected")),1),e("p",null,s(o(a)("rightPanel.selectStepHint")),1)]))])):B("",!0),$(Le,{name:"scroll-button"},{default:Me(()=>[G.value?(d(),h("button",{key:0,onClick:ae,class:"scroll-to-bottom-btn",title:o(a)("rightPanel.scrollToBottom")},[$(o(_),{icon:"carbon:chevron-down"})],8,ua)):B("",!0)]),_:1})],544)])):B("",!0),A.value==="files"?(d(),h("div",pa,[X.value?(d(),ue(Go,{key:0,"plan-id":X.value},null,8,["plan-id"])):ee.value?(d(),h("div",ha,[$(o(_),{icon:"carbon:folder-off"}),e("div",va,[e("h3",null,s(o(a)("fileBrowser.noFilesYet")),1),e("p",null,s(o(a)("fileBrowser.noPlanExecuting")),1),e("div",ma,[$(o(_),{icon:"carbon:information"}),e("span",null,s(o(a)("fileBrowser.startTaskTip")),1)])])])):B("",!0)])):B("",!0)])])}}}),fa=Te(ga,[["__scopeId","data-v-d7e4058f"]]);function ba(){const U=$e,n=me(()=>U.getActivePlanId()),t=me(()=>U.getState()),a=me(()=>t.value.isPolling),v=me(()=>!!n.value),k=(D,V)=>{U.initiatePlanExecutionSequence(D,V)},u=()=>{U.stopPolling()},A=()=>{U.startPolling()},z=()=>{U.cleanup()};return xe(()=>{z()}),{activePlanId:n,state:t,isPolling:a,hasActivePlan:v,startExecution:k,stopPolling:u,startPolling:A,cleanup:z}}const $a={class:"chat-container"},_a={class:"message-content"},ya={key:0,class:"user-message"},ka={key:1,class:"assistant-message"},Sa={key:0,class:"thinking-section"},Pa={class:"thinking-header"},Ca={class:"thinking-avatar"},wa={class:"thinking-label"},Ta={class:"thinking-content"},Ea={key:0,class:"thinking"},Ia={key:1,class:"progress"},Da={class:"progress-bar"},xa={class:"progress-text"},Ra={key:2,class:"steps-container"},Aa={class:"steps-title"},Ma=["onClick"],Ua={class:"section-header"},Na={class:"step-icon"},Fa={class:"step-title"},La={key:0,class:"step-status current"},qa={key:1,class:"step-status completed"},Ba={key:2,class:"step-status pending"},Va={key:0,class:"action-info"},ja={class:"action-description"},Oa={class:"action-icon"},Wa={key:0,class:"tool-params"},za={class:"param-label"},Ha={class:"param-content"},Ja={key:1,class:"think-details"},Ga={class:"think-header"},Ka={class:"think-label"},Xa={class:"think-output"},Qa={class:"think-content"},Ya={key:1,class:"sub-plan-steps"},Za={class:"sub-plan-header"},el={class:"sub-plan-title"},tl={class:"sub-plan-step-list"},nl=["onClick"],ol={class:"sub-step-indicator"},sl={class:"sub-step-icon"},al={class:"sub-step-number"},ll={class:"sub-step-content"},il={class:"sub-step-title"},rl={class:"sub-step-badge"},cl={key:2,class:"user-input-form-container"},dl={class:"user-input-message"},ul={key:0,class:"form-description"},pl=["onSubmit"],hl={key:0,class:"form-grid"},vl=["for"],ml=["id","name","placeholder","required","onUpdate:modelValue"],gl=["id","name","placeholder","required","onUpdate:modelValue"],fl=["id","name","placeholder","required","onUpdate:modelValue"],bl=["id","name","placeholder","required","onUpdate:modelValue"],$l=["id","name","placeholder","required","onUpdate:modelValue"],_l=["id","name","required","onUpdate:modelValue"],yl={value:""},kl=["value"],Sl=["id","name","placeholder","required","onUpdate:modelValue"],Pl={key:1,class:"form-group"},Cl={for:"form-input-genericInput"},wl=["onUpdate:modelValue"],Tl={type:"submit",class:"submit-user-input-btn"},El={key:3,class:"default-processing"},Il={class:"processing-indicator"},Dl={class:"response-section"},xl={class:"response-header"},Rl={class:"response-avatar"},Al={class:"response-name"},Ml={class:"response-content"},Ul={key:0,class:"final-response"},Nl=["innerHTML"],Fl={key:1,class:"response-placeholder"},Ll={class:"typing-indicator"},ql={class:"typing-text"},Bl={key:0,class:"message assistant"},Vl={class:"message-content"},jl={class:"assistant-message"},Ol={class:"thinking-section"},Wl={class:"thinking-header"},zl={class:"thinking-avatar"},Hl={class:"thinking-label"},Jl={class:"thinking-content"},Gl={class:"default-processing"},Kl={class:"processing-indicator"},Xl={class:"response-section"},Ql={class:"response-header"},Yl={class:"response-avatar"},Zl={class:"response-name"},ei={class:"response-content"},ti={class:"response-placeholder"},ni={class:"typing-indicator"},oi={class:"typing-text"},si=["title"],ai=we({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(U,{expose:n,emit:t}){const a=U,v=t,{t:k}=De(),u=ba(),A=x(),z=x(!1),D=x([]),V=x(),G=x(!1),j=Oe({}),m=(i,r,p)=>{const P={id:Date.now().toString(),type:i,content:r,timestamp:new Date,...p};return i==="assistant"&&!P.thinking&&!P.content&&(P.thinking=k("chat.thinking")),D.value.push(P),P},M=i=>{const r=D.value[D.value.length-1];r.type==="assistant"&&Object.assign(r,i)},X=async i=>{try{z.value=!0;const r=m("assistant","",{thinking:k("chat.thinkingProcessing")}),p=await We.sendMessage(i);if(p.planId)console.log("[ChatComponent] Received planId from direct execution:",p.planId),r.planExecution||(r.planExecution={}),r.planExecution.currentPlanId=p.planId,$e.handlePlanExecutionRequested(p.planId,i),delete r.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete r.thinking;const P=ee(p,i);r.content=P}}catch(r){console.error("Direct mode error:",r),M({content:g(r)})}finally{z.value=!1}},ee=(i,r)=>i.result??i.message??i.content??"",g=i=>{const r=(i==null?void 0:i.message)??(i==null?void 0:i.toString())??k("chat.unknownError");return r.includes("network")||r.includes("timeout")?k("chat.networkError"):r.includes("auth")||r.includes("unauthorized")?k("chat.authError"):r.includes("invalid")||r.includes("format")||r.includes("parameter")?k("chat.formatError"):`${k("chat.unknownError")} (${r})`},N=(i=!1)=>{pe(()=>{if(A.value){const r=A.value;(i||r.scrollHeight-r.scrollTop-r.clientHeight<150)&&r.scrollTo({top:r.scrollHeight,behavior:i?"auto":"smooth"})}})},c=()=>{N(!0),G.value=!1},I=()=>{if(A.value){const i=A.value,r=i.scrollHeight-i.scrollTop-i.clientHeight<150;G.value=!r&&D.value.length>0}},R=()=>{A.value&&A.value.addEventListener("scroll",I)},E=()=>{A.value&&A.value.removeEventListener("scroll",I)},F=i=>{m("user",i),a.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",i):X(i)},ae=(i,r)=>{var f;const p=((f=i.planExecution)==null?void 0:f.agentExecutionSequence)??[];return r<0||r>=p.length?"IDLE":p[r].status??"IDLE"},Se=(i,r)=>{var p,P;if(!((p=i.planExecution)!=null&&p.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:i.planExecution.currentPlanId,stepIndex:r,stepTitle:(P=i.planExecution.steps)==null?void 0:P[r]}),v("step-selected",i.planExecution.currentPlanId,r)},fe=(i,r)=>{var p;try{const P=(p=i.planExecution)==null?void 0:p.agentExecutionSequence;if(!(P!=null&&P.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const f=P[r];if(!f)return console.log(`[ChatComponent] No agentExecution found for step ${r}`),[];if(!f.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${r}`),[];for(const y of f.thinkActSteps)if(y.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${r}:`,y.subPlanExecutionRecord),(y.subPlanExecutionRecord.steps??[]).map(J=>typeof J=="string"?J:typeof J=="object"&&J!==null&&(J.title||J.description)||k("rightPanel.subStep"));return[]}catch(P){return console.warn("[ChatComponent] Error getting sub-plan steps:",P),[]}},be=(i,r,p)=>{var P;try{const f=(P=i.planExecution)==null?void 0:P.agentExecutionSequence;if(!(f!=null&&f.length))return"pending";const y=f[r];if(!y||!y.thinkActSteps)return"pending";let S=null;for(const Q of y.thinkActSteps)if(Q.subPlanExecutionRecord){S=Q.subPlanExecutionRecord;break}if(!S)return"pending";const J=S.currentStepIndex;return S.completed?"completed":J==null?p===0?"current":"pending":p<J?"completed":p===J?"current":"pending"}catch(f){return console.warn("[ChatComponent] Error getting sub-plan step status:",f),"pending"}},Pe=(i,r,p)=>{var P,f;try{const y=(P=i.planExecution)==null?void 0:P.agentExecutionSequence;if(!(y!=null&&y.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const S=y[r];if(!S){console.warn("[ChatComponent] No agentExecution found for step",r);return}if(!S.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",r);return}let J=null;for(const Q of S.thinkActSteps)if(Q.subPlanExecutionRecord){J=Q.subPlanExecutionRecord;break}if(!(J!=null&&J.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}v("sub-plan-step-selected",((f=i.planExecution)==null?void 0:f.currentPlanId)??"",J.currentPlanId,r,p)}catch(y){console.error("[ChatComponent] Error handling sub-plan step click:",y)}},C=(i,r)=>{var P,f,y,S;if(!((P=i.planExecution)!=null&&P.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",i.planExecution.steps.length,"execution sequence:",((f=r.agentExecutionSequence)==null?void 0:f.length)??0);const p=new Array(i.planExecution.steps.length).fill(null);if((y=r.agentExecutionSequence)!=null&&y.length){const J=Math.min(r.agentExecutionSequence.length,i.planExecution.steps.length);for(let Q=0;Q<J;Q++){const W=r.agentExecutionSequence[Q];if((S=W.thinkActSteps)!=null&&S.length){const Z=W.thinkActSteps[W.thinkActSteps.length-1];Z.actionDescription&&Z.toolParameters?(p[Q]={actionDescription:Z.actionDescription,toolParameters:typeof Z.toolParameters=="string"?Z.toolParameters:JSON.stringify(Z.toolParameters,null,2),thinkInput:Z.thinkInput??"",thinkOutput:Z.thinkOutput??"",status:r.currentStepIndex!==void 0&&Q<r.currentStepIndex?"completed":r.currentStepIndex!==void 0&&Q===r.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${Q} action set: ${p[Q].actionDescription}`)):(p[Q]={actionDescription:k("chat.thinking"),toolParameters:k("chat.waitingDecision"),thinkInput:Z.thinkInput??"",thinkOutput:Z.thinkOutput??"",status:r.currentStepIndex!==void 0&&Q===r.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${Q} is thinking`))}else p[Q]={actionDescription:r.currentStepIndex!==void 0&&Q<r.currentStepIndex?k("chat.status.completed"):k("chat.status.pending"),toolParameters:k("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:r.currentStepIndex!==void 0&&Q<r.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${Q} has no execution details, status set to: ${p[Q].status}`)}}else console.log("[ChatComponent] No execution sequence data");i.stepActions=[...p],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(p.map(J=>J==null?void 0:J.actionDescription))),pe(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},q=i=>{console.log("[ChatComponent] Starting dialog round with planId:",i),i&&(D.value.findIndex(p=>{var P;return((P=p.planExecution)==null?void 0:P.currentPlanId)===i&&p.type==="assistant"})===-1?(m("assistant","",{planExecution:{currentPlanId:i},thinking:k("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",i)):console.log("[ChatComponent] Found existing assistant message for planId:",i))},Y=i=>{var y,S,J,Q;console.log("[ChatComponent] Processing plan update with rootPlanId:",i);const r=$e.getCachedPlanRecord(i);if(!r){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",r),console.log("[ChatComponent] Plan steps:",r.steps),console.log("[ChatComponent] Plan completed:",r.completed),!r.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const p=D.value.findIndex(W=>{var Z;return((Z=W.planExecution)==null?void 0:Z.currentPlanId)===r.currentPlanId&&W.type==="assistant"});let P;if(p!==-1)P=D.value[p],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",r.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",r.currentPlanId),console.log("[ChatComponent] Current messages:",D.value.map(Z=>{var ge;return{type:Z.type,planId:(ge=Z.planExecution)==null?void 0:ge.currentPlanId,content:Z.content.substring(0,50)}}));let W=-1;for(let Z=D.value.length-1;Z>=0;Z--)if(D.value[Z].type==="assistant"){W=Z;break}if(W!==-1)P=D.value[W],P.planExecution||(P.planExecution={}),P.planExecution.currentPlanId=r.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",r.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(P.planExecution||(P.planExecution={}),P.planExecution=JSON.parse(JSON.stringify(r)),!r.steps||r.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),r.completed){delete P.thinking;const W=r.summary??r.result??r.message??k("chat.executionCompleted");P.content=K(W),console.log("[ChatComponent] Set simple response content:",P.content)}else r.title&&(P.thinking=`${k("chat.thinkingExecuting",{title:r.title})}`);return}delete P.thinking;const f=r.steps.map(W=>typeof W=="string"?W:typeof W=="object"&&W!==null&&(W.title||W.description)||k("chat.step"));if(P.planExecution&&(P.planExecution.steps=f),r.agentExecutionSequence&&r.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",r.agentExecutionSequence.length),C(P,r);const W=r.currentStepIndex??0;if(W>=0&&W<r.agentExecutionSequence.length){const ge=r.agentExecutionSequence[W].thinkActSteps;if(ge&&ge.length>0){const Ee=ge[ge.length-1];if(Ee.thinkOutput){const Be=Ee.thinkOutput.length>150?Ee.thinkOutput.substring(0,150)+"...":Ee.thinkOutput;P.thinking=`${k("chat.thinking")}: ${Be}`}}}}else if(P.planExecution){const W=P.planExecution.currentStepIndex??0,Z=(y=P.planExecution.steps)==null?void 0:y[W],ge=typeof Z=="string"?Z:"";P.thinking=`${k("chat.thinkingExecuting",{title:ge})}`}if(r.userInputWaitState&&P.planExecution?(console.log("[ChatComponent] User input required:",r.userInputWaitState),P.planExecution.userInputWaitState||(P.planExecution.userInputWaitState={}),P.planExecution.userInputWaitState={message:r.userInputWaitState.message??"",formDescription:r.userInputWaitState.formDescription??"",formInputs:((S=r.userInputWaitState.formInputs)==null?void 0:S.map(W=>({label:W.label,value:W.value||"",type:W.type||"text",required:W.required==="true"||W.required===!0,placeholder:W.placeholder||"",name:W.name||W.label,options:W.options||void 0})))??[]},j[J=P.id]??(j[J]={}),P.thinking=k("input.waiting")):(Q=P.planExecution)!=null&&Q.userInputWaitState&&delete P.planExecution.userInputWaitState,r.completed??r.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete P.thinking;let W="";r.summary?W=r.summary:r.result?W=r.result:W=k("chat.executionCompleted"),P.content=L(W),console.log("[ChatComponent] Updated completed message:",P.content)}pe(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},K=i=>i?i.includes("I ")||i.includes("you")||i.includes("hello")||i.includes("can")||i.includes("I")||i.includes("you")||i.includes("can")?i:i.length<10?`${i}! ${k("chat.anythingElse")}`:i.length<50?`${k("chat.okayDone",{text:i})}. ${k("chat.ifOtherQuestions")}`:`${i}

${k("chat.hopeHelpful")} ${k("chat.anythingElse")}`:k("chat.defaultResponse"),L=i=>i?`${i}`:`${k("chat.executionCompleted")}! ${k("chat.anythingElse")}`,b=i=>{console.log("[ChatComponent] Plan completed with rootPlanId:",i);const r=$e.getCachedPlanRecord(i);if(!r){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Plan details:",r),r.rootPlanId){const p=D.value.findIndex(P=>{var f;return((f=P.planExecution)==null?void 0:f.currentPlanId)===r.rootPlanId});if(p!==-1){const P=D.value[p];delete P.thinking;let y=r.summary??r.result??k("chat.executionCompleted");!y.includes("I")&&!y.includes("you")&&(y.includes("success")||y.includes("complete")||y.includes("finished")?y=`${k("chat.great")}${y}. ${k("chat.ifOtherHelp")}`:y=`${k("chat.completedRequest",{result:y})}`),P.content=y,console.log("[ChatComponent] Updated completed message:",P.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",r.rootPlanId)}},l=i=>{z.value=!1,D.value[D.value.length-1]={id:Date.now().toString(),type:"assistant",content:i,timestamp:new Date}},T=i=>{if(!i)return"";let r=i.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return r=r.replace(/(<br><br>)/g,"</p><p>"),r.includes("</p><p>")&&(r=`<p>${r}</p>`),r},O=async i=>{var r;if(!((r=i.planExecution)!=null&&r.currentPlanId)||!i.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const p={},P=i.planExecution.userInputWaitState.formInputs;P&&P.length>0?Object.entries(j[i.id]).forEach(([y,S])=>{var W;const J=parseInt(y,10),Q=((W=P[J])==null?void 0:W.label)||`input_${y}`;p[Q]=S}):p.genericInput=i.genericInput??"",console.log("[ChatComponent] Submitting user input:",p);const f=await ze.submitFormInput(i.planExecution.currentPlanId,p);delete i.planExecution.userInputWaitState,delete i.genericInput,delete j[i.id],u.startPolling(),console.log("[ChatComponent] User input submitted successfully:",f)}catch(p){console.error("[ChatComponent] User input submission failed:",p),alert(`${k("common.submitFailed")}: ${(p==null?void 0:p.message)||k("common.unknownError")}`)}};_e(()=>a.initialPrompt,(i,r)=>{console.log("[ChatComponent] initialPrompt changed from:",r,"to:",i),i&&typeof i=="string"&&i.trim()&&i!==r&&(console.log("[ChatComponent] Processing changed initial prompt:",i),pe(()=>{F(i)}))},{immediate:!1}),Ie(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),$e.setEventCallbacks({onPlanUpdate:Y,onPlanCompleted:b,onDialogRoundStart:q,onChatInputUpdateState:i=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",i)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:l}),pe(()=>{R()}),a.initialPrompt&&typeof a.initialPrompt=="string"&&a.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",a.initialPrompt),pe(()=>{F(a.initialPrompt)}))}),xe(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),E(),V.value&&clearInterval(V.value),u.cleanup(),Object.keys(j).forEach(i=>delete j[i])});const te=i=>i?Array.isArray(i)?i:typeof i=="string"?i.split(",").map(r=>r.trim()).filter(r=>r.length>0):[]:[],ie=i=>typeof i=="boolean"?i:typeof i=="string"?i==="true":!1;return n({handleSendMessage:F,handlePlanUpdate:Y,handlePlanCompleted:b,handleDialogRoundStart:q,addMessage:m,handlePlanError:l}),(i,r)=>(d(),h("div",$a,[e("div",{class:"messages",ref_key:"messagesRef",ref:A},[(d(!0),h(ve,null,ke(D.value,p=>{var P,f,y,S,J,Q,W,Z,ge;return d(),h("div",{key:p.id,class:se(["message",{user:p.type==="user",assistant:p.type==="assistant"}])},[e("div",_a,[p.type==="user"?(d(),h("div",ya,s(p.content),1)):(d(),h("div",ka,[p.thinking||((P=p.planExecution)==null?void 0:P.progress)!==void 0||(((y=(f=p.planExecution)==null?void 0:f.steps)==null?void 0:y.length)??0)>0?(d(),h("div",Sa,[e("div",Pa,[e("div",Ca,[$(o(_),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",wa,s(i.$t("chat.thinkingLabel")),1)]),e("div",Ta,[p.thinking?(d(),h("div",Ea,[$(o(_),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,s(p.thinking),1)])):B("",!0),((S=p.planExecution)==null?void 0:S.progress)!==void 0?(d(),h("div",Ia,[e("div",Da,[e("div",{class:"progress-fill",style:Fe({width:p.planExecution.progress+"%"})},null,4)]),e("span",xa,s(p.planExecution.progressText??i.$t("chat.processing")+"..."),1)])):B("",!0),(((Q=(J=p.planExecution)==null?void 0:J.steps)==null?void 0:Q.length)??0)>0?(d(),h("div",Ra,[e("h4",Aa,s(i.$t("chat.stepExecutionDetails")),1),(d(!0),h(ve,null,ke((W=p.planExecution)==null?void 0:W.steps,(Ee,ne)=>{var Be,He,Je,Ge,Ke,Xe,Qe,Ye,Ze,et,tt,nt,ot,st,at,lt,it,rt,ct;return d(),h("div",{key:ne,class:se(["ai-section",{running:ae(p,ne)==="RUNNING",completed:ae(p,ne)==="FINISHED",pending:ae(p,ne)==="IDLE"}]),onClick:he(H=>Se(p,ne),["stop"])},[e("div",Ua,[e("span",Na,s(ae(p,ne)==="FINISHED"?"✓":ae(p,ne)==="RUNNING"?"▶":"○"),1),e("span",Fa,s(Ee||`${i.$t("chat.step")} ${ne+1}`),1),ae(p,ne)==="RUNNING"?(d(),h("span",La,s(i.$t("chat.status.executing")),1)):ae(p,ne)==="FINISHED"?(d(),h("span",qa,s(i.$t("chat.status.completed")),1)):(d(),h("span",Ba,s(i.$t("chat.status.pending")),1))]),p.stepActions&&p.stepActions[ne]?(d(),h("div",Va,[e("div",ja,[e("span",Oa,s(((Be=p.stepActions[ne])==null?void 0:Be.status)==="current"?"🔄":((He=p.stepActions[ne])==null?void 0:He.status)==="completed"?"✓":"⏳"),1),e("strong",null,s((Je=p.stepActions[ne])==null?void 0:Je.actionDescription),1)]),(Ge=p.stepActions[ne])!=null&&Ge.toolParameters?(d(),h("div",Wa,[r[0]||(r[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",za,s(i.$t("common.parameters"))+":",1),e("pre",Ha,s((Ke=p.stepActions[ne])==null?void 0:Ke.toolParameters),1)])):B("",!0),(Xe=p.stepActions[ne])!=null&&Xe.thinkOutput?(d(),h("div",Ja,[e("div",Ga,[r[1]||(r[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",Ka,s(i.$t("chat.thinkingOutput"))+":",1)]),e("div",Xa,[e("pre",Qa,s((Qe=p.stepActions[ne])==null?void 0:Qe.thinkOutput),1)])])):B("",!0)])):B("",!0),((Ye=fe(p,ne))==null?void 0:Ye.length)>0?(d(),h("div",Ya,[e("div",Za,[$(o(_),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",el,s(i.$t("rightPanel.subPlan")),1)]),e("div",tl,[(d(!0),h(ve,null,ke(fe(p,ne),(H,le)=>(d(),h("div",{key:`sub-${ne}-${le}`,class:se(["sub-plan-step-item",{completed:be(p,ne,le)==="completed",current:be(p,ne,le)==="current",pending:be(p,ne,le)==="pending"}]),onClick:he(de=>Pe(p,ne,le),["stop"])},[e("div",ol,[e("span",sl,s(be(p,ne,le)==="completed"?"✓":be(p,ne,le)==="current"?"▶":"○"),1),e("span",al,s(le+1),1)]),e("div",ll,[e("span",il,s(H),1),e("span",rl,s(i.$t("rightPanel.subStep")),1)])],10,nl))),128))])])):B("",!0),(Ze=p.planExecution)!=null&&Ze.userInputWaitState&&ae(p,ne)==="RUNNING"?(d(),h("div",cl,[e("p",dl,s(((tt=(et=p.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.message)??i.$t("chat.userInput.message")),1),(ot=(nt=p.planExecution)==null?void 0:nt.userInputWaitState)!=null&&ot.formDescription?(d(),h("p",ul,s((at=(st=p.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:at.formDescription),1)):B("",!0),e("form",{onSubmit:he(H=>O(p),["prevent"]),class:"user-input-form"},[(it=(lt=p.planExecution)==null?void 0:lt.userInputWaitState)!=null&&it.formInputs&&p.planExecution.userInputWaitState.formInputs.length>0?(d(),h("div",hl,[(d(!0),h(ve,null,ke((ct=(rt=p.planExecution)==null?void 0:rt.userInputWaitState)==null?void 0:ct.formInputs,(H,le)=>(d(),h("div",{key:le,class:"form-group"},[e("label",{for:`form-input-${H.label.replace(/\W+/g,"_")}`},s(H.label)+s(ie(H.required)?" *":"")+": ",9,vl),!H.type||H.type==="text"?re((d(),h("input",{key:0,type:"text",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input"},null,8,ml)),[[ce,j[p.id][le]]]):H.type==="email"?re((d(),h("input",{key:1,type:"email",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input"},null,8,gl)),[[ce,j[p.id][le]]]):H.type==="number"?re((d(),h("input",{key:2,type:"number",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input"},null,8,fl)),[[ce,j[p.id][le]]]):H.type==="password"?re((d(),h("input",{key:3,type:"password",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input"},null,8,bl)),[[ce,j[p.id][le]]]):H.type==="textarea"?re((d(),h("textarea",{key:4,id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input form-textarea",rows:"3"},null,8,$l)),[[ce,j[p.id][le]]]):H.type==="select"&&H.options?re((d(),h("select",{key:5,id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input form-select"},[e("option",yl,s(i.$t("selectCommon.pleaseSelect")),1),(d(!0),h(ve,null,ke(te(H.options),de=>(d(),h("option",{key:de,value:de},s(de),9,kl))),128))],8,_l)),[[ut,j[p.id][le]]]):re((d(),h("input",{key:6,type:"text",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:ie(H.required),"onUpdate:modelValue":de=>j[p.id][le]=de,class:"form-input"},null,8,Sl)),[[ce,j[p.id][le]]])]))),128))])):(d(),h("div",Pl,[e("label",Cl,s(i.$t("common.input"))+":",1),re(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":H=>p.genericInput=H,class:"form-input"},null,8,wl),[[ce,p.genericInput]])])),e("button",Tl,s(i.$t("chat.userInput.submit")),1)],40,pl)])):B("",!0)],10,Ma)}),128))])):!p.content&&(p.thinking||((Z=p.planExecution)==null?void 0:Z.progress)!==void 0&&(((ge=p.planExecution)==null?void 0:ge.progress)??0)<100)?(d(),h("div",El,[e("div",Il,[r[2]||(r[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(p.thinking??i.$t("chat.thinkingProcessing")),1)])])):B("",!0)])])):B("",!0),e("div",Dl,[e("div",xl,[e("div",Rl,[$(o(_),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Al,s(i.$t("chat.botName")),1)]),e("div",Ml,[p.content?(d(),h("div",Ul,[e("div",{class:"response-text",innerHTML:T(p.content)},null,8,Nl)])):(d(),h("div",Fl,[e("div",Ll,[r[3]||(r[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ql,s(i.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),z.value?(d(),h("div",Bl,[e("div",Vl,[e("div",jl,[e("div",Ol,[e("div",Wl,[e("div",zl,[$(o(_),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Hl,s(i.$t("chat.thinkingLabel")),1)]),e("div",Jl,[e("div",Gl,[e("div",Kl,[r[4]||(r[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(i.$t("chat.thinking")),1)])])])]),e("div",Xl,[e("div",Ql,[e("div",Yl,[$(o(_),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Zl,s(i.$t("chat.botName")),1)]),e("div",ei,[e("div",ti,[e("div",ni,[r[5]||(r[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",oi,s(i.$t("chat.thinkingResponse")),1)])])])])])])])):B("",!0)],512),G.value?(d(),h("div",{key:0,class:"scroll-to-bottom-btn",onClick:c,title:i.$t("chat.scrollToBottom")},[$(o(_),{icon:"carbon:chevron-down"})],8,si)):B("",!0)]))}}),li=Te(ai,[["__scopeId","data-v-d8e739ec"]]),ii={class:"input-area"},ri={class:"input-container"},ci=["title"],di=["placeholder","disabled"],ui=["title"],pi=["disabled","title"],hi=we({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(U,{expose:n,emit:t}){const{t:a}=De(),v=U,k=t,u=x(),A=x(""),z=me(()=>v.placeholder||a("input.placeholder")),D=x(z.value),V=me(()=>!!v.disabled),G=()=>{pe(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=Math.min(u.value.scrollHeight,120)+"px")})},j=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),m())},m=()=>{if(!A.value.trim()||V.value)return;const c=A.value.trim();k("send",c),X()},M=()=>{k("plan-mode-clicked")},X=()=>{A.value="",G(),k("clear")},ee=(c,I)=>{I&&(D.value=c?I:a("input.waiting")),k("update-state",c,I)},g=c=>{A.value=c,G()},N=()=>A.value.trim();return _e(()=>v.initialValue,c=>{c&&c.trim()&&(A.value=c,G())},{immediate:!0}),n({clearInput:X,updateState:ee,setInputValue:g,getQuery:N,focus:()=>{var c;return(c=u.value)==null?void 0:c.focus()}}),Ie(()=>{}),xe(()=>{}),(c,I)=>(d(),h("div",ii,[e("div",ri,[e("button",{class:"attach-btn",title:c.$t("input.attachFile")},[$(o(_),{icon:"carbon:attachment"})],8,ci),re(e("textarea",{"onUpdate:modelValue":I[0]||(I[0]=R=>A.value=R),ref_key:"inputRef",ref:u,class:"chat-input",placeholder:D.value,disabled:V.value,onKeydown:j,onInput:G},null,40,di),[[ce,A.value]]),e("button",{class:"plan-mode-btn",title:c.$t("input.planMode"),onClick:M},[$(o(_),{icon:"carbon:document"}),oe(" "+s(c.$t("input.planMode")),1)],8,ui),e("button",{class:"send-button",disabled:!A.value.trim()||V.value,onClick:m,title:c.$t("input.send")},[$(o(_),{icon:"carbon:send-alt"}),oe(" "+s(c.$t("input.send")),1)],8,pi)])]))}}),vi=Te(hi,[["__scopeId","data-v-4b2cba42"]]);class Ue{static async getAllCronTasks(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron tasks:",n),n}}static async getCronTaskById(n){try{const t=await fetch(`${this.BASE_URL}/${n}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron task by id:",t),t}}static async createCronTask(n){try{const t=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to create cron task:",t),t}}static async updateCronTask(n,t){try{const a=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(a)).json()}catch(a){throw console.error("Failed to update cron task:",a),a}}static async updateTaskStatus(n,t){try{const a=await fetch(`${this.BASE_URL}/${n}/status?status=${t}`,{method:"PUT"});await this.handleResponse(a)}catch(a){throw console.error("Failed to update task status:",a),a}}static async deleteCronTask(n){try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE"});await this.handleResponse(t)}catch(t){throw console.error("Failed to delete cron task:",t),t}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}Ce(Ue,"BASE_URL","/api/cron-tasks");const Ne={validateCronExpression(U){const n=U.trim().split(/\s+/);return n.length>=5&&n.length<=6},formatTime(U){return new Date(U).toLocaleString()},async saveTask(U){try{let n;return U.id?n=await Ue.updateCronTask(Number(U.id),U):n=await Ue.createCronTask(U),n}catch(n){throw console.error("Failed to save cron task:",n),n}},async deleteTask(U){try{await Ue.deleteCronTask(String(U))}catch(n){throw console.error("Failed to delete cron task:",n),n}},async toggleTaskStatus(U){if(!U.id)throw new Error("Task ID is required");const n=U.status===0?1:0;return await Ue.updateCronTask(Number(U.id),{...U,status:n})},prepareTaskExecution(U){return U.planTemplateId?{useTemplate:!0,planData:{title:U.cronName||"Scheduled Task Execution",planData:{id:U.planTemplateId,planTemplateId:U.planTemplateId,planId:U.planTemplateId},params:U.executionParams||void 0}}:{useTemplate:!1,taskContent:U.planDesc||U.cronName||""}}},mi={class:"modal-header"},gi={class:"header-actions"},fi={class:"status-switch"},bi={class:"status-label"},$i={class:"toggle-switch"},_i=["checked"],yi={class:"modal-content"},ki={class:"form-group"},Si={class:"form-label"},Pi=["placeholder"],Ci={class:"form-group"},wi={class:"form-label"},Ti=["placeholder"],Ei={class:"form-help"},Ii={class:"form-group"},Di={class:"form-label"},xi=["placeholder"],Ri={class:"form-group"},Ai={class:"form-label"},Mi={class:"template-toggle"},Ui={key:0,class:"template-selector"},Ni={value:""},Fi=["value"],Li={class:"form-help"},qi={key:0,class:"form-group"},Bi={class:"time-info"},Vi={class:"time-label"},ji={class:"time-value"},Oi={key:1,class:"form-group"},Wi={class:"time-info"},zi={class:"time-label"},Hi={class:"time-value"},Ji={class:"modal-footer"},Gi=["disabled"],Ki=we({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(U,{emit:n}){const t=U,a=n,v=x(!1),k=x([]),u=x({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Ie(async()=>{try{const m=await qe.getAllPlanTemplates();m&&m.templates&&(k.value=m.templates.map(M=>({id:M.id,name:M.title||"Unnamed Template"})))}catch(m){console.error("Failed to get template list:",m)}});const z=m=>{m.target===m.currentTarget&&a("update:modelValue",!1)},D=()=>{u.value.linkTemplate=!1,u.value.templateId="",u.value.planTemplateId=""},V=()=>u.value.cronName.trim()?u.value.cronTime.trim()?Ne.validateCronExpression(u.value.cronTime)?u.value.planDesc.trim()?u.value.linkTemplate&&!u.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),G=m=>Ne.formatTime(m),j=async()=>{var m;if(V()){v.value=!0;try{const M={...u.value,...((m=t.task)==null?void 0:m.id)!==void 0&&{id:t.task.id},cronName:u.value.cronName.trim(),cronTime:u.value.cronTime.trim(),planDesc:u.value.planDesc.trim(),status:u.value.status,planTemplateId:u.value.linkTemplate&&u.value.templateId||""};a("save",M)}finally{v.value=!1}}};return _e(()=>t.task,m=>{if(m){const M=m.templateId||m.planTemplateId||"";u.value={cronName:m.cronName||"",cronTime:m.cronTime||"",planDesc:m.planDesc||"",status:m.status??1,linkTemplate:!!M,templateId:M,planTemplateId:M}}else u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),_e(()=>t.modelValue,m=>{m||(u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(m,M)=>(d(),ue(Ve,{to:"body"},[$(Le,{name:"modal"},{default:Me(()=>{var X,ee,g;return[m.modelValue?(d(),h("div",{key:0,class:"modal-overlay",onClick:z},[e("div",{class:"modal-container",onClick:M[8]||(M[8]=he(()=>{},["stop"]))},[e("div",mi,[e("h3",null,s(m.$t("cronTask.taskDetail")),1),e("div",gi,[e("div",fi,[e("span",bi,s(m.$t("cronTask.taskStatus")),1),e("label",$i,[e("input",{type:"checkbox",checked:u.value.status===0,onChange:M[0]||(M[0]=N=>u.value.status=u.value.status===0?1:0)},null,40,_i),M[9]||(M[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:M[1]||(M[1]=N=>m.$emit("update:modelValue",!1))},[$(o(_),{icon:"carbon:close"})])])]),e("div",yi,[e("form",{onSubmit:he(j,["prevent"]),class:"task-form"},[e("div",ki,[e("label",Si,s(m.$t("cronTask.taskName")),1),re(e("input",{"onUpdate:modelValue":M[2]||(M[2]=N=>u.value.cronName=N),type:"text",class:"form-input",placeholder:m.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Pi),[[ce,u.value.cronName]])]),e("div",Ci,[e("label",wi,s(m.$t("cronTask.cronExpression")),1),re(e("input",{"onUpdate:modelValue":M[3]||(M[3]=N=>u.value.cronTime=N),type:"text",class:"form-input",placeholder:m.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Ti),[[ce,u.value.cronTime]]),e("div",Ei,s(m.$t("cronTask.cronExpressionHelp")),1)]),e("div",Ii,[e("label",Di,s(m.$t("cronTask.taskDescription")),1),re(e("textarea",{"onUpdate:modelValue":M[4]||(M[4]=N=>u.value.planDesc=N),class:"form-textarea",placeholder:m.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,xi),[[ce,u.value.planDesc]])]),e("div",Ri,[e("label",Ai,s(m.$t("cronTask.planTemplate")),1),e("div",Mi,[e("button",{type:"button",class:se(["template-btn",u.value.linkTemplate?"active":""]),onClick:M[5]||(M[5]=N=>u.value.linkTemplate=!0)},[$(o(_),{icon:"carbon:checkmark"}),oe(" "+s(m.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:se(["template-btn",u.value.linkTemplate?"":"active"]),onClick:D},[$(o(_),{icon:"carbon:close"}),oe(" "+s(m.$t("cronTask.noTemplate")),1)],2)]),u.value.linkTemplate?(d(),h("div",Ui,[re(e("select",{"onUpdate:modelValue":M[6]||(M[6]=N=>u.value.templateId=N),class:"form-select"},[e("option",Ni,s(m.$t("cronTask.selectTemplate")),1),(d(!0),h(ve,null,ke(k.value,N=>(d(),h("option",{key:N.id,value:N.id},s(N.name),9,Fi))),128))],512),[[ut,u.value.templateId]]),e("div",Li,s(m.$t("cronTask.templateHelpText")),1)])):B("",!0)]),(X=m.task)!=null&&X.createTime?(d(),h("div",qi,[e("div",Bi,[e("span",Vi,s(m.$t("cronTask.createTime"))+":",1),e("span",ji,s(G(m.task.createTime)),1)])])):B("",!0),(ee=m.task)!=null&&ee.updateTime?(d(),h("div",Oi,[e("div",Wi,[e("span",zi,s(m.$t("cronTask.updateTime"))+":",1),e("span",Hi,s(G(m.task.updateTime)),1)])])):B("",!0)],32)]),e("div",Ji,[e("button",{type:"button",class:"cancel-btn",onClick:M[7]||(M[7]=N=>m.$emit("update:modelValue",!1))},s(m.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:j,disabled:v.value},[v.value?(d(),ue(o(_),{key:0,icon:"carbon:loading",class:"loading-icon"})):B("",!0),oe(" "+s((g=t.task)!=null&&g.id?m.$t("common.save"):m.$t("common.create")),1)],8,Gi)])])])):B("",!0)]}),_:1})]))}}),Xi=Te(Ki,[["__scopeId","data-v-5b32448e"]]),Qi={class:"modal-header"},Yi={class:"header-actions"},Zi={class:"modal-content"},er={key:0,class:"loading-container"},tr={key:1,class:"empty-container"},nr={key:2,class:"task-list"},or=["onClick"],sr={class:"task-main"},ar={class:"task-info"},lr={class:"task-header"},ir={class:"task-name"},rr={class:"task-description"},cr={class:"task-time"},dr=["onClick"],ur=["onClick","disabled","title"],pr=["onClick","title"],hr={class:"dropdown-menu"},vr=["onClick"],mr=["onClick","disabled"],gr=["onClick","disabled"],fr={class:"confirm-header"},br={class:"confirm-content"},$r={class:"confirm-actions"},_r=["disabled"],yr={class:"confirm-header"},kr={class:"confirm-content"},Sr={class:"create-options"},Pr={class:"option-content"},Cr={class:"option-title"},wr={class:"option-desc"},Tr={class:"option-content"},Er={class:"option-title"},Ir={class:"option-desc"},Dr={class:"confirm-actions"},xr=we({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(U,{emit:n}){const t=pt(),a=ht(),v=_t(),{t:k}=De(),u=U,A=n,z=x([]),D=x(!1),V=x(null),G=x(null),j=x(null),m=x(null),M=x(!1),X=x(null),ee=x(!1),g=x(null),N=x(!1),c=l=>{l.target===l.currentTarget&&A("update:modelValue",!1)},I=async()=>{D.value=!0;try{z.value=await Ue.getAllCronTasks()}catch(l){console.error("Failed to load cron tasks:",l),v.error(`Failed to load tasks: ${l instanceof Error?l.message:String(l)}`)}finally{D.value=!1}},R=async l=>{V.value=l;try{const T=z.value.find(ie=>ie.id===l);if(!T){console.error("Task not found:",l);return}A("update:modelValue",!1);const O=Date.now().toString();await t.push({name:"direct",params:{id:O}}),await new Promise(ie=>setTimeout(ie,100));const te=Ne.prepareTaskExecution(T);te.useTemplate&&te.planData?a.emitPlanExecutionRequested(te.planData):te.taskContent&&a.setTask(te.taskContent)}catch(T){console.error("Failed to execute task:",T),v.error(`Execution failed: ${T instanceof Error?T.message:String(T)}`)}finally{V.value=null}},E=l=>{X.value={...l},M.value=!0,m.value=null},F=async l=>{try{await Ne.saveTask(l),await I(),M.value=!1,v.success("Task saved successfully")}catch(T){console.error("Failed to save task:",T),v.error(`Save failed: ${T instanceof Error?T.message:String(T)}`)}},ae=l=>{g.value=l,ee.value=!0},Se=async()=>{var l;if((l=g.value)!=null&&l.id){G.value=g.value.id;try{await Ne.deleteTask(g.value.id),await I(),ee.value=!1,g.value=null,v.success("Task deleted successfully")}catch(T){console.error("Failed to delete task:",T),v.error(`Delete failed: ${T instanceof Error?T.message:String(T)}`)}finally{G.value=null}}},fe=()=>{ee.value=!1,g.value=null},be=l=>{m.value=m.value===l?null:l},Pe=async l=>{if(l.id){j.value=l.id;try{await Ne.toggleTaskStatus(l),await I(),m.value=null,v.success(`Task ${l.status===0?"disabled":"enabled"} successfully`)}catch(T){console.error("Failed to toggle task status:",T),v.error(`Status toggle failed: ${T instanceof Error?T.message:String(T)}`)}finally{j.value=null}}},C=async l=>{try{await navigator.clipboard.writeText(l),v.success("Cron expression copied successfully")}catch(T){v.error(`Copy failed: ${T instanceof Error?T.message:String(T)}`)}},q=()=>{N.value=!0},Y=()=>{N.value=!1;try{A("update:modelValue",!1);const l=k("cronTask.template");a.setTaskToInput(l);const T=Date.now().toString();t.push({name:"direct",params:{id:T}})}catch(l){console.error("Error in createWithJmanus:",l),v.error(`Creation failed: ${l instanceof Error?l.message:String(l)}`)}},K=()=>{N.value=!1,X.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},M.value=!0},L=()=>{N.value=!1},b=l=>{const T=l.target;!T.closest(".action-dropdown")&&!T.closest(".dropdown-menu")&&(m.value=null)};return Ie(()=>{document.addEventListener("click",b,!0)}),xe(()=>{document.removeEventListener("click",b,!0)}),_e(()=>u.modelValue,l=>{l&&I()}),(l,T)=>(d(),h(ve,null,[(d(),ue(Ve,{to:"body"},[$(Le,{name:"modal"},{default:Me(()=>[U.modelValue?(d(),h("div",{key:0,class:"modal-overlay",onClick:c},[e("div",{class:"modal-container",onClick:T[3]||(T[3]=he(()=>{},["stop"]))},[e("div",Qi,[e("h3",null,s(l.$t("cronTask.title")),1),e("div",Yi,[e("button",{class:"add-task-btn",onClick:[q,T[0]||(T[0]=he(()=>{},["stop"]))]},[$(o(_),{icon:"carbon:add"}),oe(" "+s(l.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:T[1]||(T[1]=O=>l.$emit("update:modelValue",!1))},[$(o(_),{icon:"carbon:close"})])])]),e("div",Zi,[D.value?(d(),h("div",er,[$(o(_),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,s(l.$t("common.loading")),1)])):z.value.length===0?(d(),h("div",tr,[$(o(_),{icon:"carbon:time",class:"empty-icon"}),e("span",null,s(l.$t("cronTask.noTasks")),1)])):(d(),h("div",nr,[(d(!0),h(ve,null,ke(z.value,O=>(d(),h("div",{key:O.id||"",class:"task-item",onClick:te=>E(O)},[e("div",sr,[e("div",ar,[e("div",lr,[e("div",ir,s(O.cronName),1),e("div",{class:se(["task-status-badge",O.status===0?"active":"inactive"])},[$(o(_),{icon:O.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,s(O.status===0?l.$t("cronTask.active"):l.$t("cronTask.inactive")),1)],2)]),e("div",rr,s(O.planDesc),1),e("div",cr,[$(o(_),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:he(te=>C(O.cronTime),["stop"])},s(O.cronTime),9,dr)])])]),e("div",{class:"task-actions",onClick:T[2]||(T[2]=he(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:te=>R(O.id),disabled:V.value===O.id,title:l.$t("cronTask.executeOnce")},[$(o(_),{icon:V.value===O.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),oe(" "+s(l.$t("cronTask.executeOnce")),1)],8,ur),e("div",{class:se(["action-dropdown",{active:m.value===O.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:te=>be(O.id),title:l.$t("cronTask.operations")},[$(o(_),{icon:"carbon:overflow-menu-horizontal"}),oe(" "+s(l.$t("cronTask.operations")),1)],8,pr),re(e("div",hr,[e("button",{class:"dropdown-item edit-btn",onClick:te=>E(O)},[$(o(_),{icon:"carbon:edit"}),oe(" "+s(l.$t("cronTask.edit")),1)],8,vr),e("button",{class:"dropdown-item toggle-btn",onClick:te=>Pe(O),disabled:j.value===O.id},[$(o(_),{icon:j.value===O.id?"carbon:loading":O.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),oe(" "+s(O.status===0?l.$t("cronTask.disable"):l.$t("cronTask.enable")),1)],8,mr),e("button",{class:"dropdown-item delete-btn",onClick:te=>ae(O),disabled:G.value===O.id},[$(o(_),{icon:G.value===O.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),oe(" "+s(l.$t("cronTask.delete")),1)],8,gr)],512),[[ft,m.value===O.id]])],2)])],8,or))),128))]))])])])):B("",!0)]),_:1})])),$(Xi,{modelValue:M.value,"onUpdate:modelValue":T[4]||(T[4]=O=>M.value=O),task:X.value,onSave:F},null,8,["modelValue","task"]),(d(),ue(Ve,{to:"body"},[$(Le,{name:"modal"},{default:Me(()=>{var O,te,ie,i;return[ee.value?(d(),h("div",{key:0,class:"modal-overlay",onClick:fe},[e("div",{class:"confirm-modal",onClick:T[5]||(T[5]=he(()=>{},["stop"]))},[e("div",fr,[$(o(_),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,s(l.$t("cronTask.deleteConfirm")),1)]),e("div",br,[e("p",null,s(l.$t("cronTask.deleteConfirmMessage",{taskName:((O=g.value)==null?void 0:O.cronName)||((te=g.value)==null?void 0:te.planDesc)||""})),1)]),e("div",$r,[e("button",{class:"confirm-btn cancel-btn",onClick:fe},s(l.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:Se,disabled:G.value===((ie=g.value)==null?void 0:ie.id)},[$(o(_),{icon:G.value===((i=g.value)==null?void 0:i.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),oe(" "+s(l.$t("cronTask.delete")),1)],8,_r)])])])):B("",!0)]}),_:1})])),(d(),ue(Ve,{to:"body"},[$(Le,{name:"modal"},{default:Me(()=>[N.value?(d(),h("div",{key:0,class:"modal-overlay",onClick:L},[e("div",{class:"confirm-modal create-options-modal",onClick:T[6]||(T[6]=he(()=>{},["stop"]))},[e("div",yr,[$(o(_),{icon:"carbon:time",class:"create-icon"}),e("h3",null,s(l.$t("cronTask.createTask")),1)]),e("div",kr,[e("p",null,s(l.$t("cronTask.selectCreateMethod")),1),e("div",Sr,[e("button",{class:"create-option-btn jmanus-btn",onClick:Y},[$(o(_),{icon:"carbon:ai-status"}),e("div",Pr,[e("span",Cr,s(l.$t("cronTask.createWithJmanus")),1),e("span",wr,s(l.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:K},[$(o(_),{icon:"carbon:edit"}),e("div",Tr,[e("span",Er,s(l.$t("cronTask.createManually")),1),e("span",Ir,s(l.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Dr,[e("button",{class:"confirm-btn cancel-btn",onClick:L},s(l.$t("common.cancel")),1)])])])):B("",!0)]),_:1})]))],64))}}),Rr=Te(xr,[["__scopeId","data-v-837947df"]]),Ar={class:"direct-page"},Mr={class:"direct-chat"},Ur={class:"chat-header"},Nr={class:"header-actions"},Fr=["title"],Lr=["title"],qr={class:"chat-content"},Br=["title"],Vr={class:"message-content"},jr=we({__name:"index",setup(U){const n=bt(),t=pt(),a=ht(),{t:v}=De(),{message:k}=yt(),u=x(""),A=x(""),z=x(),D=x(),V=x(),G=x(!1),j=x(!1),m=x(null),M=x(!1),X=x(50),ee=x(!1),g=x(0),N=x(0);Ie(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",a.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",a.hasUnprocessedTask()),$e.setEventCallbacks({onPlanUpdate:l=>{console.log("[Direct] Plan update event received for rootPlanId:",l),F(l)&&(console.log("[Direct] Processing plan update for current rootPlanId:",l),D.value&&typeof D.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",l),D.value.handlePlanUpdate(l)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),z.value&&typeof z.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",l),z.value.updateDisplayedPlanProgress(l)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:l=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",l),!!F(l)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",l),D.value&&typeof D.value.handlePlanCompleted=="function"){const T=$e.getCachedPlanRecord(l);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",T),D.value.handlePlanCompleted(T??{planId:l})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");m.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:l=>{console.log("[Direct] Dialog round start event received for rootPlanId:",l),m.value=l,console.log("[Direct] Set currentRootPlanId to:",l),D.value&&typeof D.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",l),D.value.handleDialogRoundStart(l)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),Se()},onChatInputUpdateState:l=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",l),!F(l,!0))return;const T=$e.getCachedUIState(l);T&&be(T.enabled,T.placeholder)},onPlanError:l=>{D.value.handlePlanError(l)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),w.loadPlanTemplateList(),a.hasUnprocessedTask()&&a.currentTask){const l=a.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",l),a.markTaskAsProcessed(),pe(()=>{D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",l),D.value.handleSendMessage(l)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),u.value=l)})}else{const l=a.getAndClearTaskToInput();l?(A.value=l,console.log("[Direct] Setting inputOnlyContent for input only:",A.value)):(u.value=n.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"))}const b=localStorage.getItem("directPanelWidth");b&&(X.value=parseFloat(b)),console.log("[Direct] Final prompt value:",u.value),A.value&&pe(()=>{V.value&&typeof V.value.setInputValue=="function"&&(V.value.setInputValue(A.value),console.log("[Direct] Set input value:",A.value),A.value="")}),window.addEventListener("plan-execution-requested",l=>{console.log("[DirectView] Received plan-execution-requested event:",l.detail),L(l.detail)})}),_e(()=>a.currentTask,b=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",b),b&&!b.processed){const l=b.prompt;a.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",l),pe(()=>{D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",l),D.value.handleSendMessage(l)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),_e(()=>u.value,(b,l)=>{console.log("[Direct] prompt value changed from:",l,"to:",b)},{immediate:!1}),_e(()=>a.taskToInput,b=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",b),b&&b.trim()&&(console.log("[Direct] Setting input value from taskToInput:",b),pe(()=>{V.value&&typeof V.value.setInputValue=="function"&&(V.value.setInputValue(b.trim()),console.log("[Direct] Input value set from taskToInput watch:",b.trim()),a.getAndClearTaskToInput())}))},{immediate:!1}),xe(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),m.value=null,$e.cleanup(),document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",R),window.removeEventListener("plan-execution-requested",b=>{L(b.detail)})});const c=b=>{ee.value=!0,g.value=b.clientX,N.value=X.value,document.addEventListener("mousemove",I),document.addEventListener("mouseup",R),document.body.style.cursor="col-resize",document.body.style.userSelect="none",b.preventDefault()},I=b=>{if(!ee.value)return;const l=window.innerWidth,O=(b.clientX-g.value)/l*100;let te=N.value+O;te=Math.max(20,Math.min(80,te)),X.value=te},R=()=>{ee.value=!1,document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",R),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",X.value.toString())},E=()=>{X.value=50,localStorage.setItem("directPanelWidth","50")},F=(b,l=!1)=>!m.value||b===m.value||l&&(b==="ui-state"||b==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",b,"current:",m.value),!1),ae=b=>{console.log("[DirectView] Send message from input:",b),D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",b),D.value.handleSendMessage(b)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},Se=()=>{console.log("[DirectView] Input cleared"),V.value&&typeof V.value.clear=="function"&&V.value.clear()},fe=()=>{console.log("[DirectView] Input focused")},be=(b,l)=>{console.log("[DirectView] Input state updated:",b,l),j.value=!b},Pe=(b,l)=>{console.log("[DirectView] Step selected:",b,l),z.value&&typeof z.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",b,l),z.value.handleStepSelected(b,l)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},C=(b,l,T,O)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:b,subPlanId:l,stepIndex:T,subStepIndex:O}),z.value&&typeof z.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:b,subPlanId:l,stepIndex:T,subStepIndex:O}),z.value.handleSubPlanStepSelected(b,l,T,O)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},q=()=>{console.log("[DirectView] Plan mode button clicked"),w.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",w.isCollapsed)},Y=()=>{t.push("/home")},K=()=>{t.push("/configs")},L=async b=>{var T,O,te,ie;if(console.log("[DirectView] Plan execution requested:",b),G.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}G.value=!0;let l=!1;D.value&&typeof D.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",b.title),D.value.addMessage("user",b.title),l=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const i=((T=b.planData)==null?void 0:T.planTemplateId)||((O=b.planData)==null?void 0:O.id)||((te=b.planData)==null?void 0:te.planId);if(!i)throw new Error(v("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",i,"params:",b.params),console.log("[Direct] About to call PlanActApiService.executePlan");let r;if((ie=b.params)!=null&&ie.trim()?(console.log("[Direct] Calling executePlan with params:",b.params.trim()),r=await qe.executePlan(i,b.params.trim())):(console.log("[Direct] Calling executePlan without params"),r=await qe.executePlan(i)),console.log("[Direct] Plan execution API response:",r),r.planId)console.log("[Direct] Got planId from response:",r.planId,"starting plan execution"),m.value=r.planId,console.log("[Direct] Set currentRootPlanId to:",r.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),$e.handlePlanExecutionRequested(r.planId,b.title);else throw console.error("[Direct] No planId in response:",r),new Error(v("direct.executionFailedNoPlanId"))}catch(i){console.error("[Direct] Plan execution failed:",i),console.error("[Direct] Error details:",{message:i.message,stack:i.stack}),m.value=null,D.value&&typeof D.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),l||D.value.addMessage("user",b.title),D.value.addMessage("assistant",`${v("direct.executionFailed")}: ${i.message||v("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${v("direct.executionFailed")}: ${i.message||v("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),G.value=!1}};return(b,l)=>(d(),h("div",Ar,[e("div",Mr,[$(ro,{onPlanExecutionRequested:L}),e("div",{class:"left-panel",style:Fe({width:X.value+"%"})},[e("div",Ur,[e("button",{class:"back-button",onClick:Y},[$(o(_),{icon:"carbon:arrow-left"})]),e("h2",null,s(b.$t("conversation")),1),e("div",Nr,[$(St),e("button",{class:"config-button",onClick:K,title:b.$t("direct.configuration")},[$(o(_),{icon:"carbon:settings-adjust",width:"20"})],8,Fr),e("button",{class:"cron-task-btn",onClick:l[0]||(l[0]=T=>M.value=!0),title:b.$t("cronTask.title")},[$(o(_),{icon:"carbon:alarm",width:"20"})],8,Lr)])]),e("div",qr,[$(li,{ref_key:"chatRef",ref:D,mode:"direct","initial-prompt":u.value||"",onStepSelected:Pe,onSubPlanStepSelected:C},null,8,["initial-prompt"])]),(d(),ue(vi,{key:b.$i18n.locale,ref_key:"inputRef",ref:V,disabled:j.value,placeholder:j.value?o(v)("input.waiting"):o(v)("input.placeholder"),"initial-value":u.value,onSend:ae,onClear:Se,onFocus:fe,onUpdateState:be,onPlanModeClicked:q},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:c,onDblclick:E,title:b.$t("direct.panelResizeHint")},l[2]||(l[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Br),$(fa,{ref_key:"rightPanelRef",ref:z,style:Fe({width:100-X.value+"%"}),"current-root-plan-id":m.value},null,8,["style","current-root-plan-id"])]),$(Rr,{modelValue:M.value,"onUpdate:modelValue":l[1]||(l[1]=T=>M.value=T)},null,8,["modelValue"]),o(k).show?(d(),h("div",{key:0,class:se(["message-toast",o(k).type])},[e("div",Vr,[e("span",null,s(o(k).text),1)])],2)):B("",!0)]))}}),Xr=Te(jr,[["__scopeId","data-v-a8377d69"]]);export{Xr as default};
