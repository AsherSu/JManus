var dt=Object.defineProperty;var pt=(U,n,t)=>n in U?dt(U,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):U[n]=t;var ke=(U,n,t)=>pt(U,typeof n!="symbol"?n+"":n,t);import{d as Se,u as Te,c as re,r as x,A as qe,B as me,o as we,a as m,b as d,F as ue,g as b,f as q,p as Re,h as te,i as o,t as s,z as le,e,n as ne,w as ae,m as ce,C as rt,q as _e,l as se,y as Ue,j as ie,D as Ee,E as ht,T as Ne,G as Le,H as vt,I as mt,x as ct,J as gt}from"./index-CBnD6cva.js";import{I as $,_ as Pe}from"./_plugin-vue_export-helper-CAV40vUM.js";import{s as w,P as Fe,u as ut}from"./sidebar-E3Xynmly.js";import{M as ft,u as bt,a as $t}from"./useMessage-Bf7D3xJB.js";import{L as kt}from"./llm-check-BVkAKrj3.js";import{L as _t}from"./index-DroCH--2.js";class ge{static async getCoordinatorToolConfig(){try{const n=await fetch(`${this.BASE_URL}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get coordinator tool config: ${n.status}`);return await n.json()}catch(n){return console.error("获取CoordinatorTool配置失败:",n),{enabled:!0,success:!1,message:n.message}}}static async getAllEndpoints(){try{const n=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get endpoints: ${n.status}`);return await n.json()}catch(n){throw console.error("获取endpoints失败:",n),new Error("获取endpoints失败: "+n.message)}}static async getOrNewCoordinatorToolsByTemplate(n){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${n}`);try{const t=await fetch(`${this.BASE_URL}/get-or-new-by-template/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const h=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",h),new Error(`Failed to get coordinator tools: ${t.status} - ${h}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",t),new Error("获取协调器工具失败: "+t.message)}}static async createCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 原始数据:",JSON.stringify(n,null,2)),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const t={id:n.id,toolName:n.toolName,toolDescription:n.toolDescription,inputSchema:n.inputSchema,mcpSchema:n.mcpSchema,planTemplateId:n.planTemplateId,endpoint:n.endpoint,publishStatus:n.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",JSON.stringify(t,null,2));try{const a=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[CoordinatorToolApiService] 响应状态:",a.status),console.log("[CoordinatorToolApiService] 响应状态文本:",a.statusText),!a.ok){const _=await a.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",_),new Error(`Failed to create coordinator tool: ${a.status} - ${_}`)}const h=await a.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",h),h}catch(a){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",a),new Error("创建协调器工具失败: "+a.message)}}static async updateCoordinatorTool(n,t){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 发送的数据:",t),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);const a={id:t.id,toolName:t.toolName,toolDescription:t.toolDescription,inputSchema:t.inputSchema,mcpSchema:t.mcpSchema,planTemplateId:t.planTemplateId,endpoint:t.endpoint,publishStatus:t.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",a);try{const h=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(console.log("[CoordinatorToolApiService] 响应状态:",h.status),console.log("[CoordinatorToolApiService] 响应状态文本:",h.statusText),!h.ok){const u=await h.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",u),new Error(`Failed to update coordinator tool: ${h.status} - ${u}`)}const _=await h.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",_),_}catch(h){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",h),new Error("更新协调器工具失败: "+h.message)}}static async publishCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}/publish`);try{const t=await fetch(`${this.BASE_URL}/${n}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const h=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",h),new Error(`Failed to publish coordinator tool: ${t.status} - ${h}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",t),new Error("发布协调器工具失败: "+t.message)}}static async deleteCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始删除协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const h=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",h),new Error(`Failed to delete coordinator tool: ${t.status} - ${h}`)}const a=await t.json();return console.log("[CoordinatorToolApiService] 删除成功，结果:",a),a}catch(t){throw console.error("[CoordinatorToolApiService] 删除协调器工具失败:",t),new Error("删除协调器工具失败: "+t.message)}}}ke(ge,"BASE_URL","/api/coordinator-tools");const yt={class:"modal-form"},St={class:"form-section"},Pt={class:"form-item endpoint-item"},Ct={class:"endpoint-container"},wt={class:"endpoint-row"},Tt={class:"custom-select"},Et={class:"select-input-container"},It={class:"input-content"},Dt=["placeholder"],xt={class:"dropdown-header"},Rt={class:"select-options"},Mt=["onClick"],At={class:"option-name"},Ut={class:"manual-input-section"},Nt={class:"manual-input-container"},Ft=["placeholder"],Lt={key:0,class:"form-item url-item"},Bt={class:"url-container"},qt=["title"],Vt={class:"url-text"},jt={class:"form-section"},Ot={class:"form-item"},Wt=["placeholder"],zt={class:"form-section"},Ht={class:"form-item"},Jt=["placeholder"],Gt={class:"form-section"},Kt={class:"section-title"},Xt={class:"parameter-table"},Qt=["onUpdate:modelValue","placeholder"],Yt=["onUpdate:modelValue","placeholder"],Zt={class:"button-container"},en=["disabled"],tn=["disabled"],nn={key:1,class:"publish-toggle-container"},on=Se({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(U,{emit:n}){const{t}=Te(),a=U,h=n,_=re({get:()=>a.modelValue,set:y=>h("update:modelValue",y)}),u=x(""),M=x(""),W=x(!1),D=x(!1),V=x(!1),H=x([]),G=x(""),v=x(""),A=x(!1),K=x("bottom"),ee=x(""),g=x(null),N=x(!1),c=x(!1),I=x(null),R=re(()=>({})),E=qe({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),F=re(()=>{const y=g.value&&g.value.id;return t(y?"mcpService.updateService":"mcpService.createService")}),oe=()=>{E.serviceName="",E.userRequest=a.planDescription||"",E.endpoint="",E.parameters=[],g.value=null,G.value="",v.value="",N.value=!1,c.value=!1},fe=async()=>{try{H.value=await ge.getAllEndpoints()}catch(y){console.error("加载endpoints失败:",y),l(t("mcpService.loadEndpointsFailed")+": "+y.message,"error")}},de=()=>{A.value||pe(),A.value=!A.value},pe=()=>{const y=document.querySelector(".custom-select");if(!y)return;const P=y.getBoundingClientRect(),k=window.innerHeight;P.bottom+200>k?K.value="top":K.value="bottom"},be=y=>{E.endpoint=y,A.value=!1,ee.value=""},C=()=>{if(ee.value.trim()){const y=ee.value.trim().replace(/[^a-zA-Z0-9_/]/g,"");y&&(E.endpoint=y,H.value.includes(y)||H.value.push(y),A.value=!1,ee.value="")}},B=()=>{setTimeout(()=>{ee.value.trim()&&C()},200)},X=()=>{H.value.includes(E.endpoint)&&be(E.endpoint)},J=()=>{H.value.includes(E.endpoint)&&be(E.endpoint)},L=()=>{H.value.includes(E.endpoint)&&be(E.endpoint)},f=async()=>{if(v.value)try{await navigator.clipboard.writeText(v.value),l(t("common.copy")+" "+t("common.success"),"success")}catch(y){console.error("复制失败:",y),l(t("common.copy")+" "+t("common.error"),"error")}},l=(y,P)=>{P==="success"?(M.value=y,setTimeout(()=>{M.value=""},3e3)):P==="error"&&(u.value=y,setTimeout(()=>{u.value=""},5e3))},T=()=>E.serviceName.trim()?E.userRequest.trim()?E.endpoint.trim()?!0:(l(t("mcpService.endpointRequiredError"),"error"),!1):(l(t("mcpService.toolDescriptionRequiredError"),"error"),!1):(l(t("mcpService.toolNameRequiredError"),"error"),!1),O=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",E),console.log("[PublishModal] 当前工具:",g.value),!T()){console.log("[PublishModal] 表单验证失败");return}D.value=!0;try{if(!g.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const k=await ge.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(!k.success)throw new Error(k.message);Array.isArray(k.data)?g.value=k.data[0]:g.value=k.data}console.log("[PublishModal] 更新工具信息"),g.value.toolName=E.serviceName.trim(),g.value.toolDescription=E.userRequest.trim(),g.value.endpoint=E.endpoint.trim(),g.value.planTemplateId=a.planTemplateId;const y=E.parameters.filter(k=>k.name.trim()&&k.description.trim()).map(k=>({name:k.name.trim(),description:k.description.trim(),type:"string"}));g.value.inputSchema=JSON.stringify(y),console.log("[PublishModal] 更新后的工具信息:",g.value);let P;g.value.id?(console.log("[PublishModal] 更新现有工具，ID:",g.value.id),P=await ge.updateCoordinatorTool(g.value.id,g.value)):(console.log("[PublishModal] 创建新工具"),P=await ge.createCoordinatorTool(g.value),g.value=P),console.log("[PublishModal] 保存成功:",P),l(t("mcpService.saveSuccess"),"success"),N.value=!0}catch(y){console.error("[PublishModal] 保存MCP服务失败:",y),l(t("mcpService.saveFailed")+": "+y.message,"error")}finally{D.value=!1}},i=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",E),console.log("[PublishModal] 当前工具:",g.value),!T()){console.log("[PublishModal] 表单验证失败");return}W.value=!0;try{if(!g.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const k=await ge.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(!k.success)throw new Error(k.message);Array.isArray(k.data)?g.value=k.data[0]:g.value=k.data}console.log("[PublishModal] 更新工具信息"),g.value.toolName=E.serviceName.trim(),g.value.toolDescription=E.userRequest.trim(),g.value.endpoint=E.endpoint.trim(),g.value.planTemplateId=a.planTemplateId;const y=E.parameters.filter(k=>k.name.trim()&&k.description.trim()).map(k=>({name:k.name.trim(),description:k.description.trim(),type:"string"}));if(g.value.inputSchema=JSON.stringify(y),console.log("[PublishModal] 更新后的工具信息:",g.value),g.value.id)console.log("[PublishModal] 更新现有工具，ID:",g.value.id),await ge.updateCoordinatorTool(g.value.id,g.value);else{console.log("[PublishModal] 创建新工具");const k=await ge.createCoordinatorTool(g.value);g.value=k}console.log("[PublishModal] 步骤5: 发布工具，ID:",g.value.id);const P=await ge.publishCoordinatorTool(g.value.id);if(console.log("[PublishModal] 发布结果:",P),P.success){if(console.log("[PublishModal] 发布成功"),G.value=P.publishStatus||"PUBLISHED",P.endpointUrl)v.value=P.endpointUrl;else if(g.value.endpoint){const k=window.location.origin;v.value=`${k}/mcp${g.value.endpoint}`}else v.value="";console.log("[PublishModal] 设置状态 - publishStatus:",G.value,"endpointUrl:",v.value),l(t("mcpService.publishSuccess"),"success"),h("published",g.value)}else throw new Error(P.message)}catch(y){console.error("[PublishModal] 发布MCP服务失败:",y),l(t("mcpService.publishFailed")+": "+y.message,"error")}finally{W.value=!1}},r=async()=>{if(!W.value){W.value=!0;try{c.value?(console.log("[PublishModal] 取消发布MCP服务"),g.value&&(g.value.publishStatus="UNPUBLISHED",await ge.updateCoordinatorTool(g.value.id,g.value),c.value=!1,v.value="",l(t("mcpService.unpublishSuccess"),"success"))):(console.log("[PublishModal] 发布MCP服务"),await i(),c.value=!0)}catch(y){console.error("[PublishModal] 发布开关操作失败:",y),l(t("mcpService.unpublishFailed")+": "+y.message,"error")}finally{W.value=!1}}},p=async()=>{if(!V.value&&confirm(t("mcpService.deleteConfirmMessage"))){if(!g.value||!g.value.id){l(t("mcpService.deleteFailed")+": "+t("mcpService.selectPlanTemplateFirst"),"error");return}V.value=!0;try{console.log("[PublishModal] 开始删除MCP服务，ID:",g.value.id);const y=await ge.deleteCoordinatorTool(g.value.id);if(y.success)console.log("[PublishModal] 删除成功"),l(t("mcpService.deleteSuccess"),"success"),_.value=!1,h("published",null);else throw new Error(y.message)}catch(y){console.error("[PublishModal] 删除MCP服务失败:",y),l(t("mcpService.deleteFailed")+": "+y.message,"error")}finally{V.value=!1}}},S=async()=>{_.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),oe(),await fe(),await Q(),z())},Q=async()=>{if(!a.planTemplateId){console.log("[PublishModal] "+t("mcpService.noPlanTemplateId"));return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",a.planTemplateId);const y=await ge.getOrNewCoordinatorToolsByTemplate(a.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",y),y.success&&y.data){let P;if(Array.isArray(y.data)?(P=y.data[0],console.log("[PublishModal] 使用已存在的工具:",P)):(P=y.data,console.log("[PublishModal] 使用新创建的工具:",P)),g.value=P,G.value=P.publishStatus||"",c.value=P.publishStatus==="PUBLISHED",N.value=!!P.id,P.publishStatus==="PUBLISHED")if(y.endpointUrl)v.value=y.endpointUrl;else if(P.endpoint){const k=window.location.origin;v.value=`${k}/mcp${P.endpoint}`}else v.value="";else v.value="";console.log("[PublishModal] 加载工具数据 - publishStatus:",G.value,"endpointUrl:",v.value),E.serviceName=P.toolName||"",E.userRequest=P.toolDescription||a.planDescription||"",E.endpoint=P.endpoint||"";try{if(P.inputSchema){const k=JSON.parse(P.inputSchema);Array.isArray(k)&&(E.parameters=k.map(j=>({name:j.name||"",description:j.description||""})))}}catch(k){console.warn("[PublishModal] "+t("mcpService.parseInputSchemaFailed")+":",k),E.parameters=[]}console.log("[PublishModal] 表单数据已填充:",E)}else console.log("[PublishModal] 获取协调器工具数据失败:",y.message)}catch(y){console.error("[PublishModal] "+t("mcpService.loadToolDataFailed")+":",y)}};me(()=>a.modelValue,S);const z=()=>{le(()=>{if(!I.value)return;const y=I.value,P=y.parentElement;if(!P)return;const k=P.getBoundingClientRect(),j=P.querySelector(".toggle-thumb"),Y=j?j.getBoundingClientRect():null,he=Y?Y.width:32,Ce=k.width-he-4,Z=y.scrollWidth;if(Z<=Ce){const Ie=(Ce-Z)/2;c.value?(y.style.position="absolute",y.style.left=`${8+Ie}px`,y.style.right="auto",y.style.transform="none"):(y.style.position="absolute",y.style.right=`${8+Ie}px`,y.style.left="auto",y.style.transform="none")}else c.value?(y.style.position="absolute",y.style.left="8px",y.style.right="50px",y.style.transform="none"):(y.style.position="absolute",y.style.left="50px",y.style.right="8px",y.style.transform="none")})};return me(()=>c.value,z),me(()=>t("mcpService.published"),z),me(()=>t("mcpService.unpublished"),z),we(async()=>{_.value&&(console.log("[PublishModal] 组件挂载时初始化"),oe(),await fe(),await Q(),z())}),(y,P)=>(d(),m(ue,null,[b(ft,{modelValue:_.value,"onUpdate:modelValue":P[7]||(P[7]=k=>_.value=k),title:F.value,"endpoint-url":v.value,onConfirm:i,class:"wide-modal"},{footer:Re(()=>{var k,j;return[e("div",Zt,[N.value&&((k=g.value)!=null&&k.id)?(d(),m("button",{key:0,class:"action-btn danger",onClick:p,disabled:V.value},[V.value?(d(),se(o($),{key:0,icon:"carbon:loading",class:"loading-icon"})):(d(),se(o($),{key:1,icon:"carbon:trash-can"})),te(" "+s(V.value?o(t)("mcpService.deleting"):o(t)("mcpService.delete")),1)],8,en)):q("",!0),e("button",{class:"action-btn primary",onClick:O,disabled:D.value},[D.value?(d(),se(o($),{key:0,icon:"carbon:loading",class:"loading-icon"})):(d(),se(o($),{key:1,icon:"carbon:save"})),te(" "+s(D.value?o(t)("mcpService.saving"):o(t)("mcpService.save")),1)],8,tn),N.value&&((j=g.value)!=null&&j.id)?(d(),m("div",nn,[e("div",{class:"publish-toggle",onClick:r},[e("div",{class:ne(["toggle-track",{"toggle-on":c.value,"toggle-off":!c.value}])},[e("div",{class:ne(["toggle-thumb",{"thumb-on":c.value,"thumb-off":!c.value}])},null,2),e("span",{ref_key:"toggleLabelRef",ref:I,class:ne(["toggle-label",{"label-on":c.value,"label-off":!c.value}]),style:Ue(R.value)},s(c.value?o(t)("mcpService.published"):o(t)("mcpService.unpublished")),7)],2)])])):q("",!0)])]}),default:Re(()=>[e("div",yt,[e("div",St,[e("div",{class:ne(["endpoint-url-row",{"single-item":!c.value}])},[e("div",Pt,[e("label",null,s(o(t)("mcpService.endpointRequired")),1),e("div",Ct,[e("div",wt,[e("div",Tt,[e("div",Et,[e("div",It,[b(o($),{icon:"carbon:application",width:"16",class:"input-icon"}),ae(e("input",{type:"text","onUpdate:modelValue":P[0]||(P[0]=k=>E.endpoint=k),placeholder:o(t)("mcpService.endpointPlaceholder"),class:"select-input",onFocus:P[1]||(P[1]=k=>A.value=!0),onInput:X,onKeydown:rt(J,["enter"]),onBlur:L},null,40,Dt),[[ce,E.endpoint]])]),e("button",{class:"select-arrow-btn",onClick:de,title:"展开选项"},[b(o($),{icon:A.value?"carbon:chevron-up":"carbon:chevron-down",width:"14",class:"chevron"},null,8,["icon"])])]),A.value?(d(),m("div",{key:0,class:ne(["select-dropdown",{"dropdown-top":K.value==="top"}])},[e("div",xt,[e("span",null,s(o(t)("mcpService.selectEndpoint")),1),e("button",{class:"close-btn",onClick:P[2]||(P[2]=k=>A.value=!1)},[b(o($),{icon:"carbon:close",width:"12"})])]),e("div",Rt,[(d(!0),m(ue,null,_e(H.value,k=>(d(),m("button",{key:k,class:ne(["select-option",{active:E.endpoint===k}]),onClick:j=>be(k)},[e("span",At,s(k),1),E.endpoint===k?(d(),se(o($),{key:0,icon:"carbon:checkmark",width:"14",class:"check-icon"})):q("",!0)],10,Mt))),128))]),e("div",Ut,[e("div",Nt,[ae(e("input",{type:"text","onUpdate:modelValue":P[3]||(P[3]=k=>ee.value=k),placeholder:o(t)("mcpService.manualInput"),class:"manual-input",onKeydown:rt(C,["enter"]),onBlur:B},null,40,Ft),[[ce,ee.value]]),e("button",{class:"add-manual-btn",onClick:C},[b(o($),{icon:"carbon:add",width:"14"})])])])],2)):q("",!0),A.value?(d(),m("div",{key:1,class:"backdrop",onClick:P[4]||(P[4]=k=>A.value=!1)})):q("",!0)])])])]),c.value?(d(),m("div",Lt,[e("label",null,s(o(t)("mcpService.mcpStreamableUrl")),1),e("div",Bt,[e("div",{class:"url-display",onDblclick:f,title:o(t)("mcpService.copyUrl")+": "+v.value},[e("span",Vt,s(v.value||o(t)("mcpService.mcpStreamableUrlPlaceholder")),1),b(o($),{icon:"carbon:copy",width:"16",class:"copy-icon"})],40,qt)])])):q("",!0)],2)]),e("div",jt,[e("div",Ot,[e("label",null,s(o(t)("mcpService.toolNameRequired")),1),ae(e("input",{type:"text","onUpdate:modelValue":P[5]||(P[5]=k=>E.serviceName=k),placeholder:o(t)("mcpService.toolNamePlaceholder"),required:"",readonly:"",class:"readonly-input"},null,8,Wt),[[ce,E.serviceName]])])]),e("div",zt,[e("div",Ht,[e("label",null,s(o(t)("mcpService.toolDescriptionRequired")),1),ae(e("textarea",{"onUpdate:modelValue":P[6]||(P[6]=k=>E.userRequest=k),placeholder:o(t)("mcpService.toolDescriptionPlaceholder"),class:"description-field",rows:"3",required:""},null,8,Jt),[[ce,E.userRequest]])])]),e("div",Gt,[e("div",Kt,s(o(t)("mcpService.parameterConfig")),1),e("div",Xt,[e("table",null,[e("thead",null,[e("tr",null,[e("th",null,s(o(t)("mcpService.parameterName")),1),e("th",null,s(o(t)("mcpService.parameterDescription")),1)])]),e("tbody",null,[(d(!0),m(ue,null,_e(E.parameters,(k,j)=>(d(),m("tr",{key:j},[e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":Y=>k.name=Y,placeholder:o(t)("mcpService.parameterName"),class:"parameter-input"},null,8,Qt),[[ce,k.name]])]),e("td",null,[ae(e("input",{type:"text","onUpdate:modelValue":Y=>k.description=Y,placeholder:o(t)("mcpService.parameterDescription"),class:"parameter-input"},null,8,Yt),[[ce,k.description]])])]))),128))])])])])])]),_:1},8,["modelValue","title","endpoint-url"]),u.value?(d(),m("div",{key:0,class:"error-toast",onClick:P[8]||(P[8]=k=>u.value="")},[b(o($),{icon:"carbon:error"}),te(" "+s(u.value),1)])):q("",!0),M.value?(d(),m("div",{key:1,class:"success-toast",onClick:P[9]||(P[9]=k=>M.value="")},[b(o($),{icon:"carbon:checkmark"}),te(" "+s(M.value),1)])):q("",!0)],64))}}),sn=Pe(on,[["__scopeId","data-v-d94c5d19"]]),an={class:"sidebar-content"},ln={class:"sidebar-content-header"},rn={class:"sidebar-content-title"},cn={class:"tab-switcher"},un=["disabled"],dn={key:0,class:"tab-content"},pn={class:"new-task-section"},hn={class:"sidebar-content-list"},vn={key:0,class:"loading-state"},mn={key:1,class:"error-state"},gn={key:2,class:"empty-state"},fn=["onClick"],bn={class:"task-icon"},$n={class:"task-details"},kn={class:"task-title"},_n={class:"task-preview"},yn={class:"task-time"},Sn={class:"task-actions"},Pn=["title","onClick"],Cn={key:1,class:"tab-content config-tab"},wn={key:0,class:"config-container"},Tn={class:"template-info-header"},En={class:"template-info"},In={class:"template-id"},Dn={class:"config-section"},xn={class:"section-header"},Rn={class:"generator-content"},Mn=["placeholder"],An={class:"generator-actions"},Un=["disabled"],Nn=["disabled"],Fn={class:"config-section"},Ln={class:"section-header"},Bn={class:"section-actions"},qn=["disabled","title"],Vn=["disabled","title"],jn=["disabled"],On=["placeholder"],Wn={class:"config-section"},zn={class:"section-header"},Hn={class:"execution-content"},Jn={class:"params-input-group"},Gn={class:"params-help-text"},Kn={class:"params-input-container"},Xn=["placeholder"],Qn=["title"],Yn={class:"api-url-display"},Zn={class:"api-url-label"},eo={class:"api-url"},to={class:"api-url-display"},no={class:"api-url-label"},oo=["disabled"],so=["disabled"],ao=Se({__name:"index",emits:["planExecutionRequested"],setup(U,{expose:n,emit:t}){const{t:a}=Te(),h=["currentPlanId","userRequest","rootPlanId"],_=x({enabled:!0,success:!0}),u=re(()=>_.value.enabled),M=async()=>{try{const c=await ge.getCoordinatorToolConfig();_.value=c}catch(c){console.error("加载CoordinatorTool配置失败:",c),_.value={enabled:!0,success:!1,message:c instanceof Error?c.message:"Unknown error"}}},W=re({get(){try{if(!w.jsonContent)return"";const I={...JSON.parse(w.jsonContent)};return h.forEach(R=>{delete I[R]}),JSON.stringify(I,null,2)}catch{return w.jsonContent}},set(c){try{if(!c.trim()){w.jsonContent="";return}const I=JSON.parse(c);let R={};try{R=JSON.parse(w.jsonContent||"{}")}catch{}const E={...I};h.forEach(F=>{R[F]!==void 0&&(E[F]=R[F])}),w.jsonContent=JSON.stringify(E)}catch{w.jsonContent=c}}}),D=t,V=async()=>{try{const c=await w.saveTemplate();c!=null&&c.duplicate?alert(a("sidebar.saveCompleted",{message:c.message,versionCount:c.versionCount})):c!=null&&c.saved?alert(a("sidebar.saveSuccess",{message:c.message,versionCount:c.versionCount})):c!=null&&c.message&&alert(a("sidebar.saveStatus",{message:c.message}))}catch(c){console.error("Failed to save plan modifications:",c),alert(c.message||a("sidebar.saveFailed"))}},H=async()=>{var c;try{await w.generatePlan(),alert(a("sidebar.generateSuccess",{templateId:((c=w.selectedTemplate)==null?void 0:c.id)??a("sidebar.unknown")}))}catch(I){console.error("Failed to generate plan:",I),alert(a("sidebar.generateFailed")+": "+I.message)}},G=async()=>{try{await w.updatePlan(),alert(a("sidebar.updateSuccess"))}catch(c){console.error("Failed to update plan:",c),alert(a("sidebar.updateFailed")+": "+c.message)}},v=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const c=w.preparePlanExecution();if(!c){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",c),console.log("[Sidebar] Emitting planExecutionRequested event"),D("planExecutionRequested",c),console.log("[Sidebar] Event emitted")}catch(c){console.error("Error executing plan:",c),alert(a("sidebar.executeFailed")+": "+c.message)}finally{w.finishPlanExecution()}},A=x(!1),K=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",w.currentPlanTemplateId),!w.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert(a("mcpService.selectPlanTemplateFirst"));return}console.log("[Sidebar] 打开发布MCP服务模态框"),A.value=!0},ee=c=>{c===null?console.log("MCP服务删除成功"):console.log("MCP服务发布成功:",c)},g=c=>{if(isNaN(c.getTime()))return console.warn("Invalid date received:",c),a("time.unknown");const R=new Date().getTime()-c.getTime(),E=Math.floor(R/6e4),F=Math.floor(R/36e5),oe=Math.floor(R/864e5);return E<1?a("time.now"):E<60?a("time.minuteAgo",{count:E}):F<24?a("time.hourAgo",{count:F}):oe<30?a("time.dayAgo",{count:oe}):c.toLocaleDateString("zh-CN")},N=(c,I)=>!c||c.length<=I?c:c.substring(0,I)+"...";return we(()=>{w.loadPlanTemplateList(),M()}),n({loadPlanTemplateList:w.loadPlanTemplateList,toggleSidebar:w.toggleSidebar,currentPlanTemplateId:w.currentPlanTemplateId}),(c,I)=>{var R,E;return d(),m(ue,null,[e("div",{class:ne(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(w).isCollapsed}])},[e("div",an,[e("div",ln,[e("div",rn,s(c.$t("sidebar.title")),1)]),e("div",cn,[e("button",{class:ne(["tab-button",{active:o(w).currentTab==="list"}]),onClick:I[0]||(I[0]=F=>o(w).switchToTab("list"))},[b(o($),{icon:"carbon:list",width:"16"}),te(" "+s(c.$t("sidebar.templateList")),1)],2),e("button",{class:ne(["tab-button",{active:o(w).currentTab==="config"}]),onClick:I[1]||(I[1]=F=>o(w).switchToTab("config")),disabled:!o(w).selectedTemplate},[b(o($),{icon:"carbon:settings",width:"16"}),te(" "+s(c.$t("sidebar.configuration")),1)],10,un)]),o(w).currentTab==="list"?(d(),m("div",dn,[e("div",pn,[e("button",{class:"new-task-btn",onClick:I[2]||(I[2]=F=>o(w).createNewTemplate())},[b(o($),{icon:"carbon:add",width:"16"}),te(" "+s(c.$t("sidebar.newPlan"))+" ",1),I[12]||(I[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",hn,[o(w).isLoading?(d(),m("div",vn,[b(o($),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,s(c.$t("sidebar.loading")),1)])):o(w).errorMessage?(d(),m("div",mn,[b(o($),{icon:"carbon:warning",width:"20"}),e("span",null,s(o(w).errorMessage),1),e("button",{onClick:I[3]||(I[3]=(...F)=>o(w).loadPlanTemplateList&&o(w).loadPlanTemplateList(...F)),class:"retry-btn"},s(c.$t("sidebar.retry")),1)])):o(w).planTemplateList.length===0?(d(),m("div",gn,[b(o($),{icon:"carbon:document",width:"32"}),e("span",null,s(c.$t("sidebar.noTemplates")),1)])):(d(!0),m(ue,{key:3},_e(o(w).sortedTemplates,F=>(d(),m("div",{key:F.id,class:ne(["sidebar-content-list-item",{"sidebar-content-list-item-active":F.id===o(w).currentPlanTemplateId}]),onClick:oe=>o(w).selectTemplate(F)},[e("div",bn,[b(o($),{icon:"carbon:document",width:"20"})]),e("div",$n,[e("div",kn,s(F.title||c.$t("sidebar.unnamedPlan")),1),e("div",_n,s(N(F.description||c.$t("sidebar.noDescription"),40)),1)]),e("div",yn,s(g(o(w).parseDateTime(F.updateTime||F.createTime))),1),e("div",Sn,[e("button",{class:"delete-task-btn",title:c.$t("sidebar.deleteTemplate"),onClick:ie(oe=>o(w).deleteTemplate(F),["stop"])},[b(o($),{icon:"carbon:close",width:"16"})],8,Pn)])],10,fn))),128))])])):o(w).currentTab==="config"?(d(),m("div",Cn,[o(w).selectedTemplate?(d(),m("div",wn,[e("div",Tn,[e("div",En,[e("h3",null,s(o(w).selectedTemplate.title||c.$t("sidebar.unnamedPlan")),1),e("span",In,"ID: "+s(o(w).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:I[4]||(I[4]=F=>o(w).switchToTab("list"))},[b(o($),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Dn,[e("div",xn,[b(o($),{icon:"carbon:generate",width:"16"}),e("span",null,s(c.$t("sidebar.planGenerator")),1)]),e("div",Rn,[ae(e("textarea",{"onUpdate:modelValue":I[5]||(I[5]=F=>o(w).generatorPrompt=F),class:"prompt-input",placeholder:c.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Mn),[[ce,o(w).generatorPrompt]]),e("div",An,[e("button",{class:"btn btn-primary btn-sm",onClick:H,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()},[b(o($),{icon:o(w).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ne({spinning:o(w).isGenerating})},null,8,["icon","class"]),te(" "+s(o(w).isGenerating?c.$t("sidebar.generating"):c.$t("sidebar.generatePlan")),1)],8,Un),e("button",{class:"btn btn-secondary btn-sm",onClick:G,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()||!o(w).jsonContent.trim()},[b(o($),{icon:"carbon:edit",width:"14"}),te(" "+s(c.$t("sidebar.updatePlan")),1)],8,Nn)])])]),e("div",Fn,[e("div",Ln,[b(o($),{icon:"carbon:code",width:"16"}),e("span",null,s(c.$t("sidebar.jsonTemplate")),1),e("div",Bn,[e("button",{class:"btn btn-sm",onClick:I[6]||(I[6]=(...F)=>o(w).rollbackVersion&&o(w).rollbackVersion(...F)),disabled:!o(w).canRollback,title:c.$t("sidebar.rollback")},[b(o($),{icon:"carbon:undo",width:"14"})],8,qn),e("button",{class:"btn btn-sm",onClick:I[7]||(I[7]=(...F)=>o(w).restoreVersion&&o(w).restoreVersion(...F)),disabled:!o(w).canRestore,title:c.$t("sidebar.restore")},[b(o($),{icon:"carbon:redo",width:"14"})],8,Vn),e("button",{class:"btn btn-primary btn-sm",onClick:V,disabled:o(w).isGenerating||o(w).isExecuting},[b(o($),{icon:"carbon:save",width:"14"})],8,jn)])]),ae(e("textarea",{"onUpdate:modelValue":I[8]||(I[8]=F=>W.value=F),class:"json-editor",placeholder:c.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,On),[[ce,W.value]])]),e("div",Wn,[e("div",zn,[b(o($),{icon:"carbon:play",width:"16"}),e("span",null,s(c.$t("sidebar.executionController")),1)]),e("div",Hn,[e("div",Jn,[e("label",null,s(c.$t("sidebar.executionParams")),1),e("div",Gn,s(c.$t("sidebar.executionParamsHelp")),1),e("div",Kn,[ae(e("input",{"onUpdate:modelValue":I[9]||(I[9]=F=>o(w).executionParams=F),class:"params-input",placeholder:c.$t("sidebar.executionParamsPlaceholder")},null,8,Xn),[[ce,o(w).executionParams]]),e("button",{class:"clear-params-btn",onClick:I[10]||(I[10]=(...F)=>o(w).clearExecutionParams&&o(w).clearExecutionParams(...F)),title:c.$t("sidebar.clearParams")},[b(o($),{icon:"carbon:close",width:"12"})],8,Qn)])]),e("div",Yn,[e("span",Zn,s(c.$t("sidebar.apiUrl"))+":",1),e("code",eo,s(o(w).computedApiUrl),1)]),e("div",to,[e("span",no,s(c.$t("sidebar.statusApiUrl"))+":",1),I[13]||(I[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:v,disabled:o(w).isExecuting||o(w).isGenerating},[b(o($),{icon:o(w).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ne({spinning:o(w).isExecuting})},null,8,["icon","class"]),te(" "+s(o(w).isExecuting?c.$t("sidebar.executing"):c.$t("sidebar.executePlan")),1)],8,oo),u.value?(d(),m("button",{key:0,class:"btn publish-mcp-btn",onClick:K,disabled:!o(w).currentPlanTemplateId},[b(o($),{icon:"carbon:application",width:"16"}),te(" "+s(o(a)("sidebar.publishMcpService")),1)],8,so)):q("",!0)])])])):q("",!0)])):q("",!0)])],2),b(sn,{modelValue:A.value,"onUpdate:modelValue":I[11]||(I[11]=F=>A.value=F),"plan-template-id":o(w).currentPlanTemplateId||"","plan-title":((R=o(w).selectedTemplate)==null?void 0:R.title)||"","plan-description":((E=o(w).selectedTemplate)==null?void 0:E.description)||"",onPublished:ee},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),lo=Pe(ao,[["__scopeId","data-v-de78f1ad"]]);class Ve{static async sendMessage(n){return kt.withLlmCheck(async()=>{const t=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n})});if(!t.ok)throw new Error(`API request failed: ${t.status}`);return await t.json()})}}ke(Ve,"BASE_URL","/api/executor");class je{static async getDetails(n){try{const t=await fetch(`${this.BASE_URL}/details/${n}`);if(t.status===404)return null;if(!t.ok){const _=await t.text();throw new Error(`Failed to get detailed information: ${t.status} - ${_}`)}const a=await t.text(),h=JSON.parse(a);return h&&typeof h=="object"&&!h.currentPlanId&&(h.currentPlanId=n),h}catch(t){return console.error("[CommonApiService] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to save, please retry"}}}static async submitFormInput(n,t){const a=await fetch(`${this.BASE_URL}/submit-input/${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let _;try{_=await a.json()}catch{_={message:`Failed to submit form input: ${a.status}`}}throw new Error(_.message||`Failed to submit form input: ${a.status}`)}const h=a.headers.get("content-type");return h&&h.indexOf("application/json")!==-1?await a.json():{success:!0}}static async getAllPrompts(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get Prompt list:",n),n}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}ke(je,"BASE_URL","/api/executor");const xe=class xe{constructor(){ke(this,"POLL_INTERVAL",5e3);ke(this,"state",qe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));ke(this,"callbacks",{});ke(this,"planExecutionCache",new Map);ke(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(n){return this.planExecutionCache.get(n)}getCachedUIState(n){return this.uiStateCache.get(n)}setCachedUIState(n,t){this.uiStateCache.set(n,t),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${n}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(n){return this.planExecutionCache.has(n)}setCachedPlanRecord(n,t){this.planExecutionCache.set(n,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n}`)}clearCachedPlanRecord(n){const t=this.planExecutionCache.delete(n);return t&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${n}`),t}clearAllCachedRecords(){const n=this.planExecutionCache.size,t=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${n}, UI States: ${t}`)}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(n){this.callbacks={...this.callbacks,...n},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(n))}async handleUserMessageSendRequested(n){if(this.validateAndPrepareUIForNewRequest(n))try{if(await this.sendUserMessageAndSetPlanId(n),this.state.activePlanId)this.initiatePlanExecutionSequence(n,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(t){console.error("[PlanExecutionManager] Failed to send user message:",t);const a=this.state.activePlanId??"error";this.setCachedUIState(a,{enabled:!0}),this.emitChatInputUpdateState(a),this.state.activePlanId=null}}handlePlanExecutionRequested(n,t){console.log("[PlanExecutionManager] Received plan execution request:",{planId:n,query:t}),n?(this.state.activePlanId=n,this.initiatePlanExecutionSequence(t??"Execute Plan",n)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(n,t){const a=this.getCachedPlanRecord(n);return a!=null&&a.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${n}`),this.handlePlanExecutionRequested(a.currentPlanId,t),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${n}`),!1)}validateAndPrepareUIForNewRequest(n){if(!n)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const t=this.state.activePlanId??"ui-state";return this.setCachedUIState(t,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(t),!0}async sendUserMessageAndSetPlanId(n){try{const t=await Ve.sendMessage(n);if(t!=null&&t.planId)return this.state.activePlanId=t.planId,t;if(t!=null&&t.planTemplateId)return this.state.activePlanId=t.planTemplateId,{...t,planId:t.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",t),new Error("Failed to get valid planId from API response")}catch(t){throw console.error("[PlanExecutionManager] API call failed:",t),t}}initiatePlanExecutionSequence(n,t){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${n}", planId: ${t}`);const a=t;this.emitDialogRoundStart(a),this.startPolling()}handlePlanCompletion(n){this.emitPlanCompleted(n.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Fe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}n.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(n.rootPlanId??""))}handlePlanError(n){this.emitPlanError(n.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Fe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const n=await this.getPlanDetails(this.state.activePlanId);if(!n){console.warn("[PlanExecutionManager] No details received from API");return}if(n.status&&n.status==="failed"){this.handlePlanError(n);return}if(n.rootPlanId&&this.setCachedPlanRecord(n.rootPlanId,n),!n.steps||n.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(n.rootPlanId??""),this.handlePlanCompletion(n);return}this.emitPlanUpdate(n.rootPlanId??""),n.completed&&this.handlePlanCompletion(n)}catch(n){console.error("[PlanExecutionManager] Failed to poll plan status:",n)}finally{this.state.isPolling=!1}}}async getPlanDetails(n){try{const t=await je.getDetails(n);return t!=null&&t.rootPlanId&&(this.planExecutionCache.set(t.rootPlanId,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t.rootPlanId}`)),t}catch(t){return console.error("[PlanExecutionManager] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(n){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(n)}emitDialogRoundStart(n){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(n)}emitPlanUpdate(n){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(n)}emitPlanCompleted(n){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(n)}emitPlanError(n){this.callbacks.onPlanError&&this.callbacks.onPlanError(n)}};ke(xe,"instance",null);let Be=xe;const ve=Be.getInstance();class De{static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}static async getFileTree(n){try{const t=await fetch(`${this.BASE_URL}/tree/${n}`),h=await(await this.handleResponse(t)).json();if(!h.success)throw new Error(h.message||"Failed to get file tree");return h.data}catch(t){throw console.error("Failed to get file tree:",t),t}}static async getFileContent(n,t){try{const a=await fetch(`${this.BASE_URL}/content/${n}?path=${encodeURIComponent(t)}`),_=await(await this.handleResponse(a)).json();if(!_.success)throw new Error(_.message||"Failed to get file content");return _.data}catch(a){throw console.error("Failed to get file content:",a),a}}static async downloadFile(n,t,a){try{const h=await fetch(`${this.BASE_URL}/download/${n}?path=${encodeURIComponent(t)}`);await this.handleResponse(h);const _=await h.blob(),u=window.URL.createObjectURL(_),M=document.createElement("a");M.href=u,M.download=a||t.split("/").pop()||"download",document.body.appendChild(M),M.click(),window.URL.revokeObjectURL(u),document.body.removeChild(M)}catch(h){throw console.error("Failed to download file:",h),h}}static isTextFile(n,t){const a=["text/","application/json","application/xml","application/javascript","application/typescript"],h=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(a.some(u=>n.startsWith(u)))return!0;const _=t.toLowerCase();return h.some(u=>_.endsWith(u))}static getFileIcon(n){if(n.type==="directory")return"carbon:folder";const t=n.name.toLowerCase();return t.endsWith(".js")?"vscode-icons:file-type-js":t.endsWith(".ts")?"vscode-icons:file-type-typescript":t.endsWith(".vue")?"vscode-icons:file-type-vue":t.endsWith(".java")?"vscode-icons:file-type-java":t.endsWith(".py")?"vscode-icons:file-type-python":t.endsWith(".json")?"vscode-icons:file-type-json":t.endsWith(".xml")?"vscode-icons:file-type-xml":t.endsWith(".html")?"vscode-icons:file-type-html":t.endsWith(".css")?"vscode-icons:file-type-css":t.endsWith(".md")?"vscode-icons:file-type-markdown":t.endsWith(".yml")||t.endsWith(".yaml")?"vscode-icons:file-type-yaml":t.endsWith(".pdf")?"vscode-icons:file-type-pdf2":t.endsWith(".doc")||t.endsWith(".docx")?"vscode-icons:file-type-word":t.endsWith(".xls")||t.endsWith(".xlsx")?"vscode-icons:file-type-excel":t.endsWith(".ppt")||t.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":t.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":t.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}ke(De,"BASE_URL","/api/file-browser");const io={class:"file-tree-node"},ro={class:"node-icon"},co={class:"node-name"},uo={key:1,class:"file-size"},po={key:2,class:"node-actions"},ho={key:0,class:"children"},vo=Se({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(U,{emit:n}){const t=U,a=n,h=x(t.level===0),_=x(!1),u=x(!1),M=x({}),W=()=>{t.node.type==="directory"&&(h.value=!h.value)},D=()=>{t.node.type==="directory"?W():V()},V=()=>{t.node.type==="file"&&a("file-selected",t.node),v()},H=()=>{a("download-file",t.node),v()},G=g=>{g.preventDefault(),u.value=!0,M.value={position:"fixed",top:`${g.clientY}px`,left:`${g.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",v)},0)},v=()=>{u.value=!1,document.removeEventListener("click",v)},A=async()=>{try{await navigator.clipboard.writeText(t.node.path)}catch(g){console.error("Failed to copy path:",g)}v()},K=()=>t.node.type==="directory"?h.value?"carbon:folder-open":"carbon:folder":De.getFileIcon(t.node),ee=g=>{if(g===0)return"0 B";const N=1024,c=["B","KB","MB","GB"],I=Math.floor(Math.log(g)/Math.log(N));return parseFloat((g/Math.pow(N,I)).toFixed(1))+" "+c[I]};return Ee(()=>{document.removeEventListener("click",v)}),(g,N)=>{const c=ht("FileTreeNode",!0);return d(),m("div",io,[e("div",{class:ne(["node-content",{"is-directory":g.node.type==="directory","is-file":g.node.type==="file","is-expanded":h.value}]),style:Ue({paddingLeft:`${g.level*16+12}px`}),onClick:D,onContextmenu:ie(G,["prevent"])},[g.node.type==="directory"?(d(),m("div",{key:0,class:"expand-icon",onClick:ie(W,["stop"])},[b(o($),{icon:h.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):q("",!0),e("div",ro,[b(o($),{icon:K()},null,8,["icon"])]),e("span",co,s(g.node.name),1),g.node.type==="file"?(d(),m("span",uo,s(ee(g.node.size)),1)):q("",!0),_.value?(d(),m("div",po,[g.node.type==="file"?(d(),m("button",{key:0,onClick:N[0]||(N[0]=ie(I=>g.$emit("download-file",g.node),["stop"])),class:"action-btn download-btn",title:"Download"},[b(o($),{icon:"carbon:download"})])):q("",!0)])):q("",!0)],38),g.node.type==="directory"&&h.value&&g.node.children?(d(),m("div",ho,[(d(!0),m(ue,null,_e(g.node.children,I=>(d(),se(c,{key:I.path,node:I,level:g.level+1,onFileSelected:N[1]||(N[1]=R=>g.$emit("file-selected",R)),onDownloadFile:N[2]||(N[2]=R=>g.$emit("download-file",R))},null,8,["node","level"]))),128))])):q("",!0),u.value?(d(),m("div",{key:1,class:"context-menu",style:Ue(M.value),onClick:N[3]||(N[3]=ie(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:V},[b(o($),{icon:"carbon:view"}),N[4]||(N[4]=e("span",null,"Open",-1))]),g.node.type==="file"?(d(),m("div",{key:0,class:"context-menu-item",onClick:H},[b(o($),{icon:"carbon:download"}),N[5]||(N[5]=e("span",null,"Download",-1))])):q("",!0),N[7]||(N[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:A},[b(o($),{icon:"carbon:copy"}),N[6]||(N[6]=e("span",null,"Copy Path",-1))])],4)):q("",!0)])}}}),mo=Pe(vo,[["__scopeId","data-v-e4a376d5"]]),go={class:"file-browser"},fo={class:"file-browser-header"},bo={class:"header-actions"},$o=["disabled","title"],ko={class:"file-browser-content"},_o={class:"file-tree-panel"},yo={key:0,class:"loading-state"},So={key:1,class:"error-state"},Po={key:0,class:"waiting-for-files"},Co={class:"message-content"},wo={class:"tips"},To=["disabled"],Eo={key:1,class:"actual-error"},Io={key:2,class:"empty-state"},Do={key:3,class:"file-tree"},xo={key:0,class:"file-content-panel"},Ro={class:"file-content-header"},Mo={class:"file-info"},Ao={class:"file-name"},Uo={class:"file-size"},No={class:"file-actions"},Fo=["title"],Lo=["title"],Bo={class:"file-content-body"},qo={key:0,class:"loading-content"},Vo={key:1,class:"content-error"},jo={key:2,class:"file-content"},Oo={key:0,class:"text-content"},Wo={key:1,class:"binary-content"},zo=Se({__name:"index",props:{planId:{}},setup(U){const n=U,{t}=Te(),a=x(!1),h=x(null),_=x(null),u=x(null),M=x(null),W=x(!1),D=x(null),V=x(null),H=re(()=>!M.value||!u.value?!1:De.isTextFile(M.value.mimeType,u.value.name)),G=re(()=>h.value&&(h.value.includes("Plan directory not found")||h.value.includes("not found"))),v=()=>{V.value&&(clearTimeout(V.value),V.value=null)},A=()=>{v(),V.value=window.setTimeout(()=>{G.value&&K()},5e3)},K=async()=>{if(n.planId){a.value=!0,h.value=null,v();try{_.value=await De.getFileTree(n.planId)}catch(R){h.value=R instanceof Error?R.message:t("fileBrowser.loadError"),console.error("Failed to load file tree:",R);const E=R instanceof Error?R.message:"";(E.includes("Plan directory not found")||E.includes("not found"))&&A()}finally{a.value=!1}}},ee=async R=>{if(R.type!=="directory"){u.value=R,M.value=null,W.value=!0,D.value=null;try{M.value=await De.getFileContent(n.planId,R.path)}catch(E){D.value=E instanceof Error?E.message:t("fileBrowser.contentLoadError"),console.error("Failed to load file content:",E)}finally{W.value=!1}}},g=async R=>{try{await De.downloadFile(n.planId,R.path,R.name)}catch(E){console.error("Failed to download file:",E)}},N=()=>{u.value=null,M.value=null,D.value=null},c=R=>De.getFileIcon(R),I=R=>{if(R===0)return"0 B";const E=1024,F=["B","KB","MB","GB"],oe=Math.floor(Math.log(R)/Math.log(E));return parseFloat((R/Math.pow(E,oe)).toFixed(1))+" "+F[oe]};return me(()=>n.planId,R=>{R&&(u.value=null,M.value=null,K())},{immediate:!0}),we(()=>{n.planId&&K()}),Ee(()=>{v()}),(R,E)=>(d(),m("div",go,[e("div",fo,[e("h3",null,s(R.$t("fileBrowser.title")),1),e("div",bo,[e("button",{class:"refresh-btn",onClick:K,disabled:a.value,title:R.$t("fileBrowser.refresh")},[b(o($),{icon:"carbon:refresh",class:ne({rotating:a.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,$o)])]),e("div",ko,[e("div",_o,[a.value?(d(),m("div",yo,[b(o($),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(R.$t("fileBrowser.loading")),1)])):h.value?(d(),m("div",So,[G.value?(d(),m("div",Po,[b(o($),{icon:"carbon:time",class:"rotating"}),e("div",Co,[e("h3",null,s(R.$t("fileBrowser.waitingForGeneration")),1),e("p",null,s(R.$t("fileBrowser.planExecuting")),1),e("div",wo,[b(o($),{icon:"carbon:information"}),e("span",null,s(R.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:K,class:"retry-btn",disabled:a.value},[b(o($),{icon:"carbon:refresh",class:ne({rotating:a.value})},null,8,["class"]),te(" "+s(a.value?R.$t("fileBrowser.checking"):R.$t("fileBrowser.checkNow")),1)],8,To)])):(d(),m("div",Eo,[b(o($),{icon:"carbon:warning"}),e("span",null,s(h.value),1),e("button",{onClick:K,class:"retry-btn"},s(R.$t("fileBrowser.retry")),1)]))])):_.value?(d(),m("div",Do,[b(mo,{node:_.value,level:0,onFileSelected:ee,onDownloadFile:g},null,8,["node"])])):(d(),m("div",Io,[b(o($),{icon:"carbon:folder-off"}),e("span",null,s(R.$t("fileBrowser.noFiles")),1)]))]),u.value?(d(),m("div",xo,[e("div",Ro,[e("div",Mo,[b(o($),{icon:c(u.value)},null,8,["icon"]),e("span",Ao,s(u.value.name),1),e("span",Uo,"("+s(I(u.value.size))+")",1)]),e("div",No,[e("button",{onClick:E[0]||(E[0]=F=>g(u.value)),class:"download-btn",title:R.$t("fileBrowser.download")},[b(o($),{icon:"carbon:download"})],8,Fo),e("button",{onClick:N,class:"close-btn",title:R.$t("common.close")},[b(o($),{icon:"carbon:close"})],8,Lo)])]),e("div",Bo,[W.value?(d(),m("div",qo,[b(o($),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(R.$t("fileBrowser.loadingContent")),1)])):D.value?(d(),m("div",Vo,[b(o($),{icon:"carbon:warning"}),e("span",null,s(D.value),1)])):M.value?(d(),m("div",jo,[H.value?(d(),m("div",Oo,[e("pre",null,[e("code",null,s(M.value.content),1)])])):(d(),m("div",Wo,[b(o($),{icon:"carbon:document-unknown"}),e("p",null,s(R.$t("fileBrowser.binaryFile")),1),e("button",{onClick:E[1]||(E[1]=F=>g(u.value)),class:"download-btn-large"},[b(o($),{icon:"carbon:download"}),te(" "+s(R.$t("fileBrowser.downloadToView")),1)])]))])):q("",!0)])])):q("",!0)])]))}}),Ho=Pe(zo,[["__scopeId","data-v-e7c74fe4"]]),Jo={class:"right-panel"},Go={class:"preview-header"},Ko={class:"preview-tabs"},Xo={class:"preview-content"},Qo={key:0,class:"step-details"},Yo={key:0,class:"step-info-fixed"},Zo={key:0,class:"agent-info"},es={class:"info-item"},ts={class:"label"},ns={class:"value"},os={class:"info-item"},ss={class:"label"},as={class:"value"},ls={class:"info-item"},is={class:"label"},rs={class:"value"},cs={class:"info-item"},us={class:"label"},ds={class:"value"},ps={class:"info-item"},hs={class:"label"},vs={class:"execution-status"},ms={class:"status-item"},gs={class:"status-text"},fs={key:0},bs={key:0,class:"think-act-steps"},$s={class:"steps-container"},ks={class:"step-header"},_s={class:"step-number"},ys={class:"think-section"},Ss={class:"think-content"},Ps={class:"input"},Cs={class:"label"},ws={class:"output"},Ts={class:"label"},Es={key:0,class:"action-section"},Is={class:"action-content"},Ds={class:"tool-info"},xs={class:"label"},Rs={class:"value"},Ms={class:"input"},As={class:"label"},Us={class:"output"},Ns={class:"label"},Fs={key:0,class:"sub-plan-section"},Ls={class:"sub-plan-content"},Bs={class:"sub-plan-header"},qs={class:"sub-plan-info"},Vs={class:"label"},js={class:"value"},Os={key:0,class:"sub-plan-info"},Ws={class:"label"},zs={class:"value"},Hs={class:"sub-plan-status"},Js={class:"status-text"},Gs={key:0,class:"no-steps-message"},Ks={key:1,class:"no-execution-message"},Xs={class:"step-basic-info"},Qs={class:"info-item"},Ys={class:"label"},Zs={class:"value"},ea={key:0,class:"info-item"},ta={class:"label"},na={class:"value"},oa={class:"info-item"},sa={class:"label"},aa={class:"no-execution-hint"},la={key:2,class:"execution-indicator"},ia={class:"execution-text"},ra={key:1,class:"no-selection"},ca=["title"],ua={key:1,class:"file-browser-container"},da={key:1,class:"no-plan-message"},pa={class:"message-content"},ha={class:"tips"},va=Se({__name:"index",props:{currentRootPlanId:{}},setup(U,{expose:n}){const t=U,{t:a}=Te(),h=x(),_=x(),u=x(),M=x("details"),W=x(localStorage.getItem("jmanus-last-plan-id")),D=x(localStorage.getItem("jmanus-has-executed-plan")==="true"),V=x(null),H=x(!1),G=x(!0),v=x(!0),A=re(()=>u.value?u.value.completed?a("rightPanel.status.completed"):u.value.current?a("rightPanel.status.executing"):a("rightPanel.status.waiting"):""),K=re(()=>t.currentRootPlanId?t.currentRootPlanId:W.value),ee=re(()=>!K.value&&!D.value),g=C=>{var X;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${C}`),u.value&&V.value){const J=V.value.rootPlanId??_.value;if(J&&J!==C){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${J}, Requested: ${C}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${C}`);const B=ve.getCachedPlanRecord(C);if(!B){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${C}`);return}if(B.steps&&B.steps.length>0){const J=B.steps.length,L=(B.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${L} / ${J}`)}if(u.value&&_.value&&(_.value===C||((X=V.value)==null?void 0:X.rootPlanId)===C)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${C}`),V.value)){const L=V.value,f=c(L.planId,L.rootPlanId,L.subPlanId);f?(I(f,L.stepIndex,L.planId,L.isSubPlan),fe()):console.warn("[RightPanel] Could not find plan record for refresh:",L)}},N=(C,B,X,J,L)=>{console.log("[RightPanel] Step selected:",{planId:C,stepIndex:B,rootPlanId:X,subPlanId:J,subStepIndex:L});const f=!!(X&&J&&L!==void 0);V.value={planId:C,stepIndex:B,isSubPlan:f,...f&&{rootPlanId:X,subPlanId:J,subStepIndex:L}};const l=c(C,X,J);if(!l){console.warn("[RightPanel] Plan data not found:",{planId:C,rootPlanId:X,subPlanId:J}),u.value=null,V.value=null;return}I(l,B,C,f)},c=(C,B,X)=>{var f;if(!B||!X)return ve.getCachedPlanRecord(C)??null;const J=ve.getCachedPlanRecord(C);if(J)return J;const L=ve.getCachedPlanRecord(B);if(!(L!=null&&L.agentExecutionSequence))return null;for(const l of L.agentExecutionSequence)if(l.thinkActSteps){for(const T of l.thinkActSteps)if(((f=T.subPlanExecutionRecord)==null?void 0:f.currentPlanId)===X)return T.subPlanExecutionRecord}return null},I=(C,B,X,J)=>{var i,r,p,S,Q;if(!C.steps||B>=C.steps.length){u.value=null,V.value=null,console.warn("[RightPanel] Invalid step data:",{planId:X,stepIndex:B,hasSteps:!!C.steps,stepsLength:(i=C.steps)==null?void 0:i.length,message:"Invalid step index"});return}_.value=X;const L=C.steps[B],f=(r=C.agentExecutionSequence)==null?void 0:r[B];console.log("[RightPanel] Step data details:",{planId:X,stepIndex:B,step:L,hasAgentExecutionSequence:!!C.agentExecutionSequence,agentExecutionSequenceLength:(p=C.agentExecutionSequence)==null?void 0:p.length,agentExecution:f,hasThinkActSteps:!!(f!=null&&f.thinkActSteps),thinkActStepsLength:(S=f==null?void 0:f.thinkActSteps)==null?void 0:S.length,isSubPlan:J});const l=(f==null?void 0:f.status)==="FINISHED",T=!l&&B===C.currentStepIndex&&!C.completed,O={planId:X,index:B,title:typeof L=="string"?L:L.title||L.description||L.name||`${J?"Sub ":""}Step ${B+1}`,description:typeof L=="string"?L:L.description||L,completed:l,current:T};f&&(O.agentExecution=f),u.value=O,console.log("[RightPanel] Step details updated:",{planId:X,stepIndex:B,stepTitle:u.value.title,hasAgentExecution:!!f,hasThinkActSteps:(((Q=f==null?void 0:f.thinkActSteps)==null?void 0:Q.length)??0)>0,completed:l,current:T,planCurrentStep:C.currentStepIndex,planCompleted:C.completed,isSubPlan:J}),f!=null&&f.thinkActSteps&&f.thinkActSteps.forEach((z,y)=>{z.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${y}:`,z.subPlanExecutionRecord)}),setTimeout(()=>{F()},100),fe()},R=(C,B,X,J)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:C,subPlanId:B,stepIndex:X,subStepIndex:J}),N(B,J,C,B,J)},E=C=>{h.value=C??void 0},F=()=>{if(!h.value)return;const{scrollTop:C,scrollHeight:B,clientHeight:X}=h.value,J=B-C-X<50,L=B>X;G.value=J,H.value=L&&!J,J?v.value=!0:B-C-X>100&&(v.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:C,scrollHeight:B,clientHeight:X,isAtBottom:J,hasScrollableContent:L,showButton:H.value,shouldAutoScroll:v.value})},oe=()=>{h.value&&(h.value.scrollTo({top:h.value.scrollHeight,behavior:"smooth"}),le(()=>{v.value=!0,F()}))},fe=()=>{!v.value||!h.value||le(()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},de=C=>{if(C===null||typeof C>"u"||C==="")return"N/A";try{const B=typeof C=="object"?C:JSON.parse(C);return JSON.stringify(B,null,2)}catch{return String(C)}},pe=()=>{u.value=null,_.value=void 0,v.value=!0,h.value&&h.value.removeEventListener("scroll",F)},be=()=>{const C=()=>{const B=h.value;return B?(E(B),B.addEventListener("scroll",F),v.value=!0,F(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};le(()=>{C()||setTimeout(()=>{C()},100)})};return me(()=>t.currentRootPlanId,(C,B)=>{C&&C!==B?(W.value=C,D.value=!0,localStorage.setItem("jmanus-last-plan-id",C),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",C)):!C&&B&&console.log("[RightPanel] Plan execution finished, keeping last plan:",W.value)},{immediate:!0}),we(()=>{console.log("[RightPanel] Component mounted"),le(()=>{be()})}),Ee(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),V.value=null,pe()}),n({updateDisplayedPlanProgress:g,handleStepSelected:N,handleSubPlanStepSelected:R}),(C,B)=>{var X,J;return d(),m("div",Jo,[e("div",Go,[e("div",Ko,[e("div",{class:ne(["tab-item",{active:M.value==="details"}]),onClick:B[0]||(B[0]=L=>M.value="details")},[b(o($),{icon:"carbon:events"}),e("span",null,s(o(a)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:ne(["tab-item",{active:M.value==="files"}]),onClick:B[1]||(B[1]=L=>M.value="files")},[b(o($),{icon:"carbon:folder"}),e("span",null,s(o(a)("fileBrowser.title")),1)],2)])]),e("div",Xo,[M.value==="details"?(d(),m("div",Qo,[u.value?(d(),m("div",Yo,[e("h3",null,s(u.value.title||u.value.description||o(a)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(d(),m("div",Zo,[e("div",es,[e("span",ts,s(o(a)("rightPanel.executingAgent"))+":",1),e("span",ns,s(u.value.agentExecution.agentName),1)]),e("div",os,[e("span",ss,s(o(a)("rightPanel.description"))+":",1),e("span",as,s(u.value.agentExecution.agentDescription||""),1)]),e("div",ls,[e("span",is,s(o(a)("rightPanel.callingModel"))+":",1),e("span",rs,s(u.value.agentExecution.modelName),1)]),e("div",cs,[e("span",us,s(o(a)("rightPanel.request"))+":",1),e("span",ds,s(u.value.agentExecution.agentRequest||""),1)]),e("div",ps,[e("span",hs,s(o(a)("rightPanel.executionResult"))+":",1),e("span",{class:ne(["value",{success:u.value.agentExecution.status==="FINISHED"}])},s(u.value.agentExecution.status||o(a)("rightPanel.executing")),3)])])):q("",!0),e("div",vs,[e("div",ms,[u.value.completed?(d(),se(o($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(d(),se(o($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(d(),se(o($),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",gs,s(A.value),1)])])])):q("",!0),e("div",{ref_key:"scrollContainer",ref:h,class:"step-details-scroll-container",onScroll:F},[u.value?(d(),m("div",fs,[(X=u.value.agentExecution)!=null&&X.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(d(),m("div",bs,[e("h4",null,s(o(a)("rightPanel.thinkAndActionSteps")),1),e("div",$s,[(d(!0),m(ue,null,_e(u.value.agentExecution.thinkActSteps,(L,f)=>(d(),m("div",{key:f,class:"think-act-step"},[e("div",ks,[e("span",_s,"#"+s(f+1),1),e("span",{class:ne(["step-status",L.status])},s(L.status||o(a)("rightPanel.executing")),3)]),e("div",ys,[e("h5",null,[b(o($),{icon:"carbon:thinking"}),te(" "+s(o(a)("rightPanel.thinking")),1)]),e("div",Ss,[e("div",Ps,[e("span",Cs,s(o(a)("rightPanel.input"))+":",1),e("pre",null,s(de(L.thinkInput)),1)]),e("div",ws,[e("span",Ts,s(o(a)("rightPanel.output"))+":",1),e("pre",null,s(de(L.thinkOutput)),1)])])]),L.actionNeeded?(d(),m("div",Es,[e("h5",null,[b(o($),{icon:"carbon:play"}),te(" "+s(o(a)("rightPanel.action")),1)]),e("div",Is,[(d(!0),m(ue,null,_e(L.actToolInfoList,(l,T)=>(d(),m("div",{key:T},[e("div",Ds,[e("span",xs,s(o(a)("rightPanel.tool"))+":",1),e("span",Rs,s(l.name||""),1)]),e("div",Ms,[e("span",As,s(o(a)("rightPanel.toolParameters"))+":",1),e("pre",null,s(de(l.parameters)),1)]),e("div",Us,[e("span",Ns,s(o(a)("rightPanel.executionResult"))+":",1),e("pre",null,s(de(l.result)),1)])]))),128))]),L.subPlanExecutionRecord?(d(),m("div",Fs,[e("h5",null,[b(o($),{icon:"carbon:tree-view"}),te(" "+s(o(a)("rightPanel.subPlan")),1)]),e("div",Ls,[e("div",Bs,[e("div",qs,[e("span",Vs,s(C.$t("rightPanel.subPlanId"))+":",1),e("span",js,s(L.subPlanExecutionRecord.currentPlanId),1)]),L.subPlanExecutionRecord.title?(d(),m("div",Os,[e("span",Ws,s(C.$t("rightPanel.title"))+":",1),e("span",zs,s(L.subPlanExecutionRecord.title),1)])):q("",!0),e("div",Hs,[L.subPlanExecutionRecord.completed?(d(),se(o($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(d(),se(o($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",Js,s(L.subPlanExecutionRecord.completed?C.$t("rightPanel.status.completed"):C.$t("rightPanel.status.executing")),1)])])])])):q("",!0)])):q("",!0)]))),128))]),u.value.agentExecution&&!((J=u.value.agentExecution.thinkActSteps)!=null&&J.length)?(d(),m("div",Gs,[e("p",null,s(o(a)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?q("",!0):(d(),m("div",Ks,[b(o($),{icon:"carbon:information",class:"info-icon"}),e("h4",null,s(o(a)("rightPanel.stepInfo")),1),e("div",Xs,[e("div",Qs,[e("span",Ys,s(o(a)("rightPanel.stepName"))+":",1),e("span",Zs,s(u.value.title||u.value.description||C.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(d(),m("div",ea,[e("span",ta,s(C.$t("rightPanel.description"))+":",1),e("span",na,s(u.value.description),1)])):q("",!0),e("div",oa,[e("span",sa,s(C.$t("rightPanel.status.label"))+":",1),e("span",{class:ne(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},s(u.value.completed?C.$t("rightPanel.status.completed"):u.value.current?C.$t("rightPanel.status.executing"):C.$t("rightPanel.status.pending")),3)])]),e("p",aa,s(o(a)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(d(),m("div",la,[B[2]||(B[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",ia,[b(o($),{icon:"carbon:in-progress",class:"rotating-icon"}),te(" "+s(o(a)("rightPanel.stepExecuting")),1)])])):q("",!0)])):(d(),m("div",ra,[b(o($),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,s(o(a)("rightPanel.noStepSelected")),1),e("p",null,s(o(a)("rightPanel.selectStepHint")),1)]))])):q("",!0),b(Ne,{name:"scroll-button"},{default:Re(()=>[H.value?(d(),m("button",{key:0,onClick:oe,class:"scroll-to-bottom-btn",title:o(a)("rightPanel.scrollToBottom")},[b(o($),{icon:"carbon:chevron-down"})],8,ca)):q("",!0)]),_:1})],544)])):q("",!0),M.value==="files"?(d(),m("div",ua,[K.value?(d(),se(Ho,{key:0,"plan-id":K.value},null,8,["plan-id"])):ee.value?(d(),m("div",da,[b(o($),{icon:"carbon:folder-off"}),e("div",pa,[e("h3",null,s(o(a)("fileBrowser.noFilesYet")),1),e("p",null,s(o(a)("fileBrowser.noPlanExecuting")),1),e("div",ha,[b(o($),{icon:"carbon:information"}),e("span",null,s(o(a)("fileBrowser.startTaskTip")),1)])])])):q("",!0)])):q("",!0)])])}}}),ma=Pe(va,[["__scopeId","data-v-d7e4058f"]]);function ga(){const U=ve,n=re(()=>U.getActivePlanId()),t=re(()=>U.getState()),a=re(()=>t.value.isPolling),h=re(()=>!!n.value),_=(D,V)=>{U.initiatePlanExecutionSequence(D,V)},u=()=>{U.stopPolling()},M=()=>{U.startPolling()},W=()=>{U.cleanup()};return Ee(()=>{W()}),{activePlanId:n,state:t,isPolling:a,hasActivePlan:h,startExecution:_,stopPolling:u,startPolling:M,cleanup:W}}const fa={class:"chat-container"},ba={class:"message-content"},$a={key:0,class:"user-message"},ka={key:1,class:"assistant-message"},_a={key:0,class:"thinking-section"},ya={class:"thinking-header"},Sa={class:"thinking-avatar"},Pa={class:"thinking-label"},Ca={class:"thinking-content"},wa={key:0,class:"thinking"},Ta={key:1,class:"progress"},Ea={class:"progress-bar"},Ia={class:"progress-text"},Da={key:2,class:"steps-container"},xa={class:"steps-title"},Ra=["onClick"],Ma={class:"section-header"},Aa={class:"step-icon"},Ua={class:"step-title"},Na={key:0,class:"step-status current"},Fa={key:1,class:"step-status completed"},La={key:2,class:"step-status pending"},Ba={key:0,class:"action-info"},qa={class:"action-description"},Va={class:"action-icon"},ja={key:0,class:"tool-params"},Oa={class:"param-label"},Wa={class:"param-content"},za={key:1,class:"think-details"},Ha={class:"think-header"},Ja={class:"think-label"},Ga={class:"think-output"},Ka={class:"think-content"},Xa={key:1,class:"sub-plan-steps"},Qa={class:"sub-plan-header"},Ya={class:"sub-plan-title"},Za={class:"sub-plan-step-list"},el=["onClick"],tl={class:"sub-step-indicator"},nl={class:"sub-step-icon"},ol={class:"sub-step-number"},sl={class:"sub-step-content"},al={class:"sub-step-title"},ll={class:"sub-step-badge"},il={key:2,class:"user-input-form-container"},rl={class:"user-input-message"},cl={key:0,class:"form-description"},ul=["onSubmit"],dl=["for"],pl=["id","name","onUpdate:modelValue"],hl={key:1,class:"form-group"},vl={for:"form-input-genericInput"},ml=["onUpdate:modelValue"],gl={type:"submit",class:"submit-user-input-btn"},fl={key:3,class:"default-processing"},bl={class:"processing-indicator"},$l={class:"response-section"},kl={class:"response-header"},_l={class:"response-avatar"},yl={class:"response-name"},Sl={class:"response-content"},Pl={key:0,class:"final-response"},Cl=["innerHTML"],wl={key:1,class:"response-placeholder"},Tl={class:"typing-indicator"},El={class:"typing-text"},Il={key:0,class:"message assistant"},Dl={class:"message-content"},xl={class:"assistant-message"},Rl={class:"thinking-section"},Ml={class:"thinking-header"},Al={class:"thinking-avatar"},Ul={class:"thinking-label"},Nl={class:"thinking-content"},Fl={class:"default-processing"},Ll={class:"processing-indicator"},Bl={class:"response-section"},ql={class:"response-header"},Vl={class:"response-avatar"},jl={class:"response-name"},Ol={class:"response-content"},Wl={class:"response-placeholder"},zl={class:"typing-indicator"},Hl={class:"typing-text"},Jl=["title"],Gl=Se({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(U,{expose:n,emit:t}){const a=U,h=t,{t:_}=Te(),u=ga(),M=x(),W=x(!1),D=x([]),V=x(),H=x(!1),G=qe({}),v=(i,r,p)=>{const S={id:Date.now().toString(),type:i,content:r,timestamp:new Date,...p};return i==="assistant"&&!S.thinking&&!S.content&&(S.thinking=_("chat.thinking")),D.value.push(S),S},A=i=>{const r=D.value[D.value.length-1];r.type==="assistant"&&Object.assign(r,i)},K=async i=>{try{W.value=!0;const r=v("assistant","",{thinking:_("chat.thinkingProcessing")}),p=await Ve.sendMessage(i);if(p.planId)console.log("[ChatComponent] Received planId from direct execution:",p.planId),r.planExecution||(r.planExecution={}),r.planExecution.currentPlanId=p.planId,ve.handlePlanExecutionRequested(p.planId,i),delete r.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete r.thinking;const S=ee(p,i);r.content=S}}catch(r){console.error("Direct mode error:",r),A({content:g(r)})}finally{W.value=!1}},ee=(i,r)=>i.result??i.message??i.content??"",g=i=>{const r=(i==null?void 0:i.message)??(i==null?void 0:i.toString())??_("chat.unknownError");return r.includes("network")||r.includes("timeout")?_("chat.networkError"):r.includes("auth")||r.includes("unauthorized")?_("chat.authError"):r.includes("invalid")||r.includes("format")||r.includes("parameter")?_("chat.formatError"):`${_("chat.unknownError")} (${r})`},N=(i=!1)=>{le(()=>{if(M.value){const r=M.value;(i||r.scrollHeight-r.scrollTop-r.clientHeight<150)&&r.scrollTo({top:r.scrollHeight,behavior:i?"auto":"smooth"})}})},c=()=>{N(!0),H.value=!1},I=()=>{if(M.value){const i=M.value,r=i.scrollHeight-i.scrollTop-i.clientHeight<150;H.value=!r&&D.value.length>0}},R=()=>{M.value&&M.value.addEventListener("scroll",I)},E=()=>{M.value&&M.value.removeEventListener("scroll",I)},F=i=>{v("user",i),a.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",i):K(i)},oe=(i,r)=>{var Q;const p=((Q=i.planExecution)==null?void 0:Q.agentExecutionSequence)??[];return r<0||r>=p.length?"IDLE":p[r].status??"IDLE"},fe=(i,r)=>{var p,S;if(!((p=i.planExecution)!=null&&p.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:i.planExecution.currentPlanId,stepIndex:r,stepTitle:(S=i.planExecution.steps)==null?void 0:S[r]}),h("step-selected",i.planExecution.currentPlanId,r)},de=(i,r)=>{var p;try{const S=(p=i.planExecution)==null?void 0:p.agentExecutionSequence;if(!(S!=null&&S.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const Q=S[r];if(!Q)return console.log(`[ChatComponent] No agentExecution found for step ${r}`),[];if(!Q.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${r}`),[];for(const z of Q.thinkActSteps)if(z.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${r}:`,z.subPlanExecutionRecord),(z.subPlanExecutionRecord.steps??[]).map(P=>typeof P=="string"?P:typeof P=="object"&&P!==null&&(P.title||P.description)||_("rightPanel.subStep"));return[]}catch(S){return console.warn("[ChatComponent] Error getting sub-plan steps:",S),[]}},pe=(i,r,p)=>{var S;try{const Q=(S=i.planExecution)==null?void 0:S.agentExecutionSequence;if(!(Q!=null&&Q.length))return"pending";const z=Q[r];if(!z||!z.thinkActSteps)return"pending";let y=null;for(const k of z.thinkActSteps)if(k.subPlanExecutionRecord){y=k.subPlanExecutionRecord;break}if(!y)return"pending";const P=y.currentStepIndex;return y.completed?"completed":P==null?p===0?"current":"pending":p<P?"completed":p===P?"current":"pending"}catch(Q){return console.warn("[ChatComponent] Error getting sub-plan step status:",Q),"pending"}},be=(i,r,p)=>{var S,Q;try{const z=(S=i.planExecution)==null?void 0:S.agentExecutionSequence;if(!(z!=null&&z.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const y=z[r];if(!y){console.warn("[ChatComponent] No agentExecution found for step",r);return}if(!y.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",r);return}let P=null;for(const k of y.thinkActSteps)if(k.subPlanExecutionRecord){P=k.subPlanExecutionRecord;break}if(!(P!=null&&P.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}h("sub-plan-step-selected",((Q=i.planExecution)==null?void 0:Q.currentPlanId)??"",P.currentPlanId,r,p)}catch(z){console.error("[ChatComponent] Error handling sub-plan step click:",z)}},C=(i,r)=>{var S,Q,z,y;if(!((S=i.planExecution)!=null&&S.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",i.planExecution.steps.length,"execution sequence:",((Q=r.agentExecutionSequence)==null?void 0:Q.length)??0);const p=new Array(i.planExecution.steps.length).fill(null);if((z=r.agentExecutionSequence)!=null&&z.length){const P=Math.min(r.agentExecutionSequence.length,i.planExecution.steps.length);for(let k=0;k<P;k++){const j=r.agentExecutionSequence[k];if((y=j.thinkActSteps)!=null&&y.length){const Y=j.thinkActSteps[j.thinkActSteps.length-1];Y.actionDescription&&Y.toolParameters?(p[k]={actionDescription:Y.actionDescription,toolParameters:typeof Y.toolParameters=="string"?Y.toolParameters:JSON.stringify(Y.toolParameters,null,2),thinkInput:Y.thinkInput??"",thinkOutput:Y.thinkOutput??"",status:r.currentStepIndex!==void 0&&k<r.currentStepIndex?"completed":r.currentStepIndex!==void 0&&k===r.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${k} action set: ${p[k].actionDescription}`)):(p[k]={actionDescription:_("chat.thinking"),toolParameters:_("chat.waitingDecision"),thinkInput:Y.thinkInput??"",thinkOutput:Y.thinkOutput??"",status:r.currentStepIndex!==void 0&&k===r.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${k} is thinking`))}else p[k]={actionDescription:r.currentStepIndex!==void 0&&k<r.currentStepIndex?_("chat.status.completed"):_("chat.status.pending"),toolParameters:_("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:r.currentStepIndex!==void 0&&k<r.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${k} has no execution details, status set to: ${p[k].status}`)}}else console.log("[ChatComponent] No execution sequence data");i.stepActions=[...p],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(p.map(P=>P==null?void 0:P.actionDescription))),le(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},B=i=>{console.log("[ChatComponent] Starting dialog round with planId:",i),i&&(D.value.findIndex(p=>{var S;return((S=p.planExecution)==null?void 0:S.currentPlanId)===i&&p.type==="assistant"})===-1?(v("assistant","",{planExecution:{currentPlanId:i},thinking:_("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",i)):console.log("[ChatComponent] Found existing assistant message for planId:",i))},X=i=>{var z,y,P,k;console.log("[ChatComponent] Processing plan update with rootPlanId:",i);const r=ve.getCachedPlanRecord(i);if(!r){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",r),console.log("[ChatComponent] Plan steps:",r.steps),console.log("[ChatComponent] Plan completed:",r.completed),!r.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const p=D.value.findIndex(j=>{var Y;return((Y=j.planExecution)==null?void 0:Y.currentPlanId)===r.currentPlanId&&j.type==="assistant"});let S;if(p!==-1)S=D.value[p],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",r.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",r.currentPlanId),console.log("[ChatComponent] Current messages:",D.value.map(Y=>{var he;return{type:Y.type,planId:(he=Y.planExecution)==null?void 0:he.currentPlanId,content:Y.content.substring(0,50)}}));let j=-1;for(let Y=D.value.length-1;Y>=0;Y--)if(D.value[Y].type==="assistant"){j=Y;break}if(j!==-1)S=D.value[j],S.planExecution||(S.planExecution={}),S.planExecution.currentPlanId=r.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",r.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(S.planExecution||(S.planExecution={}),S.planExecution=JSON.parse(JSON.stringify(r)),!r.steps||r.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),r.completed){delete S.thinking;const j=r.summary??r.result??r.message??_("chat.executionCompleted");S.content=J(j),console.log("[ChatComponent] Set simple response content:",S.content)}else r.title&&(S.thinking=`${_("chat.thinkingExecuting",{title:r.title})}`);return}delete S.thinking;const Q=r.steps.map(j=>typeof j=="string"?j:typeof j=="object"&&j!==null&&(j.title||j.description)||_("chat.step"));if(S.planExecution&&(S.planExecution.steps=Q),r.agentExecutionSequence&&r.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",r.agentExecutionSequence.length),C(S,r);const j=r.currentStepIndex??0;if(j>=0&&j<r.agentExecutionSequence.length){const he=r.agentExecutionSequence[j].thinkActSteps;if(he&&he.length>0){const Ce=he[he.length-1];if(Ce.thinkOutput){const Ie=Ce.thinkOutput.length>150?Ce.thinkOutput.substring(0,150)+"...":Ce.thinkOutput;S.thinking=`${_("chat.thinking")}: ${Ie}`}}}}else if(S.planExecution){const j=S.planExecution.currentStepIndex??0,Y=(z=S.planExecution.steps)==null?void 0:z[j],he=typeof Y=="string"?Y:"";S.thinking=`${_("chat.thinkingExecuting",{title:he})}`}if(r.userInputWaitState&&S.planExecution?(console.log("[ChatComponent] User input required:",r.userInputWaitState),S.planExecution.userInputWaitState||(S.planExecution.userInputWaitState={}),S.planExecution.userInputWaitState={message:r.userInputWaitState.message??"",formDescription:r.userInputWaitState.formDescription??"",formInputs:((y=r.userInputWaitState.formInputs)==null?void 0:y.map(j=>({label:j.label,value:j.value||""})))??[]},G[P=S.id]??(G[P]={}),S.thinking=_("input.waiting")):(k=S.planExecution)!=null&&k.userInputWaitState&&delete S.planExecution.userInputWaitState,r.completed??r.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete S.thinking;let j="";r.summary?j=r.summary:r.result?j=r.result:j=_("chat.executionCompleted"),S.content=L(j),console.log("[ChatComponent] Updated completed message:",S.content)}le(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},J=i=>i?i.includes("I ")||i.includes("you")||i.includes("hello")||i.includes("can")||i.includes("I")||i.includes("you")||i.includes("can")?i:i.length<10?`${i}! ${_("chat.anythingElse")}`:i.length<50?`${_("chat.okayDone",{text:i})}. ${_("chat.ifOtherQuestions")}`:`${i}

${_("chat.hopeHelpful")} ${_("chat.anythingElse")}`:_("chat.defaultResponse"),L=i=>i?`${i}`:`${_("chat.executionCompleted")}! ${_("chat.anythingElse")}`,f=i=>{console.log("[ChatComponent] Plan completed with rootPlanId:",i);const r=ve.getCachedPlanRecord(i);if(!r){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Plan details:",r),r.rootPlanId){const p=D.value.findIndex(S=>{var Q;return((Q=S.planExecution)==null?void 0:Q.currentPlanId)===r.rootPlanId});if(p!==-1){const S=D.value[p];delete S.thinking;let z=r.summary??r.result??_("chat.executionCompleted");!z.includes("I")&&!z.includes("you")&&(z.includes("success")||z.includes("complete")||z.includes("finished")?z=`${_("chat.great")}${z}. ${_("chat.ifOtherHelp")}`:z=`${_("chat.completedRequest",{result:z})}`),S.content=z,console.log("[ChatComponent] Updated completed message:",S.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",r.rootPlanId)}},l=i=>{W.value=!1,D.value[D.value.length-1]={id:Date.now().toString(),type:"assistant",content:i,timestamp:new Date}},T=i=>{if(!i)return"";let r=i.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return r=r.replace(/(<br><br>)/g,"</p><p>"),r.includes("</p><p>")&&(r=`<p>${r}</p>`),r},O=async i=>{var r;if(!((r=i.planExecution)!=null&&r.currentPlanId)||!i.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const p={},S=i.planExecution.userInputWaitState.formInputs;S&&S.length>0?Object.entries(G[i.id]).forEach(([z,y])=>{var j;const P=parseInt(z,10),k=((j=S[P])==null?void 0:j.label)||`input_${z}`;p[k]=y}):p.genericInput=i.genericInput??"",console.log("[ChatComponent] Submitting user input:",p);const Q=await je.submitFormInput(i.planExecution.currentPlanId,p);delete i.planExecution.userInputWaitState,delete i.genericInput,delete G[i.id],u.startPolling(),console.log("[ChatComponent] User input submitted successfully:",Q)}catch(p){console.error("[ChatComponent] User input submission failed:",p),alert(`${_("common.submitFailed")}: ${(p==null?void 0:p.message)||_("common.unknownError")}`)}};return me(()=>a.initialPrompt,(i,r)=>{console.log("[ChatComponent] initialPrompt changed from:",r,"to:",i),i&&typeof i=="string"&&i.trim()&&i!==r&&(console.log("[ChatComponent] Processing changed initial prompt:",i),le(()=>{F(i)}))},{immediate:!1}),we(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ve.setEventCallbacks({onPlanUpdate:X,onPlanCompleted:f,onDialogRoundStart:B,onChatInputUpdateState:i=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",i)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:l}),le(()=>{R()}),a.initialPrompt&&typeof a.initialPrompt=="string"&&a.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",a.initialPrompt),le(()=>{F(a.initialPrompt)}))}),Ee(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),E(),V.value&&clearInterval(V.value),u.cleanup(),Object.keys(G).forEach(i=>delete G[i])}),n({handleSendMessage:F,handlePlanUpdate:X,handlePlanCompleted:f,handleDialogRoundStart:B,addMessage:v,handlePlanError:l}),(i,r)=>(d(),m("div",fa,[e("div",{class:"messages",ref_key:"messagesRef",ref:M},[(d(!0),m(ue,null,_e(D.value,p=>{var S,Q,z,y,P,k,j,Y,he;return d(),m("div",{key:p.id,class:ne(["message",{user:p.type==="user",assistant:p.type==="assistant"}])},[e("div",ba,[p.type==="user"?(d(),m("div",$a,s(p.content),1)):(d(),m("div",ka,[p.thinking||((S=p.planExecution)==null?void 0:S.progress)!==void 0||(((z=(Q=p.planExecution)==null?void 0:Q.steps)==null?void 0:z.length)??0)>0?(d(),m("div",_a,[e("div",ya,[e("div",Sa,[b(o($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Pa,s(i.$t("chat.thinkingLabel")),1)]),e("div",Ca,[p.thinking?(d(),m("div",wa,[b(o($),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,s(p.thinking),1)])):q("",!0),((y=p.planExecution)==null?void 0:y.progress)!==void 0?(d(),m("div",Ta,[e("div",Ea,[e("div",{class:"progress-fill",style:Ue({width:p.planExecution.progress+"%"})},null,4)]),e("span",Ia,s(p.planExecution.progressText??i.$t("chat.processing")+"..."),1)])):q("",!0),(((k=(P=p.planExecution)==null?void 0:P.steps)==null?void 0:k.length)??0)>0?(d(),m("div",Da,[e("h4",xa,s(i.$t("chat.stepExecutionDetails")),1),(d(!0),m(ue,null,_e((j=p.planExecution)==null?void 0:j.steps,(Ce,Z)=>{var Ie,Oe,We,ze,He,Je,Ge,Ke,Xe,Qe,Ye,Ze,et,tt,nt,ot,st,at,lt;return d(),m("div",{key:Z,class:ne(["ai-section",{running:oe(p,Z)==="RUNNING",completed:oe(p,Z)==="FINISHED",pending:oe(p,Z)==="IDLE"}]),onClick:ie(ye=>fe(p,Z),["stop"])},[e("div",Ma,[e("span",Aa,s(oe(p,Z)==="FINISHED"?"✓":oe(p,Z)==="RUNNING"?"▶":"○"),1),e("span",Ua,s(Ce||`${i.$t("chat.step")} ${Z+1}`),1),oe(p,Z)==="RUNNING"?(d(),m("span",Na,s(i.$t("chat.status.executing")),1)):oe(p,Z)==="FINISHED"?(d(),m("span",Fa,s(i.$t("chat.status.completed")),1)):(d(),m("span",La,s(i.$t("chat.status.pending")),1))]),p.stepActions&&p.stepActions[Z]?(d(),m("div",Ba,[e("div",qa,[e("span",Va,s(((Ie=p.stepActions[Z])==null?void 0:Ie.status)==="current"?"🔄":((Oe=p.stepActions[Z])==null?void 0:Oe.status)==="completed"?"✓":"⏳"),1),e("strong",null,s((We=p.stepActions[Z])==null?void 0:We.actionDescription),1)]),(ze=p.stepActions[Z])!=null&&ze.toolParameters?(d(),m("div",ja,[r[0]||(r[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Oa,s(i.$t("common.parameters"))+":",1),e("pre",Wa,s((He=p.stepActions[Z])==null?void 0:He.toolParameters),1)])):q("",!0),(Je=p.stepActions[Z])!=null&&Je.thinkOutput?(d(),m("div",za,[e("div",Ha,[r[1]||(r[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",Ja,s(i.$t("chat.thinkingOutput"))+":",1)]),e("div",Ga,[e("pre",Ka,s((Ge=p.stepActions[Z])==null?void 0:Ge.thinkOutput),1)])])):q("",!0)])):q("",!0),((Ke=de(p,Z))==null?void 0:Ke.length)>0?(d(),m("div",Xa,[e("div",Qa,[b(o($),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",Ya,s(i.$t("rightPanel.subPlan")),1)]),e("div",Za,[(d(!0),m(ue,null,_e(de(p,Z),(ye,$e)=>(d(),m("div",{key:`sub-${Z}-${$e}`,class:ne(["sub-plan-step-item",{completed:pe(p,Z,$e)==="completed",current:pe(p,Z,$e)==="current",pending:pe(p,Z,$e)==="pending"}]),onClick:ie(it=>be(p,Z,$e),["stop"])},[e("div",tl,[e("span",nl,s(pe(p,Z,$e)==="completed"?"✓":pe(p,Z,$e)==="current"?"▶":"○"),1),e("span",ol,s($e+1),1)]),e("div",sl,[e("span",al,s(ye),1),e("span",ll,s(i.$t("rightPanel.subStep")),1)])],10,el))),128))])])):q("",!0),(Xe=p.planExecution)!=null&&Xe.userInputWaitState&&oe(p,Z)==="RUNNING"?(d(),m("div",il,[e("p",rl,s(((Ye=(Qe=p.planExecution)==null?void 0:Qe.userInputWaitState)==null?void 0:Ye.message)??i.$t("chat.userInput.message")),1),(et=(Ze=p.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&et.formDescription?(d(),m("p",cl,s((nt=(tt=p.planExecution)==null?void 0:tt.userInputWaitState)==null?void 0:nt.formDescription),1)):q("",!0),e("form",{onSubmit:ie(ye=>O(p),["prevent"]),class:"user-input-form"},[(st=(ot=p.planExecution)==null?void 0:ot.userInputWaitState)!=null&&st.formInputs&&p.planExecution.userInputWaitState.formInputs.length>0?(d(!0),m(ue,{key:0},_e((lt=(at=p.planExecution)==null?void 0:at.userInputWaitState)==null?void 0:lt.formInputs,(ye,$e)=>(d(),m("div",{key:$e,class:"form-group"},[e("label",{for:`form-input-${ye.label.replace(/\W+/g,"_")}`},s(ye.label)+": ",9,dl),ae(e("input",{type:"text",id:`form-input-${ye.label.replace(/\W+/g,"_")}`,name:ye.label,"onUpdate:modelValue":it=>G[p.id][$e]=it,class:"form-input"},null,8,pl),[[ce,G[p.id][$e]]])]))),128)):(d(),m("div",hl,[e("label",vl,s(i.$t("common.input"))+":",1),ae(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ye=>p.genericInput=ye,class:"form-input"},null,8,ml),[[ce,p.genericInput]])])),e("button",gl,s(i.$t("chat.userInput.submit")),1)],40,ul)])):q("",!0)],10,Ra)}),128))])):!p.content&&(p.thinking||((Y=p.planExecution)==null?void 0:Y.progress)!==void 0&&(((he=p.planExecution)==null?void 0:he.progress)??0)<100)?(d(),m("div",fl,[e("div",bl,[r[2]||(r[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(p.thinking??i.$t("chat.thinkingProcessing")),1)])])):q("",!0)])])):q("",!0),e("div",$l,[e("div",kl,[e("div",_l,[b(o($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",yl,s(i.$t("chat.botName")),1)]),e("div",Sl,[p.content?(d(),m("div",Pl,[e("div",{class:"response-text",innerHTML:T(p.content)},null,8,Cl)])):(d(),m("div",wl,[e("div",Tl,[r[3]||(r[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",El,s(i.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),W.value?(d(),m("div",Il,[e("div",Dl,[e("div",xl,[e("div",Rl,[e("div",Ml,[e("div",Al,[b(o($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ul,s(i.$t("chat.thinkingLabel")),1)]),e("div",Nl,[e("div",Fl,[e("div",Ll,[r[4]||(r[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(i.$t("chat.thinking")),1)])])])]),e("div",Bl,[e("div",ql,[e("div",Vl,[b(o($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",jl,s(i.$t("chat.botName")),1)]),e("div",Ol,[e("div",Wl,[e("div",zl,[r[5]||(r[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Hl,s(i.$t("chat.thinkingResponse")),1)])])])])])])])):q("",!0)],512),H.value?(d(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:c,title:i.$t("chat.scrollToBottom")},[b(o($),{icon:"carbon:chevron-down"})],8,Jl)):q("",!0)]))}}),Kl=Pe(Gl,[["__scopeId","data-v-99c33eb1"]]),Xl={class:"input-area"},Ql={class:"input-container"},Yl=["title"],Zl=["placeholder","disabled"],ei=["title"],ti=["disabled","title"],ni=Se({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(U,{expose:n,emit:t}){const{t:a}=Te(),h=U,_=t,u=x(),M=x(""),W=re(()=>h.placeholder||a("input.placeholder")),D=x(W.value),V=re(()=>!!h.disabled),H=()=>{le(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=Math.min(u.value.scrollHeight,120)+"px")})},G=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),v())},v=()=>{if(!M.value.trim()||V.value)return;const c=M.value.trim();_("send",c),K()},A=()=>{_("plan-mode-clicked")},K=()=>{M.value="",H(),_("clear")},ee=(c,I)=>{I&&(D.value=c?I:a("input.waiting")),_("update-state",c,I)},g=c=>{M.value=c,H()},N=()=>M.value.trim();return me(()=>h.initialValue,c=>{c&&c.trim()&&(M.value=c,H())},{immediate:!0}),n({clearInput:K,updateState:ee,setInputValue:g,getQuery:N,focus:()=>{var c;return(c=u.value)==null?void 0:c.focus()}}),we(()=>{}),Ee(()=>{}),(c,I)=>(d(),m("div",Xl,[e("div",Ql,[e("button",{class:"attach-btn",title:c.$t("input.attachFile")},[b(o($),{icon:"carbon:attachment"})],8,Yl),ae(e("textarea",{"onUpdate:modelValue":I[0]||(I[0]=R=>M.value=R),ref_key:"inputRef",ref:u,class:"chat-input",placeholder:D.value,disabled:V.value,onKeydown:G,onInput:H},null,40,Zl),[[ce,M.value]]),e("button",{class:"plan-mode-btn",title:c.$t("input.planMode"),onClick:A},[b(o($),{icon:"carbon:document"}),te(" "+s(c.$t("input.planMode")),1)],8,ei),e("button",{class:"send-button",disabled:!M.value.trim()||V.value,onClick:v,title:c.$t("input.send")},[b(o($),{icon:"carbon:send-alt"}),te(" "+s(c.$t("input.send")),1)],8,ti)])]))}}),oi=Pe(ni,[["__scopeId","data-v-4b2cba42"]]);class Me{static async getAllCronTasks(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron tasks:",n),n}}static async getCronTaskById(n){try{const t=await fetch(`${this.BASE_URL}/${n}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron task by id:",t),t}}static async createCronTask(n){try{const t=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to create cron task:",t),t}}static async updateCronTask(n,t){try{const a=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(a)).json()}catch(a){throw console.error("Failed to update cron task:",a),a}}static async updateTaskStatus(n,t){try{const a=await fetch(`${this.BASE_URL}/${n}/status?status=${t}`,{method:"PUT"});await this.handleResponse(a)}catch(a){throw console.error("Failed to update task status:",a),a}}static async deleteCronTask(n){try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE"});await this.handleResponse(t)}catch(t){throw console.error("Failed to delete cron task:",t),t}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}ke(Me,"BASE_URL","/api/cron-tasks");const Ae={validateCronExpression(U){const n=U.trim().split(/\s+/);return n.length>=5&&n.length<=6},formatTime(U){return new Date(U).toLocaleString()},async saveTask(U){try{let n;return U.id?n=await Me.updateCronTask(Number(U.id),U):n=await Me.createCronTask(U),n}catch(n){throw console.error("Failed to save cron task:",n),n}},async deleteTask(U){try{await Me.deleteCronTask(String(U))}catch(n){throw console.error("Failed to delete cron task:",n),n}},async toggleTaskStatus(U){if(!U.id)throw new Error("Task ID is required");const n=U.status===0?1:0;return await Me.updateCronTask(Number(U.id),{...U,status:n})},prepareTaskExecution(U){return U.planTemplateId?{useTemplate:!0,planData:{title:U.cronName||"Scheduled Task Execution",planData:{id:U.planTemplateId,planTemplateId:U.planTemplateId,planId:U.planTemplateId},params:U.executionParams||void 0}}:{useTemplate:!1,taskContent:U.planDesc||U.cronName||""}}},si={class:"modal-header"},ai={class:"header-actions"},li={class:"status-switch"},ii={class:"status-label"},ri={class:"toggle-switch"},ci=["checked"],ui={class:"modal-content"},di={class:"form-group"},pi={class:"form-label"},hi=["placeholder"],vi={class:"form-group"},mi={class:"form-label"},gi=["placeholder"],fi={class:"form-help"},bi={class:"form-group"},$i={class:"form-label"},ki=["placeholder"],_i={class:"form-group"},yi={class:"form-label"},Si={class:"template-toggle"},Pi={key:0,class:"template-selector"},Ci={value:""},wi=["value"],Ti={class:"form-help"},Ei={key:0,class:"form-group"},Ii={class:"time-info"},Di={class:"time-label"},xi={class:"time-value"},Ri={key:1,class:"form-group"},Mi={class:"time-info"},Ai={class:"time-label"},Ui={class:"time-value"},Ni={class:"modal-footer"},Fi=["disabled"],Li=Se({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(U,{emit:n}){const t=U,a=n,h=x(!1),_=x([]),u=x({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});we(async()=>{try{const v=await Fe.getAllPlanTemplates();v&&v.templates&&(_.value=v.templates.map(A=>({id:A.id,name:A.title||"Unnamed Template"})))}catch(v){console.error("Failed to get template list:",v)}});const W=v=>{v.target===v.currentTarget&&a("update:modelValue",!1)},D=()=>{u.value.linkTemplate=!1,u.value.templateId="",u.value.planTemplateId=""},V=()=>u.value.cronName.trim()?u.value.cronTime.trim()?Ae.validateCronExpression(u.value.cronTime)?u.value.planDesc.trim()?u.value.linkTemplate&&!u.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),H=v=>Ae.formatTime(v),G=async()=>{var v;if(V()){h.value=!0;try{const A={...u.value,...((v=t.task)==null?void 0:v.id)!==void 0&&{id:t.task.id},cronName:u.value.cronName.trim(),cronTime:u.value.cronTime.trim(),planDesc:u.value.planDesc.trim(),status:u.value.status,planTemplateId:u.value.linkTemplate&&u.value.templateId||""};a("save",A)}finally{h.value=!1}}};return me(()=>t.task,v=>{if(v){const A=v.templateId||v.planTemplateId||"";u.value={cronName:v.cronName||"",cronTime:v.cronTime||"",planDesc:v.planDesc||"",status:v.status??1,linkTemplate:!!A,templateId:A,planTemplateId:A}}else u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),me(()=>t.modelValue,v=>{v||(u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(v,A)=>(d(),se(Le,{to:"body"},[b(Ne,{name:"modal"},{default:Re(()=>{var K,ee,g;return[v.modelValue?(d(),m("div",{key:0,class:"modal-overlay",onClick:W},[e("div",{class:"modal-container",onClick:A[8]||(A[8]=ie(()=>{},["stop"]))},[e("div",si,[e("h3",null,s(v.$t("cronTask.taskDetail")),1),e("div",ai,[e("div",li,[e("span",ii,s(v.$t("cronTask.taskStatus")),1),e("label",ri,[e("input",{type:"checkbox",checked:u.value.status===0,onChange:A[0]||(A[0]=N=>u.value.status=u.value.status===0?1:0)},null,40,ci),A[9]||(A[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:A[1]||(A[1]=N=>v.$emit("update:modelValue",!1))},[b(o($),{icon:"carbon:close"})])])]),e("div",ui,[e("form",{onSubmit:ie(G,["prevent"]),class:"task-form"},[e("div",di,[e("label",pi,s(v.$t("cronTask.taskName")),1),ae(e("input",{"onUpdate:modelValue":A[2]||(A[2]=N=>u.value.cronName=N),type:"text",class:"form-input",placeholder:v.$t("cronTask.taskNamePlaceholder"),required:""},null,8,hi),[[ce,u.value.cronName]])]),e("div",vi,[e("label",mi,s(v.$t("cronTask.cronExpression")),1),ae(e("input",{"onUpdate:modelValue":A[3]||(A[3]=N=>u.value.cronTime=N),type:"text",class:"form-input",placeholder:v.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,gi),[[ce,u.value.cronTime]]),e("div",fi,s(v.$t("cronTask.cronExpressionHelp")),1)]),e("div",bi,[e("label",$i,s(v.$t("cronTask.taskDescription")),1),ae(e("textarea",{"onUpdate:modelValue":A[4]||(A[4]=N=>u.value.planDesc=N),class:"form-textarea",placeholder:v.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,ki),[[ce,u.value.planDesc]])]),e("div",_i,[e("label",yi,s(v.$t("cronTask.planTemplate")),1),e("div",Si,[e("button",{type:"button",class:ne(["template-btn",u.value.linkTemplate?"active":""]),onClick:A[5]||(A[5]=N=>u.value.linkTemplate=!0)},[b(o($),{icon:"carbon:checkmark"}),te(" "+s(v.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ne(["template-btn",u.value.linkTemplate?"":"active"]),onClick:D},[b(o($),{icon:"carbon:close"}),te(" "+s(v.$t("cronTask.noTemplate")),1)],2)]),u.value.linkTemplate?(d(),m("div",Pi,[ae(e("select",{"onUpdate:modelValue":A[6]||(A[6]=N=>u.value.templateId=N),class:"form-select"},[e("option",Ci,s(v.$t("cronTask.selectTemplate")),1),(d(!0),m(ue,null,_e(_.value,N=>(d(),m("option",{key:N.id,value:N.id},s(N.name),9,wi))),128))],512),[[vt,u.value.templateId]]),e("div",Ti,s(v.$t("cronTask.templateHelpText")),1)])):q("",!0)]),(K=v.task)!=null&&K.createTime?(d(),m("div",Ei,[e("div",Ii,[e("span",Di,s(v.$t("cronTask.createTime"))+":",1),e("span",xi,s(H(v.task.createTime)),1)])])):q("",!0),(ee=v.task)!=null&&ee.updateTime?(d(),m("div",Ri,[e("div",Mi,[e("span",Ai,s(v.$t("cronTask.updateTime"))+":",1),e("span",Ui,s(H(v.task.updateTime)),1)])])):q("",!0)],32)]),e("div",Ni,[e("button",{type:"button",class:"cancel-btn",onClick:A[7]||(A[7]=N=>v.$emit("update:modelValue",!1))},s(v.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:G,disabled:h.value},[h.value?(d(),se(o($),{key:0,icon:"carbon:loading",class:"loading-icon"})):q("",!0),te(" "+s((g=t.task)!=null&&g.id?v.$t("common.save"):v.$t("common.create")),1)],8,Fi)])])])):q("",!0)]}),_:1})]))}}),Bi=Pe(Li,[["__scopeId","data-v-5b32448e"]]),qi={class:"modal-header"},Vi={class:"header-actions"},ji={class:"modal-content"},Oi={key:0,class:"loading-container"},Wi={key:1,class:"empty-container"},zi={key:2,class:"task-list"},Hi=["onClick"],Ji={class:"task-main"},Gi={class:"task-info"},Ki={class:"task-header"},Xi={class:"task-name"},Qi={class:"task-description"},Yi={class:"task-time"},Zi=["onClick"],er=["onClick","disabled","title"],tr=["onClick","title"],nr={class:"dropdown-menu"},or=["onClick"],sr=["onClick","disabled"],ar=["onClick","disabled"],lr={class:"confirm-header"},ir={class:"confirm-content"},rr={class:"confirm-actions"},cr=["disabled"],ur={class:"confirm-header"},dr={class:"confirm-content"},pr={class:"create-options"},hr={class:"option-content"},vr={class:"option-title"},mr={class:"option-desc"},gr={class:"option-content"},fr={class:"option-title"},br={class:"option-desc"},$r={class:"confirm-actions"},kr=Se({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(U,{emit:n}){const t=ct(),a=ut(),h=bt(),{t:_}=Te(),u=U,M=n,W=x([]),D=x(!1),V=x(null),H=x(null),G=x(null),v=x(null),A=x(!1),K=x(null),ee=x(!1),g=x(null),N=x(!1),c=l=>{l.target===l.currentTarget&&M("update:modelValue",!1)},I=async()=>{D.value=!0;try{W.value=await Me.getAllCronTasks()}catch(l){console.error("Failed to load cron tasks:",l),h.error(`Failed to load tasks: ${l instanceof Error?l.message:String(l)}`)}finally{D.value=!1}},R=async l=>{V.value=l;try{const T=W.value.find(r=>r.id===l);if(!T){console.error("Task not found:",l);return}M("update:modelValue",!1);const O=Date.now().toString();await t.push({name:"direct",params:{id:O}}),await new Promise(r=>setTimeout(r,100));const i=Ae.prepareTaskExecution(T);i.useTemplate&&i.planData?a.emitPlanExecutionRequested(i.planData):i.taskContent&&a.setTask(i.taskContent)}catch(T){console.error("Failed to execute task:",T),h.error(`Execution failed: ${T instanceof Error?T.message:String(T)}`)}finally{V.value=null}},E=l=>{K.value={...l},A.value=!0,v.value=null},F=async l=>{try{await Ae.saveTask(l),await I(),A.value=!1,h.success("Task saved successfully")}catch(T){console.error("Failed to save task:",T),h.error(`Save failed: ${T instanceof Error?T.message:String(T)}`)}},oe=l=>{g.value=l,ee.value=!0},fe=async()=>{var l;if((l=g.value)!=null&&l.id){H.value=g.value.id;try{await Ae.deleteTask(g.value.id),await I(),ee.value=!1,g.value=null,h.success("Task deleted successfully")}catch(T){console.error("Failed to delete task:",T),h.error(`Delete failed: ${T instanceof Error?T.message:String(T)}`)}finally{H.value=null}}},de=()=>{ee.value=!1,g.value=null},pe=l=>{v.value=v.value===l?null:l},be=async l=>{if(l.id){G.value=l.id;try{await Ae.toggleTaskStatus(l),await I(),v.value=null,h.success(`Task ${l.status===0?"disabled":"enabled"} successfully`)}catch(T){console.error("Failed to toggle task status:",T),h.error(`Status toggle failed: ${T instanceof Error?T.message:String(T)}`)}finally{G.value=null}}},C=async l=>{try{await navigator.clipboard.writeText(l),h.success("Cron expression copied successfully")}catch(T){h.error(`Copy failed: ${T instanceof Error?T.message:String(T)}`)}},B=()=>{N.value=!0},X=()=>{N.value=!1;try{M("update:modelValue",!1);const l=_("cronTask.template");a.setTaskToInput(l);const T=Date.now().toString();t.push({name:"direct",params:{id:T}})}catch(l){console.error("Error in createWithJmanus:",l),h.error(`Creation failed: ${l instanceof Error?l.message:String(l)}`)}},J=()=>{N.value=!1,K.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},A.value=!0},L=()=>{N.value=!1},f=l=>{const T=l.target;!T.closest(".action-dropdown")&&!T.closest(".dropdown-menu")&&(v.value=null)};return we(()=>{document.addEventListener("click",f,!0)}),Ee(()=>{document.removeEventListener("click",f,!0)}),me(()=>u.modelValue,l=>{l&&I()}),(l,T)=>(d(),m(ue,null,[(d(),se(Le,{to:"body"},[b(Ne,{name:"modal"},{default:Re(()=>[U.modelValue?(d(),m("div",{key:0,class:"modal-overlay",onClick:c},[e("div",{class:"modal-container",onClick:T[3]||(T[3]=ie(()=>{},["stop"]))},[e("div",qi,[e("h3",null,s(l.$t("cronTask.title")),1),e("div",Vi,[e("button",{class:"add-task-btn",onClick:[B,T[0]||(T[0]=ie(()=>{},["stop"]))]},[b(o($),{icon:"carbon:add"}),te(" "+s(l.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:T[1]||(T[1]=O=>l.$emit("update:modelValue",!1))},[b(o($),{icon:"carbon:close"})])])]),e("div",ji,[D.value?(d(),m("div",Oi,[b(o($),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,s(l.$t("common.loading")),1)])):W.value.length===0?(d(),m("div",Wi,[b(o($),{icon:"carbon:time",class:"empty-icon"}),e("span",null,s(l.$t("cronTask.noTasks")),1)])):(d(),m("div",zi,[(d(!0),m(ue,null,_e(W.value,O=>(d(),m("div",{key:O.id||"",class:"task-item",onClick:i=>E(O)},[e("div",Ji,[e("div",Gi,[e("div",Ki,[e("div",Xi,s(O.cronName),1),e("div",{class:ne(["task-status-badge",O.status===0?"active":"inactive"])},[b(o($),{icon:O.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,s(O.status===0?l.$t("cronTask.active"):l.$t("cronTask.inactive")),1)],2)]),e("div",Qi,s(O.planDesc),1),e("div",Yi,[b(o($),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ie(i=>C(O.cronTime),["stop"])},s(O.cronTime),9,Zi)])])]),e("div",{class:"task-actions",onClick:T[2]||(T[2]=ie(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:i=>R(O.id),disabled:V.value===O.id,title:l.$t("cronTask.executeOnce")},[b(o($),{icon:V.value===O.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),te(" "+s(l.$t("cronTask.executeOnce")),1)],8,er),e("div",{class:ne(["action-dropdown",{active:v.value===O.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:i=>pe(O.id),title:l.$t("cronTask.operations")},[b(o($),{icon:"carbon:overflow-menu-horizontal"}),te(" "+s(l.$t("cronTask.operations")),1)],8,tr),ae(e("div",nr,[e("button",{class:"dropdown-item edit-btn",onClick:i=>E(O)},[b(o($),{icon:"carbon:edit"}),te(" "+s(l.$t("cronTask.edit")),1)],8,or),e("button",{class:"dropdown-item toggle-btn",onClick:i=>be(O),disabled:G.value===O.id},[b(o($),{icon:G.value===O.id?"carbon:loading":O.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),te(" "+s(O.status===0?l.$t("cronTask.disable"):l.$t("cronTask.enable")),1)],8,sr),e("button",{class:"dropdown-item delete-btn",onClick:i=>oe(O),disabled:H.value===O.id},[b(o($),{icon:H.value===O.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),te(" "+s(l.$t("cronTask.delete")),1)],8,ar)],512),[[mt,v.value===O.id]])],2)])],8,Hi))),128))]))])])])):q("",!0)]),_:1})])),b(Bi,{modelValue:A.value,"onUpdate:modelValue":T[4]||(T[4]=O=>A.value=O),task:K.value,onSave:F},null,8,["modelValue","task"]),(d(),se(Le,{to:"body"},[b(Ne,{name:"modal"},{default:Re(()=>{var O,i,r,p;return[ee.value?(d(),m("div",{key:0,class:"modal-overlay",onClick:de},[e("div",{class:"confirm-modal",onClick:T[5]||(T[5]=ie(()=>{},["stop"]))},[e("div",lr,[b(o($),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,s(l.$t("cronTask.deleteConfirm")),1)]),e("div",ir,[e("p",null,s(l.$t("cronTask.deleteConfirmMessage",{taskName:((O=g.value)==null?void 0:O.cronName)||((i=g.value)==null?void 0:i.planDesc)||""})),1)]),e("div",rr,[e("button",{class:"confirm-btn cancel-btn",onClick:de},s(l.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:fe,disabled:H.value===((r=g.value)==null?void 0:r.id)},[b(o($),{icon:H.value===((p=g.value)==null?void 0:p.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),te(" "+s(l.$t("cronTask.delete")),1)],8,cr)])])])):q("",!0)]}),_:1})])),(d(),se(Le,{to:"body"},[b(Ne,{name:"modal"},{default:Re(()=>[N.value?(d(),m("div",{key:0,class:"modal-overlay",onClick:L},[e("div",{class:"confirm-modal create-options-modal",onClick:T[6]||(T[6]=ie(()=>{},["stop"]))},[e("div",ur,[b(o($),{icon:"carbon:time",class:"create-icon"}),e("h3",null,s(l.$t("cronTask.createTask")),1)]),e("div",dr,[e("p",null,s(l.$t("cronTask.selectCreateMethod")),1),e("div",pr,[e("button",{class:"create-option-btn jmanus-btn",onClick:X},[b(o($),{icon:"carbon:ai-status"}),e("div",hr,[e("span",vr,s(l.$t("cronTask.createWithJmanus")),1),e("span",mr,s(l.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:J},[b(o($),{icon:"carbon:edit"}),e("div",gr,[e("span",fr,s(l.$t("cronTask.createManually")),1),e("span",br,s(l.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",$r,[e("button",{class:"confirm-btn cancel-btn",onClick:L},s(l.$t("common.cancel")),1)])])])):q("",!0)]),_:1})]))],64))}}),_r=Pe(kr,[["__scopeId","data-v-837947df"]]),yr={class:"direct-page"},Sr={class:"direct-chat"},Pr={class:"chat-header"},Cr={class:"header-actions"},wr=["title"],Tr=["title"],Er={class:"chat-content"},Ir=["title"],Dr={class:"message-content"},xr=Se({__name:"index",setup(U){const n=gt(),t=ct(),a=ut(),{t:h}=Te(),{message:_}=$t(),u=x(""),M=x(""),W=x(),D=x(),V=x(),H=x(!1),G=x(!1),v=x(null),A=x(!1),K=x(50),ee=x(!1),g=x(0),N=x(0);we(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",a.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",a.hasUnprocessedTask()),ve.setEventCallbacks({onPlanUpdate:l=>{console.log("[Direct] Plan update event received for rootPlanId:",l),F(l)&&(console.log("[Direct] Processing plan update for current rootPlanId:",l),D.value&&typeof D.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",l),D.value.handlePlanUpdate(l)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),W.value&&typeof W.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",l),W.value.updateDisplayedPlanProgress(l)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:l=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",l),!!F(l)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",l),D.value&&typeof D.value.handlePlanCompleted=="function"){const T=ve.getCachedPlanRecord(l);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",T),D.value.handlePlanCompleted(T??{planId:l})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");v.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:l=>{console.log("[Direct] Dialog round start event received for rootPlanId:",l),v.value=l,console.log("[Direct] Set currentRootPlanId to:",l),D.value&&typeof D.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",l),D.value.handleDialogRoundStart(l)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),fe()},onChatInputUpdateState:l=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",l),!F(l,!0))return;const T=ve.getCachedUIState(l);T&&pe(T.enabled,T.placeholder)},onPlanError:l=>{D.value.handlePlanError(l)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),w.loadPlanTemplateList(),a.hasUnprocessedTask()&&a.currentTask){const l=a.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",l),a.markTaskAsProcessed(),le(()=>{D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",l),D.value.handleSendMessage(l)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),u.value=l)})}else{const l=a.getAndClearTaskToInput();l?(M.value=l,console.log("[Direct] Setting inputOnlyContent for input only:",M.value)):(u.value=n.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"))}const f=localStorage.getItem("directPanelWidth");f&&(K.value=parseFloat(f)),console.log("[Direct] Final prompt value:",u.value),M.value&&le(()=>{V.value&&typeof V.value.setInputValue=="function"&&(V.value.setInputValue(M.value),console.log("[Direct] Set input value:",M.value),M.value="")}),window.addEventListener("plan-execution-requested",l=>{console.log("[DirectView] Received plan-execution-requested event:",l.detail),L(l.detail)})}),me(()=>a.currentTask,f=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",f),f&&!f.processed){const l=f.prompt;a.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",l),le(()=>{D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",l),D.value.handleSendMessage(l)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),me(()=>u.value,(f,l)=>{console.log("[Direct] prompt value changed from:",l,"to:",f)},{immediate:!1}),me(()=>a.taskToInput,f=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",f),f&&f.trim()&&(console.log("[Direct] Setting input value from taskToInput:",f),le(()=>{V.value&&typeof V.value.setInputValue=="function"&&(V.value.setInputValue(f.trim()),console.log("[Direct] Input value set from taskToInput watch:",f.trim()),a.getAndClearTaskToInput())}))},{immediate:!1}),Ee(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),v.value=null,ve.cleanup(),document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",R),window.removeEventListener("plan-execution-requested",f=>{L(f.detail)})});const c=f=>{ee.value=!0,g.value=f.clientX,N.value=K.value,document.addEventListener("mousemove",I),document.addEventListener("mouseup",R),document.body.style.cursor="col-resize",document.body.style.userSelect="none",f.preventDefault()},I=f=>{if(!ee.value)return;const l=window.innerWidth,O=(f.clientX-g.value)/l*100;let i=N.value+O;i=Math.max(20,Math.min(80,i)),K.value=i},R=()=>{ee.value=!1,document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",R),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",K.value.toString())},E=()=>{K.value=50,localStorage.setItem("directPanelWidth","50")},F=(f,l=!1)=>!v.value||f===v.value||l&&(f==="ui-state"||f==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",f,"current:",v.value),!1),oe=f=>{console.log("[DirectView] Send message from input:",f),D.value&&typeof D.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",f),D.value.handleSendMessage(f)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},fe=()=>{console.log("[DirectView] Input cleared"),V.value&&typeof V.value.clear=="function"&&V.value.clear()},de=()=>{console.log("[DirectView] Input focused")},pe=(f,l)=>{console.log("[DirectView] Input state updated:",f,l),G.value=!f},be=(f,l)=>{console.log("[DirectView] Step selected:",f,l),W.value&&typeof W.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",f,l),W.value.handleStepSelected(f,l)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},C=(f,l,T,O)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:f,subPlanId:l,stepIndex:T,subStepIndex:O}),W.value&&typeof W.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:f,subPlanId:l,stepIndex:T,subStepIndex:O}),W.value.handleSubPlanStepSelected(f,l,T,O)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},B=()=>{console.log("[DirectView] Plan mode button clicked"),w.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",w.isCollapsed)},X=()=>{t.push("/home")},J=()=>{t.push("/configs")},L=async f=>{var T,O,i,r;if(console.log("[DirectView] Plan execution requested:",f),H.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}H.value=!0;let l=!1;D.value&&typeof D.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",f.title),D.value.addMessage("user",f.title),l=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const p=((T=f.planData)==null?void 0:T.planTemplateId)||((O=f.planData)==null?void 0:O.id)||((i=f.planData)==null?void 0:i.planId);if(!p)throw new Error(h("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",p,"params:",f.params),console.log("[Direct] About to call PlanActApiService.executePlan");let S;if((r=f.params)!=null&&r.trim()?(console.log("[Direct] Calling executePlan with params:",f.params.trim()),S=await Fe.executePlan(p,f.params.trim())):(console.log("[Direct] Calling executePlan without params"),S=await Fe.executePlan(p)),console.log("[Direct] Plan execution API response:",S),S.planId)console.log("[Direct] Got planId from response:",S.planId,"starting plan execution"),v.value=S.planId,console.log("[Direct] Set currentRootPlanId to:",S.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ve.handlePlanExecutionRequested(S.planId,f.title);else throw console.error("[Direct] No planId in response:",S),new Error(h("direct.executionFailedNoPlanId"))}catch(p){console.error("[Direct] Plan execution failed:",p),console.error("[Direct] Error details:",{message:p.message,stack:p.stack}),v.value=null,D.value&&typeof D.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),l||D.value.addMessage("user",f.title),D.value.addMessage("assistant",`${h("direct.executionFailed")}: ${p.message||h("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${h("direct.executionFailed")}: ${p.message||h("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),H.value=!1}};return(f,l)=>(d(),m("div",yr,[e("div",Sr,[b(lo,{onPlanExecutionRequested:L}),e("div",{class:"left-panel",style:Ue({width:K.value+"%"})},[e("div",Pr,[e("button",{class:"back-button",onClick:X},[b(o($),{icon:"carbon:arrow-left"})]),e("h2",null,s(f.$t("conversation")),1),e("div",Cr,[b(_t),e("button",{class:"config-button",onClick:J,title:f.$t("direct.configuration")},[b(o($),{icon:"carbon:settings-adjust",width:"20"})],8,wr),e("button",{class:"cron-task-btn",onClick:l[0]||(l[0]=T=>A.value=!0),title:f.$t("cronTask.title")},[b(o($),{icon:"carbon:alarm",width:"20"})],8,Tr)])]),e("div",Er,[b(Kl,{ref_key:"chatRef",ref:D,mode:"direct","initial-prompt":u.value||"",onStepSelected:be,onSubPlanStepSelected:C},null,8,["initial-prompt"])]),(d(),se(oi,{key:f.$i18n.locale,ref_key:"inputRef",ref:V,disabled:G.value,placeholder:G.value?o(h)("input.waiting"):o(h)("input.placeholder"),"initial-value":u.value,onSend:oe,onClear:fe,onFocus:de,onUpdateState:pe,onPlanModeClicked:B},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:c,onDblclick:E,title:f.$t("direct.panelResizeHint")},l[2]||(l[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Ir),b(ma,{ref_key:"rightPanelRef",ref:W,style:Ue({width:100-K.value+"%"}),"current-root-plan-id":v.value},null,8,["style","current-root-plan-id"])]),b(_r,{modelValue:A.value,"onUpdate:modelValue":l[1]||(l[1]=T=>A.value=T)},null,8,["modelValue"]),o(_).show?(d(),m("div",{key:0,class:ne(["message-toast",o(_).type])},[e("div",Dr,[e("span",null,s(o(_).text),1)])],2)):q("",!0)]))}}),Br=Pe(xr,[["__scopeId","data-v-a8377d69"]]);export{Br as default};
