var ut=Object.defineProperty;var dt=(A,n,t)=>n in A?ut(A,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):A[n]=t;var ge=(A,n,t)=>dt(A,typeof n!="symbol"?n+"":n,t);import{d as Ce,u as Ee,c as _e,r as U,z as qe,A as $e,o as Se,a as f,b as p,F as re,g as _,f as j,k as we,i as H,x as o,t as l,e,w as oe,B as it,l as ve,j as le,s as ce,n as se,h as pe,y as ae,C as Re,T as Ae,q as Le,D as Ue,E as pt,p as rt,G as ht}from"./index-DTi5MOHm.js";import{I as C}from"./iconify-BNbRZVdB.js";import{s as b,P as Me,u as ct}from"./sidebar-Cbtq9e4U.js";import{M as mt,u as gt,a as vt}from"./useMessage-DR-Z-vyo.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as ft}from"./llm-check-D2idVWhZ.js";import{L as bt}from"./index-CueBKJip.js";class be{static async getAllEndpoints(){try{const n=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to get endpoints: ${n.status}`);return await n.json()}catch(n){throw console.error("获取endpoints失败:",n),new Error("获取endpoints失败: "+n.message)}}static async getOrNewCoordinatorToolsByTemplate(n){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${n}`);try{const t=await fetch(`${this.BASE_URL}/get-or-new-by-template/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const T=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",T),new Error(`Failed to get coordinator tools: ${t.status} - ${T}`)}const r=await t.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",r),r}catch(t){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",t),new Error("获取协调器工具失败: "+t.message)}}static async createCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 发送的数据:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const t={id:n.id,toolName:n.toolName,toolDescription:n.toolDescription,inputSchema:n.inputSchema,mcpSchema:n.mcpSchema,planTemplateId:n.planTemplateId,endpoint:n.endpoint,publishStatus:n.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",t);try{const r=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[CoordinatorToolApiService] 响应状态:",r.status),console.log("[CoordinatorToolApiService] 响应状态文本:",r.statusText),!r.ok){const v=await r.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",v),new Error(`Failed to create coordinator tool: ${r.status} - ${v}`)}const T=await r.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",T),T}catch(r){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",r),new Error("创建协调器工具失败: "+r.message)}}static async updateCoordinatorTool(n,t){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 发送的数据:",t),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}`);const r={id:t.id,toolName:t.toolName,toolDescription:t.toolDescription,inputSchema:t.inputSchema,mcpSchema:t.mcpSchema,planTemplateId:t.planTemplateId,endpoint:t.endpoint,publishStatus:t.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",r);try{const T=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("[CoordinatorToolApiService] 响应状态:",T.status),console.log("[CoordinatorToolApiService] 响应状态文本:",T.statusText),!T.ok){const k=await T.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",k),new Error(`Failed to update coordinator tool: ${T.status} - ${k}`)}const v=await T.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",v),v}catch(T){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",T),new Error("更新协调器工具失败: "+T.message)}}static async publishCoordinatorTool(n){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",n),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${n}/publish`);try{const t=await fetch(`${this.BASE_URL}/${n}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const T=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",T),new Error(`Failed to publish coordinator tool: ${t.status} - ${T}`)}const r=await t.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",r),r}catch(t){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",t),new Error("发布协调器工具失败: "+t.message)}}}ge(be,"BASE_URL","/api/coordinator-tools");const kt={class:"modal-form"},_t={class:"form-section"},$t={class:"form-item"},Pt={class:"endpoint-container"},Ct=["value"],St={class:"form-section"},yt={class:"form-item"},Tt={class:"form-section"},wt={class:"form-item"},Et={class:"form-section"},It={class:"parameters-table"},Dt=["onUpdate:modelValue"],xt=["onUpdate:modelValue"],Rt=["onClick"],At=["disabled"],Mt=["disabled"],Nt=Ce({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(A,{emit:n}){const{t}=Ee(),r=A,T=n,v=_e({get:()=>r.modelValue,set:$=>T("update:modelValue",$)}),k=U(""),V=U(""),O=U(!1),S=U(!1),J=U([]),E=U(null),I=qe({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),g=()=>{I.serviceName="",I.userRequest=r.planDescription||"",I.endpoint="",I.parameters=[],E.value=null},M=async()=>{try{J.value=await be.getAllEndpoints()}catch($){console.error("加载endpoints失败:",$),N("加载endpoints失败: "+$.message,"error")}},Z=()=>{I.parameters.push({name:"",description:""})},d=$=>{I.parameters.splice($,1)},P=$=>{const u=$.target;I.endpoint=u.value},q=$=>{const h=$.target.value.replace(/[^a-zA-Z0-9_/]/g,"");I.endpoint=h},N=($,u)=>{u==="success"?(V.value=$,setTimeout(()=>{V.value=""},3e3)):u==="error"&&(k.value=$,setTimeout(()=>{k.value=""},5e3))},R=()=>I.serviceName.trim()?I.userRequest.trim()?I.endpoint.trim()?!0:(N("请输入Endpoint","error"),!1):(N("请输入Tool Description","error"),!1):(N("请输入Tool Name","error"),!1),ne=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",I),console.log("[PublishModal] 当前工具:",E.value),!R()){console.log("[PublishModal] 表单验证失败");return}S.value=!0;try{if(!E.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const h=await be.getOrNewCoordinatorToolsByTemplate(r.planTemplateId);if(!h.success)throw new Error(h.message);Array.isArray(h.data)?E.value=h.data[0]:E.value=h.data}console.log("[PublishModal] 更新工具信息"),E.value.toolName=I.serviceName.trim(),E.value.toolDescription=I.userRequest.trim(),E.value.endpoint=I.endpoint.trim(),E.value.planTemplateId=r.planTemplateId;const $=I.parameters.filter(h=>h.name.trim()&&h.description.trim()).map(h=>({name:h.name.trim(),description:h.description.trim(),type:"string"}));E.value.inputSchema=JSON.stringify($),console.log("[PublishModal] 更新后的工具信息:",E.value);let u;E.value.id?(console.log("[PublishModal] 更新现有工具，ID:",E.value.id),u=await be.updateCoordinatorTool(E.value.id,E.value)):(console.log("[PublishModal] 创建新工具"),u=await be.createCoordinatorTool(E.value),E.value=u),console.log("[PublishModal] 保存成功:",u),N("MCP服务保存成功","success")}catch($){console.error("[PublishModal] 保存MCP服务失败:",$),N("保存MCP服务失败: "+$.message,"error")}finally{S.value=!1}},he=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",I),console.log("[PublishModal] planTemplateId:",r.planTemplateId),!R()){console.log("[PublishModal] 表单验证失败");return}O.value=!0;try{if(!E.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const h=await be.getOrNewCoordinatorToolsByTemplate(r.planTemplateId);if(!h.success)throw new Error(h.message);Array.isArray(h.data)?E.value=h.data[0]:E.value=h.data}console.log("[PublishModal] 更新工具信息"),E.value.toolName=I.serviceName.trim(),E.value.toolDescription=I.userRequest.trim(),E.value.endpoint=I.endpoint.trim(),E.value.planTemplateId=r.planTemplateId;const $=I.parameters.filter(h=>h.name.trim()&&h.description.trim()).map(h=>({name:h.name.trim(),description:h.description.trim(),type:"string"}));if(E.value.inputSchema=JSON.stringify($),console.log("[PublishModal] 更新后的工具信息:",E.value),E.value.id)console.log("[PublishModal] 更新现有工具，ID:",E.value.id),await be.updateCoordinatorTool(E.value.id,E.value);else{console.log("[PublishModal] 创建新工具");const h=await be.createCoordinatorTool(E.value);E.value=h}console.log("[PublishModal] 步骤5: 发布工具，ID:",E.value.id);const u=await be.publishCoordinatorTool(E.value.id);if(console.log("[PublishModal] 发布结果:",u),u.success)console.log("[PublishModal] 发布成功"),N("MCP服务发布成功","success"),T("published",E.value),v.value=!1;else throw new Error(u.message)}catch($){console.error("[PublishModal] 发布MCP服务失败:",$),N("发布MCP服务失败: "+$.message,"error")}finally{O.value=!1}},D=()=>{v.value=!1,g()},x=async()=>{v.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),g(),await M(),await B())},B=async()=>{if(!r.planTemplateId){console.log("[PublishModal] 没有planTemplateId，跳过加载协调器工具数据");return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",r.planTemplateId);const $=await be.getOrNewCoordinatorToolsByTemplate(r.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",$),$.success&&$.data){let u;Array.isArray($.data)?(u=$.data[0],console.log("[PublishModal] 使用已存在的工具:",u)):(u=$.data,console.log("[PublishModal] 使用新创建的工具:",u)),E.value=u,I.serviceName=u.toolName||"",I.userRequest=u.toolDescription||r.planDescription||"",I.endpoint=u.endpoint||"";try{if(u.inputSchema){const h=JSON.parse(u.inputSchema);Array.isArray(h)&&(I.parameters=h.map(Y=>({name:Y.name||"",description:Y.description||""})))}}catch(h){console.warn("[PublishModal] 解析inputSchema失败:",h),I.parameters=[]}console.log("[PublishModal] 表单数据已填充:",I)}else console.log("[PublishModal] 获取协调器工具数据失败:",$.message)}catch($){console.error("[PublishModal] 加载协调器工具数据失败:",$)}};return $e(()=>r.modelValue,x),Se(async()=>{v.value&&(console.log("[PublishModal] 组件挂载时初始化"),g(),await M(),await B())}),($,u)=>(p(),f(re,null,[_(mt,{modelValue:v.value,"onUpdate:modelValue":u[4]||(u[4]=h=>v.value=h),title:"发布MCP服务",onConfirm:he},{footer:we(()=>[e("button",{class:"cancel-btn",onClick:D},l(o(t)("common.cancel")),1),e("button",{class:"save-btn",onClick:ne,disabled:S.value},[S.value?(p(),ce(o(C),{key:0,icon:"carbon:loading",class:"loading-icon"})):j("",!0),H(" "+l(S.value?"保存中...":"保存"),1)],8,At),e("button",{class:"publish-btn",onClick:he,disabled:O.value},[O.value?(p(),ce(o(C),{key:0,icon:"carbon:loading",class:"loading-icon"})):j("",!0),H(" "+l(O.value?"发布中...":"发布"),1)],8,Mt)]),default:we(()=>[e("div",kt,[e("div",_t,[e("div",$t,[u[8]||(u[8]=e("label",null,[H("Endpoint "),e("span",{class:"required"},"*")],-1)),e("div",Pt,[oe(e("select",{"onUpdate:modelValue":u[0]||(u[0]=h=>I.endpoint=h),class:"endpoint-select",onChange:P},[u[7]||(u[7]=e("option",{value:""},"请选择或输入Endpoint",-1)),(p(!0),f(re,null,ve(J.value,h=>(p(),f("option",{key:h,value:h},l(h),9,Ct))),128))],544),[[it,I.endpoint]]),oe(e("input",{type:"text","onUpdate:modelValue":u[1]||(u[1]=h=>I.endpoint=h),placeholder:"请输入Endpoint（必须是英文）",class:"endpoint-input",onInput:q},null,544),[[le,I.endpoint]])])])]),e("div",St,[e("div",yt,[u[9]||(u[9]=e("label",null,[H("Tool Name "),e("span",{class:"required"},"*")],-1)),oe(e("input",{type:"text","onUpdate:modelValue":u[2]||(u[2]=h=>I.serviceName=h),placeholder:"请输入Tool Name",required:""},null,512),[[le,I.serviceName]])])]),e("div",Tt,[e("div",wt,[u[10]||(u[10]=e("label",null,[H("Tool Description "),e("span",{class:"required"},"*")],-1)),oe(e("textarea",{"onUpdate:modelValue":u[3]||(u[3]=h=>I.userRequest=h),placeholder:"请输入Tool Description",class:"description-field",rows:"3",required:""},null,512),[[le,I.userRequest]])])]),e("div",Et,[u[13]||(u[13]=e("h4",{class:"section-title"},"参数配置",-1)),e("div",It,[e("table",null,[u[11]||(u[11]=e("thead",null,[e("tr",null,[e("th",null,"字段名"),e("th",null,"字段描述"),e("th",null,"操作")])],-1)),e("tbody",null,[(p(!0),f(re,null,ve(I.parameters,(h,Y)=>(p(),f("tr",{key:Y},[e("td",null,[oe(e("input",{type:"text","onUpdate:modelValue":te=>h.name=te,placeholder:"字段名",class:"param-input"},null,8,Dt),[[le,h.name]])]),e("td",null,[oe(e("input",{type:"text","onUpdate:modelValue":te=>h.description=te,placeholder:"字段描述",class:"param-input"},null,8,xt),[[le,h.description]])]),e("td",null,[e("button",{type:"button",class:"remove-param-btn",onClick:te=>d(Y)},[_(o(C),{icon:"carbon:trash-can"})],8,Rt)])]))),128))])])]),e("button",{type:"button",class:"add-param-btn",onClick:Z},[_(o(C),{icon:"carbon:add"}),u[12]||(u[12]=H(" 添加参数 ",-1))])])])]),_:1},8,["modelValue"]),k.value?(p(),f("div",{key:0,class:"error-toast",onClick:u[5]||(u[5]=h=>k.value="")},[_(o(C),{icon:"carbon:error"}),H(" "+l(k.value),1)])):j("",!0),V.value?(p(),f("div",{key:1,class:"success-toast",onClick:u[6]||(u[6]=h=>V.value="")},[_(o(C),{icon:"carbon:checkmark"}),H(" "+l(V.value),1)])):j("",!0)],64))}}),Ut=ye(Nt,[["__scopeId","data-v-e041001a"]]),Lt={class:"sidebar-content"},Vt={class:"sidebar-content-header"},qt={class:"sidebar-content-title"},Ft={class:"tab-switcher"},Ot=["disabled"],Bt={key:0,class:"tab-content"},jt={class:"new-task-section"},Wt={class:"sidebar-content-list"},Jt={key:0,class:"loading-state"},Ht={key:1,class:"error-state"},zt={key:2,class:"empty-state"},Gt=["onClick"],Xt={class:"task-icon"},Kt={class:"task-details"},Qt={class:"task-title"},Zt={class:"task-preview"},Yt={class:"task-time"},en={class:"task-actions"},tn=["title","onClick"],nn={key:1,class:"tab-content config-tab"},on={key:0,class:"config-container"},sn={class:"template-info-header"},an={class:"template-info"},ln={class:"template-id"},rn={class:"config-section"},cn={class:"section-header"},un={class:"generator-content"},dn=["placeholder"],pn={class:"generator-actions"},hn=["disabled"],mn=["disabled"],gn={class:"config-section"},vn={class:"section-header"},fn={class:"section-actions"},bn=["disabled","title"],kn=["disabled","title"],_n=["disabled"],$n=["placeholder"],Pn={class:"config-section"},Cn={class:"section-header"},Sn={class:"execution-content"},yn={class:"params-input-group"},Tn={class:"params-help-text"},wn={class:"params-input-container"},En=["placeholder"],In=["title"],Dn={class:"api-url-display"},xn={class:"api-url-label"},Rn={class:"api-url"},An={class:"api-url-display"},Mn={class:"api-url-label"},Nn=["disabled"],Un=["disabled"],Ln=Ce({__name:"index",emits:["planExecutionRequested"],setup(A,{expose:n,emit:t}){const{t:r}=Ee(),T=["currentPlanId","userRequest","rootPlanId"],v=_e({get(){try{if(!b.jsonContent)return"";const P={...JSON.parse(b.jsonContent)};return T.forEach(q=>{delete P[q]}),JSON.stringify(P,null,2)}catch{return b.jsonContent}},set(d){try{if(!d.trim()){b.jsonContent="";return}const P=JSON.parse(d);let q={};try{q=JSON.parse(b.jsonContent||"{}")}catch{}const N={...P};T.forEach(R=>{q[R]!==void 0&&(N[R]=q[R])}),b.jsonContent=JSON.stringify(N)}catch{b.jsonContent=d}}}),k=t,V=async()=>{try{const d=await b.saveTemplate();d!=null&&d.duplicate?alert(r("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(r("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(r("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("Failed to save plan modifications:",d),alert(d.message||r("sidebar.saveFailed"))}},O=async()=>{var d;try{await b.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((d=b.selectedTemplate)==null?void 0:d.id)??r("sidebar.unknown")}))}catch(P){console.error("Failed to generate plan:",P),alert(r("sidebar.generateFailed")+": "+P.message)}},S=async()=>{try{await b.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(d){console.error("Failed to update plan:",d),alert(r("sidebar.updateFailed")+": "+d.message)}},J=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=b.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),k("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("Error executing plan:",d),alert(r("sidebar.executeFailed")+": "+d.message)}finally{b.finishPlanExecution()}},E=U(!1),I=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",b.currentPlanTemplateId),!b.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert("请先选择一个计划模板");return}console.log("[Sidebar] 打开发布MCP服务模态框"),E.value=!0},g=d=>{console.log("MCP服务发布成功:",d)},M=d=>{if(isNaN(d.getTime()))return console.warn("Invalid date received:",d),r("time.unknown");const q=new Date().getTime()-d.getTime(),N=Math.floor(q/6e4),R=Math.floor(q/36e5),ne=Math.floor(q/864e5);return N<1?r("time.now"):N<60?r("time.minuteAgo",{count:N}):R<24?r("time.hourAgo",{count:R}):ne<30?r("time.dayAgo",{count:ne}):d.toLocaleDateString("zh-CN")},Z=(d,P)=>!d||d.length<=P?d:d.substring(0,P)+"...";return Se(()=>{b.loadPlanTemplateList()}),n({loadPlanTemplateList:b.loadPlanTemplateList,toggleSidebar:b.toggleSidebar,currentPlanTemplateId:b.currentPlanTemplateId}),(d,P)=>{var q,N;return p(),f(re,null,[e("div",{class:se(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(b).isCollapsed}])},[e("div",Lt,[e("div",Vt,[e("div",qt,l(d.$t("sidebar.title")),1)]),e("div",Ft,[e("button",{class:se(["tab-button",{active:o(b).currentTab==="list"}]),onClick:P[0]||(P[0]=R=>o(b).switchToTab("list"))},[_(o(C),{icon:"carbon:list",width:"16"}),H(" "+l(d.$t("sidebar.templateList")),1)],2),e("button",{class:se(["tab-button",{active:o(b).currentTab==="config"}]),onClick:P[1]||(P[1]=R=>o(b).switchToTab("config")),disabled:!o(b).selectedTemplate},[_(o(C),{icon:"carbon:settings",width:"16"}),H(" "+l(d.$t("sidebar.configuration")),1)],10,Ot)]),o(b).currentTab==="list"?(p(),f("div",Bt,[e("div",jt,[e("button",{class:"new-task-btn",onClick:P[2]||(P[2]=R=>o(b).createNewTemplate())},[_(o(C),{icon:"carbon:add",width:"16"}),H(" "+l(d.$t("sidebar.newPlan"))+" ",1),P[12]||(P[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",Wt,[o(b).isLoading?(p(),f("div",Jt,[_(o(C),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,l(d.$t("sidebar.loading")),1)])):o(b).errorMessage?(p(),f("div",Ht,[_(o(C),{icon:"carbon:warning",width:"20"}),e("span",null,l(o(b).errorMessage),1),e("button",{onClick:P[3]||(P[3]=(...R)=>o(b).loadPlanTemplateList&&o(b).loadPlanTemplateList(...R)),class:"retry-btn"},l(d.$t("sidebar.retry")),1)])):o(b).planTemplateList.length===0?(p(),f("div",zt,[_(o(C),{icon:"carbon:document",width:"32"}),e("span",null,l(d.$t("sidebar.noTemplates")),1)])):(p(!0),f(re,{key:3},ve(o(b).sortedTemplates,R=>(p(),f("div",{key:R.id,class:se(["sidebar-content-list-item",{"sidebar-content-list-item-active":R.id===o(b).currentPlanTemplateId}]),onClick:ne=>o(b).selectTemplate(R)},[e("div",Xt,[_(o(C),{icon:"carbon:document",width:"20"})]),e("div",Kt,[e("div",Qt,l(R.title||d.$t("sidebar.unnamedPlan")),1),e("div",Zt,l(Z(R.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Yt,l(M(o(b).parseDateTime(R.updateTime||R.createTime))),1),e("div",en,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:pe(ne=>o(b).deleteTemplate(R),["stop"])},[_(o(C),{icon:"carbon:close",width:"16"})],8,tn)])],10,Gt))),128))])])):o(b).currentTab==="config"?(p(),f("div",nn,[o(b).selectedTemplate?(p(),f("div",on,[e("div",sn,[e("div",an,[e("h3",null,l(o(b).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",ln,"ID: "+l(o(b).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:P[4]||(P[4]=R=>o(b).switchToTab("list"))},[_(o(C),{icon:"carbon:arrow-left",width:"16"})])]),e("div",rn,[e("div",cn,[_(o(C),{icon:"carbon:generate",width:"16"}),e("span",null,l(d.$t("sidebar.planGenerator")),1)]),e("div",un,[oe(e("textarea",{"onUpdate:modelValue":P[5]||(P[5]=R=>o(b).generatorPrompt=R),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,dn),[[le,o(b).generatorPrompt]]),e("div",pn,[e("button",{class:"btn btn-primary btn-sm",onClick:O,disabled:o(b).isGenerating||!o(b).generatorPrompt.trim()},[_(o(C),{icon:o(b).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:se({spinning:o(b).isGenerating})},null,8,["icon","class"]),H(" "+l(o(b).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,hn),e("button",{class:"btn btn-secondary btn-sm",onClick:S,disabled:o(b).isGenerating||!o(b).generatorPrompt.trim()||!o(b).jsonContent.trim()},[_(o(C),{icon:"carbon:edit",width:"14"}),H(" "+l(d.$t("sidebar.updatePlan")),1)],8,mn)])])]),e("div",gn,[e("div",vn,[_(o(C),{icon:"carbon:code",width:"16"}),e("span",null,l(d.$t("sidebar.jsonTemplate")),1),e("div",fn,[e("button",{class:"btn btn-sm",onClick:P[6]||(P[6]=(...R)=>o(b).rollbackVersion&&o(b).rollbackVersion(...R)),disabled:!o(b).canRollback,title:d.$t("sidebar.rollback")},[_(o(C),{icon:"carbon:undo",width:"14"})],8,bn),e("button",{class:"btn btn-sm",onClick:P[7]||(P[7]=(...R)=>o(b).restoreVersion&&o(b).restoreVersion(...R)),disabled:!o(b).canRestore,title:d.$t("sidebar.restore")},[_(o(C),{icon:"carbon:redo",width:"14"})],8,kn),e("button",{class:"btn btn-primary btn-sm",onClick:V,disabled:o(b).isGenerating||o(b).isExecuting},[_(o(C),{icon:"carbon:save",width:"14"})],8,_n)])]),oe(e("textarea",{"onUpdate:modelValue":P[8]||(P[8]=R=>v.value=R),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,$n),[[le,v.value]])]),e("div",Pn,[e("div",Cn,[_(o(C),{icon:"carbon:play",width:"16"}),e("span",null,l(d.$t("sidebar.executionController")),1)]),e("div",Sn,[e("div",yn,[e("label",null,l(d.$t("sidebar.executionParams")),1),e("div",Tn,l(d.$t("sidebar.executionParamsHelp")),1),e("div",wn,[oe(e("input",{"onUpdate:modelValue":P[9]||(P[9]=R=>o(b).executionParams=R),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,En),[[le,o(b).executionParams]]),e("button",{class:"clear-params-btn",onClick:P[10]||(P[10]=(...R)=>o(b).clearExecutionParams&&o(b).clearExecutionParams(...R)),title:d.$t("sidebar.clearParams")},[_(o(C),{icon:"carbon:close",width:"12"})],8,In)])]),e("div",Dn,[e("span",xn,l(d.$t("sidebar.apiUrl"))+":",1),e("code",Rn,l(o(b).computedApiUrl),1)]),e("div",An,[e("span",Mn,l(d.$t("sidebar.statusApiUrl"))+":",1),P[13]||(P[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:J,disabled:o(b).isExecuting||o(b).isGenerating},[_(o(C),{icon:o(b).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:se({spinning:o(b).isExecuting})},null,8,["icon","class"]),H(" "+l(o(b).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,Nn),e("button",{class:"btn btn-secondary publish-mcp-btn",onClick:I,disabled:!o(b).currentPlanTemplateId},[_(o(C),{icon:"carbon:cloud-service",width:"16"}),P[14]||(P[14]=H(" 发布MCP服务 ",-1))],8,Un)])])])):j("",!0)])):j("",!0)])],2),_(Ut,{modelValue:E.value,"onUpdate:modelValue":P[11]||(P[11]=R=>E.value=R),"plan-template-id":o(b).currentPlanTemplateId||"","plan-title":((q=o(b).selectedTemplate)==null?void 0:q.title)||"","plan-description":((N=o(b).selectedTemplate)==null?void 0:N.description)||"",onPublished:g},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),Vn=ye(Ln,[["__scopeId","data-v-6b1e180e"]]);class Fe{static async sendMessage(n){return ft.withLlmCheck(async()=>{const t=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n})});if(!t.ok)throw new Error(`API request failed: ${t.status}`);return await t.json()})}}ge(Fe,"BASE_URL","/api/executor");class Oe{static async getDetails(n){try{const t=await fetch(`${this.BASE_URL}/details/${n}`);if(t.status===404)return null;if(!t.ok){const v=await t.text();throw new Error(`Failed to get detailed information: ${t.status} - ${v}`)}const r=await t.text(),T=JSON.parse(r);return T&&typeof T=="object"&&!T.currentPlanId&&(T.currentPlanId=n),T}catch(t){return console.error("[CommonApiService] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to save, please retry"}}}static async submitFormInput(n,t){const r=await fetch(`${this.BASE_URL}/submit-input/${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok){let v;try{v=await r.json()}catch{v={message:`Failed to submit form input: ${r.status}`}}throw new Error(v.message||`Failed to submit form input: ${r.status}`)}const T=r.headers.get("content-type");return T&&T.indexOf("application/json")!==-1?await r.json():{success:!0}}static async getAllPrompts(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get Prompt list:",n),n}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}ge(Oe,"BASE_URL","/api/executor");const Te=class Te{constructor(){ge(this,"POLL_INTERVAL",5e3);ge(this,"state",qe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));ge(this,"callbacks",{});ge(this,"planExecutionCache",new Map);ge(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(n){return this.planExecutionCache.get(n)}getCachedUIState(n){return this.uiStateCache.get(n)}setCachedUIState(n,t){this.uiStateCache.set(n,t),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${n}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(n){return this.planExecutionCache.has(n)}setCachedPlanRecord(n,t){this.planExecutionCache.set(n,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n}`)}clearCachedPlanRecord(n){const t=this.planExecutionCache.delete(n);return t&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${n}`),t}clearAllCachedRecords(){const n=this.planExecutionCache.size,t=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${n}, UI States: ${t}`)}static getInstance(){return Te.instance||(Te.instance=new Te),Te.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(n){this.callbacks={...this.callbacks,...n},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(n))}async handleUserMessageSendRequested(n){if(this.validateAndPrepareUIForNewRequest(n))try{if(await this.sendUserMessageAndSetPlanId(n),this.state.activePlanId)this.initiatePlanExecutionSequence(n,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(t){console.error("[PlanExecutionManager] Failed to send user message:",t);const r=this.state.activePlanId??"error";this.setCachedUIState(r,{enabled:!0}),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(n,t){console.log("[PlanExecutionManager] Received plan execution request:",{planId:n,query:t}),n?(this.state.activePlanId=n,this.initiatePlanExecutionSequence(t??"执行计划",n)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(n,t){const r=this.getCachedPlanRecord(n);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${n}`),this.handlePlanExecutionRequested(r.currentPlanId,t),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${n}`),!1)}validateAndPrepareUIForNewRequest(n){if(!n)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const t=this.state.activePlanId??"ui-state";return this.setCachedUIState(t,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(t),!0}async sendUserMessageAndSetPlanId(n){try{const t=await Fe.sendMessage(n);if(t!=null&&t.planId)return this.state.activePlanId=t.planId,t;if(t!=null&&t.planTemplateId)return this.state.activePlanId=t.planTemplateId,{...t,planId:t.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",t),new Error("Failed to get valid planId from API response")}catch(t){throw console.error("[PlanExecutionManager] API call failed:",t),t}}initiatePlanExecutionSequence(n,t){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${n}", planId: ${t}`);const r=t;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(n){this.emitPlanCompleted(n.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}n.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(n.rootPlanId??""))}handlePlanError(n){this.emitPlanError(n.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const n=await this.getPlanDetails(this.state.activePlanId);if(!n){console.warn("[PlanExecutionManager] No details received from API");return}if(n.status&&n.status==="failed"){this.handlePlanError(n);return}if(n.rootPlanId&&this.setCachedPlanRecord(n.rootPlanId,n),!n.steps||n.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(n.rootPlanId??""),this.handlePlanCompletion(n);return}this.emitPlanUpdate(n.rootPlanId??""),n.completed&&this.handlePlanCompletion(n)}catch(n){console.error("[PlanExecutionManager] Failed to poll plan status:",n)}finally{this.state.isPolling=!1}}}async getPlanDetails(n){try{const t=await Oe.getDetails(n);return t!=null&&t.rootPlanId&&(this.planExecutionCache.set(t.rootPlanId,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t.rootPlanId}`)),t}catch(t){return console.error("[PlanExecutionManager] Failed to get plan details:",t),{currentPlanId:n,status:"failed",message:t instanceof Error?t.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(n){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(n)}emitDialogRoundStart(n){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(n)}emitPlanUpdate(n){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(n)}emitPlanCompleted(n){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(n)}emitPlanError(n){this.callbacks.onPlanError&&this.callbacks.onPlanError(n)}};ge(Te,"instance",null);let Ve=Te;const ie=Ve.getInstance(),qn={class:"right-panel"},Fn={class:"preview-header"},On={class:"preview-tabs"},Bn={class:"tab-button active"},jn={class:"preview-content"},Wn={class:"step-details"},Jn={key:0,class:"step-info-fixed"},Hn={key:0,class:"agent-info"},zn={class:"info-item"},Gn={class:"label"},Xn={class:"value"},Kn={class:"info-item"},Qn={class:"label"},Zn={class:"value"},Yn={class:"info-item"},eo={class:"label"},to={class:"value"},no={class:"info-item"},oo={class:"label"},so={class:"value"},ao={class:"info-item"},lo={class:"label"},io={class:"execution-status"},ro={class:"status-item"},co={class:"status-text"},uo={key:0},po={key:0,class:"think-act-steps"},ho={class:"steps-container"},mo={class:"step-header"},go={class:"step-number"},vo={class:"think-section"},fo={class:"think-content"},bo={class:"input"},ko={class:"label"},_o={class:"output"},$o={class:"label"},Po={key:0,class:"action-section"},Co={class:"action-content"},So={class:"tool-info"},yo={class:"label"},To={class:"value"},wo={class:"input"},Eo={class:"label"},Io={class:"output"},Do={class:"label"},xo={key:0,class:"sub-plan-section"},Ro={class:"sub-plan-content"},Ao={class:"sub-plan-header"},Mo={class:"sub-plan-info"},No={class:"value"},Uo={key:0,class:"sub-plan-info"},Lo={class:"value"},Vo={class:"sub-plan-status"},qo={class:"status-text"},Fo={key:0,class:"no-steps-message"},Oo={key:1,class:"no-execution-message"},Bo={class:"step-basic-info"},jo={class:"info-item"},Wo={class:"label"},Jo={class:"value"},Ho={key:0,class:"info-item"},zo={class:"value"},Go={class:"info-item"},Xo={class:"no-execution-hint"},Ko={key:2,class:"execution-indicator"},Qo={class:"execution-text"},Zo={key:1,class:"no-selection"},Yo=["title"],es=Ce({__name:"index",setup(A,{expose:n}){const{t}=Ee(),r=U(),T=U(),v=U(),k=U(null),V=U(!1),O=U(!0),S=U(!0),J=_e(()=>v.value?v.value.completed?t("rightPanel.status.completed"):v.value.current?t("rightPanel.status.executing"):t("rightPanel.status.waiting"):""),E=D=>{var B;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${D}`),v.value&&k.value){const $=k.value.rootPlanId??T.value;if($&&$!==D){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${$}, Requested: ${D}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${D}`);const x=ie.getCachedPlanRecord(D);if(!x){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${D}`);return}if(x.steps&&x.steps.length>0){const $=x.steps.length,u=(x.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${u} / ${$}`)}if(v.value&&T.value&&(T.value===D||((B=k.value)==null?void 0:B.rootPlanId)===D)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${D}`),k.value)){const u=k.value,h=g(u.planId,u.rootPlanId,u.subPlanId);h?(M(h,u.stepIndex,u.planId,u.isSubPlan),N()):console.warn("[RightPanel] Could not find plan record for refresh:",u)}},I=(D,x,B,$,u)=>{console.log("[RightPanel] Step selected:",{planId:D,stepIndex:x,rootPlanId:B,subPlanId:$,subStepIndex:u});const h=!!(B&&$&&u!==void 0);k.value={planId:D,stepIndex:x,isSubPlan:h,...h&&{rootPlanId:B,subPlanId:$,subStepIndex:u}};const Y=g(D,B,$);if(!Y){console.warn("[RightPanel] Plan data not found:",{planId:D,rootPlanId:B,subPlanId:$}),v.value=null,k.value=null;return}M(Y,x,D,h)},g=(D,x,B)=>{var h;if(!x||!B)return ie.getCachedPlanRecord(D)??null;const $=ie.getCachedPlanRecord(D);if($)return $;const u=ie.getCachedPlanRecord(x);if(!(u!=null&&u.agentExecutionSequence))return null;for(const Y of u.agentExecutionSequence)if(Y.thinkActSteps){for(const te of Y.thinkActSteps)if(((h=te.subPlanExecutionRecord)==null?void 0:h.currentPlanId)===B)return te.subPlanExecutionRecord}return null},M=(D,x,B,$)=>{var Pe,me,y,i,w;if(!D.steps||x>=D.steps.length){v.value=null,k.value=null,console.warn("[RightPanel] Invalid step data:",{planId:B,stepIndex:x,hasSteps:!!D.steps,stepsLength:(Pe=D.steps)==null?void 0:Pe.length,message:"Invalid step index"});return}T.value=B;const u=D.steps[x],h=(me=D.agentExecutionSequence)==null?void 0:me[x];console.log("[RightPanel] Step data details:",{planId:B,stepIndex:x,step:u,hasAgentExecutionSequence:!!D.agentExecutionSequence,agentExecutionSequenceLength:(y=D.agentExecutionSequence)==null?void 0:y.length,agentExecution:h,hasThinkActSteps:!!(h!=null&&h.thinkActSteps),thinkActStepsLength:(i=h==null?void 0:h.thinkActSteps)==null?void 0:i.length,isSubPlan:$});const Y=(h==null?void 0:h.status)==="FINISHED",te=!Y&&x===D.currentStepIndex&&!D.completed,ke={planId:B,index:x,title:typeof u=="string"?u:u.title||u.description||u.name||`${$?"子":""}步骤 ${x+1}`,description:typeof u=="string"?u:u.description||u,completed:Y,current:te};h&&(ke.agentExecution=h),v.value=ke,console.log("[RightPanel] Step details updated:",{planId:B,stepIndex:x,stepTitle:v.value.title,hasAgentExecution:!!h,hasThinkActSteps:(((w=h==null?void 0:h.thinkActSteps)==null?void 0:w.length)??0)>0,completed:Y,current:te,planCurrentStep:D.currentStepIndex,planCompleted:D.completed,isSubPlan:$}),h!=null&&h.thinkActSteps&&h.thinkActSteps.forEach((L,a)=>{L.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${a}:`,L.subPlanExecutionRecord)}),setTimeout(()=>{P()},100),N()},Z=(D,x,B,$)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:D,subPlanId:x,stepIndex:B,subStepIndex:$}),I(x,$,D,x,$)},d=D=>{r.value=D??void 0},P=()=>{if(!r.value)return;const{scrollTop:D,scrollHeight:x,clientHeight:B}=r.value,$=x-D-B<50,u=x>B;O.value=$,V.value=u&&!$,$?S.value=!0:x-D-B>100&&(S.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:D,scrollHeight:x,clientHeight:B,isAtBottom:$,hasScrollableContent:u,showButton:V.value,shouldAutoScroll:S.value})},q=()=>{r.value&&(r.value.scrollTo({top:r.value.scrollHeight,behavior:"smooth"}),ae(()=>{S.value=!0,P()}))},N=()=>{!S.value||!r.value||ae(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},R=D=>{if(D===null||typeof D>"u"||D==="")return"N/A";try{const x=typeof D=="object"?D:JSON.parse(D);return JSON.stringify(x,null,2)}catch{return String(D)}},ne=()=>{v.value=null,T.value=void 0,S.value=!0,r.value&&r.value.removeEventListener("scroll",P)},he=()=>{const D=()=>{const x=r.value;return x?(d(x),x.addEventListener("scroll",P),S.value=!0,P(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ae(()=>{D()||setTimeout(()=>{D()},100)})};return Se(()=>{console.log("[RightPanel] Component mounted"),ae(()=>{he()})}),Re(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),k.value=null,ne()}),n({updateDisplayedPlanProgress:E,handleStepSelected:I,handleSubPlanStepSelected:Z}),(D,x)=>{var B,$;return p(),f("div",qn,[e("div",Fn,[e("div",On,[e("button",Bn,[_(o(C),{icon:"carbon:events"}),H(" "+l(o(t)("rightPanel.stepExecutionDetails")),1)])])]),e("div",jn,[e("div",Wn,[v.value?(p(),f("div",Jn,[e("h3",null,l(v.value.title||v.value.description||o(t)("rightPanel.defaultStepTitle",{number:v.value.index+1})),1),v.value.agentExecution?(p(),f("div",Hn,[e("div",zn,[e("span",Gn,l(o(t)("rightPanel.executingAgent"))+":",1),e("span",Xn,l(v.value.agentExecution.agentName),1)]),e("div",Kn,[e("span",Qn,l(o(t)("rightPanel.description"))+":",1),e("span",Zn,l(v.value.agentExecution.agentDescription||""),1)]),e("div",Yn,[e("span",eo,l(o(t)("rightPanel.callingModel"))+":",1),e("span",to,l(v.value.agentExecution.modelName),1)]),e("div",no,[e("span",oo,l(o(t)("rightPanel.request"))+":",1),e("span",so,l(v.value.agentExecution.agentRequest||""),1)]),e("div",ao,[e("span",lo,l(o(t)("rightPanel.executionResult"))+":",1),e("span",{class:se(["value",{success:v.value.agentExecution.status==="FINISHED"}])},l(v.value.agentExecution.status||o(t)("rightPanel.executing")),3)])])):j("",!0),e("div",io,[e("div",ro,[v.value.completed?(p(),ce(o(C),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):v.value.current?(p(),ce(o(C),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(p(),ce(o(C),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",co,l(J.value),1)])])])):j("",!0),e("div",{ref_key:"scrollContainer",ref:r,class:"step-details-scroll-container",onScroll:P},[v.value?(p(),f("div",uo,[(B=v.value.agentExecution)!=null&&B.thinkActSteps&&v.value.agentExecution.thinkActSteps.length>0?(p(),f("div",po,[e("h4",null,l(o(t)("rightPanel.thinkAndActionSteps")),1),e("div",ho,[(p(!0),f(re,null,ve(v.value.agentExecution.thinkActSteps,(u,h)=>(p(),f("div",{key:h,class:"think-act-step"},[e("div",mo,[e("span",go,"#"+l(h+1),1),e("span",{class:se(["step-status",u.status])},l(u.status||o(t)("rightPanel.executing")),3)]),e("div",vo,[e("h5",null,[_(o(C),{icon:"carbon:thinking"}),H(" "+l(o(t)("rightPanel.thinking")),1)]),e("div",fo,[e("div",bo,[e("span",ko,l(o(t)("rightPanel.input"))+":",1),e("pre",null,l(R(u.thinkInput)),1)]),e("div",_o,[e("span",$o,l(o(t)("rightPanel.output"))+":",1),e("pre",null,l(R(u.thinkOutput)),1)])])]),u.actionNeeded?(p(),f("div",Po,[e("h5",null,[_(o(C),{icon:"carbon:play"}),H(" "+l(o(t)("rightPanel.action")),1)]),e("div",Co,[(p(!0),f(re,null,ve(u.actToolInfoList,(Y,te)=>(p(),f("div",{key:te},[e("div",So,[e("span",yo,l(o(t)("rightPanel.tool"))+":",1),e("span",To,l(Y.name||""),1)]),e("div",wo,[e("span",Eo,l(o(t)("rightPanel.toolParameters"))+":",1),e("pre",null,l(R(Y.parameters)),1)]),e("div",Io,[e("span",Do,l(o(t)("rightPanel.executionResult"))+":",1),e("pre",null,l(R(Y.result)),1)])]))),128))]),u.subPlanExecutionRecord?(p(),f("div",xo,[e("h5",null,[_(o(C),{icon:"carbon:tree-view"}),H(" "+l(o(t)("rightPanel.subPlan")),1)]),e("div",Ro,[e("div",Ao,[e("div",Mo,[x[0]||(x[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",No,l(u.subPlanExecutionRecord.currentPlanId),1)]),u.subPlanExecutionRecord.title?(p(),f("div",Uo,[x[1]||(x[1]=e("span",{class:"label"},"标题:",-1)),e("span",Lo,l(u.subPlanExecutionRecord.title),1)])):j("",!0),e("div",Vo,[u.subPlanExecutionRecord.completed?(p(),ce(o(C),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(p(),ce(o(C),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",qo,l(u.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):j("",!0)])):j("",!0)]))),128))]),v.value.agentExecution&&!(($=v.value.agentExecution.thinkActSteps)!=null&&$.length)?(p(),f("div",Fo,[e("p",null,l(o(t)("rightPanel.noStepDetails")),1)])):v.value.agentExecution?j("",!0):(p(),f("div",Oo,[_(o(C),{icon:"carbon:information",class:"info-icon"}),e("h4",null,l(o(t)("rightPanel.stepInfo")),1),e("div",Bo,[e("div",jo,[e("span",Wo,l(o(t)("rightPanel.stepName"))+":",1),e("span",Jo,l(v.value.title||v.value.description||`步骤 ${v.value.index+1}`),1)]),v.value.description?(p(),f("div",Ho,[x[2]||(x[2]=e("span",{class:"label"},"描述:",-1)),e("span",zo,l(v.value.description),1)])):j("",!0),e("div",Go,[x[3]||(x[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:se(["value",{"status-completed":v.value.completed,"status-current":v.value.current,"status-pending":!v.value.completed&&!v.value.current}])},l(v.value.completed?"已完成":v.value.current?"执行中":"待执行"),3)])]),e("p",Xo,l(o(t)("rightPanel.noExecutionInfo")),1)])),v.value.current&&!v.value.completed?(p(),f("div",Ko,[x[4]||(x[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Qo,[_(o(C),{icon:"carbon:in-progress",class:"rotating-icon"}),H(" "+l(o(t)("rightPanel.stepExecuting")),1)])])):j("",!0)])):(p(),f("div",Zo,[_(o(C),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,l(o(t)("rightPanel.noStepSelected")),1),e("p",null,l(o(t)("rightPanel.selectStepHint")),1)]))])):j("",!0),_(Ae,{name:"scroll-button"},{default:we(()=>[V.value?(p(),f("button",{key:0,onClick:q,class:"scroll-to-bottom-btn",title:o(t)("rightPanel.scrollToBottom")},[_(o(C),{icon:"carbon:chevron-down"})],8,Yo)):j("",!0)]),_:1})],544)])])])}}}),ts=ye(es,[["__scopeId","data-v-e90596ce"]]);function ns(){const A=ie,n=_e(()=>A.getActivePlanId()),t=_e(()=>A.getState()),r=_e(()=>t.value.isPolling),T=_e(()=>!!n.value),v=(S,J)=>{A.initiatePlanExecutionSequence(S,J)},k=()=>{A.stopPolling()},V=()=>{A.startPolling()},O=()=>{A.cleanup()};return Re(()=>{O()}),{activePlanId:n,state:t,isPolling:r,hasActivePlan:T,startExecution:v,stopPolling:k,startPolling:V,cleanup:O}}const os={class:"chat-container"},ss={class:"message-content"},as={key:0,class:"user-message"},ls={key:1,class:"assistant-message"},is={key:0,class:"thinking-section"},rs={class:"thinking-header"},cs={class:"thinking-avatar"},us={class:"thinking-label"},ds={class:"thinking-content"},ps={key:0,class:"thinking"},hs={key:1,class:"progress"},ms={class:"progress-bar"},gs={class:"progress-text"},vs={key:2,class:"steps-container"},fs={class:"steps-title"},bs=["onClick"],ks={class:"section-header"},_s={class:"step-icon"},$s={class:"step-title"},Ps={key:0,class:"step-status current"},Cs={key:1,class:"step-status completed"},Ss={key:2,class:"step-status pending"},ys={key:0,class:"action-info"},Ts={class:"action-description"},ws={class:"action-icon"},Es={key:0,class:"tool-params"},Is={class:"param-label"},Ds={class:"param-content"},xs={key:1,class:"think-details"},Rs={class:"think-header"},As={class:"think-label"},Ms={class:"think-output"},Ns={class:"think-content"},Us={key:1,class:"sub-plan-steps"},Ls={class:"sub-plan-header"},Vs={class:"sub-plan-step-list"},qs=["onClick"],Fs={class:"sub-step-indicator"},Os={class:"sub-step-icon"},Bs={class:"sub-step-number"},js={class:"sub-step-content"},Ws={class:"sub-step-title"},Js={key:2,class:"user-input-form-container"},Hs={class:"user-input-message"},zs={key:0,class:"form-description"},Gs=["onSubmit"],Xs=["for"],Ks=["id","name","onUpdate:modelValue"],Qs={key:1,class:"form-group"},Zs={for:"form-input-genericInput"},Ys=["onUpdate:modelValue"],ea={type:"submit",class:"submit-user-input-btn"},ta={key:3,class:"default-processing"},na={class:"processing-indicator"},oa={class:"response-section"},sa={class:"response-header"},aa={class:"response-avatar"},la={class:"response-name"},ia={class:"response-content"},ra={key:0,class:"final-response"},ca=["innerHTML"],ua={key:1,class:"response-placeholder"},da={class:"typing-indicator"},pa={class:"typing-text"},ha={key:0,class:"message assistant"},ma={class:"message-content"},ga={class:"assistant-message"},va={class:"thinking-section"},fa={class:"thinking-header"},ba={class:"thinking-avatar"},ka={class:"thinking-label"},_a={class:"thinking-content"},$a={class:"default-processing"},Pa={class:"processing-indicator"},Ca={class:"response-section"},Sa={class:"response-header"},ya={class:"response-avatar"},Ta={class:"response-name"},wa={class:"response-content"},Ea={class:"response-placeholder"},Ia={class:"typing-indicator"},Da={class:"typing-text"},xa=["title"],Ra=Ce({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(A,{expose:n,emit:t}){const r=A,T=t,{t:v}=Ee(),k=ns(),V=U(),O=U(!1),S=U([]),J=U(),E=U(!1),I=qe({}),g=(a,s,c)=>{const m={id:Date.now().toString(),type:a,content:s,timestamp:new Date,...c};return a==="assistant"&&!m.thinking&&!m.content&&(m.thinking=v("chat.thinking")),S.value.push(m),m},M=a=>{const s=S.value[S.value.length-1];s.type==="assistant"&&Object.assign(s,a)},Z=async a=>{try{O.value=!0;const s=g("assistant","",{thinking:"正在理解您的请求并准备回复..."}),c=await Fe.sendMessage(a);if(c.planId)console.log("[ChatComponent] Received planId from direct execution:",c.planId),s.planExecution||(s.planExecution={}),s.planExecution.currentPlanId=c.planId,ie.handlePlanExecutionRequested(c.planId,a),delete s.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete s.thinking;const m=d(c,a);s.content=m}}catch(s){console.error("Direct mode error:",s),M({content:P(s)})}finally{O.value=!1}},d=(a,s)=>a.result??a.message??a.content??"",P=a=>{const s=(a==null?void 0:a.message)??(a==null?void 0:a.toString())??"未知错误";return s.includes("网络")||s.includes("network")||s.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":s.includes("认证")||s.includes("权限")||s.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":s.includes("格式")||s.includes("参数")||s.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${s}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},q=(a=!1)=>{ae(()=>{if(V.value){const s=V.value;(a||s.scrollHeight-s.scrollTop-s.clientHeight<150)&&s.scrollTo({top:s.scrollHeight,behavior:a?"auto":"smooth"})}})},N=()=>{q(!0),E.value=!1},R=()=>{if(V.value){const a=V.value,s=a.scrollHeight-a.scrollTop-a.clientHeight<150;E.value=!s&&S.value.length>0}},ne=()=>{V.value&&V.value.addEventListener("scroll",R)},he=()=>{V.value&&V.value.removeEventListener("scroll",R)},D=a=>{g("user",a),r.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",a):Z(a)},x=(a,s)=>{var z;const c=((z=a.planExecution)==null?void 0:z.agentExecutionSequence)??[];return s<0||s>=c.length?"IDLE":c[s].status??"IDLE"},B=(a,s)=>{var c,m;if(!((c=a.planExecution)!=null&&c.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:a.planExecution.currentPlanId,stepIndex:s,stepTitle:(m=a.planExecution.steps)==null?void 0:m[s]}),T("step-selected",a.planExecution.currentPlanId,s)},$=(a,s)=>{var c;try{const m=(c=a.planExecution)==null?void 0:c.agentExecutionSequence;if(!(m!=null&&m.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const z=m[s];if(!z)return console.log(`[ChatComponent] No agentExecution found for step ${s}`),[];if(!z.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${s}`),[];for(const W of z.thinkActSteps)if(W.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${s}:`,W.subPlanExecutionRecord),(W.subPlanExecutionRecord.steps??[]).map(G=>typeof G=="string"?G:typeof G=="object"&&G!==null&&(G.title||G.description)||"子步骤");return[]}catch(m){return console.warn("[ChatComponent] Error getting sub-plan steps:",m),[]}},u=(a,s,c)=>{var m;try{const z=(m=a.planExecution)==null?void 0:m.agentExecutionSequence;if(!(z!=null&&z.length))return"pending";const W=z[s];if(!W||!W.thinkActSteps)return"pending";let ee=null;for(const X of W.thinkActSteps)if(X.subPlanExecutionRecord){ee=X.subPlanExecutionRecord;break}if(!ee)return"pending";const G=ee.currentStepIndex;return ee.completed?"completed":G==null?c===0?"current":"pending":c<G?"completed":c===G?"current":"pending"}catch(z){return console.warn("[ChatComponent] Error getting sub-plan step status:",z),"pending"}},h=(a,s,c)=>{var m,z;try{const W=(m=a.planExecution)==null?void 0:m.agentExecutionSequence;if(!(W!=null&&W.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const ee=W[s];if(!ee){console.warn("[ChatComponent] No agentExecution found for step",s);return}if(!ee.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",s);return}let G=null;for(const X of ee.thinkActSteps)if(X.subPlanExecutionRecord){G=X.subPlanExecutionRecord;break}if(!(G!=null&&G.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}T("sub-plan-step-selected",((z=a.planExecution)==null?void 0:z.currentPlanId)??"",G.currentPlanId,s,c)}catch(W){console.error("[ChatComponent] Error handling sub-plan step click:",W)}},Y=(a,s)=>{var m,z,W,ee;if(!((m=a.planExecution)!=null&&m.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",a.planExecution.steps.length,"execution sequence:",((z=s.agentExecutionSequence)==null?void 0:z.length)??0);const c=new Array(a.planExecution.steps.length).fill(null);if((W=s.agentExecutionSequence)!=null&&W.length){const G=Math.min(s.agentExecutionSequence.length,a.planExecution.steps.length);for(let X=0;X<G;X++){const F=s.agentExecutionSequence[X];if((ee=F.thinkActSteps)!=null&&ee.length){const K=F.thinkActSteps[F.thinkActSteps.length-1];K.actionDescription&&K.toolParameters?(c[X]={actionDescription:K.actionDescription,toolParameters:typeof K.toolParameters=="string"?K.toolParameters:JSON.stringify(K.toolParameters,null,2),thinkInput:K.thinkInput??"",thinkOutput:K.thinkOutput??"",status:s.currentStepIndex!==void 0&&X<s.currentStepIndex?"completed":s.currentStepIndex!==void 0&&X===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${X} action set: ${c[X].actionDescription}`)):(c[X]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:K.thinkInput??"",thinkOutput:K.thinkOutput??"",status:s.currentStepIndex!==void 0&&X===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${X} is thinking`))}else c[X]={actionDescription:s.currentStepIndex!==void 0&&X<s.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:s.currentStepIndex!==void 0&&X<s.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${X} 无执行细节, 状态设为: ${c[X].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");a.stepActions=[...c],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(c.map(G=>G==null?void 0:G.actionDescription))),ae(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},te=a=>{console.log("[ChatComponent] Starting dialog round with planId:",a),a&&(S.value.findIndex(c=>{var m;return((m=c.planExecution)==null?void 0:m.currentPlanId)===a&&c.type==="assistant"})===-1?(g("assistant","",{planExecution:{currentPlanId:a},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",a)):console.log("[ChatComponent] Found existing assistant message for planId:",a))},ke=a=>{var W,ee,G,X;console.log("[ChatComponent] Processing plan update with rootPlanId:",a);const s=ie.getCachedPlanRecord(a);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",a);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",s),console.log("[ChatComponent] Plan steps:",s.steps),console.log("[ChatComponent] Plan completed:",s.completed),!s.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const c=S.value.findIndex(F=>{var K;return((K=F.planExecution)==null?void 0:K.currentPlanId)===s.currentPlanId&&F.type==="assistant"});let m;if(c!==-1)m=S.value[c],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",s.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",s.currentPlanId),console.log("[ChatComponent] Current messages:",S.value.map(K=>{var ue;return{type:K.type,planId:(ue=K.planExecution)==null?void 0:ue.currentPlanId,content:K.content.substring(0,50)}}));let F=-1;for(let K=S.value.length-1;K>=0;K--)if(S.value[K].type==="assistant"){F=K;break}if(F!==-1)m=S.value[F],m.planExecution||(m.planExecution={}),m.planExecution.currentPlanId=s.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",s.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(m.planExecution||(m.planExecution={}),m.planExecution=JSON.parse(JSON.stringify(s)),!s.steps||s.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),s.completed){delete m.thinking;const F=s.summary??s.result??s.message??"处理完成";m.content=Pe(F),console.log("[ChatComponent] Set simple response content:",m.content)}else s.title&&(m.thinking=`正在执行: ${s.title}`);return}delete m.thinking;const z=s.steps.map(F=>typeof F=="string"?F:typeof F=="object"&&F!==null&&(F.title||F.description)||"步骤");if(m.planExecution&&(m.planExecution.steps=z),s.agentExecutionSequence&&s.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",s.agentExecutionSequence.length),Y(m,s);const F=s.currentStepIndex??0;if(F>=0&&F<s.agentExecutionSequence.length){const ue=s.agentExecutionSequence[F].thinkActSteps;if(ue&&ue.length>0){const Ie=ue[ue.length-1];if(Ie.thinkOutput){const Ne=Ie.thinkOutput.length>150?Ie.thinkOutput.substring(0,150)+"...":Ie.thinkOutput;m.thinking=`正在思考: ${Ne}`}}}}else if(m.planExecution){const F=m.planExecution.currentStepIndex??0,K=(W=m.planExecution.steps)==null?void 0:W[F],ue=typeof K=="string"?K:"";m.thinking=`正在执行: ${ue}`}if(s.userInputWaitState&&m.planExecution?(console.log("[ChatComponent] 需要用户输入:",s.userInputWaitState),m.planExecution.userInputWaitState||(m.planExecution.userInputWaitState={}),m.planExecution.userInputWaitState={message:s.userInputWaitState.message??"",formDescription:s.userInputWaitState.formDescription??"",formInputs:((ee=s.userInputWaitState.formInputs)==null?void 0:ee.map(F=>({label:F.label,value:F.value||""})))??[]},I[G=m.id]??(I[G]={}),m.thinking="等待用户输入..."):(X=m.planExecution)!=null&&X.userInputWaitState&&delete m.planExecution.userInputWaitState,s.completed??s.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete m.thinking;let F="";s.summary?F=s.summary:s.result?F=s.result:F="任务已完成",m.content=me(F),console.log("[ChatComponent] Updated completed message:",m.content)}ae(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},Pe=a=>a?a.includes("我")||a.includes("您")||a.includes("您好")||a.includes("可以")?a:a.length<10?`${a}！还有什么需要我帮助的吗？`:a.length<50?`好的，${a}。如果您还有其他问题，请随时告诉我。`:`${a}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",me=a=>a?`${a}`:"任务已完成！还有什么我可以帮您的吗？",y=a=>{console.log("[ChatComponent] Plan completed with rootPlanId:",a);const s=ie.getCachedPlanRecord(a);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",a);return}if(console.log("[ChatComponent] Plan details:",s),s.rootPlanId){const c=S.value.findIndex(m=>{var z;return((z=m.planExecution)==null?void 0:z.currentPlanId)===s.rootPlanId});if(c!==-1){const m=S.value[c];delete m.thinking;let W=s.summary??s.result??"任务已完成";!W.includes("我")&&!W.includes("您")&&(W.includes("成功")||W.includes("完成")?W=`很好！${W}。如果您还有其他需要帮助的地方，请随时告诉我。`:W=`我已经完成了您的请求：${W}`),m.content=W,console.log("[ChatComponent] Updated completed message:",m.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",s.rootPlanId)}},i=a=>{O.value=!1,S.value[S.value.length-1]={id:Date.now().toString(),type:"assistant",content:a,timestamp:new Date}},w=a=>{if(!a)return"";let s=a.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return s=s.replace(/(<br><br>)/g,"</p><p>"),s.includes("</p><p>")&&(s=`<p>${s}</p>`),s},L=async a=>{var s;if(!((s=a.planExecution)!=null&&s.currentPlanId)||!a.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const c={},m=a.planExecution.userInputWaitState.formInputs;m&&m.length>0?Object.entries(I[a.id]).forEach(([W,ee])=>{var F;const G=parseInt(W,10),X=((F=m[G])==null?void 0:F.label)||`input_${W}`;c[X]=ee}):c.genericInput=a.genericInput??"",console.log("[ChatComponent] 提交用户输入:",c);const z=await Oe.submitFormInput(a.planExecution.currentPlanId,c);delete a.planExecution.userInputWaitState,delete a.genericInput,delete I[a.id],k.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",z)}catch(c){console.error("[ChatComponent] 用户输入提交失败:",c),alert(`提交失败: ${(c==null?void 0:c.message)||"未知错误"}`)}};return $e(()=>r.initialPrompt,(a,s)=>{console.log("[ChatComponent] initialPrompt changed from:",s,"to:",a),a&&typeof a=="string"&&a.trim()&&a!==s&&(console.log("[ChatComponent] Processing changed initial prompt:",a),ae(()=>{D(a)}))},{immediate:!1}),Se(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ie.setEventCallbacks({onPlanUpdate:ke,onPlanCompleted:y,onDialogRoundStart:te,onChatInputUpdateState:a=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",a)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:i}),ae(()=>{ne()}),r.initialPrompt&&typeof r.initialPrompt=="string"&&r.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",r.initialPrompt),ae(()=>{D(r.initialPrompt)}))}),Re(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),he(),J.value&&clearInterval(J.value),k.cleanup(),Object.keys(I).forEach(a=>delete I[a])}),n({handleSendMessage:D,handlePlanUpdate:ke,handlePlanCompleted:y,handleDialogRoundStart:te,addMessage:g,handlePlanError:i}),(a,s)=>(p(),f("div",os,[e("div",{class:"messages",ref_key:"messagesRef",ref:V},[(p(!0),f(re,null,ve(S.value,c=>{var m,z,W,ee,G,X,F,K,ue;return p(),f("div",{key:c.id,class:se(["message",{user:c.type==="user",assistant:c.type==="assistant"}])},[e("div",ss,[c.type==="user"?(p(),f("div",as,l(c.content),1)):(p(),f("div",ls,[c.thinking||((m=c.planExecution)==null?void 0:m.progress)!==void 0||(((W=(z=c.planExecution)==null?void 0:z.steps)==null?void 0:W.length)??0)>0?(p(),f("div",is,[e("div",rs,[e("div",cs,[_(o(C),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",us,l(a.$t("chat.thinkingLabel")),1)]),e("div",ds,[c.thinking?(p(),f("div",ps,[_(o(C),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,l(c.thinking),1)])):j("",!0),((ee=c.planExecution)==null?void 0:ee.progress)!==void 0?(p(),f("div",hs,[e("div",ms,[e("div",{class:"progress-fill",style:Le({width:c.planExecution.progress+"%"})},null,4)]),e("span",gs,l(c.planExecution.progressText??a.$t("chat.processing")+"..."),1)])):j("",!0),(((X=(G=c.planExecution)==null?void 0:G.steps)==null?void 0:X.length)??0)>0?(p(),f("div",vs,[e("h4",fs,l(a.$t("chat.stepExecutionDetails")),1),(p(!0),f(re,null,ve((F=c.planExecution)==null?void 0:F.steps,(Ie,Q)=>{var Ne,Be,je,We,Je,He,ze,Ge,Xe,Ke,Qe,Ze,Ye,et,tt,nt,ot,st,at;return p(),f("div",{key:Q,class:se(["ai-section",{running:x(c,Q)==="RUNNING",completed:x(c,Q)==="FINISHED",pending:x(c,Q)==="IDLE"}]),onClick:pe(fe=>B(c,Q),["stop"])},[e("div",ks,[e("span",_s,l(x(c,Q)==="FINISHED"?"✓":x(c,Q)==="RUNNING"?"▶":"○"),1),e("span",$s,l(Ie||`${a.$t("chat.step")} ${Q+1}`),1),x(c,Q)==="RUNNING"?(p(),f("span",Ps,l(a.$t("chat.status.executing")),1)):x(c,Q)==="FINISHED"?(p(),f("span",Cs,l(a.$t("chat.status.completed")),1)):(p(),f("span",Ss,l(a.$t("chat.status.pending")),1))]),c.stepActions&&c.stepActions[Q]?(p(),f("div",ys,[e("div",Ts,[e("span",ws,l(((Ne=c.stepActions[Q])==null?void 0:Ne.status)==="current"?"🔄":((Be=c.stepActions[Q])==null?void 0:Be.status)==="completed"?"✓":"⏳"),1),e("strong",null,l((je=c.stepActions[Q])==null?void 0:je.actionDescription),1)]),(We=c.stepActions[Q])!=null&&We.toolParameters?(p(),f("div",Es,[s[0]||(s[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Is,l(a.$t("common.parameters"))+":",1),e("pre",Ds,l((Je=c.stepActions[Q])==null?void 0:Je.toolParameters),1)])):j("",!0),(He=c.stepActions[Q])!=null&&He.thinkOutput?(p(),f("div",xs,[e("div",Rs,[s[1]||(s[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",As,l(a.$t("chat.thinkingOutput"))+":",1)]),e("div",Ms,[e("pre",Ns,l((ze=c.stepActions[Q])==null?void 0:ze.thinkOutput),1)])])):j("",!0)])):j("",!0),((Ge=$(c,Q))==null?void 0:Ge.length)>0?(p(),f("div",Us,[e("div",Ls,[_(o(C),{icon:"carbon:tree-view",class:"sub-plan-icon"}),s[2]||(s[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",Vs,[(p(!0),f(re,null,ve($(c,Q),(fe,de)=>(p(),f("div",{key:`sub-${Q}-${de}`,class:se(["sub-plan-step-item",{completed:u(c,Q,de)==="completed",current:u(c,Q,de)==="current",pending:u(c,Q,de)==="pending"}]),onClick:pe(lt=>h(c,Q,de),["stop"])},[e("div",Fs,[e("span",Os,l(u(c,Q,de)==="completed"?"✓":u(c,Q,de)==="current"?"▶":"○"),1),e("span",Bs,l(de+1),1)]),e("div",js,[e("span",Ws,l(fe),1),s[3]||(s[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,qs))),128))])])):j("",!0),(Xe=c.planExecution)!=null&&Xe.userInputWaitState&&x(c,Q)==="RUNNING"?(p(),f("div",Js,[e("p",Hs,l(((Qe=(Ke=c.planExecution)==null?void 0:Ke.userInputWaitState)==null?void 0:Qe.message)??a.$t("chat.userInput.message")),1),(Ye=(Ze=c.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&Ye.formDescription?(p(),f("p",zs,l((tt=(et=c.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.formDescription),1)):j("",!0),e("form",{onSubmit:pe(fe=>L(c),["prevent"]),class:"user-input-form"},[(ot=(nt=c.planExecution)==null?void 0:nt.userInputWaitState)!=null&&ot.formInputs&&c.planExecution.userInputWaitState.formInputs.length>0?(p(!0),f(re,{key:0},ve((at=(st=c.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:at.formInputs,(fe,de)=>(p(),f("div",{key:de,class:"form-group"},[e("label",{for:`form-input-${fe.label.replace(/\W+/g,"_")}`},l(fe.label)+": ",9,Xs),oe(e("input",{type:"text",id:`form-input-${fe.label.replace(/\W+/g,"_")}`,name:fe.label,"onUpdate:modelValue":lt=>I[c.id][de]=lt,class:"form-input"},null,8,Ks),[[le,I[c.id][de]]])]))),128)):(p(),f("div",Qs,[e("label",Zs,l(a.$t("common.input"))+":",1),oe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":fe=>c.genericInput=fe,class:"form-input"},null,8,Ys),[[le,c.genericInput]])])),e("button",ea,l(a.$t("chat.userInput.submit")),1)],40,Gs)])):j("",!0)],10,bs)}),128))])):!c.content&&(c.thinking||((K=c.planExecution)==null?void 0:K.progress)!==void 0&&(((ue=c.planExecution)==null?void 0:ue.progress)??0)<100)?(p(),f("div",ta,[e("div",na,[s[4]||(s[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(c.thinking??a.$t("chat.thinkingProcessing")),1)])])):j("",!0)])])):j("",!0),e("div",oa,[e("div",sa,[e("div",aa,[_(o(C),{icon:"carbon:bot",class:"bot-icon"})]),e("div",la,l(a.$t("chat.botName")),1)]),e("div",ia,[c.content?(p(),f("div",ra,[e("div",{class:"response-text",innerHTML:w(c.content)},null,8,ca)])):(p(),f("div",ua,[e("div",da,[s[5]||(s[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",pa,l(a.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),O.value?(p(),f("div",ha,[e("div",ma,[e("div",ga,[e("div",va,[e("div",fa,[e("div",ba,[_(o(C),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",ka,l(a.$t("chat.thinkingLabel")),1)]),e("div",_a,[e("div",$a,[e("div",Pa,[s[6]||(s[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(a.$t("chat.thinking")),1)])])])]),e("div",Ca,[e("div",Sa,[e("div",ya,[_(o(C),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ta,l(a.$t("chat.botName")),1)]),e("div",wa,[e("div",Ea,[e("div",Ia,[s[7]||(s[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Da,l(a.$t("chat.thinkingResponse")),1)])])])])])])])):j("",!0)],512),E.value?(p(),f("div",{key:0,class:"scroll-to-bottom-btn",onClick:N,title:a.$t("chat.scrollToBottom")},[_(o(C),{icon:"carbon:chevron-down"})],8,xa)):j("",!0)]))}}),Aa=ye(Ra,[["__scopeId","data-v-46f87864"]]),Ma={class:"input-area"},Na={class:"input-container"},Ua={class:"attach-btn",title:"附加文件"},La=["placeholder","disabled"],Va=["title"],qa=["disabled","title"],Fa=Ce({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(A,{expose:n,emit:t}){const{t:r}=Ee(),T=A,v=t,k=U(),V=U(""),O=_e(()=>T.placeholder||r("input.placeholder")),S=U(O.value),J=_e(()=>!!T.disabled),E=()=>{ae(()=>{k.value&&(k.value.style.height="auto",k.value.style.height=Math.min(k.value.scrollHeight,120)+"px")})},I=N=>{N.key==="Enter"&&!N.shiftKey&&(N.preventDefault(),g())},g=()=>{if(!V.value.trim()||J.value)return;const N=V.value.trim();v("send",N),Z()},M=()=>{v("plan-mode-clicked")},Z=()=>{V.value="",E(),v("clear")},d=(N,R)=>{R&&(S.value=N?R:r("input.waiting")),v("update-state",N,R)},P=N=>{V.value=N,E()},q=()=>V.value.trim();return $e(()=>T.initialValue,N=>{N&&N.trim()&&(V.value=N,E())},{immediate:!0}),n({clearInput:Z,updateState:d,setInputValue:P,getQuery:q,focus:()=>{var N;return(N=k.value)==null?void 0:N.focus()}}),Se(()=>{}),Re(()=>{}),(N,R)=>(p(),f("div",Ma,[e("div",Na,[e("button",Ua,[_(o(C),{icon:"carbon:attachment"})]),oe(e("textarea",{"onUpdate:modelValue":R[0]||(R[0]=ne=>V.value=ne),ref_key:"inputRef",ref:k,class:"chat-input",placeholder:S.value,disabled:J.value,onKeydown:I,onInput:E},null,40,La),[[le,V.value]]),e("button",{class:"plan-mode-btn",title:N.$t("input.planMode"),onClick:M},[_(o(C),{icon:"carbon:document"}),H(" "+l(N.$t("input.planMode")),1)],8,Va),e("button",{class:"send-button",disabled:!V.value.trim()||J.value,onClick:g,title:N.$t("input.send")},[_(o(C),{icon:"carbon:send-alt"}),H(" "+l(N.$t("input.send")),1)],8,qa)])]))}}),Oa=ye(Fa,[["__scopeId","data-v-639c8b2a"]]);class De{static async getAllCronTasks(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron tasks:",n),n}}static async getCronTaskById(n){try{const t=await fetch(`${this.BASE_URL}/${n}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron task by id:",t),t}}static async createCronTask(n){try{const t=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to create cron task:",t),t}}static async updateCronTask(n,t){try{const r=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(r)).json()}catch(r){throw console.error("Failed to update cron task:",r),r}}static async updateTaskStatus(n,t){try{const r=await fetch(`${this.BASE_URL}/${n}/status?status=${t}`,{method:"PUT"});await this.handleResponse(r)}catch(r){throw console.error("Failed to update task status:",r),r}}static async deleteCronTask(n){try{const t=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE"});await this.handleResponse(t)}catch(t){throw console.error("Failed to delete cron task:",t),t}}static async handleResponse(n){if(!n.ok)try{const t=await n.json();throw new Error(t.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}ge(De,"BASE_URL","/api/cron-tasks");const xe={validateCronExpression(A){const n=A.trim().split(/\s+/);return n.length>=5&&n.length<=6},formatTime(A){return new Date(A).toLocaleString()},async saveTask(A){try{let n;return A.id?n=await De.updateCronTask(Number(A.id),A):n=await De.createCronTask(A),n}catch(n){throw console.error("Failed to save cron task:",n),n}},async deleteTask(A){try{await De.deleteCronTask(String(A))}catch(n){throw console.error("Failed to delete cron task:",n),n}},async toggleTaskStatus(A){if(!A.id)throw new Error("Task ID is required");const n=A.status===0?1:0;return await De.updateCronTask(Number(A.id),{...A,status:n})},prepareTaskExecution(A){return A.planTemplateId?{useTemplate:!0,planData:{title:A.cronName||"定时任务执行",planData:{id:A.planTemplateId,planTemplateId:A.planTemplateId,planId:A.planTemplateId},params:A.executionParams||void 0}}:{useTemplate:!1,taskContent:A.planDesc||A.cronName||""}}},Ba={class:"modal-header"},ja={class:"header-actions"},Wa={class:"status-switch"},Ja={class:"status-label"},Ha={class:"toggle-switch"},za=["checked"],Ga={class:"modal-content"},Xa={class:"form-group"},Ka={class:"form-label"},Qa=["placeholder"],Za={class:"form-group"},Ya={class:"form-label"},el=["placeholder"],tl={class:"form-help"},nl={class:"form-group"},ol={class:"form-label"},sl=["placeholder"],al={class:"form-group"},ll={class:"form-label"},il={class:"template-toggle"},rl={key:0,class:"template-selector"},cl={value:""},ul=["value"],dl={class:"form-help"},pl={key:0,class:"form-group"},hl={class:"time-info"},ml={class:"time-label"},gl={class:"time-value"},vl={key:1,class:"form-group"},fl={class:"time-info"},bl={class:"time-label"},kl={class:"time-value"},_l={class:"modal-footer"},$l=["disabled"],Pl=Ce({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(A,{emit:n}){const t=A,r=n,T=U(!1),v=U([]),k=U({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Se(async()=>{try{const g=await Me.getAllPlanTemplates();g&&g.templates&&(v.value=g.templates.map(M=>({id:M.id,name:M.title||"Unnamed Template"})))}catch(g){console.error("Failed to get template list:",g)}});const O=g=>{g.target===g.currentTarget&&r("update:modelValue",!1)},S=()=>{k.value.linkTemplate=!1,k.value.templateId="",k.value.planTemplateId=""},J=()=>k.value.cronName.trim()?k.value.cronTime.trim()?xe.validateCronExpression(k.value.cronTime)?k.value.planDesc.trim()?k.value.linkTemplate&&!k.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),E=g=>xe.formatTime(g),I=async()=>{var g;if(J()){T.value=!0;try{const M={...k.value,...((g=t.task)==null?void 0:g.id)!==void 0&&{id:t.task.id},cronName:k.value.cronName.trim(),cronTime:k.value.cronTime.trim(),planDesc:k.value.planDesc.trim(),status:k.value.status,planTemplateId:k.value.linkTemplate&&k.value.templateId||""};r("save",M)}finally{T.value=!1}}};return $e(()=>t.task,g=>{if(g){const M=g.templateId||g.planTemplateId||"";k.value={cronName:g.cronName||"",cronTime:g.cronTime||"",planDesc:g.planDesc||"",status:g.status??1,linkTemplate:!!M,templateId:M,planTemplateId:M}}else k.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),$e(()=>t.modelValue,g=>{g||(k.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(g,M)=>(p(),ce(Ue,{to:"body"},[_(Ae,{name:"modal"},{default:we(()=>{var Z,d,P;return[g.modelValue?(p(),f("div",{key:0,class:"modal-overlay",onClick:O},[e("div",{class:"modal-container",onClick:M[8]||(M[8]=pe(()=>{},["stop"]))},[e("div",Ba,[e("h3",null,l(g.$t("cronTask.taskDetail")),1),e("div",ja,[e("div",Wa,[e("span",Ja,l(g.$t("cronTask.taskStatus")),1),e("label",Ha,[e("input",{type:"checkbox",checked:k.value.status===0,onChange:M[0]||(M[0]=q=>k.value.status=k.value.status===0?1:0)},null,40,za),M[9]||(M[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:M[1]||(M[1]=q=>g.$emit("update:modelValue",!1))},[_(o(C),{icon:"carbon:close"})])])]),e("div",Ga,[e("form",{onSubmit:pe(I,["prevent"]),class:"task-form"},[e("div",Xa,[e("label",Ka,l(g.$t("cronTask.taskName")),1),oe(e("input",{"onUpdate:modelValue":M[2]||(M[2]=q=>k.value.cronName=q),type:"text",class:"form-input",placeholder:g.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Qa),[[le,k.value.cronName]])]),e("div",Za,[e("label",Ya,l(g.$t("cronTask.cronExpression")),1),oe(e("input",{"onUpdate:modelValue":M[3]||(M[3]=q=>k.value.cronTime=q),type:"text",class:"form-input",placeholder:g.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,el),[[le,k.value.cronTime]]),e("div",tl,l(g.$t("cronTask.cronExpressionHelp")),1)]),e("div",nl,[e("label",ol,l(g.$t("cronTask.taskDescription")),1),oe(e("textarea",{"onUpdate:modelValue":M[4]||(M[4]=q=>k.value.planDesc=q),class:"form-textarea",placeholder:g.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,sl),[[le,k.value.planDesc]])]),e("div",al,[e("label",ll,l(g.$t("cronTask.planTemplate")),1),e("div",il,[e("button",{type:"button",class:se(["template-btn",k.value.linkTemplate?"active":""]),onClick:M[5]||(M[5]=q=>k.value.linkTemplate=!0)},[_(o(C),{icon:"carbon:checkmark"}),H(" "+l(g.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:se(["template-btn",k.value.linkTemplate?"":"active"]),onClick:S},[_(o(C),{icon:"carbon:close"}),H(" "+l(g.$t("cronTask.noTemplate")),1)],2)]),k.value.linkTemplate?(p(),f("div",rl,[oe(e("select",{"onUpdate:modelValue":M[6]||(M[6]=q=>k.value.templateId=q),class:"form-select"},[e("option",cl,l(g.$t("cronTask.selectTemplate")),1),(p(!0),f(re,null,ve(v.value,q=>(p(),f("option",{key:q.id,value:q.id},l(q.name),9,ul))),128))],512),[[it,k.value.templateId]]),e("div",dl,l(g.$t("cronTask.templateHelpText")),1)])):j("",!0)]),(Z=g.task)!=null&&Z.createTime?(p(),f("div",pl,[e("div",hl,[e("span",ml,l(g.$t("cronTask.createTime"))+":",1),e("span",gl,l(E(g.task.createTime)),1)])])):j("",!0),(d=g.task)!=null&&d.updateTime?(p(),f("div",vl,[e("div",fl,[e("span",bl,l(g.$t("cronTask.updateTime"))+":",1),e("span",kl,l(E(g.task.updateTime)),1)])])):j("",!0)],32)]),e("div",_l,[e("button",{type:"button",class:"cancel-btn",onClick:M[7]||(M[7]=q=>g.$emit("update:modelValue",!1))},l(g.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:I,disabled:T.value},[T.value?(p(),ce(o(C),{key:0,icon:"carbon:loading",class:"loading-icon"})):j("",!0),H(" "+l((P=t.task)!=null&&P.id?g.$t("common.save"):g.$t("common.create")),1)],8,$l)])])])):j("",!0)]}),_:1})]))}}),Cl=ye(Pl,[["__scopeId","data-v-5b32448e"]]),Sl={class:"modal-header"},yl={class:"header-actions"},Tl={class:"modal-content"},wl={key:0,class:"loading-container"},El={key:1,class:"empty-container"},Il={key:2,class:"task-list"},Dl=["onClick"],xl={class:"task-main"},Rl={class:"task-info"},Al={class:"task-header"},Ml={class:"task-name"},Nl={class:"task-description"},Ul={class:"task-time"},Ll=["onClick"],Vl=["onClick","disabled","title"],ql=["onClick","title"],Fl={class:"dropdown-menu"},Ol=["onClick"],Bl=["onClick","disabled"],jl=["onClick","disabled"],Wl={class:"confirm-header"},Jl={class:"confirm-content"},Hl={class:"confirm-actions"},zl=["disabled"],Gl={class:"confirm-header"},Xl={class:"confirm-content"},Kl={class:"create-options"},Ql={class:"option-content"},Zl={class:"option-title"},Yl={class:"option-desc"},ei={class:"option-content"},ti={class:"option-title"},ni={class:"option-desc"},oi={class:"confirm-actions"},si=Ce({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(A,{emit:n}){const t=rt(),r=ct(),T=gt(),{t:v}=Ee(),k=A,V=n,O=U([]),S=U(!1),J=U(null),E=U(null),I=U(null),g=U(null),M=U(!1),Z=U(null),d=U(!1),P=U(null),q=U(!1),N=i=>{i.target===i.currentTarget&&V("update:modelValue",!1)},R=async()=>{S.value=!0;try{O.value=await De.getAllCronTasks()}catch(i){console.error("Failed to load cron tasks:",i),T.error(`Failed to load tasks: ${i instanceof Error?i.message:String(i)}`)}finally{S.value=!1}},ne=async i=>{J.value=i;try{const w=O.value.find(s=>s.id===i);if(!w){console.error("Task not found:",i);return}V("update:modelValue",!1);const L=Date.now().toString();await t.push({name:"direct",params:{id:L}}),await new Promise(s=>setTimeout(s,100));const a=xe.prepareTaskExecution(w);a.useTemplate&&a.planData?r.emitPlanExecutionRequested(a.planData):a.taskContent&&r.setTask(a.taskContent)}catch(w){console.error("Failed to execute task:",w),T.error(`Execution failed: ${w instanceof Error?w.message:String(w)}`)}finally{J.value=null}},he=i=>{Z.value={...i},M.value=!0,g.value=null},D=async i=>{try{await xe.saveTask(i),await R(),M.value=!1,T.success("Task saved successfully")}catch(w){console.error("Failed to save task:",w),T.error(`Save failed: ${w instanceof Error?w.message:String(w)}`)}},x=i=>{P.value=i,d.value=!0},B=async()=>{var i;if((i=P.value)!=null&&i.id){E.value=P.value.id;try{await xe.deleteTask(P.value.id),await R(),d.value=!1,P.value=null,T.success("Task deleted successfully")}catch(w){console.error("Failed to delete task:",w),T.error(`Delete failed: ${w instanceof Error?w.message:String(w)}`)}finally{E.value=null}}},$=()=>{d.value=!1,P.value=null},u=i=>{g.value=g.value===i?null:i},h=async i=>{if(i.id){I.value=i.id;try{await xe.toggleTaskStatus(i),await R(),g.value=null,T.success(`Task ${i.status===0?"disabled":"enabled"} successfully`)}catch(w){console.error("Failed to toggle task status:",w),T.error(`Status toggle failed: ${w instanceof Error?w.message:String(w)}`)}finally{I.value=null}}},Y=async i=>{try{await navigator.clipboard.writeText(i),T.success("Cron expression copied successfully")}catch(w){T.error(`Copy failed: ${w instanceof Error?w.message:String(w)}`)}},te=()=>{q.value=!0},ke=()=>{q.value=!1;try{V("update:modelValue",!1);const i=v("cronTask.template");r.setTaskToInput(i);const w=Date.now().toString();t.push({name:"direct",params:{id:w}})}catch(i){console.error("Error in createWithJmanus:",i),T.error(`Creation failed: ${i instanceof Error?i.message:String(i)}`)}},Pe=()=>{q.value=!1,Z.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},M.value=!0},me=()=>{q.value=!1},y=i=>{const w=i.target;!w.closest(".action-dropdown")&&!w.closest(".dropdown-menu")&&(g.value=null)};return Se(()=>{document.addEventListener("click",y,!0)}),Re(()=>{document.removeEventListener("click",y,!0)}),$e(()=>k.modelValue,i=>{i&&R()}),(i,w)=>(p(),f(re,null,[(p(),ce(Ue,{to:"body"},[_(Ae,{name:"modal"},{default:we(()=>[A.modelValue?(p(),f("div",{key:0,class:"modal-overlay",onClick:N},[e("div",{class:"modal-container",onClick:w[3]||(w[3]=pe(()=>{},["stop"]))},[e("div",Sl,[e("h3",null,l(i.$t("cronTask.title")),1),e("div",yl,[e("button",{class:"add-task-btn",onClick:[te,w[0]||(w[0]=pe(()=>{},["stop"]))]},[_(o(C),{icon:"carbon:add"}),H(" "+l(i.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:w[1]||(w[1]=L=>i.$emit("update:modelValue",!1))},[_(o(C),{icon:"carbon:close"})])])]),e("div",Tl,[S.value?(p(),f("div",wl,[_(o(C),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,l(i.$t("common.loading")),1)])):O.value.length===0?(p(),f("div",El,[_(o(C),{icon:"carbon:time",class:"empty-icon"}),e("span",null,l(i.$t("cronTask.noTasks")),1)])):(p(),f("div",Il,[(p(!0),f(re,null,ve(O.value,L=>(p(),f("div",{key:L.id||"",class:"task-item",onClick:a=>he(L)},[e("div",xl,[e("div",Rl,[e("div",Al,[e("div",Ml,l(L.cronName),1),e("div",{class:se(["task-status-badge",L.status===0?"active":"inactive"])},[_(o(C),{icon:L.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,l(L.status===0?i.$t("cronTask.active"):i.$t("cronTask.inactive")),1)],2)]),e("div",Nl,l(L.planDesc),1),e("div",Ul,[_(o(C),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:pe(a=>Y(L.cronTime),["stop"])},l(L.cronTime),9,Ll)])])]),e("div",{class:"task-actions",onClick:w[2]||(w[2]=pe(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:a=>ne(L.id),disabled:J.value===L.id,title:i.$t("cronTask.executeOnce")},[_(o(C),{icon:J.value===L.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),H(" "+l(i.$t("cronTask.executeOnce")),1)],8,Vl),e("div",{class:se(["action-dropdown",{active:g.value===L.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:a=>u(L.id),title:i.$t("cronTask.operations")},[_(o(C),{icon:"carbon:overflow-menu-horizontal"}),H(" "+l(i.$t("cronTask.operations")),1)],8,ql),oe(e("div",Fl,[e("button",{class:"dropdown-item edit-btn",onClick:a=>he(L)},[_(o(C),{icon:"carbon:edit"}),H(" "+l(i.$t("cronTask.edit")),1)],8,Ol),e("button",{class:"dropdown-item toggle-btn",onClick:a=>h(L),disabled:I.value===L.id},[_(o(C),{icon:I.value===L.id?"carbon:loading":L.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),H(" "+l(L.status===0?i.$t("cronTask.disable"):i.$t("cronTask.enable")),1)],8,Bl),e("button",{class:"dropdown-item delete-btn",onClick:a=>x(L),disabled:E.value===L.id},[_(o(C),{icon:E.value===L.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),H(" "+l(i.$t("cronTask.delete")),1)],8,jl)],512),[[pt,g.value===L.id]])],2)])],8,Dl))),128))]))])])])):j("",!0)]),_:1})])),_(Cl,{modelValue:M.value,"onUpdate:modelValue":w[4]||(w[4]=L=>M.value=L),task:Z.value,onSave:D},null,8,["modelValue","task"]),(p(),ce(Ue,{to:"body"},[_(Ae,{name:"modal"},{default:we(()=>{var L,a,s,c;return[d.value?(p(),f("div",{key:0,class:"modal-overlay",onClick:$},[e("div",{class:"confirm-modal",onClick:w[5]||(w[5]=pe(()=>{},["stop"]))},[e("div",Wl,[_(o(C),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,l(i.$t("cronTask.deleteConfirm")),1)]),e("div",Jl,[e("p",null,l(i.$t("cronTask.deleteConfirmMessage",{taskName:((L=P.value)==null?void 0:L.cronName)||((a=P.value)==null?void 0:a.planDesc)||""})),1)]),e("div",Hl,[e("button",{class:"confirm-btn cancel-btn",onClick:$},l(i.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:B,disabled:E.value===((s=P.value)==null?void 0:s.id)},[_(o(C),{icon:E.value===((c=P.value)==null?void 0:c.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),H(" "+l(i.$t("cronTask.delete")),1)],8,zl)])])])):j("",!0)]}),_:1})])),(p(),ce(Ue,{to:"body"},[_(Ae,{name:"modal"},{default:we(()=>[q.value?(p(),f("div",{key:0,class:"modal-overlay",onClick:me},[e("div",{class:"confirm-modal create-options-modal",onClick:w[6]||(w[6]=pe(()=>{},["stop"]))},[e("div",Gl,[_(o(C),{icon:"carbon:time",class:"create-icon"}),e("h3",null,l(i.$t("cronTask.createTask")),1)]),e("div",Xl,[e("p",null,l(i.$t("cronTask.selectCreateMethod")),1),e("div",Kl,[e("button",{class:"create-option-btn jmanus-btn",onClick:ke},[_(o(C),{icon:"carbon:ai-status"}),e("div",Ql,[e("span",Zl,l(i.$t("cronTask.createWithJmanus")),1),e("span",Yl,l(i.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:Pe},[_(o(C),{icon:"carbon:edit"}),e("div",ei,[e("span",ti,l(i.$t("cronTask.createManually")),1),e("span",ni,l(i.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",oi,[e("button",{class:"confirm-btn cancel-btn",onClick:me},l(i.$t("common.cancel")),1)])])])):j("",!0)]),_:1})]))],64))}}),ai=ye(si,[["__scopeId","data-v-f31a9ce7"]]),li={class:"direct-page"},ii={class:"direct-chat"},ri={class:"chat-header"},ci={class:"header-actions"},ui=["title"],di=["title"],pi={class:"chat-content"},hi=["title"],mi={class:"message-content"},gi=Ce({__name:"index",setup(A){const n=ht(),t=rt(),r=ct(),{t:T}=Ee(),{message:v}=vt(),k=U(""),V=U(""),O=U(),S=U(),J=U(),E=U(!1),I=U(!1),g=U(null),M=U(!1),Z=U(50),d=U(!1),P=U(0),q=U(0);Se(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),ie.setEventCallbacks({onPlanUpdate:i=>{console.log("[Direct] Plan update event received for rootPlanId:",i),D(i)&&(console.log("[Direct] Processing plan update for current rootPlanId:",i),S.value&&typeof S.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",i),S.value.handlePlanUpdate(i)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),O.value&&typeof O.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",i),O.value.updateDisplayedPlanProgress(i)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:i=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",i),!!D(i)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",i),S.value&&typeof S.value.handlePlanCompleted=="function"){const w=ie.getCachedPlanRecord(i);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",w),S.value.handlePlanCompleted(w??{planId:i})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");g.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:i=>{console.log("[Direct] Dialog round start event received for rootPlanId:",i),g.value=i,console.log("[Direct] Set currentRootPlanId to:",i),S.value&&typeof S.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",i),S.value.handleDialogRoundStart(i)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),B()},onChatInputUpdateState:i=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",i),!D(i,!0))return;const w=ie.getCachedUIState(i);w&&u(w.enabled,w.placeholder)},onPlanError:i=>{S.value.handlePlanError(i)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),b.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask){const i=r.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",i),r.markTaskAsProcessed(),ae(()=>{S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",i),S.value.handleSendMessage(i)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),k.value=i)})}else{const i=r.getAndClearTaskToInput();i?(V.value=i,console.log("[Direct] Setting inputOnlyContent for input only:",V.value)):(k.value=n.query.prompt||"",console.log("[Direct] Received task from URL:",k.value),console.log("[Direct] No unprocessed task in store"))}const y=localStorage.getItem("directPanelWidth");y&&(Z.value=parseFloat(y)),console.log("[Direct] Final prompt value:",k.value),V.value&&ae(()=>{J.value&&typeof J.value.setInputValue=="function"&&(J.value.setInputValue(V.value),console.log("[Direct] Set input value:",V.value),V.value="")}),window.addEventListener("plan-execution-requested",i=>{console.log("[DirectView] Received plan-execution-requested event:",i.detail),me(i.detail)})}),$e(()=>r.currentTask,y=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",y),y&&!y.processed){const i=y.prompt;r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",i),ae(()=>{S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",i),S.value.handleSendMessage(i)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),$e(()=>k.value,(y,i)=>{console.log("[Direct] prompt value changed from:",i,"to:",y)},{immediate:!1}),$e(()=>r.taskToInput,y=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",y),y&&y.trim()&&(console.log("[Direct] Setting input value from taskToInput:",y),ae(()=>{J.value&&typeof J.value.setInputValue=="function"&&(J.value.setInputValue(y.trim()),console.log("[Direct] Input value set from taskToInput watch:",y.trim()),r.getAndClearTaskToInput())}))},{immediate:!1}),Re(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),g.value=null,ie.cleanup(),document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",ne),window.removeEventListener("plan-execution-requested",y=>{me(y.detail)})});const N=y=>{d.value=!0,P.value=y.clientX,q.value=Z.value,document.addEventListener("mousemove",R),document.addEventListener("mouseup",ne),document.body.style.cursor="col-resize",document.body.style.userSelect="none",y.preventDefault()},R=y=>{if(!d.value)return;const i=window.innerWidth,L=(y.clientX-P.value)/i*100;let a=q.value+L;a=Math.max(20,Math.min(80,a)),Z.value=a},ne=()=>{d.value=!1,document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",ne),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",Z.value.toString())},he=()=>{Z.value=50,localStorage.setItem("directPanelWidth","50")},D=(y,i=!1)=>!g.value||y===g.value||i&&(y==="ui-state"||y==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",y,"current:",g.value),!1),x=y=>{console.log("[DirectView] Send message from input:",y),S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",y),S.value.handleSendMessage(y)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},B=()=>{console.log("[DirectView] Input cleared"),J.value&&typeof J.value.clear=="function"&&J.value.clear()},$=()=>{console.log("[DirectView] Input focused")},u=(y,i)=>{console.log("[DirectView] Input state updated:",y,i),I.value=!y},h=(y,i)=>{console.log("[DirectView] Step selected:",y,i),O.value&&typeof O.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",y,i),O.value.handleStepSelected(y,i)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},Y=(y,i,w,L)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:y,subPlanId:i,stepIndex:w,subStepIndex:L}),O.value&&typeof O.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:y,subPlanId:i,stepIndex:w,subStepIndex:L}),O.value.handleSubPlanStepSelected(y,i,w,L)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},te=()=>{console.log("[DirectView] Plan mode button clicked"),b.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",b.isCollapsed)},ke=()=>{t.push("/home")},Pe=()=>{t.push("/configs")},me=async y=>{var w,L,a,s;if(console.log("[DirectView] Plan execution requested:",y),E.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}E.value=!0;let i=!1;S.value&&typeof S.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",y.title),S.value.addMessage("user",y.title),i=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const c=((w=y.planData)==null?void 0:w.planTemplateId)||((L=y.planData)==null?void 0:L.id)||((a=y.planData)==null?void 0:a.planId);if(!c)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",c,"params:",y.params),console.log("[Direct] About to call PlanActApiService.executePlan");let m;if((s=y.params)!=null&&s.trim()?(console.log("[Direct] Calling executePlan with params:",y.params.trim()),m=await Me.executePlan(c,y.params.trim())):(console.log("[Direct] Calling executePlan without params"),m=await Me.executePlan(c)),console.log("[Direct] Plan execution API response:",m),m.planId)console.log("[Direct] Got planId from response:",m.planId,"starting plan execution"),g.value=m.planId,console.log("[Direct] Set currentRootPlanId to:",m.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ie.handlePlanExecutionRequested(m.planId,y.title);else throw console.error("[Direct] No planId in response:",m),new Error("执行计划失败：未返回有效的计划ID")}catch(c){console.error("[Direct] Plan execution failed:",c),console.error("[Direct] Error details:",{message:c.message,stack:c.stack}),g.value=null,S.value&&typeof S.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),i||S.value.addMessage("user",y.title),S.value.addMessage("assistant",`执行计划失败: ${c.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${c.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),E.value=!1}};return(y,i)=>(p(),f("div",li,[e("div",ii,[_(Vn,{onPlanExecutionRequested:me}),e("div",{class:"left-panel",style:Le({width:Z.value+"%"})},[e("div",ri,[e("button",{class:"back-button",onClick:ke},[_(o(C),{icon:"carbon:arrow-left"})]),e("h2",null,l(y.$t("conversation")),1),e("div",ci,[_(bt),e("button",{class:"config-button",onClick:Pe,title:y.$t("direct.configuration")},[_(o(C),{icon:"carbon:settings-adjust",width:"20"})],8,ui),e("button",{class:"cron-task-btn",onClick:i[0]||(i[0]=w=>M.value=!0),title:y.$t("cronTask.title")},[_(o(C),{icon:"carbon:alarm",width:"20"})],8,di)])]),e("div",pi,[_(Aa,{ref_key:"chatRef",ref:S,mode:"direct","initial-prompt":k.value||"",onStepSelected:h,onSubPlanStepSelected:Y},null,8,["initial-prompt"])]),(p(),ce(Oa,{key:y.$i18n.locale,ref_key:"inputRef",ref:J,disabled:I.value,placeholder:I.value?o(T)("input.waiting"):o(T)("input.placeholder"),"initial-value":k.value,onSend:x,onClear:B,onFocus:$,onUpdateState:u,onPlanModeClicked:te},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:N,onDblclick:he,title:y.$t("direct.panelResizeHint")},i[2]||(i[2]=[e("div",{class:"resizer-line"},null,-1)]),40,hi),_(ts,{ref_key:"rightPanelRef",ref:O,style:Le({width:100-Z.value+"%"})},null,8,["style"])]),_(ai,{modelValue:M.value,"onUpdate:modelValue":i[1]||(i[1]=w=>M.value=w)},null,8,["modelValue"]),o(v).show?(p(),f("div",{key:0,class:se(["message-toast",o(v).type])},[e("div",mi,[e("span",null,l(o(v).text),1)])],2)):j("",!0)]))}}),Si=ye(gi,[["__scopeId","data-v-ea79c7eb"]]);export{Si as default};
